---
editor_options: 
  markdown: 
    wrap: 72
---

# Actitudes hacia la democracia

## Apoyo a la Democracia

### 3.1 ¿Con cuál de las siguientes frases está usted más de acuerdo?

<!-- ### 3.1 ¿Con cuál de las siguientes frases está usted más de acuerdo? -->

```{r include=FALSE}
elsoc_panel_m1$aut_dem <- car::recode(as.numeric(elsoc_panel_m1$c25), 
                                      recodes = "c(1)='Democracia es preferible a cualquier otra forma de gobierno'; 
                                      c(2)='En algunos casos, gobierno autoritario puede ser preferible'; c(3)='Da lo mismo régimen democrático o autoritario'; 
                                      c(4)='Ninguna'; 
                                      else=NA", as.factor = TRUE) 
elsoc_panel_m1$aut_dem <- na.replace(elsoc_panel_m1$aut_dem, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

```

```{r}

datos.3.1 <- data.frame((svytable(~aut_dem + ola + idencuesta, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit()

etiquetas.3.1 <- data.frame((svytable(~aut_dem + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
g.3.1 <- ggplot(datos.3.1, aes(x = ola, fill = aut_dem, stratum = aut_dem,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.text = element_text(size=5),
          legend.title = element_blank(),
          legend.key.size = unit(.3, "cm")) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.3.1, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))

g.3.1
```

### 3.2 Frecuencia de respuesta "Nada satisfecho" con la democracia según ola

<!-- ### 3.2 Frecuencia de respuesta "Nada satisfecho" con la democracia según ola -->

```{r echo=FALSE}
#agregar variable a bbdd original

datos.3.2 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra == 1 & c01 %in% c(1)) %>%
  prop(x = ola, by = c01, na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, c01)
g.3.2 <- datos.3.2 %>% 
  ggplot(aes(y = prop, x = ola, fill = c01, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())
g.3.2
```

### 3.3 ¿Con cuál de las siguientes frases está usted más de acuerdo? (2021), según posición ideológica

<!-- ### 3.3. ¿Con cuál de las siguientes frases está usted más de acuerdo? (2019), según posición ideológica -->

```{r include=FALSE}
datos.3.3 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% c(5) & !c25 %in% c(-888,-999)) %>%
  mutate(aut_dem = factor(c25, levels = c(1, 2, 3, 4),
                         labels = c('Democracia es preferible a\ncualquier otra forma\nde gobierno', 'En algunos casos,\n gobierno autoritario puede\n ser preferible', 'Da lo mismo régimen\ndemocrático o autoritario', 'Ninguna'))) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(x = aut_dem, by = c(pos_id, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(pos_id, ola)

g.3.3 <-datos.3.3 %>% 
  ggplot(aes(y = prop, x = pos_id, fill = aut_dem, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g.3.3
```





