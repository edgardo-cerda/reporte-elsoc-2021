# Confianza y seguridad con perspectiva territorial
```{r Diseno complejo, include=FALSE}
rm(list = ls())
library(survey)
library(tidyverse)
load("1_input/datos_elsoc.RData")

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel_m1)
```

La configuración urbana influye en la calidad de vida y determina, a su vez, la confianza entre los vecinos de un barrio. La confianza y la seguridad barrial tiene una importancia sustantiva en la medida de que nos permite comprender la evolución de la calidad de vida en los barrios y su sustentabilidad en el tiempo [@brown_Incivilities_2004].

```{r Recode, include=FALSE}

elsoc_panel_m1 <- 
  elsoc_panel_m1 %>%
  mutate(conf_vecinos = factor(car::recode(t01, "c(1,2) = 1;c(3) = 2;c(4,5) = 3"),
                               labels = c('Muy poco o poco', 
                                              'Algo',
                                              'Bastante o mucho')),
         segur_barrio = factor(car::recode(t10, "c(1,2) = 1;c(3) = 2;c(4,5) = 3"),
                               labels = c('Muy inseguro o inseguro', 
                                          'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro')))
sjmisc::frq(elsoc_panel_m1$conf_vecinos)
sjmisc::frq(elsoc_panel_m1$segur_barrio)

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                             nest = TRUE, data = elsoc_panel_m1)
```

A nivel territorial se puede observar que la confianza en los vecinos ha tendido a aumentar levemente a nivel territorial (Figura \@ref(fig:vecinos-zona)), constatándose un incremento mayor en el norte del país. La confianza en los vecinos sigue siendo más alta en los barrios de mayores ingresos, sin embargo, nuevamente no se observan variaciones a lo largo del tiempo (Figura \@ref(fig:vecinos-quinti)). 

<!-- ### 10.1 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.  -->
```{r vecinos-zona, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.g10.1 <- data.frame(svytable(~conf_vecinos + ola + estrato, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, estrato) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(conf_vecinos == 'Bastante o mucho', ola == '2019' | ola == '2021')

g10.1 <-
  datos.g10.1 %>% 
  ggplot(aes(y = porcentaje, x = estrato, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g10.1
```



<!-- ### 10.2 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y nivel educacional. Suma de Respuestas “Bastante” y “Mucho”. -->
```{r vecinos-quinti, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y nivel educacional. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.g10.2 <- data.frame(svytable(~conf_vecinos + ola + quintil, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, quintil) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(conf_vecinos == 'Bastante o mucho', ola == '2019' | ola == '2021')

g10.2 <-
  datos.g10.2 %>% 
  ggplot(aes(y = porcentaje, x = quintil, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g10.2
```


En relación a la percepción de seguridad en los barrios, se puede constatar que en la zona sur del país ha tendido a crecer con el paso del tiempo (Figura \@ref(fig:seguri-zona)). La seguridad percibida en los barrios también tiende a aumentar con los niveles de escolaridad y de ingresos, siendo más alta en los tramos de mayor escolaridad e ingresos (Figura \@ref(fig:seguri-educ) y Figura \@ref(fig:seguri-quintil)). Son las personas mayores de 50 años en adelante quienes perciben mayor seguridad en sus barrios y quienes experimentan un aumento sustantivo desde el 2016 al 2019 (Figura \@ref(fig:seguri-edad)). No se constatan variaciones según posición ideológica, sin embargo, ésta tiende a aumentar entre el 2016 al 2019 especialmente en quienes se declaran de centro y de derecha (Figura \@ref(fig:seguri-ideolo)).

<!-- ### 10.3 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Seguro" o ”Muy Seguro".  -->

```{r seguri-zona, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.3 <- data.frame((svytable(~zona1 + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, zona1) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.3 <- 
  ggplot(datos.g10.3, aes(y = porcentaje, x = ola, color = zona1, group = zona1,
                           label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .88, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.3
```


<!-- ### 10.4 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-educ, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.4 <- data.frame((svytable(~educ + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, educ) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.4 <- 
  ggplot(datos.g10.4, aes(y = porcentaje, x = ola, color = educ, group = educ,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .88, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.4
```


<!-- ### 10.5 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-edad, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.5 <- data.frame((svytable(~edadt + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, edadt) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.5 <- 
  ggplot(datos.g10.5, aes(y = porcentaje, x = ola, color = edadt, group = edadt,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .88, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
                  posilinetion = position_dodge(width = .9),
                  size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.5
```


<!-- ### 10.6 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintiles de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-quintil, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintiles de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro".'}

datos.g10.6 <- data.frame((svytable(~quintil + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, quintil) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro", quintil == "Q1" | quintil == "Q5") 

g10.6 <- 
  ggplot(datos.g10.6, aes(y = porcentaje, x = ola, color = quintil, group = quintil,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .22, end = .88, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.6
```



<!-- ### 10.7 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio e ideología política. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-ideolo, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio e ideología política. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.7 <- data.frame((svytable(~pos_id + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, pos_id) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.7 <- 
  ggplot(datos.g10.7, aes(y = porcentaje, x = ola, color = pos_id, group = pos_id,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .22, end = .88, direction = -1, option = 'viridis') +
  geom_text_repel(vjust = -0.8,
                  posilinetion = position_dodge(width = .9),
                  size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.7  
```

 