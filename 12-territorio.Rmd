# Conflicto y cohesión territorial en pandemia

```{r library-12, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 
Sys.setlocale("LC_ALL","ES_ES.UTF-8")

#devtools::install_github('edgardo-cerda/elsoc', force = TRUE)
library(elsoc)
library(tidyverse)
library(sjlabelled)
library(ggrepel)
library(survey)
library(sf)
library(chilemapas)
library(rgdal)

#load(file.path('1_input', 'ELSOC_Long_2016_2021_v1.00_R.RData'))
elsoc::load_elsoc(format = 'long')
```

## Conflictividad barrial

<!-- ### 8.1 ¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio -->
```{r confli-olas, fig.align='center', fig.cap='¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio '}
datos.8.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_confli_rec, by = ola, na.rm = TRUE)

g8.1 <- datos.8.1 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_confli_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top', legend.title = element_blank())
g8.1
```

<!-- ### 8.2 Cambios en frecuencia de conflictos barriales -->
```{r confli-cambio, fig.align='center', fig.cap='Cambios en frecuencia de conflictos barriales'}

elsoc_diseno <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.8.2 <- data.frame((svytable(~barrio_confli_rec + ola + idencuesta, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>%  
  drop_na()

etiquetas.8.2 <- data.frame((svytable(~barrio_confli_rec + ola, elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  drop_na()

g8.2 <- 
  ggplot(datos.8.2, aes(x = ola, fill = barrio_confli_rec, stratum = barrio_confli_rec, 
                           alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.8.2, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('black', 'white', 'white'),2))
g8.2
```

<!-- ### 8.3 Porce´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´{+}egún ola del estudio y zona geográfica. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-zona, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona geográfica. Porcentaje con conflictos barriales "Siempre" o "Muchas veces"'}

datos.8.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate( zona1 = factor(car::recode(region_cod, 
                                     "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana"))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_confli >= 2.76, by = c(ola, zona1), na.rm = TRUE)

g8.3 <- datos.8.3 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.3
```

<!-- ### 8.4 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-estrato, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".'}
datos.8.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
         labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción', 
                    'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_confli_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  filter(barrio_confli_rec == 'Muchas veces o siempre')

g8.4 <- datos.8.4 %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.4
```


<!-- ### 8.5 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintil de ingreso. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-quintil, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintil de ingreso. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".'}
datos.8.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4,
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_confli >= 2.76, by = c(ola, quintil), na.rm = TRUE)

g8.5 <- datos.8.5 %>% 
  ggplot(aes(y = prop, x = quintil, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.5
```

### Cartografía del conflicto barrial

```{r confli-comuna, fig.align='center', fig.cap='Frecuencia promedio de problemas con vecinos, según comuna de residencia en la región metropolitana (2021).'}

elsoc_comuna_rm <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & region_cod == 13 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(m_confli = weighted.mean(barrio_confli, ponderador02, na.rm = T),
            sd_confli = sd(barrio_confli, na.rm = T),
            n = n())

comunas_rm <- mapa_comunas[mapa_comunas$codigo_region==13,]
comunas_rm <- merge(comunas_rm, 
                    elsoc_comuna_rm, 
                    by.x = "codigo_comuna", by.y = "comuna_cod",
                    all.x = TRUE,
                    sort=F)

#comunas_rm <- comunas_rm %>% drop_na() #en caso de quitar comunas con NA

g.confli.rm <- 
  ggplot(comunas_rm) + 
  geom_sf(aes(fill = m_confli, geometry = geometry)) +
  labs(y = NULL, x = NULL, fill = "Conflictividad barrial\npromedio por comuna") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis') +
  theme_bw()
g.confli.rm
```

```{r confli-region, fig.align='center', fig.cap='Frecuencia promedio de problemas con vecinos, según región de Chile (2021)' message=FALSE, warning=FALSE}

elsoc_region <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(region, region_cod) %>% 
  summarise(m_confli = weighted.mean(barrio_confli, ponderador02, na.rm = T),
            sd_confli = sd(barrio_confli, na.rm = T),
            n = n())

elsoc_region$region_cod <- factor(elsoc_region$region_cod,
                                  labels = c('01','02','03','04','05','06','07','08',
                                            '09','10','11','13','14','15','16'))

regiones <- generar_regiones()
regiones <- merge(regiones,elsoc_region, by.x="codigo_region",by.y="region_cod",all.x=TRUE,sort=F)

#para intentar hacer facet_wrap
#regiones$mitad <- c('1','1','1','1','1','1','1','2','2','2','2','1','2','1','2','2')

regiones$region[is.na(regiones$region)] <- 'Magallanes\n(Sin datos)'
regiones$region[regiones$region == 'Metropolitana de santiago'] <- 'Metropolitana'
regiones$region[regiones$region == 'Libertador general bernardo ohiggins'] <- 'Ohiggins'
regiones$region[regiones$region == 'Aysen del general carlos ibannez del campo'] <- 'Aysen'
regiones$region[regiones$region == 'Arica y parinacota'] <- 'Arica'

g.confli.region <- regiones %>% 
  ggplot(aes(fill = m_confli, geometry = geometry, label = region)) + 
  geom_sf() +
  coord_sf(xlim = c(-100, -65)) +
  labs(y = NULL, x = NULL, fill = "Conflictividad barrial\npromedio por región") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis', na.value = 'white') +
  ggrepel::geom_text_repel(stat = "sf_coordinates", min.segment.length = 0,
                           colour = "black", segment.colour = "black",
                           direction = "y", hjust = 2.5, size = 3) +
  ggspatial::annotation_north_arrow(aes(which_north = "true", location = "bl"), pad_y = unit(0.8, "cm")) +
  ggspatial::annotation_scale(aes(location = "bl", style = "bar")) +
  theme_bw()
g.confli.region
```

## Confianza en vecinos

<!-- ### 8.6 En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio -->
```{r vecinos-ola, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio.'}
datos.8.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t01 %in% c(-888, -999)) %>% 
  mutate(barrio_conf = factor(car::recode(t01, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels = c('Muy poco o poco', 'Algo', 'Bastante o mucho'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_conf, by = ola, na.rm = TRUE)

g8.6 <- datos.8.6 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_conf, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.6
```

<!-- ### 8.7 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.  -->
```{r vecinos-zona, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.8.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t01 %in% c(-888, -999)) %>% 
  mutate(zona1 = factor(car::recode(region_cod, 
                                    "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana")))%>%
  sjlabelled::as_label(ola) %>%
  prop(x = t01 %in% c(4, 5), by = c(ola, zona1), na.rm = TRUE) 

g8.7 <- datos.8.7 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.7
```

<!-- ### 8.8 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y quintil de ingreso. Suma de Respuestas “Bastante” y “Mucho”. -->
```{r vecinos-quintil, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y quintil de ingreso. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.8.8 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t01 %in% c(-888, -999)) %>% 
  mutate(m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m30b = as.numeric(car::recode(m30b, "1 = 125000; 2 = 300000; 3 = 400000; 4 = 620000; 5 = 1100000; NA = NA")),
         m29_imp = ifelse(!is.na(m29), m29, ifelse(ola == 5, m30b ,m30)),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54),
         ing_pc = (m29_imp/n_hogar)) %>%
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), 
                          levels = c(1,2,3,4,5),
                          labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = t01 %in% c(4, 5), by = c(ola, quintil), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.8 <- datos.8.8 %>% 
  ggplot(aes(y = prop, x = quintil, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.8
```


## Seguridad barrial

<!-- ### 8.9 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio. -->
```{r seguri-ola, fig.align='center', fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio.'}
datos.8.9 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(barrio_segur = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), levels = c(1,2,3),
                               labels = c('Muy inseguro o inseguro', 'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_segur, by = ola, na.rm = TRUE)

g8.9 <- datos.8.9 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_segur, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.9
```

<!-- ### 8.10 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Inseguro" o ”Muy Inseguro".  -->

```{r seguri-zona, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}

datos.8.10 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(zona1 = factor(car::recode(region_cod, 
                                    "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana")))%>%
  prop(x = t10 %in% c(1, 2), by = c(ola, zona1), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.10 <- datos.8.10 %>% 
  ggplot(aes(y = prop, x = ola, color = zona1, group = zona1,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.10
```

<!-- ### 8.11 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Inseguro" o ”Muy Inseguro". -->
```{r seguri-educ, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}

datos.8.11 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999) & !m01 %in% c(-888, -999)) %>% 
  mutate(educ = factor(car::recode(m01,
                                   "c(1,2,3)=1; c(4,5)=2; c(6,7)=3; c(8,9,10)=4"),
                        levels = c(1,2,3,4), 
                       labels = c("Basica","Media","Tecnica","Universitaria"))) %>%
  prop(x = t10 %in% c(1, 2), by = c(ola, educ), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.11 <- datos.8.11 %>% 
  ggplot(aes(y = prop, x = ola, color = educ, group = educ,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.11
```

<!-- ### 8.12 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Inseguro" o ”Muy Inseguro". -->
```{r seguri-edad, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}
datos.8.12 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(edadt = factor(car::recode(m0_edad, 
                                    "18:29=1;30:49=2;50:64=3;65:150=4"),
                        levels = c(1,2,3,4), 
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = t10 %in% c(1,2), by = c(ola, edadt), na.rm = TRUE)

g8.12 <- datos.8.12 %>% 
  ggplot(aes(y = prop, x = ola, color = edadt, group = edadt,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.12
```

<!-- ### 8.13 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintil de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-quintil, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintil de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro".'}

datos.8.13 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(barrio_segur = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), levels = c(1,2,3),
                               labels = c('Muy inseguro o inseguro', 'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro')),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_segur, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(barrio_segur == 'Muy inseguro o inseguro', quintil == "Q1" | quintil == "Q5") %>% 
  drop_na()

g8.13 <- datos.8.13 %>% 
  ggplot(aes(y = prop, x = ola, color = quintil, group = quintil,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .55, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.13
```

## Criminalidad barrial

<!-- ### 8.14 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola de estudio. -->
```{r crim-olas, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola de estudio.'}
datos.8.14 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = ola, na.rm = TRUE)

g8.14 <- datos.8.14 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_crim_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top', legend.title = element_blank())
g8.14
```

<!-- ### 8.15 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y zona geográfica. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-zona, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y zona geográfica. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}
datos.8.15 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         zona1 = factor(car::recode(region_cod, "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), labels = c("Norte","Centro","Sur","Metropolitana"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = c(ola, zona1), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre')

g8.15 <- datos.8.15 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.15
```

<!-- ### 8.16 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y tipo de ciudad. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-estrato, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y tipo de ciudad. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}
datos.8.16 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre')

g8.16 <- datos.8.16 %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.16
```

<!-- ### 8.17 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y quintil de ingreso. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-quintil, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y quintil de ingreso. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}

datos.8.17 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_crim_rec, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre', quintil == "Q1" | quintil == "Q5") 

g8.17 <- datos.8.17 %>% 
  ggplot(aes(y = prop, x = ola, color = quintil, group = quintil,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .55, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.17
```
### Cartografía de la criminalidad barrial

```{r crimi-comuna, fig.align='center', fig.cap='Frecuencia promedio de percepción de crímenes (riñas, robos y tráfico de drogas) en el barrio, según comuna de residencia en la región metropolitana (2021).'}

elsoc_comuna_rm <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & region_cod == 13 & !t09_01 %in% c(-888, -999) &
           !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(m_crim = weighted.mean(barrio_crim, ponderador02, na.rm = T),
            sd_crim = sd(barrio_crim, na.rm = T),
            n = n())

comunas_rm <- chilemapas::mapa_zonas %>% 
  filter(codigo_region==13 & codigo_provincia == '131') %>% 
  st_as_sf(.) %>% 
  group_by(codigo_comuna) %>% 
  summarise()

comunas_rm <- merge(comunas_rm, 
                    elsoc_comuna_rm, 
                    by.x = "codigo_comuna", by.y = "comuna_cod",
                    all.x = TRUE,
                    sort=F)

#comunas_rm <- comunas_rm %>% drop_na() #en caso de quitar comunas con NA

g.crimi.rm <- 
  ggplot(comunas_rm) + 
  geom_sf(aes(fill = m_crim, geometry = geometry)) +
  labs(y = NULL, x = NULL, fill = "Criminalidad barrial\npromedio por comuna") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis') +
  theme_bw() 
g.crimi.rm
```

```{r confli-region, fig.align='center', fig.cap='Frecuencia promedio de percepción de crímenes (riñas, robos y tráfico de drogas) en el barrio, según región de Chile (2021)' message=FALSE, warning=FALSE}

elsoc_region <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !t09_01 %in% c(-888, -999) &
           !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(region, region_cod) %>% 
  summarise(m_crim = weighted.mean(barrio_crim, ponderador02, na.rm = T),
            sd_crim = sd(barrio_crim, na.rm = T),
            n = n())

elsoc_region$region_cod <- factor(elsoc_region$region_cod,
                                  labels = c('01','02','03','04','05','06','07','08',
                                            '09','10','11','13','14','15','16'))

regiones <- generar_regiones()
regiones <- merge(regiones,elsoc_region, by.x="codigo_region",by.y="region_cod",all.x=TRUE,sort=F)

#para intentar hacer facet_wrap
#regiones$mitad <- c('1','1','1','1','1','1','1','2','2','2','2','1','2','1','2','2')

regiones$region[is.na(regiones$region)] <- 'Magallanes\n(Sin datos)'
regiones$region[regiones$region == 'Metropolitana de santiago'] <- 'Metropolitana'
regiones$region[regiones$region == 'Libertador general bernardo ohiggins'] <- 'Ohiggins'
regiones$region[regiones$region == 'Aysen del general carlos ibannez del campo'] <- 'Aysen'
regiones$region[regiones$region == 'Arica y parinacota'] <- 'Arica'

g.crim.region <- regiones %>% 
  ggplot(aes(fill = m_crim, geometry = geometry, label = region)) + 
  geom_sf() +
  coord_sf(xlim = c(-100, -65)) +
  labs(y = NULL, x = NULL, fill = "Criminalidad barrial\npromedio por región") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis', na.value = 'white') +
  ggrepel::geom_text_repel(stat = "sf_coordinates", min.segment.length = 0,
                           colour = "black", segment.colour = "black",
                           direction = "y", hjust = 2.5, size = 3) +
  ggspatial::annotation_north_arrow(aes(which_north = "true", location = "bl"), pad_y = unit(0.8, "cm")) +
  ggspatial::annotation_scale(aes(location = "bl", style = "bar")) +
  theme_bw()
g.crim.region
```
