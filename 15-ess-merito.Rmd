# Estatus subjetivo y Percepción de Mérito
```{r library-15, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 
Sys.setlocale("LC_ALL","ES_ES.UTF-8")

#devtools::install_github('edgardo-cerda/elsoc', force = TRUE)
library(elsoc)
library(tidyverse)
library(sjlabelled)
library(ggrepel)
library(survey)

#load(file.path('1_input', 'ELSOC_Long_2016_2021_v1.00_R.RData'))
elsoc::load_elsoc(format = 'long')
```

## Estatus subjetivo
<!-- ### 11.1 En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio. -->
```{r ess-ola, fig.align='center',fig.cap='En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio.'}
datos.11.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !d01_01 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4, 5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = clase_sub, by = ola, na.rm = T)

g11.1 <- datos.11.1 %>% 
  ggplot(aes(y = prop, x = ola, fill = clase_sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.1

```

<!-- ### 11.2 Cambios de Clase social subjetiva entre 2016, 2019 y 2021 -->
```{r ess-cambio, fig.align='center',fig.cap='Cambios de Clase social subjetiva entre 2016, 2019 y 2021'}
elsoc_panel_m1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1, 4, 5)) %>% 
  group_by(idencuesta) %>% 
  mutate(missing = any(d01_01 %in% c(-888, -999))) %>% 
  filter(!missing) %>% 
  ungroup() %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4, 5)=2; c(6,7,8,9,10)=3; else=NA"), 
                            levels = c(1, 2, 3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.11.2 <- data.frame((svytable(~clase_sub + ola + idencuesta, elsoc_panel_m1, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>%
  filter(Freq>0 & (ola == '2016'| ola == '2019' | ola == '2021')) %>%
  drop_na()

etiquetas.11.2 <- data.frame((svytable(~clase_sub + ola, elsoc_panel_m1, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  filter(Freq>0 & (ola == '2016'| ola == '2019' | ola == '2021')) %>% 
  drop_na()

g11.2 <- 
  ggplot(datos.11.2, aes(x = ola, fill = clase_sub, stratum = clase_sub, 
                          alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(data = etiquetas.11.2, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('white', 'white', 'black'),3))
g11.2
```

<!-- ### 11.3 Clase social subjetiva, según quintiles de ingreso (2021) -->
```{r ess-quintil, fig.align='center',fig.cap='Clase social subjetiva, según quintiles de ingreso (2021)'}

datos.11.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !t01 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = clase_sub, by = c(ola, quintil), na.rm = TRUE)

g11.3 <- 
  datos.11.3 %>% 
  ggplot(aes(y = prop, x = quintil, fill = clase_sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c( 'black','black','white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.3
```

<!-- ### 11.4  Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021) -->
```{r esshijos-ess, fig.align='center',fig.cap='Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021)'}
datos11.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & 
         !d01_01 %in% c(-888, -999) & !d01_03 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta")),
         clase_sub_hijo = factor(car::recode(d01_03, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"),
                                 levels = c(1,2,3), 
                                 labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = clase_sub_hijo, by = c(ola, clase_sub), na.rm = T)

g11.4 <- datos11.4 %>% 
  ggplot(aes(y = prop, x = clase_sub, fill = clase_sub_hijo, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = 'Clase social subjetiva propia') +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.4
```

## Movilidad social

<!-- ### 11.5  Perspectiva de movilidad social, según ola.  -->
```{r mov-soc-rec, fig.align='center',fig.cap='Perspectiva de movilidad social, según ola. '}
datos.11.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_03 %in% c(-888, -999)) %>% 
  mutate(mov_interg = d01_03 - d01_01) %>% 
  mutate(mov_interg_rec = factor(car::recode(mov_interg, "-8:-1=1;0=2;1:10=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Perpectiva de\nmovilidad descendente", "Perspectiva de\ninmovilidad social",
                                       "Perspectiva de\nmovilidad ascendente"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = mov_interg_rec, by = ola, na.rm = T)

g11.5 <- 
  datos.11.5 %>% 
  ggplot(aes(y = prop, x = ola, fill = mov_interg_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .99, direction = -1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.5
```

```{r}
datos.11.6e <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_02 %in% c(-888,-999) & !d01_03 %in% c(-888, -999)) %>%
  sjlabelled::as_label(ola) %>% 
  mutate(mov_interg = d01_03 - d01_01,
         mov_relativa = d01_01 - d01_02) %>% 
  group_by(ola) %>% 
  summarise(m_interg = weighted.mean(mov_interg, ponderador02 ,na.rm = T),
            m_relativa = weighted.mean(mov_relativa, ponderador02 ,na.rm = T),
            m_estatus = weighted.mean(d01_01, ponderador02 ,na.rm = T),
            conteo = n()) %>% 
  mutate(var_interg = 'Perspectiva de\nmovilidad social',
         var_relativa = 'Movilidad social\nrelativa',
         var_estatus = 'Estatus social\nactual') %>% 
  pivot_longer(cols = starts_with('var_'))  %>%
  mutate(m_mov_social = case_when(
    value == 'Perspectiva de\nmovilidad social' ~ m_interg,
    value == 'Movilidad social\nrelativa' ~ m_relativa,
    value == 'Estatus social\nactual' ~ m_estatus)) 

datos.11.6e$m_mov_social <- round(datos.11.6e$m_mov_social, digits = 2) 

g11.6e <- datos.11.6e %>% 
  ggplot(aes(y = m_mov_social, x = ola, group = value, color = value,
             label = m_mov_social)) +
  theme_bw() +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(limits = c(0,6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .11, end = .55, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,  size= 3.5)
g11.6e
```

<!-- ### 11.6  Estatus subjetivo y tipo de movilidad social, nivel promedio según ola.  -->
```{r mov-soc, fig.align='center',fig.cap='Estatus subjetivo y tipo de movilidad social, nivel promedio según ola'}

datos11.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_02 %in% c(-888,-999) & !d01_03 %in% c(-888, -999)) %>%
  sjlabelled::as_label(ola) %>% 
  mutate(mov_interg = d01_03 - d01_01,
         mov_relativa = d01_01 - d01_02) %>% 
  group_by(ola) %>% 
  summarise(m_interg = weighted.mean(mov_interg, ponderador02 ,na.rm = T),
            m_relativa = weighted.mean(mov_relativa, ponderador02 ,na.rm = T),
            m_estatus = weighted.mean(d01_01, ponderador02 ,na.rm = T),
            conteo = n()) %>% 
  mutate(var_interg = 'Perspectiva de\nmovilidad social',
         var_relativa = 'Movilidad social\nrelativa',
         var_estatus = 'Estatus social\nactual') %>% 
  pivot_longer(cols = starts_with('var_'))  %>%
  mutate(m_mov_social = case_when(
    value == 'Perspectiva de\nmovilidad social' ~ m_interg,
    value == 'Movilidad social\nrelativa' ~ m_relativa,
    value == 'Estatus social\nactual' ~ m_estatus))

datos11.6$m_mov_social <- round(datos11.6$m_mov_social, digits = 2) 

g11.6 <- 
  ggplot(datos11.6, aes(y = m_mov_social, x = ola, group = value, color = value,
                              label = m_mov_social)) +
  theme_bw() +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(limits = c(0,6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .11, end = .55, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,  size= 3.5)
g11.6
```
## Percepción de meritocracia

<!-- ### 11.7  Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".  -->
```{r merit-wave, fig.align='center',fig.cap='Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".'}

datos.11.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(c18_09, c18_10, d05_02, d05_04, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(c18_09, c18_10, d05_02, d05_04)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value %in% c(4,5), by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c18_09', 'c18_10', 'd05_02', 'd05_04'),
                       labels = c('Personas son\nrecompensadas\npor su esfuerzo',
                               'Personas son\nrecompensadas\npor su inteligencia',
                               'Educación es\nimportante para\nsurgir en la vida',
                               'Trabajo duro\nes importante para\nsurgir en la vida')))

g11.7 <- datos.11.7 %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.7
```

