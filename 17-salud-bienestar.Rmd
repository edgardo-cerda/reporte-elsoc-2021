---
editor_options: 
  markdown: 
    wrap: 72
---

# Salud mental y bienestar

```{r recode-var}
elsoc_panel_m1$depr_rec <- car::recode(elsoc_panel_m1$suma_dep,
                               "c(0,1,2,3,4)='1';
c(5,6,7,8,9)='2';
c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='3'")

elsoc_panel_m1$m43_rec <- car::recode(elsoc_panel_m1$m43,
                               "c(1,2)='Nada o Poco Sobrecargado';
c(3)='Algo Sobrecargado';
c(4,5)='Bastante o Muy Sobrecargado'")

elsoc_panel_m1$s03_rec <- car::recode(elsoc_panel_m1$s03,
                               "c(1,2)='Mala o Regular';
c(3)='Buena';
c(4,5)='Muy buena o Excelente'")

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel_m1)

elsoc_panel$depr_rec <- car::recode(elsoc_panel$suma_dep,
                               "c(0,1,2,3,4)='1';
c(5,6,7,8,9)='2';
c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='3'")

elsoc_panel$m43_rec <- car::recode(elsoc_panel$m43,
                               "c(1,2)='Nada o Poco Sobrecargado';
c(3)='Algo Sobrecargado';
c(4,5)='Bastante o Muy Sobrecargado'")

elsoc_diseno_2 <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel)
```

```{r depre-wave, echo=FALSE, fig.align='center', fig.cap= 'Síntomas de Depresión, según Ola del Estudio'}
datos.grafico <- data.frame((svytable(~depr + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g17.1

```

```{r N5, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```

```{r depre-deuda-wave, echo=FALSE, fig.align='center', fig.cap="Síntomas de Depresión, según Ola del Estudio y Sobrecarga de Deuda"}
datos.grafico <- data.frame((svytable(~depr + ola + m43_rec, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m43_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  filter((ola==2016 | ola==2018 | ola==2021)) 
datos.grafico$porcentaje[is.na(datos.grafico$porcentaje)] <- 0

g17.2 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 9)) + 
  facet_grid(~factor(m43_rec, levels=c('Nada o Poco Sobrecargado','Algo Sobrecargado','Bastante o Muy Sobrecargado'))) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.2

```

```{r deuda-phq, fig.align='center',fig.cap="Deuda según ola y Sintomas Depresivos"}
#este grafico no logra nada... eliminarlo
datos.01 <- data.frame((svytable(~deuda_01 + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_01=Freq/sum(Freq))
datos.01$phq <- NULL
datos.01$ola <- NULL
datos.02 <- data.frame((svytable(~deuda_02 + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_02=Freq/sum(Freq))
datos.02$phq <- NULL
datos.02$ola <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_03=Freq/sum(Freq))
datos.03$phq <- NULL
datos.03$ola <- NULL
datos.04 <- data.frame((svytable(~deuda_04  + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g17.3 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  facet_wrap(.~phq)+
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.3
```

## Brecha de género en Salud Mental

```{r depre-year-sexo, echo=FALSE, fig.align='center', fig.cap= 'Sintomatología Depresiva por año, según sexo. Porcentaje con síntomas de “Depresion Moderada” o “Depresion Moderada Severa a Severa”.'}

datos.grafico <- data.frame((svytable(~depr_rec + ola + m0_sexo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$depr_rec == '3'))

g17.4 <- ggplot(datos.subset, 
               aes(y = porcentaje, x = ola, 
                   color = m0_sexo, group = m0_sexo,
              label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .55, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.4
 
```
```{r N6, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


```{r depre-sexo, echo=FALSE, fig.align='center', fig.cap= 'Cambios en Síntomas de depresión entre años 2018 y 2021, según sexo'}

#1
elsoc_panel$depr <- na.replace(elsoc_panel$depr, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel)

datos.grafico <- data.frame((svytable(~depr + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola,m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~depr + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años 2017 y 2019
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, 
                     etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g17.5 <- ggplot(subset.grafico, aes(x = ola, fill = depr, stratum = depr, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.1 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep('white'))

g17.5

```

```{r N7, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


```{r depre-edad-sexo, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según tramos de edad y sexo (2021). Porcentaje con síntomas de “Depresion Moderada” o “Depresion Moderada Severa a Severa'}
datos.grafico <- data.frame((svytable(~depr_rec + ola + m0_sexo + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021' & datos.grafico$depr_rec == '3'))

g17.6 <- ggplot(datos.subset, 
               aes(y = porcentaje, x = edadt, 
                   color = m0_sexo, group = m0_sexo,
                   label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .55, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.6

```

```{r N8, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
``` 

## Sintomatología depresiva, sexo y ocupación

```{r depre-labstat, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según sexo y situación ocupacional (2021). Porcentaje con síntomas PHQ-9>10'}
datos.grafico <- data.frame((svytable(~depr_rec + ola + m0_sexo + empleo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo, empleo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021' & datos.grafico$depr_rec == '3'))

g17.7 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = empleo, fill = m0_sexo, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .65, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.7
```

En 2021 no hay hombres en la categoría Trabajo doméstico no remunerado $^{*}$

```{r N9, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```

## COVID - 19
```{r covid-sexo, fig.align='center', fig.cap= 'Diagnosticado con COVID-19 según sexo'}
datos.grafico <- data.frame((svytable(~s31 + m0_sexo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, s31=='1'))

g17.8 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = s31, fill = m0_sexo, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.2)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.8
```

```{r depre-s03, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según Estado de Salud y ola de estudio. Porcentaje con síntomas PHQ-9>10'}
datos.grafico <- data.frame((svytable(~s03_rec + ola + depr_rec, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, depr_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico,datos.grafico$depr_rec == '3'))

g17.9 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = s03_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .65, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.9
```

## Salud Mental en COVID-19


```{r depre-teletrabajo, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión, según Modalidad de Trabajo'}
datos.grafico <- data.frame((svytable(~depr + ola + m60, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m60) %>% 
  na.omit(m60) %>%
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

g17.10 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = m60, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.10
```


```{r depre-beneficios, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión (2021), según sexo y acceso a beneficios'}
datos.grafico <- data.frame((svytable(~depr + ola + m0_sexo + m63_01, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m63_01, m0_sexo) %>% 
  na.omit(m63_01) %>%
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

g17.11 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = m63_01, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  #Agrego facer_wrap para hacer un Gráfico para cada sexo
  facet_wrap(datos.subset$m0_sexo) +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.11
```

```{r depre clase.sub, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión, según Clase Subjetiva'}
datos.grafico <- data.frame((svytable(~depr_rec + clase.sub, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(clase.sub) %>% 
  mutate(porcentaje=Freq/sum(Freq)) 

g17.12 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = clase.sub, fill = depr_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 3)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.12

```

