---
editor_options: 
  markdown: 
    wrap: 72
---

# Pandemia Covid-19

## Cuarentenas 
```{r hist-fecha-2021, fig.align='center', fig.cap="Histograma Fechas de Entrevistas"}
elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  filter(ola == 5) %>% 
  ggplot(mapping = aes(x = fecha)) +
  theme_bw() + 
  geom_histogram(bins = 30) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%d %b %Y")

```

```{r dias_cuarentena-heter, fig.align='center', fig.cap="Heterogeneidad de Cuarentena Acumulada en el Panel"}
elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  filter(!is.na(dias_cuarentena)) %>% 
  ggplot(aes(x = dias_cuarentena)) + 
  geom_histogram(bins = 30) + 
  geom_density() +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

```

```{r dias_cuarentena-zona, fig.align='center', fig.cap='Días de Cuarentena Acumulada al momento de la entrevista, según Zona'}

elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  mutate(zona1 = factor(car::recode(region_cod, "c(1,2,3,4,15) = 'Norte'; c(5,6,7,8,16) = 'Centro'; c(9,10,11,12,14) = 'Sur'; 13 = 'Metropolitana'", 
                                    levels = c("Norte","Centro","Sur","Metropolitana"))))  %>% 
  dplyr::filter(ola == 5) %>%
  prop(dias_cuarentena_t, by = c(zona1), na.rm = TRUE) %>% 
  add_row(zona1 = 'Sur', dias_cuarentena_t = '0 días', prop = 0) %>% 
  ggplot(aes(y = prop, x = zona1, fill = dias_cuarentena_t, 
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

```

```{r dias_cuarentena-edad, fig.align='center', fig.cap='Días de Cuarentena Acumulada al momento de la entrevista, según Tramo Etario'}

elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  dplyr::filter(ola == 5 & !is.na(dias_cuarentena_t)) %>% 
  prop(dias_cuarentena_t, by = edadt, na.rm = TRUE) %>%
  ggplot(aes(y = prop, x = edadt, fill = dias_cuarentena_t, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'black', 'white', 'white'), 4)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

```{r dias_cuarentena-aislamiento, fig.align='center', fig.cap='Cumplimiento de Aislamiento Social, según Días de Cuarentena Acumulada al momento de la entrevista'}

elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  dplyr::filter(!is.na(dias_cuarentena_t) & !c48 %in% c(-888, -999)) %>% 
  prop(c48 %in% 4:5, by = dias_cuarentena_t, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = dias_cuarentena_t, fill = dias_cuarentena_t, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col() +
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())

```

```{r dias_cuarentena-depr, fig.align='center', fig.cap= 'Sintomatología Depresiva, según Días de Cuarentena Acumulada al momento de la entrevista'}

elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  dplyr::filter(tipo_atricion == 1 & ola == 5) %>% 
    purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; 4:5 = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o Minima', 'Depresion Media', 'Depresion Moderada', 'Depresion Moderada-Severa\na Severa'))) %>%  
  prop(depr, by = c(ola, dias_cuarentena_t), na.rm = TRUE) %>%  
  ggplot(aes(y = prop, x = dias_cuarentena_t, fill = depr,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'black', 'white', 'white'), 4)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```


```{r dias_cuarentena-ahorro, fig.align='center', fig.cap= 'Nivel de Ahorro "Nada o Poco", según Días de Cuarentena Acumulada al momento de la entrevista (2021)'}

datos.g19.8 <- elsoc_long_2016_2021 %>% 
  mutate(fecha = as_date(make_date(year = annio_entr, month = mes_entr, day = dia_entr))) %>% 
  left_join(cuarentenas_acum , by = c('comuna_cod', 'fecha')) %>% 
  mutate(m44_rec = factor(car::recode(m44, "c(1,2)='Nada o Pocos Ahorros'; c(3)='Algo de Ahorros';c(4,5)='Bastante o Muchos Ahorros'"), levels = c("Nada o Pocos Ahorros", "Algo de Ahorros", "Bastante o Muchos Ahorros"))) %>%
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !is.na(dias_cuarentena_t) & !m44_rec %in% c(-888, -999, NA)) %>% 
  prop(m44_rec=='Nada o Pocos Ahorros', by = c(dias_cuarentena_t), na.rm = TRUE) %>% 
  sjlabelled::as_label(m44_rec, dias_cuarentena_t) 


g19.8 <- datos.g19.8 %>% 
  ggplot(aes(y = prop, x = dias_cuarentena_t, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color="white") + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.8
```


## Estrés Financiero

```{r satisfaccion-wave, echo=FALSE, fig.align='center', fig.cap= 'Satisfacción con el Ingreso por Ola'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1 & !m43 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

```

```{r satisfaccion-retiro, echo=FALSE, fig.align='center', fig.cap= 'Satisfacción con el Ingreso según Retiro AFP'}
datos.g19.11 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m16 %in% c(-888, -999, NA) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m16, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(m16, m63_02) 


g19.11 <- datos.g19.11 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m16, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.11
```

```{r clase.sub-benef.estatal, echo=FALSE, fig.align='center', fig.cap='Satisfacción con el Ingreso según Acceso a Beneficios'}

datos.g19.12 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub = factor(car::recode(d01_01, "c(0,1,2,3)='Baja y media baja'; c(4, 5)='Media'; c(6,7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub, by = c(m63_01), na.rm = TRUE) %>% 
  sjlabelled::as_label(clase.sub, m63_01) 

g19.12 <- datos.g19.12 %>% 
  ggplot(aes(y = prop, x = m63_01, fill = clase.sub, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.12
```

```{r clase.sub.hij-1erretiro, echo=FALSE, fig.align='center', fig.cap='Clase Social Subjetiva de Hijo según Primer Retiro AFP'}
datos.g19.13 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub.hijos = factor(car::recode(d01_03, "c(0,1,2,3)='Baja y media baja'; c(4, 5,6)='Media'; c(7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub.hijos %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub.hijos, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(clase.sub.hijos, m63_02) 

g19.13 <- datos.g19.13 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = clase.sub.hijos, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.13
```

```{r endeud-1retiro, echo=FALSE, fig.align='center', fig.cap='Sobrecarga de Deuda según Primer Retiro AFP'}
datos.g19.14 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, m63_02) 

g19.14 <- datos.g19.14  %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.14
```

```{r endeud-2retiro, echo=FALSE, fig.align='center', fig.cap='Sobrecarga de Deuda según Primer Retiro AFP'}
datos.g19.15 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_03 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_03), na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, m63_03) 

g19.15 <- datos.g19.15  %>% 
  ggplot(aes(y = prop, x = m63_03, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.15
```

```{r deuda-retiro1, fig.align='center',fig.cap="Primer retiro de AFP, según deuda"}
elsoc_long_2016_2021 %>% 
  left_join(elsoc_wide_2016_2021 %>% 
              filter(!m63_02_w05 %in% c(-888, -999) & !m63_03_w05 %in% c(-888, -999)) %>%
              mutate(retiros = factor(case_when(m63_02_w05 == 1 & m63_03_w05 == 1 ~ 1,
                                                m63_02_w05 == 1 ~ 2,
                                                TRUE ~ 3),
                                      levels = c(3, 2, 1),
                                      labels = c('Ningún retiro', 
                                                 'Primer retiro', 
                                                 'Primer y segundo\n retiro'))) %>%
              select(idencuesta, retiros), by = 'idencuesta') %>% 
  filter(tipo_atricion == 1 & ola %in% c(3, 5) & !is.na(retiros) &
           !m42_01 %in% c(-888, -999) & !m42_02 %in% c(-888, -999) & 
           !m42_03 %in% c(-888, -999) & !m42_04 %in% c(-888, -999)) %>% 
  pivot_longer(cols = c(m42_01, m42_02, m42_03, m42_04)) %>% 
  prop(value, by = c(ola, retiros, name), na.rm = TRUE) %>% 
  as_label(value, ola) %>% 
  filter(value == 1) %>% 
  mutate(name = factor(name, 
                       levels = c('m42_01', 'm42_02', 'm42_03', 'm42_04'),
                       labels = c('Casa\ncomercial', 'Banco', 
                                  'Parientes', 'Otros'))) %>% 
  ggplot(aes(y = prop, x = name, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~retiros) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

```



