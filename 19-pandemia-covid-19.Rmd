---
editor_options: 
  markdown: 
    wrap: 72
---

# Pandemia Covid-19

## Cuarentenas 
```{r hist-fecha-2021}
elsoc_diseno_3 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_covid_panel)

datos.grafico <- data.frame((svytable(~fecha_entr + comuna_cod + ola, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(comuna_cod, ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021 & Freq>0)

datos.grafico$fecha_entr<-as.Date(datos.grafico$fecha_entr)

gr.19.1 <- datos.grafico %>% 
  ggplot(mapping = aes(x = fecha_entr)) +
  theme_bw() + 
  geom_histogram(bins = 9,
                 stat="count") +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%d %b %Y")

gr.19.1
```

```{r hist-ccum-dens}
gr.19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density(aes(color=factor(zona1))) +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

gr.19.2
```

```{r}
gr.19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density(aes(color=factor(edadt))) +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

gr.19.2
```

```{r}
gr.19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density(aes(color=factor(c48))) +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

gr.19.2
```

```{r}
elsoc_covid_panel$phq <- factor(car::recode(elsoc_covid_panel$suma_dep, "0:4=0 ; 5:27=1"), 
                                labels = c("Sin Sintomas Depresivos", "Con Sintomas Depresivos"))

gr.19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density(aes(color=factor(phq))) +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

gr.19.2
```

```{r}
datos.grafico <- data.frame((svytable(~cuarentena + edadt + ola, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(edadt + ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021)

gr.17.6 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = cuarentena, fill = edadt, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Encuestados en Cuarentena según Tramo Etario')

gr.17.6
```

## Perdida de Ingresos

```{r satisfaccion-wave, echo=FALSE, fig.align='center'}
datos.grafico <- data.frame((svytable(~m16 + ola, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

gr.17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = m16, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Satisfacción con el Ingreso por Ola')

gr.17.1

```

```{r satisfaccion-retiro, echo=FALSE, fig.align='center'}
datos.grafico <- data.frame((svytable(~m16 + m63_02, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_02) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

gr.17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_02, fill = m16, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Satisfacción con el Ingreso según Retiro AFP')

gr.17.1
```

```{r clase.sub-benef.estatal, echo=FALSE, fig.align='center'}
datos.grafico <- data.frame((svytable(~clase.sub + m63_01, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_01) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

gr.17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_01, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Satisfacción con el Ingreso según Acceso a Beneficios')

gr.17.1
```

```{r clase.sub.hij-1erretiro, echo=FALSE, fig.align='center'}
datos.grafico <- data.frame((svytable(~clase.sub.hijos + m63_02, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_02) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

gr.17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_02, fill = clase.sub.hijos, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Clase Social Subjetiva de Hijo según Primer Retiro AFP')

gr.17.1
```


```{r}
gr.19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density(aes(color=factor(clase.sub))) +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

gr.19.2
```


```{r endeud-1retiro, echo=FALSE, fig.align='center'}
datos.grafico <- data.frame((svytable(~m43 + m63_02, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_02) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

gr.17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_02, fill = m43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Sobrecarga de Deuda según Primer Retiro AFP')

gr.17.1
```

```{r endeud-2retiro, echo=FALSE, fig.align='center'}
datos.grafico <- data.frame((svytable(~m43 + m63_03, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_03) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

gr.17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_03, fill = m43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Sobrecarga de Deuda según Primer Retiro AFP')

gr.17.1
```

