---
editor_options: 
  markdown: 
    wrap: 72
---

# Cambio Constitucional

```{r particip-edad, fig.align='center', fig.cap='Participación en Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c43 + ola + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola==2021)

g11.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = edadt, fill = c43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.1
```

```{r servel-apruebo, fig.align='center', fig.cap='Voto retrospectivo Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c44 + ola, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021) 

apruebo <- tibble(c44="Apruebo", ola="Datos Servel", Freq=0 , porcentaje=0.7828)
rechazo <- tibble(c44="Rechazo", ola="Datos Servel", Freq=0 , porcentaje=0.2172)

datos.subset <- rbind(datos.grafico, apruebo, rechazo)

g11.2 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = c44, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.2
```

```{r servel-cc, fig.align='center', fig.cap= 'Voto Retrospectivo Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c45 + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021) 

cm <- tibble(c45="Convención Mixta", ola="Datos Servel", Freq=0 , porcentaje=0.2101)
cc <- tibble(c45="Convención Constitucional", ola="Datos Servel", Fre1=0 , porcentaje=0.7899)

datos.subset <- rbind(datos.grafico, cm, cc)

g11.3 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = c45, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.3
```

```{r particip-elect-id, fig.align='center', fig.cap= 'Sí Participa en Elecciones según Identificación Política'}
datos.grafico <- data.frame((svytable(~particip_electoral + pos_id + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(pos_id, ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) 

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$particip_electoral == "Si" & 
                                  (datos.grafico$ola == '2016' | 
                                  datos.grafico$ola == '2018' | 
                                  datos.grafico$ola == "2021")  ))

g11.4 <- ggplot(datos.subset, 
               aes(y = porcentaje, x = ola, 
                   color = pos_id, group = pos_id,
              label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0.22, end = .66, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.4
```

```{r id-pol-voto, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
#como voto cada id_pol en el plebicito
datos.grafico <- data.frame((svytable(~c44_rec + pos_id, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(pos_id) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g11.5 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = c44_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.5
```

## Patrones de Votación

```{r presi-voto-c44, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.grafico <- data.frame((svytable(~c44_rec + c39_rec, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c39_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g11.6 <- datos.grafico %>% 
  ggplot(aes(x = porcentaje, y = c39_rec, fill = c44_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 9)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.6
```

```{r presi-voto-c45, fig.align='center', fig.cap="Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.grafico <- data.frame((svytable(~c45_rec + c39_rec, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c39_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g11.7 <- datos.grafico %>% 
  ggplot(aes(x = porcentaje, y = c39_rec, fill = c45_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 9)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.7
```

```{r 2020-vs-2021, fig.align='center', fig.cap= "Participación Electoral 2021, según la Participación en 2017"}
datos.grafico <- data.frame((svytable(~c43 + c11, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c11) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g11.7 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = c11, fill = c43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = "Participación Electoral en 2017") +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g11.7
```

```{r cambio_participa}
#grafico y caracterización pendiente
sjmisc::frq(elsoc_wide_m1$cambio_participa_w05)
```

