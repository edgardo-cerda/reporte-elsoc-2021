---
editor_options: 
  markdown: 
    wrap: 72
---

# Cambio Constitucional

```{r particip-edad, fig.align='center', fig.cap='Participación en Plebiscito Nueva Constitucion'}
datos.g11.1 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c43 %in% c(3, -888, -999)) %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  prop(c43, by = edadt, na.rm = TRUE) %>% 
  sjlabelled::as_label(c43, edadt)
  
g11.1 <- datos.g11.1 %>% 
  ggplot(aes(y = prop, x = edadt, fill = c43, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.1
```

```{r servel-apruebo, fig.align='center', fig.cap='Voto retrospectivo Plebiscito Nueva Constitucion'}

datos.g11.2 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c44 %in% c(3, 4, -888, -999)) %>% 
  prop(c44, na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(c44) %>% 
  mutate(datos = 'Datos ELSOC') %>%
  add_row(c44 = c('Apruebo', 'Rechazo'), prop = c(.7828, .2172), datos = c('Datos servel', 'Datos servel'))

g11.2 <- datos.g11.2 %>% 
  ggplot(aes(y = prop, x = datos, fill = c44, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.2
```

```{r servel-cc, fig.align='center', fig.cap= 'Voto Retrospectivo Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c45 + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021)

cm <- tibble(c45="Convención Mixta", ola="Datos Servel", Freq=0 , porcentaje=0.2101)
cc <- tibble(c45="Convención Constitucional", ola="Datos Servel", Fre1=0 , porcentaje=0.7899)

datos.subset <- rbind(datos.grafico, cm, cc)

g11.3 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = c45, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.3
```

```{r particip-elect-id, fig.align='center', fig.cap= 'Sí Participa en Elecciones según Identificación Política'}

datos.g11.4 <- elsoc_long_2016_2021 %>% 
  mutate(c11 = car::recode(c11, '1=2;2=1'), # en c11 1 = no participa, a diferencia de c43
         particip_electoral = ifelse(ola == 5, c43, c11),
         pos_id = factor(car::recode(c15, "c(11,12) = 'No se identifica'; c(0,1,2,3,4) = 'Izquierda'; c(5) = 'Centro'; c(6,7,8,9,10) = 'Derecha'"), levels = c('Izquierda', 'Centro', 'Derecha', 'No se identifica'))) %>%
  filter(tipo_atricion == 1 & !particip_electoral %in% c(3, -888, -999) & 
           ola %in% c(1,3,5) & !is.na(pos_id)) %>% 
  prop(particip_electoral == 1, by = c(ola, pos_id), na.rm = TRUE) %>%
  sjlabelled::as_label(pos_id) %>% 
  mutate(ola = factor(ola, levels = c(1,3,5), labels = c('Elecciones Presidenciales\nde 2013', 'Elecciones Presidenciales\nde 2017', 'Plebiscito cambio\nconstitucional')))


g11.4 <- datos.g11.4 %>% 
  ggplot(aes(y = prop, x = ola, color = pos_id, group = pos_id,
              label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0.22, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.4
```

```{r id-pol-voto, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
#como voto cada id_pol en el plebicito
datos.grafico <- data.frame((svytable(~c44_rec + pos_id, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(pos_id) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g11.5 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = c44_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.5
```

## Patrones de Votación

```{r presi-voto-c44, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.grafico <- data.frame((svytable(~c44_rec + c39_rec, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c39_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g11.6 <- datos.grafico %>% 
  ggplot(aes(x = porcentaje, y = c39_rec, fill = c44_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 9)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.6
```

```{r presi-voto-c45, fig.align='center', fig.cap="Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.grafico <- data.frame((svytable(~c45_rec + c39_rec, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c39_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g11.7 <- datos.grafico %>% 
  ggplot(aes(x = porcentaje, y = c39_rec, fill = c45_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 9)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.7
```

```{r 2020-vs-2021, fig.align='center', fig.cap= "Participación Electoral 2021, según la Participación en 2017"}

datos.11.7 <- elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1 & !c43_w05 %in% c(3, -888, -999) & 
           !c11_w03 %in% c(3, -888, -999)) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(c43_w05, by = c11_w03) %>% 
  sjlabelled::as_label(c43_w05, c11_w03)

datos.11.7 %>% 
  ggplot(aes(y = prop, x = c11_w03, fill = c43_w05, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = "Participación Electoral en 2017") +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('black', 'white'), 2)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
```

```{r cambio_participa}
#grafico y caracterización pendiente
sjmisc::frq(elsoc_wide_m1$cambio_participa_w05)
```

