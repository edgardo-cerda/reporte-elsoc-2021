---
editor_options: 
  markdown: 
    wrap: 72
---

# Cambio Constitucional

```{r}
elsoc_panel_m1$c43 <- factor(elsoc_panel_m1$c43,labels = c('No', 'Sí', 'No tenía edad para hacerlo'))
elsoc_panel_m1$c44 <- factor(elsoc_panel_m1$c44,labels = c('Apruebo', 'Rechazo', 'Nulo', 'Blanco'))
elsoc_panel_m1$c45 <- factor(elsoc_panel_m1$c45,labels = c('Convención Mixta', 'Convención Constitucional', 'Nulo', 'Blanco'))

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```


```{r}
datos.grafico <- data.frame((svytable(~c44 + ola + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

gr.11.1 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = edadt, fill = c44, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Voto retrospectivo Plebiscito Nueva Constitucion')

gr.11.1
```

```{r}
datos.grafico <- data.frame((svytable(~c45 + ola + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

gr.11.2 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = edadt, fill = c45, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Voto retrospectivo Plebiscito Nueva Constitucion')

gr.11.2
```


```{r}
datos.grafico <- data.frame((svytable(~c43 + ola + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

gr.11.3 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = edadt, fill = c43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Participacion electoral retrospectiva Plebiscito Nueva Constitucion')

gr.11.3
```


