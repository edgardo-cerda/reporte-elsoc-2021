
# Temas políticos

¿Cómo ha cambiado la sociedad en temas políticos?

## Identificación política

### ¿Cómo se posicionan políticamente los chilenos?

```{r graf-idpolitica, fig.cap='Identificación política (2021)'}
elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola == 5) %>%
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:5,
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  prop(x = pos_id, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, fill = pos_id, x = pos_id, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position= 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(direction = 1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge2(width = .9),
            size = 3) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
```



Entre 2016 y 2021 la identificación con la izquierda se ha mantenido estable (25,3% en 2021), mientras que 
el centro y la derecha han aumentado su participación (de 24,8% en 2016 a 36,1% en 2021, y de 14,1% a 17,5%, respectivament), en desmedro de la no identifiación política, que disminuyó de 35,8% a 19,3%.


```{r graf-idpolitica-ola, fig.cap='Identificación política, según ola del estudio'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1) %>%
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  prop(x = pos_id, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, fill = fct_rev(pos_id), x = ola, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position= 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c(rep('white', 3), rep('black', 2)), 5)) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) 

```


Aunque los porcentajes son relativamente estables, esconden una alta fluidez en la identificación con las diferentes posiciones políticas por año.


```{r graf-alluvial-idpolitica-ola, fig.cap = 'Cambios en la identificación política, según ola del estudio'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% 1:5) %>% 
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  as_label(ola) %>% 
  survey_design_elsoc() %>%
  svytable(~pos_id + ola + idencuesta, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola) %>% 
  mutate(prop = Freq/sum(Freq)) %>%
  filter(Freq > 0) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(pos_id), 
             stratum = fct_rev(pos_id), alluvium = idencuesta)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1) +
  geom_text(data = function(x) { group_by(.data = x, ola, pos_id) %>% 
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>% 
      ungroup()}, 
            aes(label = scales::percent(prop, accuracy = .1)),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 3,
            color = rep(c('white', 'white', 'white', 'black', 'black'), 5)) + 
  guides(fill = guide_legend(reverse = TRUE)) 


```

De manera consistente aproximadamente 48% de la población cambia su posición política cada año

```{r graf-cambios-idpolitica-ola, fig.cap = 'Cambios en identificación política, según ola'}
elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c15)) %>%
  mutate(c15 = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica"))) %>% 
  group_by(idencuesta) %>% 
  mutate(cambia = c15 != lag(c15),
         ola = factor(ola,
                      levels = 1:5,
                      labels = c('', '2016-2017', '2017-2018', '2018-2019', '2019-2021'))) %>% 
  ungroup() %>% 
  prop(cambia == TRUE, by = ola, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, label = scales::percent(prop, .1))) + 
  theme_bw() +
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) + 
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, option = 'viridis') +
  theme(legend.position = 'top') +
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que cambia su posición política en cada ola' )

```

El grupo político más estable (comparando posiciones politicas entre 2016 y 2021) es el de centro: 54,0% de quienes se posicionaban políticamente de Centro, lo hicieron también en 2021. En contraste, la No identificación política es la menos estable: solo 31,3% de quienes no se identificaban políticamente en 2016, lo hicieron también en 2021. Para la izquierda y la derecha, estos porcentajes son 47,8% y 47,6%, respectivamente. 


```{r graf-cambios-idpol-idpol, fig.cap = 'Cambios en identificación política entre 2016 y 2021'}

elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1) %>% 
  mutate(pos_id_w01 = factor(car::recode(c15_w01, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica", "NS/NR")),
         pos_id_w05 = factor(car::recode(c15_w05, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica", "NS/NR"))) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(pos_id_w05, by = pos_id_w01) %>% 
  filter(pos_id_w01 != 'NS/NR') %>% 
  ggplot(aes(y = prop, x = pos_id_w01, fill = fct_rev(pos_id_w05),
             label = scales::percent(prop, accuracy = .1))) + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = 'Posición política en 2016') +
  scale_fill_viridis_d(direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c(rep('white', 3), rep('black', 2)), 4)) +
  theme(legend.position = 'right') +
  labs(fill = 'Posición política\nen 2021') + 
  guides(fill = guide_legend(reverse = TRUE))  

  
```

A mayor edad mayor estabilidad en la posición política entre años

```{r graf-cambios-idpolitica-edad, fig.cap = 'Cambios en identificación política, según grupo etáreo'}
elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c15_w01, c15_w04)) %>% 
  mutate(pos_id_w01 = factor(car::recode(c15_w01, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica")),
         pos_id_w05 = factor(car::recode(c15_w05, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica")),
         cambia = pos_id_w01 != pos_id_w05,
         edadt_w05 = factor(car::recode(m0_edad_w05, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(cambia == TRUE, by = edadt_w05, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = edadt_w05, label = scales::percent(prop, .1))) + 
  theme_bw() +
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) + 
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, option = 'viridis') +
  theme(legend.position = 'top') +
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que cambia su posición política entre 2016 y 2021' )

```

### Interés en la política y participación ciudadana

```{r graf-interespolitica-ola, fig.cap = 'Interés en política, según ola del estudio'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c13)) %>% 
  prop(c13 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, group = 1,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75, color = viridis(1, .66)) + 
  geom_line(color = viridis(1, .66)) +
  geom_text_repel(nudge_y = .04, size = 3, color = 'black') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_color_viridis_d(end = .75, option = 'viridis') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(label = NULL,
          'Porcentaje Bastante o Muy interesado en la política')
  
```


```{r graf-participciudadana-ola, fig.cap = 'Participación ciudadana, según ola del estudio'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c08_02, c08_04, c14_01, c14_02)) %>%
  as_label(ola) %>% 
  prop_list(c08_02 %in% 4:5, c08_04 %in% 4:5, c14_01 %in% 4:5, c14_02 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c08_02 %in% 4:5', 'c08_04 %in% 4:5', 'c14_01 %in% 4:5', 'c14_02 %in% 4:5'),
                       labels = c('Asiste a marcha o\nmanifestación pacífica',
                                  'Usa RRSS para opinar\nde temas públicos',
                                  'Habla de política\ncon familiares',
                                  'Se informa\nsobre política'))) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  geom_text_repel(nudge_y = .025, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .7, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(color = guide_legend(reverse = TRUE)) +
  ggtitle(label = NULL,
          subtitle = 'Portaje que responde Frecuente o Muy frecuentemente')

```


```{r graf-idpolitica-interespolitica, fig.cap = 'Identificación política, según grado de interes en la política (2021)'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola == 5 & !c13 %in% c(-888, -999)) %>%
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:5,
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR")),
         interes = factor(car::recode(c13, "1 = 1; 2:3 = 2; 4:5 = 3"),
                          levels = 1:3,
                          labels = c('Nada interesado/a', 'Poco o algo\ninteresado/a', 'Bastante o muy\ninteresado/a'))) %>%
  prop(x = pos_id, by = interes, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, fill = fct_rev(pos_id), x = interes, 
             label = scales::percent(ifelse(prop < .005, NA, prop), accuracy = .1))) +
  theme_bw() + 
  geom_col(position= 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c('white', 'white', 'white', 'black', 'black'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) + 
  ggtitle(label = NULL)

```

### Opinión en temas de discusión pública

```{r graf-temaspublicos-idpolitica, fig.cap = 'Acuerdo con temas de discusión pública, según posición política (2019-2021)'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% 4:5 & !is_nsnr(c15, c37_02, c37_04, c37_05)) %>% 
  as_label(ola) %>% 
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica"))) %>% 
  prop_list(c37_02 %in% 4:5, c37_04 %in% 4:5, c37_05 %in% 4:5, 
            by = c(ola, pos_id), na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c37_02 %in% 4:5', 'c37_04 %in% 4:5', 'c37_05 %in% 4:5'),
                       labels = c('Aborto debe ser legal\nbajo cualquier circunstancia',
                                  'Cada persona debiera\nasegurar su propia pensión', 
                                  'Se deberían tomar medidas más\ndrásticas para evitar inmigración'))) %>% 
  ggplot(aes(x = pos_id, y = prop, 
             label = scales::percent(prop, .1))) +
  facet_wrap(.~name) +
  geom_line(size = .7, color = viridis(1, begin = .44, end = .44)) +
  geom_point(aes(color = ola), size = 4) + 
  geom_point(color = 'black', size = 4, shape = 1) + 
  geom_text_repel(size= 3, nudge_x = .05, nudge_y = .033) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  scale_color_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde de acuerdo o muy de acuerdo') 

```




## Movimientos Sociales y Acciones Colectivas

### Tipología de participación política

```{r tip-participacion}

# tip_par <- elsoc_wide_2016_2021[c("idencuesta", "c11_w01", "c11_w03", "c43_w05", "c08_01_w01", "c08_02_w01", "c08_03_w01", "c08_04_w01",  "c08_01_w02", "c08_02_w02", "c08_03_w02", "c08_04_w02", "c08_01_w03", "c08_02_w03", "c08_03_w03", "c08_04_w03", "c08_01_w04", "c08_02_w04", "c08_03_w04", "c08_04_w04", "c08_05_w04", "c08_02_w05", "c08_04_w05", "c08_05_w05")]
# 
# #Crear variables donde 2 es si participa frecuentemente o muy frecuentemente.
# tip_par$par_mov_w01<-1
# tip_par$par_mov_w01[tip_par$c08_01_w01>=4 | tip_par$c08_02_w01>=4 | tip_par$c08_03_w01>=4 | tip_par$c08_04_w01>=4]<-2
# tip_par$par_mov_w02<-1
# tip_par$par_mov_w02[tip_par$c08_01_w02>=4 | tip_par$c08_02_w02>=4 | tip_par$c08_03_w02>=4 | tip_par$c08_04_w02>=4]<-2
# tip_par$par_mov_w03<-1
# tip_par$par_mov_w03[tip_par$c08_01_w03>=4 | tip_par$c08_02_w03>=4 | tip_par$c08_03_w03>=4 | tip_par$c08_04_w03>=4]<-2
# tip_par$par_mov_w04<-1
# tip_par$par_mov_w04[tip_par$c08_01_w04>=4 | tip_par$c08_02_w04>=4 | tip_par$c08_03_w04>=4 | tip_par$c08_04_w04>=4 | tip_par$c08_05_w04>=4]<-2
# tip_par$par_mov_w05<-1
# tip_par$par_mov_w05[tip_par$c08_02_w05>=4 | tip_par$c08_04_w05>=4 | tip_par$c08_05_w05>=4]<-2
# 
# tip_par$c11_w01[tip_par$c11_w01<=0 | tip_par$c11_w01==3]<-NA
# tip_par$c11_w03[tip_par$c11_w03<=0 | tip_par$c11_w03==3]<-NA
# tip_par$c43_w05[tip_par$c43_w05<=0 | tip_par$c43_w05==3]<-NA
# 
# tip_par <- tip_par %>%
#   drop_na(c("c11_w01", "c11_w03", "c43_w05", "c08_01_w01", "c08_02_w01", "c08_03_w01", "c08_04_w01",  "c08_01_w02", "c08_02_w02", "c08_03_w02", "c08_04_w02", "c08_01_w03", "c08_02_w03", "c08_03_w03", "c08_04_w03", "c08_01_w04", "c08_02_w04", "c08_03_w04", "c08_04_w04", "c08_05_w04", "c08_02_w05", "c08_04_w05", "c08_05_w05"))
# 
# var <- cbind(c11_w01, c11_w03, c43_w05, par_mov_w01, par_mov_w02, par_mov_w03, par_mov_w04, par_mov_w05)~1
# 
# library(poLCA)
# tipos_part3 <- poLCA(var, tip_par, nclass=3, na.rm = T, maxiter = 5000)
# tip_par$class_part_3<- as.factor(tipos_part3$predclass)
# 
# tipos_part4 <- poLCA(var, tip_par, nclass=4, na.rm = T, maxiter = 5000)
# tip_par$class_part_4<- as.factor(tipos_part4$predclass)
# 
# tipos_part5 <- poLCA(var, tip_par, nclass=5, na.rm = T, maxiter = 5000)
# tip_par$class_part_5<- as.factor(tipos_part5$predclass)
# 
# #Guardar base especial.
# write.csv(tip_par, file="participacion_tipos.csv", row.names = F, fileEncoding = "UTF-8")
tip_par<-read.csv("participacion_tipos.csv", sep=",", encoding="UTF-8")

#Gráfico 3 clases.
tabpart_3<-table(tip_par$class_part_3)
tabpart_3
prop.table(tabpart_3)
tab1 <- tip_par %>% group_by(class_part_3, c11_w01) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 1) %>% rename(Clase=class_part_3, Participa=c11_w01)
tab2 <- tip_par %>% group_by(class_part_3, c11_w03) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 2) %>% rename(Clase=class_part_3, Participa=c11_w03)
tab3 <- tip_par %>% group_by(class_part_3, c43_w05) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 3) %>% rename(Clase=class_part_3, Participa=c43_w05)
tab4 <- tip_par %>% group_by(class_part_3, par_mov_w01) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 4) %>% rename(Clase=class_part_3, Participa=par_mov_w01)
tab5 <- tip_par %>% group_by(class_part_3, par_mov_w02) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 5) %>% rename(Clase=class_part_3, Participa=par_mov_w02)
tab6 <- tip_par %>% group_by(class_part_3, par_mov_w03) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 6) %>% rename(Clase=class_part_3, Participa=par_mov_w03)
tab7 <- tip_par %>% group_by(class_part_3, par_mov_w04) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 7) %>% rename(Clase=class_part_3, Participa=par_mov_w04)
tab8 <- tip_par %>% group_by(class_part_3, par_mov_w05) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 8) %>% rename(Clase=class_part_3, Participa=par_mov_w05)

tab_3<- rbind(tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8)
rm(tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8)

tab_3$Clase  <- factor(tab_3$Clase, levels = c(1,2,3), labels = c("(27.88%)", "(18.2%)", "(53.92%)"))
tab_3$Participa  <- factor(tab_3$Participa, levels = c(1,2), labels = c("No participa", "Participa"))
tab_3$var  <- factor(tab_3$var, levels = c(1,2,3,4,5,6,7,8), labels = c("Elección 2013", "Elección 2017", "Plebiscito", "Protesta W1", "Protesta W2", "Protesta W3", "Protesta W4", "Protesta W5"))

tab_3 %>% ggplot(aes(x = freq, y = var, fill = Participa)) + 
  geom_bar(stat = 'identity', position = 'stack') + facet_grid(~ Clase) +
  labs(y="Evento", x="Proporción",
       title = "Perfiles de participación: 3 clases", fill = "") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), limits=c(0, 1)) +
  theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=14))  + scale_fill_viridis_d(begin = .15, end = .66, direction = -1, option = 'viridis')

#Gráfico 4 clases.
tabpart_4<-table(tip_par$class_part_4)
tabpart_4
prop.table(tabpart_4)
tab1 <- tip_par %>% group_by(class_part_4, c11_w01) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 1) %>% rename(Clase=class_part_4, Participa=c11_w01)
tab2 <- tip_par %>% group_by(class_part_4, c11_w03) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 2) %>% rename(Clase=class_part_4, Participa=c11_w03)
tab3 <- tip_par %>% group_by(class_part_4, c43_w05) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 3) %>% rename(Clase=class_part_4, Participa=c43_w05)
tab4 <- tip_par %>% group_by(class_part_4, par_mov_w01) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 4) %>% rename(Clase=class_part_4, Participa=par_mov_w01)
tab5 <- tip_par %>% group_by(class_part_4, par_mov_w02) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 5) %>% rename(Clase=class_part_4, Participa=par_mov_w02)
tab6 <- tip_par %>% group_by(class_part_4, par_mov_w03) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 6) %>% rename(Clase=class_part_4, Participa=par_mov_w03)
tab7 <- tip_par %>% group_by(class_part_4, par_mov_w04) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 7) %>% rename(Clase=class_part_4, Participa=par_mov_w04)
tab8 <- tip_par %>% group_by(class_part_4, par_mov_w05) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 8) %>% rename(Clase=class_part_4, Participa=par_mov_w05)

tab_4<- rbind(tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8)
rm(tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8)

tab_4$Clase  <- factor(tab_4$Clase, levels = c(1,2,3,4), labels = c("(50.78%)", "(22.22%)", "(17.11%)", "(9.88%)"))
tab_4$Participa  <- factor(tab_4$Participa, levels = c(1,2), labels = c("No participa", "Participa"))
tab_4$var  <- factor(tab_4$var, levels = c(1,2,3,4,5,6,7,8), labels = c("Elección 2013", "Elección 2017", "Plebiscito", "Protesta W1", "Protesta W2", "Protesta W3", "Protesta W4", "Protesta W5"))

tab_4 %>% ggplot(aes(x = freq, y = var, fill = Participa)) + 
  geom_bar(stat = 'identity', position = 'stack') + facet_grid(~ Clase) +
  labs(y="Evento", x="Proporción",
       title = "Perfiles de participación: 4 clases", fill = "") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), limits=c(0, 1)) +
  theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=14))  + scale_fill_viridis_d(begin = .15, end = .66, direction = -1, option = 'viridis')

#Gráfico 5 clases.
tabpart_5<-table(tip_par$class_part_5)
tabpart_5
prop.table(tabpart_5)
tab1 <- tip_par %>% group_by(class_part_5, c11_w01) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 1) %>% rename(Clase=class_part_5, Participa=c11_w01)
tab2 <- tip_par %>% group_by(class_part_5, c11_w03) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 2) %>% rename(Clase=class_part_5, Participa=c11_w03)
tab3 <- tip_par %>% group_by(class_part_5, c43_w05) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 3) %>% rename(Clase=class_part_5, Participa=c43_w05)
tab4 <- tip_par %>% group_by(class_part_5, par_mov_w01) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 4) %>% rename(Clase=class_part_5, Participa=par_mov_w01)
tab5 <- tip_par %>% group_by(class_part_5, par_mov_w02) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 5) %>% rename(Clase=class_part_5, Participa=par_mov_w02)
tab6 <- tip_par %>% group_by(class_part_5, par_mov_w03) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 6) %>% rename(Clase=class_part_5, Participa=par_mov_w03)
tab7 <- tip_par %>% group_by(class_part_5, par_mov_w04) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 7) %>% rename(Clase=class_part_5, Participa=par_mov_w04)
tab8 <- tip_par %>% group_by(class_part_5, par_mov_w05) %>%
  summarise (n = n()) %>% mutate(freq = n / sum(n)) %>% 
  mutate(var = 8) %>% rename(Clase=class_part_5, Participa=par_mov_w05)

tab_5<- rbind(tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8)
rm(tab1, tab2, tab3, tab4, tab5, tab6, tab7, tab8)

tab_5$Clase  <- factor(tab_5$Clase, levels = c(1,2,3,4,5), labels = c("(24.06%)", "(5.11%)", "(47.1%)", "(16.22%)", "(7.5%)"))
tab_5$Participa  <- factor(tab_5$Participa, levels = c(1,2), labels = c("No participa", "Participa"))
tab_5$var  <- factor(tab_5$var, levels = c(1,2,3,4,5,6,7,8), labels = c("Elección 2013", "Elección 2017", "Plebiscito", "Protesta W1", "Protesta W2", "Protesta W3", "Protesta W4", "Protesta W5"))

tab_5 %>% ggplot(aes(x = freq, y = var, fill = Participa)) + 
  geom_bar(stat = 'identity', position = 'stack') + facet_grid(~ Clase) +
  labs(y="Evento", x="Proporción",
       title = "Perfiles de participación: 5 clases", fill = "") +
  scale_x_continuous(breaks = scales::pretty_breaks(n = 5), limits=c(0, 1)) +
  theme_bw() + theme(legend.position = "bottom", plot.title = element_text(size=14)) + scale_fill_viridis_d(begin = .15, end = .66, direction = -1, option = 'viridis')




```

### Ciclo de movilización política y estallido social

```{r graf-movsocial, fig.cap = '¿Cuál de los siguientes movimientos sociales más valora? (2019-2021)'}
elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% c(4,5) & !c20 %in% c(-888, -999)) %>%
  mutate(c20 = factor(c20, levels = 1:12,
                      labels = c('Estudiantil', 'Laboral', 'Ambiental',
                                 'Indigena', 'Diversidad sexual', 'Provida o Antiaborto',
                                 'Antidelincuencia', 'Feminista', 'Pensiones',
                                 'Estallido social\nde Octubre 2019', 'Otro', 'Ninguno'))) %>% 
  prop(x = c20, by = ola, na.rm = TRUE) %>% 
  group_by(c20) %>% 
  mutate(orden = mean(ifelse(ola == 5, prop, NA), na.rm = TRUE)) %>% 
  sjlabelled::as_label(ola) %>%
  ggplot(aes(y = prop, x = reorder(c20, orden), 
             label = scales::percent(prop, .1))) +
  geom_line(size = .7, color = viridis(1, begin = .44, end = .44)) +
  geom_point(aes(color = ola), size = 4) + 
  geom_point(color = 'black', size = 4, shape = 1) + 
  geom_text_repel(size= 3) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  scale_color_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  theme(legend.position = 'right',
        legend.title = element_blank()) + 
  coord_flip() + 
  guides(color = guide_legend(reverse = TRUE)) +
  ggtitle(label = NULL)

```

Clasificacindo los movimientos sociales en las categorías "Progresistas" y "Conservadores", se ve un claro aumento en la valoración de movimientos sociales progresistas. 

Los movimientos sociales que se clasifican como progresistas son:

- Movimiento social de apoyo a la causa estudiantil
- Movimiento social de apoyo a demandas laborales 
- Movimiento social de grupos ambientalistas
- Movimiento social de apoyo a las demandas indígena
- Movimiento social de apoyo a la diversidad sexual
- Movimiento feminista o de apoyo a la igualdad de género
- Movimiento por el cambio al sistema de pensiones
- Estallido social del 18 de Octubre de 2019

Mientras que los Conservadores: 

- Movimiento social provida o antiaborto
- Movimiento social antidelincuencia

```{r graf-movsociales-movsocial-olas, fig.cap = 'Movimiento social que más valora, Según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !c20 %in% c(-888, -999)) %>%
  mutate(movsoc = car::recode(c20, "1:5 = 1; 8:10 = 1; 6:7 = 2; 11:12 = 3"),
       movsoc = factor(movsoc, levels = 1:3,
                       labels = c('Mov. sociales progresistas', 'Mov. sociales conservadores', 'Ninguno'))) %>%
  dplyr::filter(!is.na(movsoc)) %>%
  prop(movsoc, by  = c(ola), na.rm = TRUE)  %>% 
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, color = movsoc, group = movsoc,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_line() + 
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .5, direction = -1, option = 'viridis') +
  geom_text_repel(nudge_y = .025) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
    ggtitle(label = NULL,
          subtitle = 'Movimientos sociales agrupados en 3 categorías')

```


```{r graf-participmovsocial-olas, fig.cap='Participación en movimientos sociales valorados, según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra==1 & !c22 %in% c(-888, -999)) %>%
  prop(c22 %in% 4:5, by  = ola, na.rm = TRUE) %>%
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, group = 1, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_line(color = viridis(1)) +
  geom_point(size = 1.75, color = viridis(1)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .25)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text_repel(color = viridis(1), size = 3, nudge_y = .01) + 
  theme(legend.position = 'none',   
        legend.title = element_blank()) + 
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que participa Frecuentemente o Muy frecuentemente')

```


```{r graf-participmovsociales2-ola, fig.cap='Participación en tipos de movimientos sociales, según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra==1 & !c22 %in% c(-888, -999) & !c20 %in% c(-888, -999)) %>%
  mutate(mov_soc = factor(car::recode(c20, "1:5 = 1; 6:7 = 2; 8:10 = 1; 11:12 = 3"),
                          levels = 1:3,
                          labels = c('Mov. sociales progresistas', 
                                     'Mov. sociales conservadores', 'Ninguno'))) %>%
  prop(c22 %in% 4:5, by  = c(ola, mov_soc), na.rm = TRUE) %>%
  sjlabelled::as_label(ola) %>%
  ggplot(aes(y = prop, x = ola, group = mov_soc, color = mov_soc,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.25)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .7, direction = -1, option = 'viridis') +
  geom_text_repel(color = viridis(1), size = 3) + 
  theme(legend.position = 'top',   
        legend.title = element_blank()) + 
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que participa Frecuentemente o Muy frecuentemente')

```


## Justificación de la Violencia


### Justificación de la violencia para el control social

```{r graf-justviolencia1-ola, fig.cap='Justificación de la violencia a manos de ciudadanos, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% 1:4 &
           !f05_01 %in% c(-888, -999) & !f05_02 %in% c(-888, -999)) %>%  
  select(f05_01, f05_02, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(f05_01, f05_02)) %>% 
  prop(value %in% 4:5, by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('f05_01', 'f05_02'),
                       labels = c('Personas persigan y golpeen a un delincuente\n que acaba de cometer un asalto',
                                  'Personas amarren a un poste y desnuden a un\n delincuente que acaba de cometer un asalto'))) %>% 
sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .02) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde que Muchas veces o Siempre se justifica' )


```


```{r graf-justviolencia2-ola, fig.cap = 'Justificación de la violencia, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
           !f05_03 %in% c(-888, -999) & !f05_04 %in% c(-888, -999) & !f05_07 %in% c(-888, -999)) %>%  
  select(f05_03, f05_04, f05_07, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(f05_03, f05_04, f05_07)) %>% 
  prop(value %in% 4:5, by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('f05_03', 'f05_04', 'f05_07'),
                       labels = c('Carabineros use la fuerza para\n reprimir manifestación pacífica',
                                  'Carabineros desaloje a la fuerza\na estudiantes de liceo en toma',
                                  'Estudiantes tiren piedras a Carabi-\nneros en marcha por la educación'))) %>%
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .7, option = 'viridis') + 
  ggrepel::geom_text_repel(size = 3, nudge_y = .02) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
        subtitle = 'Porcentaje que responde que Muchas veces o Siempre se justifica' )

```


## Confianza interpersonal y en instituciones

### Confianza interpersonal

```{r graf-confianzainterpersonal-ola, fig.cap = 'Confianza interpersonal, según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c02, c04)) %>% 
  as_label(ola) %>% 
  prop_list(c02 == 1, c04 == 2, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c02 == 1', 'c04 == 2'),
                       labels = c('Casi siempre se puede\nconfiar en las personas',
                                  'La mayoría de las personas\ntratan de ser justas'))) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .025, size = 3, color = 'black') +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, option = 'viridis') +
  theme(axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde que...')

```


```{r graf-confianzainterpersonal-educ, fig.cap = 'Confianza interpersonal (2021), según nivel educacional'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1, ola == 5, !is_nsnr(c02, c04, m01)) %>% 
  mutate(educ = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                       levels = 1:4,
                       labels = c("Basica", "Media", "Tecnica", "Universitaria"))) %>% 
  prop_list(c02 == 1, c04 == 2, by = educ, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c02 == 1', 'c04 == 2'),
                       labels = c('Casi siempre se puede\nconfiar en las personas',
                                  'La mayoría de las personas\ntratan de ser justas'))) %>% 
  ggplot(aes(y = prop, fill = educ, x = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') + 
  geom_text(position = position_dodge(.9),
            vjust = -.5,
            size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .85, option = 'viridis') +
  theme(axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde que...')

```

```{r graf-confinstituciones1-ola, fig.cap = 'Grado de confianza en instituciones, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c05_01, c05_07, c05_08)) %>% 
  as_label(ola) %>% 
  prop_list(c05_01 %in% 4:5, c05_07 %in% 4:5, c05_08 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c05_01 %in% 4:5', 'c05_07 %in% 4:5', 'c05_08 %in% 4:5'),
                       labels = c('Presidente/a de la Republica', 'Congreso Nacional', 'Gobierno de Chile'))) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
               label = scales::percent(prop, accuracy = .1))) +
    theme_bw() +  
    geom_line() +
    geom_point(size = 1.75) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,.5)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .1, end = .66, option = 'viridis') +
    geom_text_repel(size = 3, nudge_y = .02, color = 'black') +
    theme(legend.position = 'top',
          legend.title = element_blank())  + 
  ggtitle(NULL,
          subtitle = 'Porcentaje que Confía Bastante o Mucho')

```

```{r graf-confinstituciones2-ola, fig.cap = 'Grado de confianza en instituciones, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c05_02, c05_03, c05_05)) %>% 
  as_label(ola) %>% 
  prop_list(c05_02 %in% 4:5, c05_03 %in% 4:5, c05_05 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c05_02 %in% 4:5', 'c05_03 %in% 4:5', 'c05_05 %in% 4:5'),
                       labels = c('Partidos Políticos', 
                                  'Carabineros de Chile', 
                                  'Poder Judicial'))) %>%
  ggplot(aes(y = prop, x = ola, color = name, group = name,
               label = scales::percent(prop, accuracy = .1))) +
    theme_bw() +  
    geom_line() +
    geom_point(size = 1.75) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,.5)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .1, end = .66, option = 'viridis') +
    geom_text_repel(size = 3, nudge_y = .02, color = 'black') +
    theme(legend.position = 'top',
          legend.title = element_blank()) + 
    ggtitle(NULL,
          subtitle = 'Porcentaje que Confía Bastante o Mucho')


```


```{r graf-cambio-confianzainstituciones-ola, fig.cap = 'Cambio en grado de confianza en instituciones (2016-2021)'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c05_01, c05_02, c05_03, c05_05, c05_07, c05_08),
         ola %in% c(1, 5)) %>% 
  as_label(ola) %>% 
  prop_list(c05_01 %in% 4:5, c05_02 %in% 4:5, c05_03 %in% 4:5, c05_05 %in% 4:5, c05_07 %in% 4:5, c05_08 %in% 4:5, by = ola, na.rm = TRUE) %>%
  mutate(name = factor(name, 
                       levels = c('c05_01 %in% 4:5', 'c05_02 %in% 4:5', 
                                  'c05_03 %in% 4:5', 'c05_05 %in% 4:5',
                                  'c05_07 %in% 4:5', 'c05_08 %in% 4:5'),
                       labels = c('Presidente/a de\nla Republica', 'Partidos Políticos', 
                                  'Carabineros de Chile', 'Poder Judicial',
                                  'Congreso Nacional', 'Gobierno de Chile'))) %>%
  group_by(name) %>% 
  mutate(orden = mean(ifelse(ola == '2021', prop, NA), na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(y = prop, x = reorder(name, orden), 
             label = scales::percent(prop, .1))) +
  geom_line(size = .7, color = viridis(1, begin = .44, end = .44)) +
  geom_point(aes(color = ola), size = 4) + 
  geom_point(color = 'black', size = 4, shape = 1) + 
  geom_text_repel(size= 3, nudge_x = .02) +
  coord_flip() +
  theme_bw() +
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  scale_color_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  theme(legend.position = 'right',
        legend.title = element_blank()) + 
  guides(color = guide_legend(reverse = TRUE)) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que Confía Bastante o Mucho')

```




## Actitudes hacia la democracia

```{r graf-preferenciademocracia-ola, fig.cap = 'Preferencia por y satisfacción con la democracia, según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c01, c25)) %>% 
  as_label(ola) %>% 
  prop_list(c01 %in% 4:5, c25 == 1, by  = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c25 == 1', 'c01 %in% 4:5'),
                       labels = c('Prefiero la democracia sobre\ncualquier otra forma de gobierno', 'Satisfecho o Muy satisfecho\ncon la democracia'))) %>% 
  ggplot(aes(y = prop, x = ola, group = name, color = name,
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) +
  geom_line() + 
  geom_text_repel(size = 3, nudge_y = .025) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',   
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde...')

```

```{r graf-preferenciademocracia-idpolitica, fig.cap = 'Preferencia por y satisfacción con la democracia (2021), según posición ideológica'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola == 5 & !is_nsnr(c01, c25, c15)) %>% 
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>% 
  as_label(ola) %>% 
  prop_list(c01 %in% 4:5, c25 == 1, by  = pos_id, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c25 == 1', 'c01 %in% 4:5'),
                       labels = c('Prefiero la democracia sobre\ncualquier otra forma de gobierno', 'Satisfecho o Muy satisfecho\ncon la democracia'))) %>% 
  ggplot(aes(y = prop, x = pos_id, fill = name,
               label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~name) +
  theme_bw() + 
  geom_col(position = 'dodge2') + 
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'none') +
  ggtitle(NULL,
        subtitle = 'Porcentaje que responde...')

```

```{r graf-preferenciademocracia2-idpolitica, fig.cap = 'Preferencia por la democracia (2021), según posición ideológica'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c25, c15) & ola == 5) %>%
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                     levels = 1:4,
                     labels = c('Izquierda', "Centro", "Derecha", "No se identifica")),
         c25 = factor(c25, 
                      levels = 1:4,
                      labels = c('Democracia es preferible\na cualquier otra forma\nde gobierno', 
                                 'En algunos casos,\n gobierno autoritario puede\n ser preferible',
                                 'Da lo mismo régimen\ndemocrático o autoritario', 
                                 'Ninguna'))) %>%
  prop(x = c25, by = pos_id, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = pos_id, fill = fct_rev(c25), 
             label = scales::percent(ifelse(prop < .01, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle(NULL,
        subtitle = 'Porcentaje que responde...')

```




## Cambio constitucional


```{r graf-participelect-ola, fig.cap = 'Participación electoral, según elección'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5) & !is_nsnr(c15, c11, c43, values = c(3, -888, -999))) %>% 
  mutate(particip_electoral = ifelse(ola == 5, c43, c11)) %>% 
  prop(particip_electoral == 1, by = ola, na.rm = TRUE) %>%
  mutate(ola = factor(ola, 
                      levels = c(1,3,5), 
                      labels = c('Elecciones Presidenciales\nde 2013', 
                                 'Elecciones Presidenciales\nde 2017', 
                                 'Plebiscito cambio\nconstitucional'))) %>% 
  ggplot(aes(y = prop, x = ola, label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que votó en...')

```


```{r graf-servel-apruebo, fig.cap='Voto retrospectivo Plebiscito Nueva Constitucion'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c44 %in% c(3, 4, -888, -999)& !is.na(c44)) %>% 
  prop(c44, na.rm = TRUE) %>% 
  sjlabelled::as_label(c44) %>%
  mutate(datos = 'Datos ELSOC') %>%
  add_row(c44 = c('Apruebo', 'Rechazo'), 
          prop = c(.7828, .2172), 
          datos = c('Datos servel', 'Datos servel')) %>%
  ggplot(aes(y = prop, x = c44, fill = datos, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

```


```{r graf-participelect-olas-edad, fig.cap = 'Participación electoral, según tramo de edad'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5) & !is_nsnr(c15, c11, c43, values = c(3, -888, -999))) %>% 
  mutate(particip_electoral = ifelse(ola == 5, c43, c11),
         edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                        levels = 1:4,
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  prop(particip_electoral == 1, by = c(ola, edadt), na.rm = TRUE) %>%
  mutate(ola = factor(ola, 
                      levels = c(1,3,5), 
                      labels = c('Elecciones Presidenciales\nde 2013', 
                                 'Elecciones Presidenciales\nde 2017', 
                                 'Plebiscito cambio\nconstitucional'))) %>%  
  ggplot(aes(y = prop, x = ola, color = edadt, group = edadt,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +
  geom_point(size = 1.75) +
  geom_line() +
  geom_text_repel(size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que votó en...')

```


```{r graf-votoplebiscito-idpolitica, fig.cap = 'Voto en plebiscito de 2020, según identificación política'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1 & !is_nsnr(c15, c43, c44)) %>% 
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica")),
         voto2020 = case_when(c43 %in% 2:3 ~ 5,
                              TRUE ~ c44),
         voto2020 = factor(car::recode(voto2020, '3:4 = 5'),
                          levels = c(1:2, 5),
                          labels = c('Apruebo', 'Rechazo', 'No votó o votó\nBlanco o Nulo'))) %>% 
  prop(voto2020, by = pos_id, na.rm = TRUE) %>%
  ggplot(aes(y = prop, x = pos_id, fill = fct_rev(voto2020),
             label = scales::percent(ifelse(prop < .02, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .7, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'white', 'white'), 4)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que voto...')

```

```{r graf-voto-votoprevio, fig.cap = 'Voto en plebiscito de 2020, según voto en elecciones previas'}

elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1, !is_nsnr(c11_w01, c11_w03, c43_w05, values = c(3, -888, -999))) %>% 
  mutate(votos = factor(case_when(c11_w01 != 1 & c11_w03 != 1 ~ 1,
                                  c11_w01 == 1 & c11_w03 != 1 ~ 2,
                                  c11_w01 != 1 & c11_w03 == 1 ~ 3,
                                  c11_w01 == 1 & c11_w03 == 1 ~ 4),
                        labels = c('No votó en elecciones\nde 2013 ni de 2017',
                                   'Votó en 2013,\npero no en 2017',
                                   'Votó en 2017,\npero no en 2013',
                                   'Votó en 2013 y 2017')),
         voto2020 = case_when(c43_w05 %in% 2:3 ~ 5,
                              TRUE ~ c44_w05),
         voto2020 = factor(car::recode(voto2020, '3:4 = 5'),
                          levels = c(1:2, 5),
                          labels = c('Apruebo', 'Rechazo', 'No votó o votó\nBlanco o Nulo'))) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(voto2020, by = votos, na.rm = TRUE) %>%
  ggplot(aes(y = prop, x = votos, fill = fct_rev(voto2020),
             label = scales::percent(ifelse(prop < .02, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .7, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'white', 'white'), 4)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```



```{r graf-voto-votopresi, fig.cap= "Voto en plebiscito de 2020, según voto en elección presidencial de 2017"}

elsoc_wide_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1 & !is_nsnr(c11_w03, c39_w03, c43_w05, c44_w05)) %>% 
  mutate(voto2017 = case_when(c11_w03 %in% 2:3 ~ 11,
                               TRUE ~ c39_w03),
         voto2017 = factor(car::recode(voto2017, '9:10 = 9'),
                           levels = c(1:9, 11),
                           labels = c('Goic', 'Kast', 'Piñera', 'Guillier', 'Sánchez', 'Enríquez-\nOminami', 'Artés', 'Navarro', 'Blanco\no Nulo', 'No votó')),
         voto2020 = case_when(c43_w05 %in% 2:3 ~ 5,
                              TRUE ~ c44_w05),
         voto2020 = factor(car::recode(voto2020, '3:4 = 3'),
                          levels = c(1:3, 5),
                          labels = c('Apruebo', 'Rechazo', 'Blanco\no Nulo', 'No votó'))) %>%
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(voto2020, by = voto2017, na.rm = TRUE) %>%
  dplyr::right_join(tidyr::expand(., voto2020, voto2017)) %>% 
  mutate(prop = ifelse(is.na(prop), 0, prop)) %>% 
  group_by(voto2017) %>% 
  mutate(orden = max(ifelse(voto2020 == 'Apruebo', prop, 0))) %>% 
  arrange(voto2017, voto2020) %>% 
  ggplot(aes(y = prop, x = reorder(voto2017, desc(orden)), fill = fct_rev(voto2020), 
             label = scales::percent(ifelse(prop < .02, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = 'Voto en elección presidencial de 2017') +
  scale_fill_viridis_d(end = .7, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'white', 'white', 'white'), 10)) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

## Optimismo constitucional

```{r graf-optimismoconstitucional, fig.cap = 'Optimismo constitucional'}
elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, !is_nsnr(c46_01, c46_02, c46_03, c46_04)) %>% 
  prop_list(c46_01 %in% 4:5, c46_02 %in% 4:5, c46_03 %in% 4:5, c46_04 %in% 4:5, na.rm = TRUE) %>% 
  mutate(name  =factor(name,
                     levels = c('c46_01 %in% 4:5', 'c46_03 %in% 4:5', 'c46_04 %in% 4:5', 'c46_02 %in% 4:5'),
                     labels = c('Reducirá la desigualdad\n en salud y educación',
                                'Reducirá la corrupción',
                                'Tendrá poco impacto en\nla calidad de vida',
                                'Empeorará condiciones\n económicas'))) %>%
  ggplot(aes(x = name, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(fill = viridis::viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  ggtitle(NULL,
        subtitle = 'Porcentaje De acuerdo o Muy de acuerdo con: "La nueva constitución..."')

```

```{r graf-optimismoconstitucional-votoplebiscito, fig.cap = 'Optimismo constitucional, según voto en plebiscito de 2020'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, 
         !is_nsnr(c46_01, c46_02, c46_03, c46_04),
         !is_nsnr(c43, c44)) %>% 
  mutate(voto2020 = case_when(c43 %in% 2:3 ~ 3,
                              TRUE ~ c44),
         voto2020 = factor(car::recode(voto2020, '3:4 = 3'),
                          levels = 1:3,
                          labels = c('Apruebo', 'Rechazo', 'No votó o votó\nblanco/nulo')),
         c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  prop(optimismo >= 4, by = voto2020, na.rm = TRUE) %>% 
  ggplot(aes(x = voto2020, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(position = 'dodge2', fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
        subtitle = 'Porcentaje de acuerdo o muy de acuerdo en promedio con atributos positivos')

```



```{r graf-optimismoconstitucional-educ, fig.cap = 'Optimismo constitucional, según nivel educacional'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, 
         !is_nsnr(c46_01, c46_02, c46_03, c46_04),
         !is_nsnr(m01)) %>% 
  mutate(educ = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                   levels = 1:4,
                   labels = c("Basica", "Media", "Tecnica", "Universitaria")),
         c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  prop(optimismo >= 4, by = educ, na.rm = TRUE) %>% 
  ggplot(aes(x = educ, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(position = 'dodge2', fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
        subtitle = 'Porcentaje de acuerdo o muy de acuerdo en promedio con atributos positivos')


```


```{r graf-optimismoconstitucional-idpolitica, fig.cap = 'Optimismo constitucional, según identificación política'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, 
         !is_nsnr(c46_01, c46_02, c46_03, c46_04),
         !is_nsnr(c15)) %>% 
    mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                       levels = 1:4,
                       labels = c('Izquierda', "Centro", "Derecha", "No se identifica")),
         c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  prop(optimismo >= 4, by = pos_id, na.rm = TRUE) %>% 
  ggplot(aes(x = pos_id, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(position = 'dodge2', fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
        subtitle = 'Porcentaje de acuerdo o muy de acuerdo en promedio con atributos positivos')

```



```{r optimismo-democracia}


elsoc_long_2016_2021 %>% 
  left_join(elsoc_long_2016_2021 %>% 
              filter(tipo_atricion == 1, !is_nsnr(c46_01, c46_02, c46_03, c46_04)) %>% 
              mutate(c46_02 = 6 - c46_02,
                     c46_04 = 6 - c46_04) %>%
              rowwise() %>%
              mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE),
                     optimista = factor(optimismo >= 4,
                                        levels = c(TRUE, FALSE),
                                        labels = c('Optimista', 'No optimista'))) %>%
              select(idencuesta, optimismo, optimista), by = 'idencuesta') %>% 
  
  filter(tipo_atricion == 1, !is_nsnr(c46_01, c46_02, c46_03, c46_04), !is_nsnr(c25, c15)) %>%
  filter(!is.na(optimista)) %>% 
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:5,
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  as_label(ola) %>% 
  prop(c25 == 1, by = c(ola, optimista, pos_id), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, group = optimista, color = optimista,
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) +
  facet_wrap(.~pos_id) +
  geom_line() + 
  geom_text_repel(size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',   
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde...')

```