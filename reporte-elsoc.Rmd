--- 
title: "Estudio Longitudinal Social de Chile"
subtitle: "Resultados longitudinales 2016-2021"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: ["book.bib"]
csl: "inputs/bib/apa-no-ampersand.csl"
biblio-style: apalike
link-citations: yes
linkcolor: blue
geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
github-repo: "edgardo-cerda/reporte-elsoc-2021"
url: "https://edgardo-cerda.github.io/reporte-elsoc-2021/"
always_allow_html: true
editor_options: 
  markdown: 
    wrap: 72
    
---



<!--chapter:end:index.Rmd-->


# Introduccion

Placeholder


## Sobre COES
## Sobre ELSOC
### Descripción del estudio
### Acceso a Bases de Datos ELSOC
### Características del diseño muestral
### Características del levantamiento de datos
## Atrición de la muestra
### Atrición acumulada según Sexo, Grupo etáreo, Nivel educacional y Estrato
### Foco en el cambio longitudinal

<!--chapter:end:01-introduccion.Rmd-->


# Temas políticos

Placeholder


## Identificación política
### ¿Cómo se posicionan políticamente los chilenos?
### Interés en la política y participación ciudadana
### Opinión en temas de discusión pública
## Movimientos Sociales y Acciones Colectivas
### Tipología de participación política
### Ciclo de movilización política y estallido social
## Participación electoral
## Justificación de la Violencia
### Justificación de la violencia para el control social
## Confianza interpersonal y en instituciones
### Confianza interpersonal
## Actitudes hacia la democracia
## Cambio constitucional
## Optimismo constitucional

<!--chapter:end:02-temas-politicos.Rmd-->


# Temas de salud mental y bienestar

## Salud mental y bienestar de la población

### ¿Cómo se encuentra, y cómo ha cambiado la salud mental y nivel de bienestar de la población?

```{r salud-bienestar-2021, fig.cap = 'Satisfacción con la vida y salud subjetiva (ola 2021)'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5 & !is_nsnr(s01, s02, s03)) %>% 
  prop_list(s01 %in% 4:5, s02 %in% 4:5, s03 %in% 4:5, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('s01 %in% 4:5', 's02 %in% 4:5', 's03 %in% 4:5'),
                       labels = c('Esta satisfecho o muy\nsatisfecho con su vida',
                                  'Su vida se acerca o se acerca\ncompletamente a su ideal',
                                  'Su salud es muy buena\no Excelente'))) %>% 
  ggplot(aes(y = prop, x = name, fill = name,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col() +
  geom_text(position = position_dodge(.9), 
            vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_fill_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'none') +
  ggtitle(NULL, 'Porcentaje que responde que...')

```

```{r salud-bienestar-olas, fig.cap = 'Satisfacción con la vida y salud subjetiva, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(s01, s02, s03)) %>% 
  sjlabelled::as_label(ola) %>%
  prop_list(s01 %in% 4:5, s02 %in% 4:5, s03 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('s01 %in% 4:5', 's02 %in% 4:5', 's03 %in% 4:5'),
                       labels = c('Esta satisfecho o muy\nsatisfecho con su vida',
                                  'Su vida se acerca o se acerca\ncompletamente a su ideal',
                                  'Su salud es muy buena\no Excelente'))) %>% 
  ggplot(aes(y = prop, x = ola, group = name, color = name,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  geom_text_repel(nudge_y = .025, size = 3, color = 'black') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_color_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL, 'Porcentaje que responde que...')

```

### Sintomatología depresiva

```{r depre-wave, fig.cap = 'Porcentaje que presenta síntomas de depresión (2021)'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5) %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o síntomas\nde depresión mínima', 
                                  'Síntomas de\ndepresion media', 
                                  'Síntomas de\ndepresion moderada', 
                                  'Síntomas de depresion\nmoderada-severa o severa'))) %>%
  prop(depr, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = depr, fill = depr, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = 0:1) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1) +
  geom_text(position = position_dodge2(.9),
            size = 3, 
            vjust = -.5) +
  theme(legend.position = 'none')

```


```{r depre-bienestar, fig.cap = 'Satisfacción con la vida y salud subjetiva (ola 2021), según Sintomas de depresión'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o síntomas\nde depresión mínima', 
                                  'Síntomas de\ndepresion media', 
                                  'Síntomas de\ndepresion moderada', 
                                  'Síntomas de depresion\nmoderada-severa o severa'))) %>%
  filter(tipo_atricion == 1 & ola == 5, !is_nsnr(s01, s02, s03) & !is.na(depr)) %>%  
  prop_list(s01 %in% 4:5, s02 %in% 4:5, s03 %in% 4:5, by = depr, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('s01 %in% 4:5', 's02 %in% 4:5', 's03 %in% 4:5'),
                       labels = c('Esta satisfecho o muy\nsatisfecho con su vida',
                                  'Su vida se acerca o se acerca\ncompletamente a su ideal',
                                  'Su salud es muy buena\no Excelente'))) %>% 
  ggplot(aes(y = prop, x = name, fill = depr, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = 0:1) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1) +
  geom_text(position = position_dodge2(.9),
            size = 3, 
            vjust = -.5) +
  theme(legend.position = 'top',
        legend.title = element_blank())


```



```{r depre-wave, fig.cap = 'Porcentaje que presenta síntomas de depresión, según ola'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o síntomas\nde depresión mínima', 
                                  'Síntomas de\ndepresion media', 
                                  'Síntomas de\ndepresion moderada', 
                                  'Síntomas de depresion\nmoderada-severa\no severa'))) %>%
  dplyr::filter(tipo_atricion == 1) %>% 
  prop(depr, by = c(ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(depr, ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(depr), 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, 
            color = rep(rep(c('black', 'white'), each = 2), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))

```


```{r depre-alluvial, fig.cap = 'Cambios en síntomas depresivos entre 2016 y 2021'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  dplyr::filter(tipo_atricion == 1 & ola %in% c(1, 5)) %>% 
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"),
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o síntomas\nde depresión mínima', 
                                  'Síntomas de\ndepresion media', 
                                  'Síntomas de\ndepresion moderada', 
                                  'Síntomas de depresion\nmoderada-severa o severa'))) %>% 
  as_label(ola) %>% 
  survey_design_elsoc() %>%
  svytable(~depr + ola + idencuesta, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola) %>% 
  mutate(prop = Freq/sum(Freq)) %>%
  filter(Freq > 0) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(depr), 
             stratum = fct_rev(depr), alluvium = idencuesta)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, end = .9) +
  geom_text(data = function(x) { group_by(.data = x, ola, depr) %>%
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>%
      ungroup()}, 
      aes(label = scales::percent(prop, accuracy = .1)),
      position = position_stack(vjust = .5),
      show.legend = FALSE,
      color = rep(c('white', 'white', 'black', 'black'), 2),
            size = 3) + 
  guides(fill = guide_legend(reverse = TRUE))

```

```{r}
elsoc_depr_lca <- elsoc_wide_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1) %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%
  mutate(
    phq9_w01 = (s11_01_w01 + s11_02_w01 + s11_03_w01 + s11_04_w01 + s11_05_w01 + s11_06_w01 + s11_07_w01 + s11_08_w01+ s11_09_w01),
    phq9_w02 = (s11_01_w02 + s11_02_w02 + s11_03_w02 + s11_04_w02 + s11_05_w02 + s11_06_w02 + s11_07_w02 + s11_08_w02+ s11_09_w02),
    phq9_w03 = (s11_01_w03 + s11_02_w03 + s11_03_w03 + s11_04_w03 + s11_05_w03 + s11_06_w03 + s11_07_w03 + s11_08_w03+ s11_09_w03),
    phq9_w04 = (s11_01_w04 + s11_02_w04 + s11_03_w04 + s11_04_w04 + s11_05_w04 + s11_06_w04 + s11_07_w04 + s11_08_w04+ s11_09_w04),
    phq9_w05 = (s11_01_w05 + s11_02_w05 + s11_03_w05 + s11_04_w05 + s11_05_w05 + s11_06_w05 + s11_07_w05 + s11_08_w05+ s11_09_w05),
    depr_w01 = car::recode(phq9_w01, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4; else = NA"),
    depr_w02 = car::recode(phq9_w02, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4; else = NA"),
    depr_w03 = car::recode(phq9_w03, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4; else = NA"),
    depr_w04 = car::recode(phq9_w04, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4; else = NA"),
    depr_w05 = car::recode(phq9_w05, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4; else = NA")
    ) %>% 
  drop_na(starts_with('depr_'))

lca3 <- poLCA(cbind(depr_w01, depr_w02, depr_w03, depr_w04, depr_w05) ~ 1,
        data = elsoc_depr_lca , nclass = 3, na.rm = TRUE, maxiter = 5000, nrep = 30)
lca4 <- poLCA(cbind(depr_w01, depr_w02, depr_w03, depr_w04, depr_w05) ~ 1,
        data = elsoc_depr_lca , nclass = 4, na.rm = TRUE, maxiter = 5000, nrep = 30)
lca5 <- poLCA(cbind(depr_w01, depr_w02, depr_w03, depr_w04, depr_w05) ~ 1,
        data = elsoc_depr_lca , nclass = 5, na.rm = TRUE, maxiter = 5000, nrep = 30)

elsoc_depr_lca$class3 <- as.factor(lca3$predclass)
elsoc_depr_lca$class4 <- as.factor(lca4$predclass)
elsoc_depr_lca$class5 <- as.factor(lca5$predclass)

indicadores_lca <- function(x) {
  purrr::map_df(.x = x, .f = function(k) {
    data.frame(Nclases = length(k$P), 
               AIC = k$aic, 
               BIC = k$bic, 
               Nobs = k$Nobs, 
               Chisq = k$Chisq)
  })
}

indicadores_lca(list(lca3, lca4, lca5))

# Agregar etiquetas (4 clases)

elsoc_depr_lca$class4r <- factor(elsoc_depr_lca$class4,
                             levels = c('2', '3', '4', '1'),
                             labels = c('baja', 'media-baja', 'media-alta', 'alta'))

elsoc_depr_lca$class_depr <- factor(elsoc_depr_lca$class4r,
                                    labels = glue::glue("{get_labels(elsoc_depr_lca$class4r)} ({scales::percent(elsoc_depr_lca %>% survey_design_elsoc(weights = 'ponderador02_w05') %>%
                                    prop(class4r, na.rm = TRUE) %>%
                                    pull(prop), .1)})"))

```


```{r}
      
elsoc_depr_lca %>%
    survey_design_elsoc(weights = 'ponderador02_w05') %>% 
    prop_list(depr_w01, depr_w02, depr_w03, depr_w04, depr_w05, 
              by = class_depr, na.rm = TRUE) %>%
    mutate(name = factor(name,
                         levels = glue::glue('depr_w0{1:5}'),
                         labels = c(2016:2019, 2021)),
           sintomas = factor(value,
                             levels = 1:4,
                             labels = c('Sin sintomas o síntomas\nde depresión mínima', 
                                  'Síntomas de\ndepresion media', 
                                  'Síntomas de\ndepresion moderada', 
                                  'Síntomas de depresion\nmoderada-severa o severa'))) %>% 
    ggplot(aes(x = prop, y = fct_rev(name), fill = fct_rev(sintomas))) + 
    geom_col(position = 'stack') + 
    facet_grid(~ class_depr) +
    labs(y = "Ola del estudio", 
         x = "Proporción",
         title = glue::glue("Perfiles de sintomatología depresiva: 4 clases"), 
         fill = "") +
    scale_x_continuous(breaks = seq(0, 1, .25),
                       labels = scales::percent) +
    guides(fill = guide_legend(reverse = TRUE)) +
    theme_bw() + 
    theme(legend.position = "top", 
          plot.title = element_text(size = 14),
          axis.text.x = element_text(size = 8)) + 
    scale_fill_viridis_d(end = .85)

```

```{r}

elsoc_long_2016_2021 %>%
  left_join(elsoc_depr_lca)
  prop(class_depr, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, m0_sexo)

  ggplot(aes(y = prop, x = ola, 
                   color = m0_sexo, group = m0_sexo,
              label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3, nudge_y = .025) + 
  theme(legend.position = 'top',
        legend.title = element_blank())  + 
  ggtitle(label = 'Síntomas depresivos, según sexo', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')
 

```


```{r depre-year-sexo, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>% 
  dplyr::filter(tipo_atricion == 1 & muestra == 1) %>% 
  prop(phq9>=10, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, m0_sexo) %>% 
  ggplot(aes(y = prop, x = ola, 
                   color = m0_sexo, group = m0_sexo,
              label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3, nudge_y = .025) + 
  theme(legend.position = 'top',
        legend.title = element_blank())  + 
  ggtitle(label = 'Síntomas depresivos, según sexo', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')
 
```

```{r depre-edad-sexo, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  dplyr::filter(ola %in% c(1, 5) & tipo_atricion == 1 & muestra == 1) %>% 
  prop(phq9 >= 10, by = c(ola, edadt), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, edadt) %>% 
  ggplot(aes(y = prop, x = edadt, 
                   group = ola, color = ola,
                   label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) + 
  theme(legend.position = 'top',
        legend.title = element_blank())  + 
  ggtitle(label = 'Síntomas depresivos, según tramo de edad y ola del estudio', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```


```{r}


elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>% 
  dplyr::filter(tipo_atricion == 1 & muestra == 1 & ola == 5,
                !is_nsnr(s01, s02, s03) & !is_nsnr(s04, s08, s09)) %>% 
  mutate(suma = 4 - (s04 %in% 1:4) - (s08 == 0) - (s09 == 2),
         conducta_saludable = 
           factor(suma, levels = 1:4,
                  labels = c('Practica deporte, y\nno fuma, ni consume\nalcohol regularmente',
                             'Realiza 1 de 3\nconductas no\nsaludables',
                             'Realiza 2 de 3\nconductas no\nsaludables',
                             'No practica deporte,\nfuma y consume\nalcohol regularmente'))) %>% 
  prop(phq9 >= 10, by = conducta_saludable, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = conducta_saludable,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2', fill = viridis(1, begin =.33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_color_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(label = 'Síntomas depresivos, según conducta saludable (2021)', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```

```{r depre-labstat, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>%
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1, 2, 3, 4, 5),
                           labels = c("Trabajo remunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otras categorías"))
         ) %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & muestra == 1 & !m02 %in% c(-888, -999)) %>% 
  prop(phq9 >= 10, by = sit_ocup) %>% 
  ggplot(aes(y = prop, x = sit_ocup, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2', fill = viridis(1, begin =.33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank())  +
  ggtitle(label = 'Síntomas depresivos, según categoría ocupacional (2021)', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```

En 2021 no hay hombres en la categoría Trabajo doméstico no remunerado $^{*}$


## Parte economía:

```{r}
elsoc_long_2016_2021 %>%
  filter(ola %in% 4:5) %>% 
  mutate(sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1, 2, 3, 4, 5),
                           labels = c("Trabajo remunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otras categorías"))
         ) %>% 
  dplyr::filter(tipo_atricion == 1 & !m02 %in% c(-888, -999)) %>% 
  prop(sit_ocup, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(sit_ocup),
             label = scales::percent(prop, accuracy = .1))) + 
  facet_wrap(~m0_sexo) +
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(end = .85, direction = -1)
```


```{r}
elsoc_long_2016_2021 %>%
  filter(ola %in% 4:5) %>% 
  mutate(sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1, 2, 3, 4, 5),
                           labels = c("Trabajo remunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otros inactivos"))
         ) %>% 
  as_label(ola) %>% 
  dplyr::filter(tipo_atricion == 1 & !is_nsnr(m02)) %>% 
  survey_design_elsoc() %>%
  svytable(~sit_ocup + ola + idencuesta, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola) %>% 
  mutate(prop = Freq/sum(Freq)) %>%
  filter(Freq > 0) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(sit_ocup), 
             stratum = fct_rev(sit_ocup), alluvium = idencuesta)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, end = .9) +
  geom_text(data = function(x) { group_by(.data = x, ola, sit_ocup) %>%
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>%
      ungroup()}, 
      aes(label = scales::percent(prop, accuracy = .1)),
      position = position_stack(vjust = .5),
      show.legend = FALSE,
      color = rep(c('white', 'white', 'white', 'black', 'black'), 2),
            size = 3) +
  guides(fill = guide_legend(reverse = TRUE))


```




## COVID - 19


```{r covid-sexo, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5, tipo_atricion == 1 & !is_nsnr(s31) & !is_nsnr(r03_09)) %>%
  prop_list(s31 == 1, r03_09 > 1, na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('s31 == 1', 'r03_09 > 1'),
                       labels = c('Fue diagnosticado con COVID-19',
                                  'Tiene al menos un conocido/a que\nfue diagnosticado con COVID-19'))) %>% 
  ggplot(aes(y = prop, x = name, fill = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Cercanía de contagio de covid',
          'Porcentaje que...')

```

```{r depre clase.sub, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5, tipo_atricion == 1,
                !is_nsnr(s31, r03_09, d01_01) & !is.na(d01_01)) %>%
  mutate(clase.sub = factor(car::recode(d01_01, "0:4 = 1; 5 = 2; 6:10 = 3"),
                            levels = 1:3,
                            labels = c('Baja y Media baja', 'Media', 'Media y Media alta'))) %>% 
  prop_list(s31 == 1, r03_09 > 1, by = clase.sub, na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('s31 == 1', 'r03_09 > 1'),
                       labels = c('Fue diagnosticado con COVID-19',
                                  'Tiene al menos un conocido/a que\nfue diagnosticado con COVID-19'))) %>%
  ggplot(aes(y = prop, x = name, fill = clase.sub,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .75, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Cercanía de contagio de covid, según clase social subjetiva (2021)',
          'Porcentaje que...')

```


```{r, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5, tipo_atricion == 1 & !is_nsnr(r03_09)) %>%
  mutate(r03_09 = factor(car::recode(r03_09, "4:7 = 4"),
                         levels = 1:4,
                         labels = c('No conoce a nadie que haya\nsido diagnosticado con COVID-19', 
                                    'Conoce a 1', 'Conoce entre 2 y 4', 'Conoce a 5 o más'))) %>% 
  prop(r03_09, na.rm = TRUE) %>% 
  as_label(r03_09) %>% 
  ggplot(aes(y = prop, x = r03_09, fill = r03_09,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Distribución de los encuestados,\nsegún número de conocidos que han sido diagnosticados de covid (2021)')

```

### Cuarentenas

```{r hist-fecha-2021, fig.align='center'}
elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5) %>% 
  mutate(fecha = make_date(year = annio_entr, month = mes_entr, day = dia_entr),
         semana = lubridate::week(fecha)) %>% 
  group_by(semana) %>% 
  summarise(n = n()) %>%
  mutate(fecha = make_date(year = 2021, month = 1, day = 1) + 7*semana) %>% 
  ggplot(mapping = aes(y = n, x = fecha)) +
  theme_bw() +
  geom_col(fill = viridis(1, begin = .33)) +
  scale_y_continuous(limits = c(0,400)) + 
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_x_date(date_labels = "%d-%m",
               date_breaks = '2 weeks') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle('¿Cuándo fueron encuestados los entrevistado? (2021)',
          'Frecuencia de encuestas, según fecha')

```

```{r}
elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1) %>% 
  left_join(elsoc_long_cuarentenas, by = c('idencuesta', 'ola')) %>% 
  mutate(cuarentena_acum.30t = factor(car::recode(cuarentena_acum.30, "0 = 1; 1:14 = 2; 15:21 = 3; 22:28 = 4; 29:30 = 5"),
                                 levels = 1:5,
                                 labels = c('0 días', '1-14 días', '15-21 días', '22-28 días', '29-30 días'))) %>% 
  prop(cuarentena_acum.30t) %>% 
  ggplot(aes(y = prop, x = cuarentena_acum.30t, fill = cuarentena_acum.30t,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Días acumulados en cuarentena, el mes previo a la encuesta',
          'Distribución de los encuestados, según días en cuarentena')

```

```{r}

elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1, !is_nsnr(m60)) %>% 
  prop(m60, na.rm = TRUE) %>% 
  mutate(m60 = factor(m60, levels = 1:3,
                      labels = c('Trabajo de manera\ncompleta desde el hogar',
                                 'Trabajo de manera\n parcial en el hogar',
                                 'Trabajo fuera del hogar'))) %>% 
  ggplot(aes(y = prop, x = m60, fill = m60,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Trabajo remoto (2021)',
          'Porcentaje que trabaja en modalidad...')

```


```{r}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5) %>%
  left_join(elsoc_long_cuarentenas, by = c('idencuesta', 'ola')) %>%
  mutate(cuarentena_acum.30t = factor(car::recode(cuarentena_acum.30, "0 = 1; 1:14 = 2; 15:21 = 3; 22:30 = 4"),
                                 levels = 1:4,
                                 labels = c('0 días', '1-14 días', '15-21 días', '22-30 días'))) %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>%
  prop(phq9 >= 10, by = cuarentena_acum.30t, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = cuarentena_acum.30t, fill = cuarentena_acum.30t,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_fill_viridis_d(begin = 0, end = .85, option = 'viridis') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  geom_text(position = position_dodge(.9),
            vjust = -.5,
            size = 3) +
  theme(legend.position = 'none') +
  ggtitle(label = 'Síntomas depresivos, según días de cuarentena', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```

```{r}
elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1, !is_nsnr(m60) & !is.na(m60)) %>% 
  mutate(m60 = factor(m60, levels = 1:3,
                      labels = c('Trabajo de manera\ncompleta desde el hogar',
                                 'Trabajo de manera\n parcial en el hogar',
                                 'Trabajo fuera del hogar'))) %>%
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>%
  prop(phq9 >= 10, by = m60, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = m60, fill = m60,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_fill_viridis_d(begin = 0, end = .85, option = 'viridis') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  geom_text(position = position_dodge(.9),
            vjust = -.5,
            size = 3) +
  theme(legend.position = 'none') +
  ggtitle(label = 'Síntomas depresivos, según modalidad de trabajo', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```


## Estrés Financiero

```{r satisfaccion-wave, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1 & !m43 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

```


```{r clase.sub-benef.estatal, echo=FALSE, fig.align='center'}

datos.g19.12 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub = factor(car::recode(d01_01, "c(0,1,2,3)='Baja y media baja'; c(4, 5)='Media'; c(6,7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub, by = c(m63_01), na.rm = TRUE) %>% 
  sjlabelled::as_label(clase.sub, m63_01) 

g19.12 <- datos.g19.12 %>% 
  ggplot(aes(y = prop, x = m63_01, fill = clase.sub, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.12
```

```{r clase.sub.hij-1erretiro, echo=FALSE, fig.align='center'}
datos.g19.13 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub.hijos = factor(car::recode(d01_03, "c(0,1,2,3)='Baja y media baja'; c(4, 5,6)='Media'; c(7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub.hijos %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub.hijos, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(clase.sub.hijos, m63_02) 

g19.13 <- datos.g19.13 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = clase.sub.hijos, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.13
```

```{r endeud-1retiro, echo=FALSE, fig.align='center'}
datos.g19.14 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, m63_02) 

g19.14 <- datos.g19.14  %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.14
```

```{r endeud-2retiro, echo=FALSE, fig.align='center'}
datos.g19.15 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_03 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_03), na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, m63_03) 

g19.15 <- datos.g19.15  %>% 
  ggplot(aes(y = prop, x = m63_03, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.15
```

```{r deuda-retiro1, fig.align='center'}
elsoc_long_2016_2021 %>% 
  left_join(elsoc_wide_2016_2021 %>% 
              filter(!m63_02_w05 %in% c(-888, -999) & !m63_03_w05 %in% c(-888, -999)) %>%
              mutate(retiros = factor(case_when(m63_02_w05 == 1 & m63_03_w05 == 1 ~ 1,
                                                m63_02_w05 == 1 ~ 2,
                                                TRUE ~ 3),
                                      levels = c(3, 2, 1),
                                      labels = c('Ningún retiro', 
                                                 'Primer retiro', 
                                                 'Primer y segundo\n retiro'))) %>%
              select(idencuesta, retiros), by = 'idencuesta') %>% 
  filter(tipo_atricion == 1 & ola %in% c(3, 5) & !is.na(retiros) &
           !m42_01 %in% c(-888, -999) & !m42_02 %in% c(-888, -999) & 
           !m42_03 %in% c(-888, -999) & !m42_04 %in% c(-888, -999)) %>% 
  pivot_longer(cols = c(m42_01, m42_02, m42_03, m42_04)) %>% 
  prop(value, by = c(ola, retiros, name), na.rm = TRUE) %>% 
  as_label(value, ola) %>% 
  filter(value == 1) %>% 
  mutate(name = factor(name, 
                       levels = c('m42_01', 'm42_02', 'm42_03', 'm42_04'),
                       labels = c('Casa\ncomercial', 'Banco', 
                                  'Parientes', 'Otros'))) %>% 
  ggplot(aes(y = prop, x = name, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~retiros) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

```



## Distanciamiento y comportamiento prosocial en pandemia

```{r dist-total, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? (2021).'}

datos.9.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  prop(x = dis_soc, na.rm = TRUE)

g9.1 <- datos.9.1 %>% 
  ggplot(aes(y = prop, x = dis_soc, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'none', 
        legend.title = element_blank())
g9.1
```

```{r dist-quintil, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según quintil de ingreso. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.2 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !t01 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;6=445000;
                                           7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;
                                           18=1670000;19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = dis_soc, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente")

g9.2 <- 
  datos.9.2 %>% 
  ggplot(aes(y = prop, x = quintil, fill = quintil, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.2
```


```{r dist-edad, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según edad. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         edadt = factor(car::recode(m0_edad, "18:29=1; 30:49=2; 50:64=3 ;65:150=4"),
                        levels = c(1,2,3,4), labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  prop(x = dis_soc, by = edadt, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente")

g9.3 <- 
  datos.9.3 %>% 
  ggplot(aes(y = prop, x = edadt, fill = edadt, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.3
```

```{r dist-estrato, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según estrato muestral (2021).'}
datos.9.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  prop(x = dis_soc, by = estrato, na.rm = TRUE)

g9.4 <- datos.9.4 %>%
  ggplot(aes(y = prop, x = estrato, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 6)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g9.4
```

```{r dist-telet, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según tipo de trabajo en pandemia. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999) & !m60 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         trab_pandemia = factor(m60, labels = c('Trabajo de manera\ncompleta desde el hogar',
                                                'Trabajo de manera\nparcial desde el hogar',
                                                'Trabajo fuera\ndel hogar'))) %>%
  prop(x = dis_soc, by = trab_pandemia, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente") %>% 
  drop_na()

g9.5 <- 
  datos.9.5 %>% 
  ggplot(aes(y = prop, x = trab_pandemia, fill = trab_pandemia, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.5
```

```{r dist-covid, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según diagnóstico con coronavirus. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999) & !s31 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         covid = factor(s31, labels = c('Si','No'))) %>%
  prop(x = dis_soc, by = covid, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente") %>% 
  drop_na()

g9.6 <- 
  datos.9.6 %>% 
  ggplot(aes(y = prop, x = covid, fill = covid, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.6
```



## Situación económica



```{r}
elsoc_clase <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(m29, m30, m30b)) %>%
  mutate(m30 = as.numeric(car::recode(m30, "1 = 110000; 2 = 251000; 
  3 = 305000; 4 = 355000; 5 = 400000; 
  6 = 445000; 7 = 490000; 8 = 535000; 9 = 585000; 10 = 640000; 
  11 = 700000; 12 = 765000; 13 = 845000; 14 = 935000; 15 = 1040000;
  16 = 1180000; 17 = 1375000; 18 = 1670000; 19 = 2275000; 20 = 2700000; NA = NA")),
  m30b = as.numeric(car::recode(m30b, "1 = 170000; 2 = 300000; 3 = 400000; 4 = 600000; 5 = 1200000; NA = NA")),
  m29_imp = ifelse(!is.na(m29), m29, ifelse(ola == 5, m30b, m30))) %>% 
  group_by(ola) %>% 
  mutate(quintil = xtile(m29, n = 5, wt = ponderador02),
         quintil = factor(quintil, levels = 1:5, labels = glue::glue('Quintil {1:5}'))) %>%
  ungroup() %>% 
  mutate(clase_sub = 
           factor(car::recode(d01_01, "0:2 = 1; 3:4 = 2; 5 = 3; 6:7 = 4; 8:10 = 5"),
                  levels = 1:5,
                  labels = c('Baja', 'Media baja', 'Media', 'Media alta', 'Alta'))) %>% 
  left_join(elsoc_egp, by = c('idencuesta', 'ola')) %>% 
  drop_na(quintil, clase_sub, egp07)

lca_clases3 <- poLCA(cbind(quintil, clase_sub, egp07) ~ 1,
                    data = elsoc_clase , nclass = 3, na.rm = TRUE, maxiter = 5000, nrep = 10)
elsoc_clase$class3 <- as.factor(lca_clases3$predclass)

lca_clases4 <- poLCA(cbind(quintil, clase_sub, egp07) ~ 1,
                    data = elsoc_clase , nclass = 4, na.rm = TRUE, maxiter = 5000, nrep = 10)
elsoc_clase$class4 <- as.factor(lca_clases4$predclass)

lca_clases5 <- poLCA(cbind(quintil, clase_sub, egp07) ~ 1,
                    data = elsoc_clase , nclass = 5, na.rm = TRUE, maxiter = 5000, nrep = 10)
elsoc_clase$class5 <- as.factor(lca_clases5$predclass)

```


```{r}

elsoc_clase %>%
  as_label(quintil, clase_sub, egp07) %>% 
  prop_list(quintil, clase_sub, egp07, 
            by = class5, na.rm = TRUE) %>%
  mutate(clase = factor(class5,
                        levels = 1:5,
                        labels = paste0('(', scales::percent(
                          elsoc_clase %>%
                            prop(class5, na.rm = TRUE) %>%
                            pull(prop), .1), ')')),
         value = factor(value)) %>% 
  ggplot(aes(x = prop, y = fct_rev(name), fill = value)) + 
  geom_col(position = 'stack') + 
  facet_grid(~ clase) +
  labs(y = "Evento", 
       x = "Proporción",
       title = glue::glue("Perfiles de sintomatología depresiva: 5 clases"), 
       fill = "") +
  scale_x_continuous(breaks = seq(0, 1, .25),
                     labels = scales::percent) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme_bw() + 
  theme(legend.position = "top", 
        plot.title = element_text(size = 14),
        axis.text.x = element_text(size = 8)) + 
  scale_fill_viridis_d(begin = 0, end = 1, direction = -1, option = 'viridis')

```


<!--chapter:end:03-salud-bienestar.Rmd-->


# Temas sociales

Placeholder


## Conflicto y cohesión territorial
### Cartografía del conflicto barrial
## Confianza en vecinos
### Seguridad barrial
### Criminalidad barrial
### Cartografía de la criminalidad barrial
## Migración
### Amenaza realista y amenaza simbólica respecto a inmigrantes
### Amenaza realista y simbólica respecto a inmigrantes según nivel educacional
## Género
### Sexismo hostil y benevolente
### Trabajo y género
## Estatus subjetivo y Percepción de Mérito
### Estatus subjetivo
### Movilidad social
### Percepción de meritocracia

<!--chapter:end:04-temas-sociales.Rmd-->

# Como citar este informe: {-}

:::{.blue-box}
> COES (2021) Radiografía del Cambio Social: Análisis de Resultados Longitudinales ELSOC 2016-2021. Presentación de Resultados COES. Septiembre, Santiago de Chile.
:::

**Entrada Bibtex:**

```{r,echo=TRUE,eval=FALSE}
@techreport{coes_Radiografia_2021,
  title = {Radiograf\'ia Del {{Cambio Social}}: {{An\'alisis}} de {{Resultados Longitudinales ELSOC}} 2016-2021.},
  author = {COES},
  year = {2021},
  month = sep,
  address = {{Santiago de Chile, Chile}},
  institution = {{Centro de Estudios de Conflicto y Cohesi\'on Social}}
}
```

<!--chapter:end:05-cierre.Rmd-->

