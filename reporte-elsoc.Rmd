--- 
title: "Estudio Longitudinal Social de Chile"
subtitle: "Resultados longitudinales 2016-2021"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
bibliography: ["book.bib"]
csl: "inputs/bib/apa-no-ampersand.csl"
biblio-style: apalike
link-citations: yes
linkcolor: blue
geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
github-repo: "edgardo-cerda/reporte-elsoc-2021"
url: "https://edgardo-cerda.github.io/reporte-elsoc-2021/"
always_allow_html: true
editor_options: 
  markdown: 
    wrap: 72
    
---


```{r packages, message=FALSE, warning=FALSE, include=FALSE}

library(knitr)
library(kableExtra)
library(gridExtra)
library(tidyverse)
library(sjmisc)
library(sjlabelled)
library(ggrepel)
library(ggalluvial)
library(survey)
library(spatstat)
library(gtools)
library(sf)
library(chilemapas)
library(elsoc)
library(lubridate)
library(viridis)
library(treemapify)

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, warning=FALSE, message=FALSE, echo=FALSE, fig.topcaption = TRUE, fig.align = 'center')

Sys.setlocale("LC_ALL","ES_ES.UTF-8")
```

```{r formats, include=FALSE }
table_format = if (is_html_output()) {
  "html"
} else if (is_latex_output()) {
  "latex" 
}

fullw = if (is_html_output()) {TRUE} else if (is_latex_output()) {FALSE}
fsize = if (is_html_output()) {14} else if(is_latex_output()) {8}

ggplot2::theme_set(new = theme_test(base_family = "serif"))
options(knitr.kable.NA = '')

```

```{r cargar-datos}

remove(list = ls())

load(file.path('..', '..', '..', '2_Bases_de_Datos', '10_Combinacion_de_Olas_ELSOC', '0E_Bases_de_Datos_Resultantes_2016_2021', 'ELSOC_Long_2016_2021_v1.00_R.RData'))

load(file.path('..', '..', '..', '2_Bases_de_Datos', '10_Combinacion_de_Olas_ELSOC', '0E_Bases_de_Datos_Resultantes_2016_2021', 'ELSOC_Wide_2016_2021_v1.00_R.RData'))

load(file.path('inputs', 'cuarentenas_acum.RData'))

```

```{r datos-elsoc, eval=FALSE}

# bases de datos ELSOC
elsoc::load_elsoc(format = 'long')
elsoc::load_elsoc(format = 'wide')

```

```{r datos-cuarentenas, eval=FALSE}

## DATA CUARENTENA ---------
# Url para descarga directa de datos desde el Github del Ministerio de Ciencia
url <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output"

## Cuarentenas desde 2020/03 hasta 2020/07/28 
cuarentenas1_bruto <- readr::read_csv(paste(url, "producto29", "Cuarentenas-Totales.csv", sep = "/"))

cuarentenas1_acum <- cuarentenas1_bruto %>% 
  janitor::clean_names() %>% 
  mutate(fecha_de_inicio = as_date(fecha_de_inicio),
         fecha_de_termino = as_date(fecha_de_termino),
         # cortar en fecha 2020/07/27 
         fecha_de_termino = as_date(ifelse(fecha_de_termino > '2020/07/27', 
                                           make_date(2020, 07, 27),
                                           fecha_de_termino)),
         csum1 = as.numeric(fecha_de_termino - fecha_de_inicio, units = 'days')) %>% 
  filter(fecha_de_inicio < '2020/07/27') %>% 
  rename(comuna_cod = codigo_cut_comuna) %>%
  group_by(comuna_cod) %>% 
  summarise(csum1 = mean(csum1, na.rm = TRUE)) %>% 
  ungroup()

## Cuarentenas desde 2020/07/28 al último día actualizado
cuarentenas2_bruto <- read_csv(paste(url, 'producto74', "paso_a_paso_std.csv", sep="/"))

cuarentenas2 <- cuarentenas2_bruto %>% 
  janitor::clean_names() %>% 
  mutate(fecha = as_date(fecha),
         dia = weekdays(fecha),
         cuarentena = case_when(paso == 1 ~ 1,
                                paso == 2 & dia %in% c('Saturday', 'Sunday') ~ 1,
                                TRUE ~ 0)) %>% 
  filter(zona %in% c('Urbana', 'Total'))

# Cuarentena acumulada desde el 2020/07/27 a la fecha respectiva:
cuarentenas2_acum <- cuarentenas2 %>% 
  group_by(codigo_comuna, zona) %>% 
  mutate(csum2 = cumsum(cuarentena),
         comuna_cod = as.numeric(codigo_comuna)) %>% 
  ungroup() %>% 
  select(fecha, comuna_cod, csum2)

# Cuarentenas acumuladas por comuna y fecha desde inicio de las cuarentenas:
cuarentenas_acum <- full_join(cuarentenas1_acum,
                              cuarentenas2_acum,
                              by = 'comuna_cod') %>% 
  rowwise() %>% 
  mutate(cuarentena_acum = sum(csum1, csum2, na.rm = TRUE)) %>% 
  select(comuna_cod, fecha, cuarentena_acum) %>%
  # Cuarentenas acumuladas en ventanas de tiempo
  arrange(comuna_cod, fecha) %>% 
  group_by(comuna_cod) %>% 
  mutate(cuarentena_acum.14 = cuarentena_acum - dplyr::lag(cuarentena_acum, n = 14),
         cuarentena_acum.30 = cuarentena_acum - dplyr::lag(cuarentena_acum, n = 30),
         cuarentena_acum.60 = cuarentena_acum - dplyr::lag(cuarentena_acum, n = 60),
         cuarentena_acum.90 = cuarentena_acum - dplyr::lag(cuarentena_acum, n = 90)
         )

### Pegar fechas de cuarentenas en distintas ventanas de tiempo a datos elsoc:
elsoc_long_cuarentenas <- elsoc_long_2016_2021 %>% 
  filter(ola == 5) %>% 
  mutate(fecha = make_date(year = annio_entr, month = mes_entr, day = dia_entr)) %>% 
  left_join(cuarentenas_acum, by = c('comuna_cod', 'fecha')) %>% 
  select(idencuesta, ola, starts_with('cuarentena_acum'))

```


```{r remover-datos-sin-uso}

rm(list = setdiff(ls(), c('elsoc_long_cuarentenas', 'elsoc_long_2016_2021', 'elsoc_wide_2016_2021')))

```

<!--chapter:end:index.Rmd-->

# Introduccion

<div style="text-align: justify">

El Centro de Estudios de Conflicto y Cohesión Social ([COES](https://coes.cl/)) tiene el agrado de publicar el informe “Radiografía del Cambio Social”, el cual consolida los principales hallazgos longitudinales de cinco mediciones anuales del Estudio Longitudinal Social de Chile ([ELSOC](https://coes.cl/encuesta-panel/)).

ELSOC es una encuesta desarrollada para analizar longitudinalmente, en un estudio panel, la evolución del conflicto y cohesión social en la sociedad chilena, basándose en modelos conceptuales descritos en la literatura nacional e internacional de las disciplinas del ámbito de la Economía, Sociología, Psicología, Ciencia Política y Estudios Urbanos. De este modo, se orienta a examinar los principales antecedentes, factores moderadores y mediadores, así como las principales consecuencias asociadas al desarrollo de distintas formas de sociabilidad en Chile.

Desde 2019 y hasta la fecha, Chile se ha visto remecido por importantes eventos que han alterado aspectos sociales, políticos y económicos de la vida nacional: la pandemia asociada al COVID-19, y las consecuencias del estallido social más grande de las últimas décadas, ocurrido a partir de octubre de 2019, el que ha desencadenado un proceso constituyente inédito en la historia de Chile.

Ambos fenómenos han significado un desafío para ELSOC, ya que afecta tanto la forma en que son levantados los datos, como las preguntas que el estudio debe abordar. Sin embargo, ELSOC presente una gran oportunidad única: la posibilidad de observar el efecto que éstos fenómenos tienen sobre la población chilena desde una perspectiva longitudinal.

## Sobre COES

El Centro de Estudios de Conflicto y Cohesión Social ([COES](https://coes.cl/)) desarrolla investigación colaborativa en temas relacionados al conflicto social y la cohesión (convivencia) en Chile, por medio de un equipo multidisciplinario proveniente de las ciencias sociales y humanidades. COES centra sus actividades académicas y de difusión en el análisis de las múltiples manifestaciones del conflicto y cohesión social en Chile, sus causas, así como también su contexto cultural e histórico.

COES está patrocinado por la Universidad de Chile y la Pontificia Universidad Católica de Chile, y como instituciones asociadas se encuentran la Universidad Diego Portales y la Universidad Adolfo Ibáñez. COES cuenta con el apoyo del Fondo de Financiamiento de Centros de Investigación en Áreas Prioritarias ([FONDAP](https://www.conicyt.cl/fondap/sobre-fondap/que-es-fondap/), dependiente de la Agencia Nacional de Investigación y Desarrollo ([ANID](https://www.anid.cl/)) del Ministerio de Ciencia, Tecnología, Conocimiento e Innovación ([MinCiencia](https://www.minciencia.gob.cl/)). ELSOC además cuenta como socio al Instituto Milenio para la Investigación en Depresión y Personalidad ([MIDAP](https://midap.org/)).


## Sobre ELSOC

### Descripción del estudio

El [Estudio Longitudinal Social de Chile (ELSOC)](https://coes.cl/encuesta-panel/) es una encuesta panel, representativa de la población nacional urbana, que analiza la estabilidad y cambio de las creencias, actitudes y percepciones que tenemos los chilenos y chilenas respecto de la convivencia y del conflicto, la cohesión y una amplia gama de aspectos políticos y sociales a lo largo del tiempo. 

Este estudio sigue la evolución de cerca de 4.500 chilenos y chilenas a lo largo de una década. Actualmente se encuentran disponibles 5 olas del estudio, abarcando el período entre 2016 y 2021. Sus temas de estudio y su aspecto longitudinal convierten a ELSOC en un recurso único en Chile y América Latina para analizar la evolución de la sociedad chilena y para el desarrollo de las ciencias sociales en Chile.

Durante los últimos años, ELSOC se ha consolidado como un importante insumo para el desarrollo de investigación científica y aplicada en ciencias sociales. En el sitio web de (ELSOC)(https://coes.cl/encuesta-panel/) se puede acceder a más información sobre el estudio. 

### Acceso a Bases de Datos ELSOC

Las bases de datos y documentación correspondientes se encuentran disponibles, de manera libre y gratuita, en un repositorio de datos, al cual se podrá acceder en el link:

https://dataverse.harvard.edu/dataverse/elsoc

En este sitio se obtendrá acceso a los datos de las 5 mediciones transversales de ELSOC, así como bases longitudinales que integran las distintas mediciones. En colaboración con el Centro de Inteligencia Territorial ([CIT](https://cit.uai.cl/)), se pone también a disposición las bases ELSOC-CIT. Estas bases de datos permiten combinar la información de ELSOC, y estimaciones e indicadores territoriales y geoespaciales de distinta índole, proveniente de diversas fuentes de información nacional para los períodos 2016 a 2019. 

ELSOC tiene un compromiso con los más altos estándares científicos en términos de producción y análisis de datos. Dentro de esta visión global, ELSOC se guía por las principales pautas de Transparencia y Apertura en la investigación científica. Por esta misma razón, los códigos utilizados para el desarrollo de este documento se encontrarán disponibles en https://github.com/centro-coes.


### Características del diseño muestral

- Unidad de Análisis: Individuos

- Muestra objetivo: 3.000 individuos en muestra original (a partir de 2016) y 1.500 en muestra refresco (a partir de 2018)

- Población Objetivo: Hombres y mujeres de 18 a 75 años, residentes habituales de viviendas particulares ocupadas en zonas urbanas, localizadas en 40 ciudades (92 comunas, 13 regiones) del país

- Periodicidad: Anual. 

- Diseño Muestral: Probabilístico, estratificado (por tamaño de ciudades), por conglomerados y multietápico

- Marco Muestral: Marco de muestreo de manzanas del pre-censo 2011

- Unidades de Muestreo: Primero se eligen ciudades (UPM), luego manzanas (USM), y sub-bloques y viviendas (UTM). La unidad final de selección es la persona

**Organismo Ejecutor**: Consultora Stephanie Eckman y Centro de Inteligencia Territorial (CIT) de la Universidad Adolfo Ibáñez

```{r ilust-olas-elsoc, echo=FALSE, fig.cap = "Mediciones de ELSOC"}

knitr::include_graphics(file.path('inputs', 'imagenes', 'olas_elsoc.png'))

```

```{r ilust-etapas-seleccion, echo=FALSE, fig.cap = "Muestreo de ELSOC"}

knitr::include_graphics(file.path('inputs/imagenes/etapas_seleccion.jpg'))

```

### Características del levantamiento de datos

- Formato de aplicación: Cuestionario estructurado. Levantamiento en formato CAPI (Encuesta presencial con asistencia de tablet). Excepcionalmente se cambió a formato CATI (Encuesta telefónica con asistencia de tablet) durante 2021, debido a contingencia COVID-19

- Período de Aplicación: entre Julio y Noviembre de cada año. Debido al estallido social, la cuarta medición se aplicó entre el 21 de noviembre de 2019 y el 9 de marzo de 2020. Debido a la pandemia, la quinta medición se aplicó entre el 29 de enero de 2021 y 12 de julio de 2021

- Instrumento: Cuestionario compuesto por preguntas cerradas de carácter simple y múltiple junto a algunas preguntas abiertas. Combina módulos de preguntas permanentes (medidas en todas las olas) y otras intercaladas entre olas

- Cobertura Temática: Contiene siete módulos temáticos: Territorio, Redes y actitudes sociales, Ciudadanía y democracia, Desigualdad y legitimidad, Conflicto social, Salud y bienestar y Caracterización sociodemográfica

- Incentivos a la participación: Entrega de incentivos monetarios para el encuestado ($ 6.000 CLP) y de material sobre el estudio (ELSOC y COES). Acciones de seguimiento basadas en la información de contacto (correo electrónico para cumpleaños y días festivos)

- Entrenamiento de entrevistadores: Contratación de entrevistadores con experiencia en encuestas complejas y/o longitudinales. Capacitación centralizada y presencial para coordinadores de campo y un subconjunto de entrevistadores en Santiago (incluidos ejercicios prácticos para la implementación del cuestionario, uso de tabletas y protocolo de contacto). Actividades adicionales en otras regiones de Chile. Diseño de un Manual de entrevistador especializado para el proyecto

- Operaciones de Control y Supervisión: Coordinadores de campo supervisan el trabajo de entrevistadores, verificando el número de visitas, el contacto, la identidad del participante y preguntas claves. Organismo ejecutor realiza una supervisión interna de al menos el 10% de la muestra (entrevistando nuevamente a algunos encuestados), verificando la duración y la respuesta de los participantes

**Organismo Ejecutor**: Levantamiento a cargo de Centro Micro Datos (CMD) de la Universidad de Chile



## Atrición de la muestra

El diseño de ELSOC contempló entrevistar a 3.000 personas en su muestra original y 1.500 en la muestra refresco. Sin embargo, es habitual que en encuestas panel se reduce el número de participantes, dado que algunos optan voluntariamente por dejar de participar y otras personas no pueden ser recontactadas. Este fenómeno es conocido como atrición, y pueden tener efectos nocivos sobre la utilidad de los datos longitudinales. En el caso de ELSOC, la tasa de atrición es comparativamente baja en comparación a otros estudios similares, por lo que no se considera al momento un problema significativo. A pesar de esto, el año 2018 se introduce una muestra refresco para contraarrestar el efecto de la atrición. 

El año 2021, la atrición presenta un alza importante debido a la mayor dificultad que implica el levantamiento durante la pandemia de COVID-19 y al cambio de modalidad.

```{r tabla-atricion, echo=FALSE}

elsoc_long_2016_2021 %>% 
  group_by(ola, muestra) %>% 
  summarise(n = n()) %>% 
  group_by(muestra) %>% 
  mutate(atricion = abs(n/lag(n) - 1)) %>% 
  pivot_wider(names_from = muestra, values_from = c(n, atricion)) %>% 
  mutate(ola = factor(ola, levels = 1:5, labels = c(2016:2019, 2021)),
         n_1 = scales::number(n_1),
         n_2 = scales::number(n_2),
         atricion_1 = scales::percent(atricion_1),
         atricion_2 = scales::percent(atricion_2)) %>% 
  select(ola, n_1, atricion_1, n_2, atricion_2) %>% 
  kbl(align = c('c', 'c', 'c', 'c', 'c'),
      col.name = c('Medición', rep(c('Muestra lograda', 'Atrición'), 2)),
      caption = 'Atrición de las muestras de ELSOC entre olas') %>% 
  kable_styling(full_width = F) %>% 
  kable_classic_2() %>% 
  add_header_above(c(" " = 1, 'Muestra original' = 2, 'Muestra refresco' = 2))

```


### Atrición acumulada según Sexo, Grupo etáreo, Nivel educacional y Estrato

Para el cálculo de atrición acumulada se considera el período 2016-2021 para la muestra original, y el período 2018-2021 para la muestra refresco

 - Según sexo:
 
```{r tabla-atricion-sexo}
elsoc_long_2016_2021 %>% 
  mutate(ola = ifelse(muestra == 2 & ola == 3, 1, ola)) %>% 
  filter(ola %in% c(1, 5)) %>% 
  as_label(m0_sexo) %>% 
  group_by(ola, muestra, m0_sexo) %>% 
  summarise(n = n()) %>% 
  group_by(muestra, m0_sexo) %>% 
  mutate(atricion = abs(n/lag(n) - 1)) %>%
  pivot_wider(names_from = muestra, values_from = c(n, atricion)) %>% 
  filter(ola == 5) %>% select(-ola) %>% 
  mutate(n_1 = scales::number(n_1),
         n_2 = scales::number(n_2),
         atricion_1 = scales::percent(atricion_1),
         atricion_2 = scales::percent(atricion_2)) %>% 
  select(m0_sexo, n_1, n_2, atricion_1, atricion_2) %>% 
  kbl(align = c('l', 'c', 'c', 'c', 'c'),
      col.name = c('Sexo', rep(c('Muestra original', 'Muestra refresco'), 2)),
      caption = 'Atrición acumulada de ELSOC, según sexo') %>% 
  kable_styling(full_width = F) %>% 
  kable_classic_2() %>% 
  add_header_above(c(" " = 1, 'Muestra lograda en 2021' = 2, 'Atrición acumulada' = 2))

```

 - Según grupo etáreo:

```{r tabla-atricion-edad}
elsoc_long_2016_2021 %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                      levels = 1:4,
                      labels = c('18-29', '30-49', '50-64', '65 o más')),
         ola = ifelse(muestra == 2 & ola == 3, 1, ola)) %>% 
  filter(ola %in% c(1, 5)) %>% 
  as_label(edadt) %>% 
  group_by(ola, muestra, edadt) %>% 
  summarise(n = n()) %>% 
  group_by(muestra, edadt) %>% 
  mutate(atricion = abs(n/lag(n) - 1)) %>%
  pivot_wider(names_from = muestra, values_from = c(n, atricion)) %>% 
  filter(ola == 5) %>% select(-ola) %>% 
  mutate(n_1 = scales::number(n_1),
         n_2 = scales::number(n_2),
         atricion_1 = scales::percent(atricion_1),
         atricion_2 = scales::percent(atricion_2)) %>% 
  select(edadt, n_1, n_2, atricion_1, atricion_2) %>% 
  kbl(align = c('l', 'c', 'c', 'c', 'c'),
      col.name = c('Grupo etáreo', rep(c('Muestra original', 'Muestra refresco'), 2)),
      caption = 'Atrición acumulada de ELSOC, según grupo etáreo') %>% 
  kable_styling(full_width = F) %>% 
  kable_classic_2() %>% 
  add_header_above(c(" " = 1, 'Muestra lograda en 2021' = 2, 'Atrición acumulada' = 2))

```

- Según nivel educacional:

```{r tabla-atricion-educ}
elsoc_long_2016_2021 %>% 
  filter(!m01 %in% c(-888, -999)) %>% 
  mutate(educ = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                       levels = 1:4,
                       labels = c("Basica", "Media", "Tecnica", "Universitaria")),
         ola = ifelse(muestra == 2 & ola == 3, 1, ola)) %>% 
  filter(ola %in% c(1, 5)) %>% 
  as_label(educ) %>% 
  group_by(ola, muestra, educ) %>% 
  summarise(n = n()) %>% 
  group_by(muestra, educ) %>% 
  mutate(atricion = abs(n/lag(n) - 1)) %>%
  pivot_wider(names_from = muestra, values_from = c(n, atricion)) %>% 
  filter(ola == 5) %>% select(-ola) %>% 
  mutate(n_1 = scales::number(n_1),
         n_2 = scales::number(n_2),
         atricion_1 = scales::percent(atricion_1),
         atricion_2 = scales::percent(atricion_2)) %>% 
  select(educ, n_1, n_2, atricion_1, atricion_2) %>% 
  kbl(align = c('l', 'c', 'c', 'c', 'c'),
      col.name = c('Nivel educacional', rep(c('Muestra original', 'Muestra refresco'), 2)),
      caption = 'Atrición acumulada de ELSOC, según nivel educacional') %>% 
  kable_styling(full_width = F) %>% 
  kable_classic_2() %>% 
  add_header_above(c(" " = 1, 'Muestra lograda en 2021' = 2, 'Atrición acumulada' = 2))

```

- Según estrato:

```{r tabla-atricion-estrato}

elsoc_long_2016_2021 %>% 
  mutate(estrato = factor(car::recode(estrato, recodes = "5:6=5"),
                       levels = 1:5,
                       labels = c("Santiago", "Valparaíso", "Concepción",
                                  "Ciudades\ngrandes", "Ciudades medianas\no pequeñas")),
         ola = ifelse(muestra == 2 & ola == 3, 1, ola)) %>% 
  filter(ola %in% c(1, 5)) %>% 
  as_label(estrato) %>% 
  group_by(ola, muestra, estrato) %>% 
  summarise(n = n()) %>% 
  group_by(muestra, estrato) %>% 
  mutate(atricion = abs(n/lag(n) - 1)) %>%
  pivot_wider(names_from = muestra, values_from = c(n, atricion)) %>% 
  filter(ola == 5) %>% select(-ola) %>% 
  mutate(n_1 = scales::number(n_1),
         n_2 = scales::number(n_2),
         atricion_1 = scales::percent(atricion_1),
         atricion_2 = scales::percent(atricion_2)) %>% 
  select(estrato, n_1, n_2, atricion_1, atricion_2) %>% 
  kbl(align = c('l', 'c', 'c', 'c', 'c'),
      col.name = c('Estrato', rep(c('Muestra original', 'Muestra refresco'), 2)),
      caption = 'Atrición acumulada de ELSOC, según estrato') %>% 
  kable_styling(full_width = F) %>% 
  kable_classic_2() %>% 
  add_header_above(c(" " = 1, 'Muestra lograda en 2021' = 2, 'Atrición acumulada' = 2))


```


### Foco en el cambio longitudinal

Radiografía del Cambio Social tiene como objetivo fundamental caracterizar la estabilidad y el cambio en opiniones, actitudes y conductas de los participantes a lo largo del tiempo, enfocándose en distintas dimensiones de la cohesión y conflicto en Chile. 

Para el logro de dicho objetivo, el presente reporte se centrará en un subconjunto de participantes del estudio: los 1.513 entrevistados y entrevistadas que participaron en las cinco olas de ELSOC (por lo tanto, todos son parte de la muestra original). Dicha submuestra será la base empírica de los hallazgos expuestos en las siguientes secciones. 

A continuación se describe a este grupo de participantes según los mismos atributos sociodemográficos (sexo, edad, educación y zona de residencia). 

Los resultados presentados a continuación incorporan el diseño muestral complejo de la encuesta, por lo que incorporan los ponderadores muestrales ajustados a población regional y sexo, según estrato y conglomerado muestral.


```{r graf-composicion-muestra, fig.cap='Composición de muestra longitudinal'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5) %>% 
  as_label(m0_sexo) %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                      levels = 1:4,
                      labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  mutate(educ = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                       levels = 1:4,
                       labels = c("Basica", "Media", "Tecnica", "Universitaria"))) %>%
  mutate(estrato = factor(car::recode(estrato, recodes = "5:6=5"),
                       levels = 1:5,
                       labels = c("Santiago", "Valparaíso", "Concepción",
                                  "Ciudades\ngrandes", "Medianas o\npequeñas"))) %>%
  prop_list(m0_sexo, edadt, educ, estrato, na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('m0_sexo', 'edadt', 'educ', 'estrato'),
                       labels = c('Sexo', 'Tramo de edad', 'Nivel educacional', 'Estrato'))) %>% 
  ggplot(aes(y = prop, x = fct_rev(value), fill = value,
             label = scales::percent(prop, .1))) +
  facet_wrap(.~name, scales = 'free_y') +
  theme_bw() + 
  geom_col(position = 'dodge2',
           fill = c(viridis(2, begin = .33, end = .66, direction = -1), 
                    viridis(4, end = .85, direction = -1), 
                    viridis(4, end = .85, direction = -1), 
                    viridis(5, end = .85, direction = -1))) +
  geom_text(position = position_dodge(.9), hjust = -0.1, size = 3) +
  coord_flip() +
  xlab(NULL) + 
  ylab(NULL) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) + 
  theme(legend.position = 'none')


```








<!--chapter:end:01-introduccion.Rmd-->


# Temas políticos

¿Cómo ha cambiado la sociedad en temas políticos?

## Identificación política

### ¿Cómo se posicionan políticamente los chilenos?

```{r graf-idpolitica, fig.cap='Identificación política (2021)'}
elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola == 5) %>%
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:5,
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  prop(x = pos_id, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, fill = pos_id, x = pos_id, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position= 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(direction = 1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge2(width = .9),
            size = 3) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
```



Entre 2016 y 2021 la identificación con la izquierda se ha mantenido estable (25,3% en 2021), mientras que 
el centro y la derecha han aumentado su participación (de 24,8% en 2016 a 36,1% en 2021, y de 14,1% a 17,5%, respectivament), en desmedro de la no identifiación política, que disminuyó de 35,8% a 19,3%.


```{r graf-idpolitica-ola, fig.cap='Identificación política, según ola del estudio'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1) %>%
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  prop(x = pos_id, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, fill = fct_rev(pos_id), x = ola, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position= 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c(rep('white', 3), rep('black', 2)), 5)) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) 

```


Aunque los porcentajes son relativamente estables, esconden una alta fluidez en la identificación con las diferentes posiciones políticas por año.


```{r graf-alluvial-idpolitica-ola, fig.cap = 'Cambios en la identificación política, según ola del estudio'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% 1:5) %>% 
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  as_label(ola) %>% 
  survey_design_elsoc() %>%
  svytable(~pos_id + ola + idencuesta, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola) %>% 
  mutate(prop = Freq/sum(Freq)) %>%
  filter(Freq > 0) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(pos_id), 
             stratum = fct_rev(pos_id), alluvium = idencuesta)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1) +
  geom_text(data = function(x) { group_by(.data = x, ola, pos_id) %>% 
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>% 
      ungroup()}, 
            aes(label = scales::percent(prop, accuracy = .1)),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 3,
            color = rep(c('white', 'white', 'white', 'black', 'black'), 5)) + 
  guides(fill = guide_legend(reverse = TRUE)) 


```

De manera consistente aproximadamente 48% de la población cambia su posición política cada año

```{r graf-cambios-idpolitica-ola, fig.cap = 'Cambios en identificación política, según ola'}
elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c15)) %>%
  mutate(c15 = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica"))) %>% 
  group_by(idencuesta) %>% 
  mutate(cambia = c15 != lag(c15),
         ola = factor(ola,
                      levels = 1:5,
                      labels = c('', '2016-2017', '2017-2018', '2018-2019', '2019-2021'))) %>% 
  ungroup() %>% 
  prop(cambia == TRUE, by = ola, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, label = scales::percent(prop, .1))) + 
  theme_bw() +
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) + 
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, option = 'viridis') +
  theme(legend.position = 'top') +
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que cambia su posición política en cada ola' )

```

El grupo político más estable (comparando posiciones politicas entre 2016 y 2021) es el de centro: 54,0% de quienes se posicionaban políticamente de Centro, lo hicieron también en 2021. En contraste, la No identificación política es la menos estable: solo 31,3% de quienes no se identificaban políticamente en 2016, lo hicieron también en 2021. Para la izquierda y la derecha, estos porcentajes son 47,8% y 47,6%, respectivamente. 


```{r graf-cambios-idpol-idpol, fig.cap = 'Cambios en identificación política entre 2016 y 2021'}

elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1) %>% 
  mutate(pos_id_w01 = factor(car::recode(c15_w01, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica", "NS/NR")),
         pos_id_w05 = factor(car::recode(c15_w05, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = c(1, 2, 3, 4, 5),
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica", "NS/NR"))) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(pos_id_w05, by = pos_id_w01) %>% 
  filter(pos_id_w01 != 'NS/NR') %>% 
  ggplot(aes(y = prop, x = pos_id_w01, fill = fct_rev(pos_id_w05),
             label = scales::percent(prop, accuracy = .1))) + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = 'Posición política en 2016') +
  scale_fill_viridis_d(direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c(rep('white', 3), rep('black', 2)), 4)) +
  theme(legend.position = 'right') +
  labs(fill = 'Posición política\nen 2021') + 
  guides(fill = guide_legend(reverse = TRUE))  

  
```

A mayor edad mayor estabilidad en la posición política entre años

```{r graf-cambios-idpolitica-edad, fig.cap = 'Cambios en identificación política, según grupo etáreo'}
elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c15_w01, c15_w04)) %>% 
  mutate(pos_id_w01 = factor(car::recode(c15_w01, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica")),
         pos_id_w05 = factor(car::recode(c15_w05, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:4,
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica")),
         cambia = pos_id_w01 != pos_id_w05,
         edadt_w05 = factor(car::recode(m0_edad_w05, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(cambia == TRUE, by = edadt_w05, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = edadt_w05, label = scales::percent(prop, .1))) + 
  theme_bw() +
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) + 
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, option = 'viridis') +
  theme(legend.position = 'top') +
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que cambia su posición política entre 2016 y 2021' )

```

### Interés en la política y participación ciudadana

```{r graf-interespolitica-ola, fig.cap = 'Interés en política, según ola del estudio'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c13)) %>% 
  prop(c13 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, group = 1,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75, color = viridis(1, .66)) + 
  geom_line(color = viridis(1, .66)) +
  geom_text_repel(nudge_y = .04, size = 3, color = 'black') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_color_viridis_d(end = .75, option = 'viridis') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(label = NULL,
          'Porcentaje Bastante o Muy interesado en la política')
  
```


```{r graf-participciudadana-ola, fig.cap = 'Participación ciudadana, según ola del estudio'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c08_02, c08_04, c14_01, c14_02)) %>%
  as_label(ola) %>% 
  prop_list(c08_02 %in% 4:5, c08_04 %in% 4:5, c14_01 %in% 4:5, c14_02 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c08_02 %in% 4:5', 'c08_04 %in% 4:5', 'c14_01 %in% 4:5', 'c14_02 %in% 4:5'),
                       labels = c('Asiste a marcha o\nmanifestación pacífica',
                                  'Usa RRSS para opinar\nde temas públicos',
                                  'Habla de política\ncon familiares',
                                  'Se informa\nsobre política'))) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  geom_text_repel(nudge_y = .025, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .7, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(color = guide_legend(reverse = TRUE)) +
  ggtitle(label = NULL,
          subtitle = 'Portaje que responde Frecuente o Muy frecuentemente')

```


```{r graf-idpolitica-interespolitica, fig.cap = 'Identificación política, según grado de interes en la política (2021)'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola == 5 & !c13 %in% c(-888, -999)) %>%
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:5,
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR")),
         interes = factor(car::recode(c13, "1 = 1; 2:3 = 2; 4:5 = 3"),
                          levels = 1:3,
                          labels = c('Nada interesado/a', 'Poco o algo\ninteresado/a', 'Bastante o muy\ninteresado/a'))) %>%
  prop(x = pos_id, by = interes, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, fill = fct_rev(pos_id), x = interes, 
             label = scales::percent(ifelse(prop < .005, NA, prop), accuracy = .1))) +
  theme_bw() + 
  geom_col(position= 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3,
            color = rep(c('white', 'white', 'white', 'black', 'black'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) + 
  ggtitle(label = NULL)

```

### Opinión en temas de discusión pública

```{r graf-temaspublicos-idpolitica, fig.cap = 'Acuerdo con temas de discusión pública, según posición política (2019-2021)'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% 4:5 & !is_nsnr(c15, c37_02, c37_04, c37_05)) %>% 
  as_label(ola) %>% 
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se\nidentifica"))) %>% 
  prop_list(c37_02 %in% 4:5, c37_04 %in% 4:5, c37_05 %in% 4:5, 
            by = c(ola, pos_id), na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c37_02 %in% 4:5', 'c37_04 %in% 4:5', 'c37_05 %in% 4:5'),
                       labels = c('Aborto debe ser legal\nbajo cualquier circunstancia',
                                  'Cada persona debiera\nasegurar su propia pensión', 
                                  'Se deberían tomar medidas más\ndrásticas para evitar inmigración'))) %>% 
  ggplot(aes(x = pos_id, y = prop, 
             label = scales::percent(prop, .1))) +
  facet_wrap(.~name) +
  geom_line(size = .7, color = viridis(1, begin = .44, end = .44)) +
  geom_point(aes(color = ola), size = 4) + 
  geom_point(color = 'black', size = 4, shape = 1) + 
  geom_text_repel(size= 3, nudge_x = .05, nudge_y = .033) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  scale_color_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde de acuerdo o muy de acuerdo') 

```




## Movimientos Sociales y Acciones Colectivas

### Ciclo de movilización política y estallido social

```{r graf-movsocial, fig.cap = '¿Cuál de los siguientes movimientos sociales más valora? (2019-2021)'}
elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% c(4,5) & !c20 %in% c(-888, -999)) %>%
  mutate(c20 = factor(c20, levels = 1:12,
                      labels = c('Estudiantil', 'Laboral', 'Ambiental',
                                 'Indigena', 'Diversidad sexual', 'Provida o Antiaborto',
                                 'Antidelincuencia', 'Feminista', 'Pensiones',
                                 'Estallido social\nde Octubre 2019', 'Otro', 'Ninguno'))) %>% 
  prop(x = c20, by = ola, na.rm = TRUE) %>% 
  group_by(c20) %>% 
  mutate(orden = mean(ifelse(ola == 5, prop, NA), na.rm = TRUE)) %>% 
  sjlabelled::as_label(ola) %>%
  ggplot(aes(y = prop, x = reorder(c20, orden), 
             label = scales::percent(prop, .1))) +
  geom_line(size = .7, color = viridis(1, begin = .44, end = .44)) +
  geom_point(aes(color = ola), size = 4) + 
  geom_point(color = 'black', size = 4, shape = 1) + 
  geom_text_repel(size= 3) +
  theme_bw() +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  scale_color_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  theme(legend.position = 'right',
        legend.title = element_blank()) + 
  coord_flip() + 
  guides(color = guide_legend(reverse = TRUE)) +
  ggtitle(label = NULL)

```

Clasificacindo los movimientos sociales en las categorías "Progresistas" y "Conservadores", se ve un claro aumento en la valoración de movimientos sociales progresistas. 

Los movimientos sociales que se clasifican como progresistas son:

- Movimiento social de apoyo a la causa estudiantil
- Movimiento social de apoyo a demandas laborales 
- Movimiento social de grupos ambientalistas
- Movimiento social de apoyo a las demandas indígena
- Movimiento social de apoyo a la diversidad sexual
- Movimiento feminista o de apoyo a la igualdad de género
- Movimiento por el cambio al sistema de pensiones
- Estallido social del 18 de Octubre de 2019

Mientras que los Conservadores: 

- Movimiento social provida o antiaborto
- Movimiento social antidelincuencia

```{r graf-movsociales-movsocial-olas, fig.cap = 'Movimiento social que más valora, Según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !c20 %in% c(-888, -999)) %>%
  mutate(movsoc = car::recode(c20, "1:5 = 1; 8:10 = 1; 6:7 = 2; 11:12 = 3"),
       movsoc = factor(movsoc, levels = 1:3,
                       labels = c('Mov. sociales progresistas', 'Mov. sociales conservadores', 'Ninguno'))) %>%
  dplyr::filter(!is.na(movsoc)) %>%
  prop(movsoc, by  = c(ola), na.rm = TRUE)  %>% 
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, color = movsoc, group = movsoc,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_line() + 
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .5, direction = -1, option = 'viridis') +
  geom_text_repel(nudge_y = .025) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
    ggtitle(label = NULL,
          subtitle = 'Movimientos sociales agrupados en 3 categorías')

```

```{r graf-particip_movsocial-olas, fig.cap='Participación en movimientos sociales valorados, según ola'}
elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra==1 & !c22 %in% c(-888, -999)) %>%
  prop(c22 %in% 4:5, by  = ola, na.rm = TRUE) %>%
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, group = 1, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_line(color = viridis(1)) +
  geom_point(size = 1.75, color = viridis(1)) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .25)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text_repel(color = viridis(1), size = 3, nudge_y = .01) + 
  theme(legend.position = 'none',   
        legend.title = element_blank()) + 
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que participa Frecuentemente o Muy frecuentemente')

```


```{r graf-particip_movsociales2-ola, fig.cap='Participación en movimientos sociales valorados, según ola'}
elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra==1 & !c22 %in% c(-888, -999) & !c20 %in% c(-888, -999)) %>%
  mutate(mov_soc = factor(car::recode(c20, "1:5 = 1; 6:7 = 2; 8:10 = 1; 11:12 = 3"),
                          levels = 1:3,
                          labels = c('Mov. sociales progresistas', 
                                     'Mov. sociales conservadores', 'Ninguno'))) %>%
  prop(c22 %in% 4:5, by  = c(ola, mov_soc), na.rm = TRUE) %>%
  sjlabelled::as_label(ola) %>%
  ggplot(aes(y = prop, x = ola, group = mov_soc, color = mov_soc,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.25)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .7, direction = -1, option = 'viridis') +
  geom_text_repel(color = viridis(1), size = 3) + 
  theme(legend.position = 'top',   
        legend.title = element_blank()) + 
  ggtitle(label = NULL,
          subtitle = 'Porcentaje que participa Frecuentemente o Muy frecuentemente')

```


## Justificación de la Violencia


### Justificación de la violencia para el control social

```{r graf-just_violencia1-ola, fig.cap='Justificación de la violencia a manos de ciudadanos, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% 1:4 &
           !f05_01 %in% c(-888, -999) & !f05_02 %in% c(-888, -999)) %>%  
  select(f05_01, f05_02, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(f05_01, f05_02)) %>% 
  prop(value %in% 4:5, by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('f05_01', 'f05_02'),
                       labels = c('Personas persigan y golpeen a un delincuente\n que acaba de cometer un asalto',
                                  'Personas amarren a un poste y desnuden a un\n delincuente que acaba de cometer un asalto'))) %>% 
sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, option = 'viridis') + 
  geom_text_repel(size = 3, nudge_y = .02) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde que Muchas veces o Siempre se justifica' )


```


```{r graf-just_violencia2-ola, fig.cap = 'Justificación de la violencia, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
           !f05_03 %in% c(-888, -999) & !f05_04 %in% c(-888, -999) & !f05_07 %in% c(-888, -999)) %>%  
  select(f05_03, f05_04, f05_07, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(f05_03, f05_04, f05_07)) %>% 
  prop(value %in% 4:5, by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('f05_03', 'f05_04', 'f05_07'),
                       labels = c('Carabineros use la fuerza para\n reprimir manifestación pacífica',
                                  'Carabineros desaloje a la fuerza\na estudiantes de liceo en toma',
                                  'Estudiantes tiren piedras a Carabi-\nneros en marcha por la educación'))) %>%
  sjlabelled::as_label(ola) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .7, option = 'viridis') + 
  ggrepel::geom_text_repel(size = 3, nudge_y = .02) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
        subtitle = 'Porcentaje que responde que Muchas veces o Siempre se justifica' )

```


## Confianza interpersonal y en instituciones

### Confianza interpersonal

```{r graf-confianza_interpersonal-ola, fig.cap = 'Confianza interpersonal, según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c02, c04)) %>% 
  as_label(ola) %>% 
  prop_list(c02 == 1, c04 == 2, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c02 == 1', 'c04 == 2'),
                       labels = c('Casi siempre se puede\nconfiar en las personas',
                                  'La mayoría de las personas\ntratan de ser justas'))) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_text_repel(nudge_y = .025, size = 3, color = 'black') +
  geom_point(size = 1.75) + 
  geom_line() + 
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, option = 'viridis') +
  theme(axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde que...')

```


```{r graf-confianza_interpersonal-educ, fig.cap = 'Confianza interpersonal (2021), según nivel educacional'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1, ola == 5, !is_nsnr(c02, c04, m01)) %>% 
  mutate(educ = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                       levels = 1:4,
                       labels = c("Basica", "Media", "Tecnica", "Universitaria"))) %>% 
  prop_list(c02 == 1, c04 == 2, by = educ, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c02 == 1', 'c04 == 2'),
                       labels = c('Casi siempre se puede\nconfiar en las personas',
                                  'La mayoría de las personas\ntratan de ser justas'))) %>% 
  ggplot(aes(y = prop, fill = educ, x = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') + 
  geom_text(position = position_dodge(.9),
            vjust = -.5,
            size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .85, option = 'viridis') +
  theme(axis.text.x = element_text(size = rel(.9)),
        legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde que...')

```

```{r graf-conf_instituciones1-ola, fig.cap = 'Grado de confianza en instituciones, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c05_01, c05_07, c05_08)) %>% 
  as_label(ola) %>% 
  prop_list(c05_01 %in% 4:5, c05_07 %in% 4:5, c05_08 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c05_01 %in% 4:5', 'c05_07 %in% 4:5', 'c05_08 %in% 4:5'),
                       labels = c('Presidente/a de la Republica', 'Congreso Nacional', 'Gobierno de Chile'))) %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
               label = scales::percent(prop, accuracy = .1))) +
    theme_bw() +  
    geom_line() +
    geom_point(size = 1.75) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,.5)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .1, end = .66, option = 'viridis') +
    geom_text_repel(size = 3, nudge_y = .02, color = 'black') +
    theme(legend.position = 'top',
          legend.title = element_blank())  + 
  ggtitle(NULL,
          subtitle = 'Porcentaje que Confía Bastante o Mucho')

```

```{r graf-conf_instituciones2-ola, fig.cap = 'Grado de confianza en instituciones, según ola'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c05_02, c05_03, c05_05)) %>% 
  as_label(ola) %>% 
  prop_list(c05_02 %in% 4:5, c05_03 %in% 4:5, c05_05 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name, 
                       levels = c('c05_02 %in% 4:5', 'c05_03 %in% 4:5', 'c05_05 %in% 4:5'),
                       labels = c('Partidos Políticos', 
                                  'Carabineros de Chile', 
                                  'Poder Judicial'))) %>%
  ggplot(aes(y = prop, x = ola, color = name, group = name,
               label = scales::percent(prop, accuracy = .1))) +
    theme_bw() +  
    geom_line() +
    geom_point(size = 1.75) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,.5)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .1, end = .66, option = 'viridis') +
    geom_text_repel(size = 3, nudge_y = .02, color = 'black') +
    theme(legend.position = 'top',
          legend.title = element_blank()) + 
    ggtitle(NULL,
          subtitle = 'Porcentaje que Confía Bastante o Mucho')


```


```{r graf-cambio-confianza_instituciones-ola, fig.cap = 'Cambio en grado de confianza en instituciones (2016-2021)'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(c05_01, c05_02, c05_03, c05_05, c05_07, c05_08),
         ola %in% c(1, 5)) %>% 
  as_label(ola) %>% 
  prop_list(c05_01 %in% 4:5, c05_02 %in% 4:5, c05_03 %in% 4:5, c05_05 %in% 4:5, c05_07 %in% 4:5, c05_08 %in% 4:5, by = ola, na.rm = TRUE) %>%
  mutate(name = factor(name, 
                       levels = c('c05_01 %in% 4:5', 'c05_02 %in% 4:5', 
                                  'c05_03 %in% 4:5', 'c05_05 %in% 4:5',
                                  'c05_07 %in% 4:5', 'c05_08 %in% 4:5'),
                       labels = c('Presidente/a de\nla Republica', 'Partidos Políticos', 
                                  'Carabineros de Chile', 'Poder Judicial',
                                  'Congreso Nacional', 'Gobierno de Chile'))) %>%
  group_by(name) %>% 
  mutate(orden = mean(ifelse(ola == '2021', prop, NA), na.rm = TRUE)) %>% 
  ungroup() %>% 
  ggplot(aes(y = prop, x = reorder(name, orden), 
             label = scales::percent(prop, .1))) +
  geom_line(size = .7, color = viridis(1, begin = .44, end = .44)) +
  geom_point(aes(color = ola), size = 4) + 
  geom_point(color = 'black', size = 4, shape = 1) + 
  geom_text_repel(size= 3, nudge_x = .02) +
  coord_flip() +
  theme_bw() +
  scale_y_continuous(labels = scales::percent, limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) + 
  scale_color_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  theme(legend.position = 'right',
        legend.title = element_blank()) + 
  guides(color = guide_legend(reverse = TRUE)) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que Confía Bastante o Mucho')

```




## Actitudes hacia la democracia

```{r graf-preferencia_democracia-ola, fig.cap = 'Preferencia por y satisfacción con la democracia, según ola'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c01, c25)) %>% 
  as_label(ola) %>% 
  prop_list(c01 %in% 4:5, c25 == 1, by  = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c25 == 1', 'c01 %in% 4:5'),
                       labels = c('Prefiero la democracia sobre\ncualquier otra forma de gobierno', 'Satisfecho o Muy satisfecho\ncon la democracia'))) %>% 
  ggplot(aes(y = prop, x = ola, group = name, color = name,
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) +
  geom_line() + 
  geom_text_repel(size = 3, nudge_y = .025) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',   
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde...')

```

```{r graf-preferencia_democracia-idpolitica, fig.cap = 'Preferencia por y satisfacción con la democracia (2021), según posición ideológica'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola == 5 & !is_nsnr(c01, c25, c15)) %>% 
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>% 
  as_label(ola) %>% 
  prop_list(c01 %in% 4:5, c25 == 1, by  = pos_id, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c25 == 1', 'c01 %in% 4:5'),
                       labels = c('Prefiero la democracia sobre\ncualquier otra forma de gobierno', 'Satisfecho o Muy satisfecho\ncon la democracia'))) %>% 
  ggplot(aes(y = prop, x = pos_id, fill = name,
               label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~name) +
  theme_bw() + 
  geom_col(position = 'dodge2') + 
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) + 
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'none') +
  ggtitle(NULL,
        subtitle = 'Porcentaje que responde...')

```

```{r graf-preferencia_democracia2-idpolitica, fig.cap = 'Preferencia por la democracia (2021), según posición ideológica'}

elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !is_nsnr(c25, c15) & ola == 5) %>%
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                     levels = 1:4,
                     labels = c('Izquierda', "Centro", "Derecha", "No se identifica")),
         c25 = factor(c25, 
                      levels = 1:4,
                      labels = c('Democracia es preferible\na cualquier otra forma\nde gobierno', 
                                 'En algunos casos,\n gobierno autoritario puede\n ser preferible',
                                 'Da lo mismo régimen\ndemocrático o autoritario', 
                                 'Ninguna'))) %>%
  prop(x = c25, by = pos_id, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = pos_id, fill = fct_rev(c25), 
             label = scales::percent(ifelse(prop < .01, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle(NULL,
        subtitle = 'Porcentaje que responde...')

```




## Cambio constitucional


```{r graf-particip_elect-ola, fig.cap = 'Participación electoral, según elección'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5) & !is_nsnr(c15, c11, c43, values = c(3, -888, -999))) %>% 
  mutate(particip_electoral = ifelse(ola == 5, c43, c11)) %>% 
  prop(particip_electoral == 1, by = ola, na.rm = TRUE) %>%
  mutate(ola = factor(ola, 
                      levels = c(1,3,5), 
                      labels = c('Elecciones Presidenciales\nde 2013', 
                                 'Elecciones Presidenciales\nde 2017', 
                                 'Plebiscito cambio\nconstitucional'))) %>% 
  ggplot(aes(y = prop, x = ola, label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_col(fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que votó en...')

```


```{r graf-servel-apruebo, fig.cap='Voto retrospectivo Plebiscito Nueva Constitucion'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c44 %in% c(3, 4, -888, -999)& !is.na(c44)) %>% 
  prop(c44, na.rm = TRUE) %>% 
  sjlabelled::as_label(c44) %>%
  mutate(datos = 'Datos ELSOC') %>%
  add_row(c44 = c('Apruebo', 'Rechazo'), 
          prop = c(.7828, .2172), 
          datos = c('Datos servel', 'Datos servel')) %>%
  ggplot(aes(y = prop, x = c44, fill = datos, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

```


```{r graf-particip_elect-olas-edad, fig.cap = 'Participación electoral, según tramo de edad'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1,3,5) & !is_nsnr(c15, c11, c43, values = c(3, -888, -999))) %>% 
  mutate(particip_electoral = ifelse(ola == 5, c43, c11),
         edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                        levels = 1:4,
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  prop(particip_electoral == 1, by = c(ola, edadt), na.rm = TRUE) %>%
  mutate(ola = factor(ola, 
                      levels = c(1,3,5), 
                      labels = c('Elecciones Presidenciales\nde 2013', 
                                 'Elecciones Presidenciales\nde 2017', 
                                 'Plebiscito cambio\nconstitucional'))) %>%  
  ggplot(aes(y = prop, x = ola, color = edadt, group = edadt,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +
  geom_point(size = 1.75) +
  geom_line() +
  geom_text_repel(size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que votó en...')

```


```{r graf-voto_plebiscito-idpolitica, fig.cap = 'Voto en plebiscito de 2020, según identificación política'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1 & !is_nsnr(c15, c43, c44)) %>% 
  mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica")),
         voto2020 = case_when(c43 %in% 2:3 ~ 5,
                              TRUE ~ c44),
         voto2020 = factor(car::recode(voto2020, '3:4 = 5'),
                          levels = c(1:2, 5),
                          labels = c('Apruebo', 'Rechazo', 'No votó o votó\nBlanco o Nulo'))) %>% 
  prop(voto2020, by = pos_id, na.rm = TRUE) %>%
  ggplot(aes(y = prop, x = pos_id, fill = fct_rev(voto2020),
             label = scales::percent(ifelse(prop < .02, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .7, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'white', 'white'), 4)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que voto...')

```

```{r graf-voto-votoprevio, fig.cap = 'Voto en plebiscito de 2020, según voto en elecciones previas'}

elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1, !is_nsnr(c11_w01, c11_w03, c43_w05, values = c(3, -888, -999))) %>% 
  mutate(votos = factor(case_when(c11_w01 != 1 & c11_w03 != 1 ~ 1,
                                  c11_w01 == 1 & c11_w03 != 1 ~ 2,
                                  c11_w01 != 1 & c11_w03 == 1 ~ 3,
                                  c11_w01 == 1 & c11_w03 == 1 ~ 4),
                        labels = c('No votó en elecciones\nde 2013 ni de 2017',
                                   'Votó en 2013,\npero no en 2017',
                                   'Votó en 2017,\npero no en 2013',
                                   'Votó en 2013 y 2017')),
         voto2020 = case_when(c43_w05 %in% 2:3 ~ 5,
                              TRUE ~ c44_w05),
         voto2020 = factor(car::recode(voto2020, '3:4 = 5'),
                          levels = c(1:2, 5),
                          labels = c('Apruebo', 'Rechazo', 'No votó o votó\nBlanco o Nulo'))) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(voto2020, by = votos, na.rm = TRUE) %>%
  ggplot(aes(y = prop, x = votos, fill = fct_rev(voto2020),
             label = scales::percent(ifelse(prop < .02, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .7, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'white', 'white'), 4)) +
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```



```{r graf-voto-votopresi, fig.cap= "Voto en plebiscito de 2020, según voto en elección presidencial de 2017"}

elsoc_wide_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1 & !is_nsnr(c11_w03, c39_w03, c43_w05, c44_w05)) %>% 
  mutate(voto2017 = case_when(c11_w03 %in% 2:3 ~ 11,
                               TRUE ~ c39_w03),
         voto2017 = factor(car::recode(voto2017, '9:10 = 9'),
                           levels = c(1:9, 11),
                           labels = c('Goic', 'Kast', 'Piñera', 'Guillier', 'Sánchez', 'Enríquez-\nOminami', 'Artés', 'Navarro', 'Blanco\no Nulo', 'No votó')),
         voto2020 = case_when(c43_w05 %in% 2:3 ~ 5,
                              TRUE ~ c44_w05),
         voto2020 = factor(car::recode(voto2020, '3:4 = 3'),
                          levels = c(1:3, 5),
                          labels = c('Apruebo', 'Rechazo', 'Blanco\no Nulo', 'No votó'))) %>%
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(voto2020, by = voto2017, na.rm = TRUE) %>%
  dplyr::right_join(tidyr::expand(., voto2020, voto2017)) %>% 
  mutate(prop = ifelse(is.na(prop), 0, prop)) %>% 
  group_by(voto2017) %>% 
  mutate(orden = max(ifelse(voto2020 == 'Apruebo', prop, 0))) %>% 
  arrange(voto2017, voto2020) %>% 
  ggplot(aes(y = prop, x = reorder(voto2017, desc(orden)), fill = fct_rev(voto2020), 
             label = scales::percent(ifelse(prop < .02, NA, prop), accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = 'Voto en elección presidencial de 2017') +
  scale_fill_viridis_d(end = .7, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, na.rm = TRUE,
            color = rep(c('black', 'white', 'white', 'white'), 10)) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

## Optimismo constitucional

```{r graf-optimismo_constitucional, fig.cap = 'Optimismo constitucional'}
elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, !is_nsnr(c46_01, c46_02, c46_03, c46_04)) %>% 
  prop_list(c46_01 %in% 4:5, c46_02 %in% 4:5, c46_03 %in% 4:5, c46_04 %in% 4:5, na.rm = TRUE) %>% 
  mutate(name  =factor(name,
                     levels = c('c46_01 %in% 4:5', 'c46_03 %in% 4:5', 'c46_04 %in% 4:5', 'c46_02 %in% 4:5'),
                     labels = c('Reducirá la desigualdad\n en salud y educación',
                                'Reducirá la corrupción',
                                'Tendrá poco impacto en\nla calidad de vida',
                                'Empeorará condiciones\n económicas'))) %>%
  ggplot(aes(x = name, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(fill = viridis::viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  ggtitle(NULL,
        subtitle = 'Porcentaje De acuerdo o Muy de acuerdo con: "La nueva constitución..."')

```

```{r graf-optimismo_constitucional-voto_plebiscito, fig.cap = 'Optimismo constitucional, según voto en plebiscito de 2020'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, 
         !is_nsnr(c46_01, c46_02, c46_03, c46_04),
         !is_nsnr(c43, c44)) %>% 
  mutate(voto2020 = case_when(c43 %in% 2:3 ~ 3,
                              TRUE ~ c44),
         voto2020 = factor(car::recode(voto2020, '3:4 = 3'),
                          levels = 1:3,
                          labels = c('Apruebo', 'Rechazo', 'No votó o votó\nblanco/nulo')),
         c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  prop(optimismo >= 4, by = voto2020, na.rm = TRUE) %>% 
  ggplot(aes(x = voto2020, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(position = 'dodge2', fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
        subtitle = 'Porcentaje de acuerdo o muy de acuerdo en promedio con atributos positivos')

```


```{r optimismo-democracia}

optimistas <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, !is_nsnr(c46_01, c46_02, c46_03, c46_04)) %>% 
  mutate(c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  mutate(optimista = factor(optimismo >= 4,
                            levels = c(TRUE, FALSE),
                            labels = c('Optimista', 'No optimista'))) %>% 
  select(idencuesta, optimismo, optimista)
  

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, !is_nsnr(c46_01, c46_02, c46_03, c46_04), !is_nsnr(c25, c15)) %>%
  left_join(optimistas, by = 'idencuesta') %>% 
  filter(!is.na(optimista)) %>% 
  mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4; c(-888, -999) = 5"),
                         levels = 1:5,
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica", "NS/NR"))) %>%
  as_label(ola) %>% 
  prop(c25 == 1, by = c(ola, optimista, pos_id), na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = ola, group = optimista, color = optimista,
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_point(size = 1.75) +
  facet_wrap(.~pos_id) +
  geom_line() + 
  geom_text_repel(size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',   
        legend.title = element_blank()) +
  ggtitle(NULL,
          subtitle = 'Porcentaje que responde...')

```

```{r graf-optimismo_constitucional-educ, fig.cap = 'Optimismo constitucional, según nivel educacional'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, 
         !is_nsnr(c46_01, c46_02, c46_03, c46_04),
         !is_nsnr(m01)) %>% 
  mutate(educ = factor(car::recode(m01, recodes = "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                   levels = 1:4,
                   labels = c("Basica", "Media", "Tecnica", "Universitaria")),
         c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  prop(optimismo >= 4, by = educ, na.rm = TRUE) %>% 
  ggplot(aes(x = educ, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(position = 'dodge2', fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
        subtitle = 'Porcentaje de acuerdo o muy de acuerdo en promedio con atributos positivos')


```


```{r graf-optimismo_constitucional-idpolitica, fig.cap = 'Optimismo constitucional, según identificación política'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5, 
         !is_nsnr(c46_01, c46_02, c46_03, c46_04),
         !is_nsnr(c15)) %>% 
    mutate(pos_id = factor(car::recode(c15, "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                       levels = 1:4,
                       labels = c('Izquierda', "Centro", "Derecha", "No se identifica")),
         c46_02 = 6 - c46_02,
         c46_04 = 6 - c46_04) %>% 
  rowwise() %>% 
  mutate(optimismo = mean(c46_01 , c46_02, c46_03, c46_04, na.rm = TRUE)) %>% 
  ungroup() %>% 
  prop(optimismo >= 4, by = pos_id, na.rm = TRUE) %>% 
  ggplot(aes(x = pos_id, y = prop,
             label = scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1))) +
  theme_bw() +
  geom_col(position = 'dodge2', fill = viridis(1, begin = .33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  theme_bw()+
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle(NULL,
        subtitle = 'Porcentaje de acuerdo o muy de acuerdo en promedio con atributos positivos')

```



<!--chapter:end:02-temas-politicos.Rmd-->


# Temas de salud mental y bienestar

## Salud mental y bienestar de la población

### ¿Cómo ha cambiado la salud mental y nivel de bienestar de la población?

```{r}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !is_nsnr(s01, s02, s03)) %>% 
  sjlabelled::as_label(ola) %>%
  prop_list(s01 %in% 4:5, s02 %in% 4:5, s03 %in% 4:5, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('s01 %in% 4:5', 's02 %in% 4:5', 's03 %in% 4:5'),
                       labels = c('Esta satisfecho o muy\nsatisfecho con su vida',
                                  'Su vida se acerca o se acerca\ncompletamente a su ideal',
                                  'Su salud es muy buena\no Excelente'))) %>% 
  ggplot(aes(y = prop, x = ola, group = name, color = name,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  geom_text_repel(nudge_y = .025, size = 3, color = 'black') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_color_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Satisfacción con la vida y salud subjetiva, según ola',
          'Porcentaje que responde que...')

```

```{r}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1, 3, 5) & !is_nsnr(s04, s08, s09)) %>% 
  sjlabelled::as_label(ola) %>%
  prop_list(s04 %in% 1:4, s08 == 0, s09 == 2, by = ola, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('s04 %in% 1:4', 's08 == 0', 's09 == 2'),
                       labels = c('Practica deporte o actividad física\nmás de 1 o 2 veces por semana',
                                  'No fuma regularmente',
                                  'No consume alcohol\nregularmente'))) %>% 
  ggplot(aes(y = prop, x = ola, group = name, color = name,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  geom_text_repel(nudge_y = .025, size = 3, color = 'black') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_color_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Conducta saludable, según ola',
          'Porcentaje que responde que...')

```


```{r}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1, 3, 5) & !is_nsnr(s04, s08, s09)) %>% 
  sjlabelled::as_label(ola) %>%
  mutate(suma = 4 - (s04 %in% 1:4) - (s08 == 0) - (s09 == 2)) %>% 
  prop(suma, by = ola, na.rm = TRUE) %>% 
  mutate(conducta_saludable = 
           factor(suma, levels = 1:4,
                  labels = c('Practica deporte, y\nno fuma, ni consume\nalcohol regularmente',
                             'Realiza 1 de 3\nconductas no\nsaludables',
                             'Realiza 2 de 3\nconductas no\nsaludables',
                             'No practica deporte,\nfuma y consume\nalcohol regularmente'))) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(conducta_saludable),
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col() +
  geom_text(position = position_stack(vjust = .5), 
            color = rep(rep(c('black', 'white'), each = 2), 3),
            size = 3) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_fill_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Conducta saludable, según ola',
          'Porcentaje que responde que...') +
  guides(fill = guide_legend(reverse = TRUE))

```


```{r}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1,
         !is_nsnr(s01, s02, s03) & !is_nsnr(s04, s08, s09),
         ola == 5) %>% 
  sjlabelled::as_label(ola) %>%
  mutate(suma = 4 - (s04 %in% 1:4) - (s08 == 0) - (s09 == 2),
         conducta_saludable = 
           factor(suma, levels = 1:4,
                  labels = c('Practica deporte, y\nno fuma, ni consume\nalcohol regularmente',
                             'Realiza 1 de 3\nconductas no\nsaludables',
                             'Realiza 2 de 3\nconductas no\nsaludables',
                             'No practica deporte,\nfuma y consume\nalcohol regularmente'))) %>% 
  prop_list(s01 %in% 4:5, s02 %in% 4:5, s03 %in% 4:5, 
            by = conducta_saludable, na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('s01 %in% 4:5', 's02 %in% 4:5', 's03 %in% 4:5'),
                       labels = c('Esta satisfecho o muy\nsatisfecho con su vida',
                                  'Su vida se acerca o se acerca\ncompletamente a su ideal',
                                  'Su salud es muy buena\no Excelente'))) %>% 
  ggplot(aes(y = prop, x = conducta_saludable, group = name, color = name,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_point(size = 1.75) + 
  geom_line() +
  geom_text_repel(nudge_y = .025, size = 3, color = 'black') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_color_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Satisfacción con la vida y salud subjetiva, según conducta saludable (2021)',
          'Porcentaje que responde que...')

```

### Sintomatología depresiva

```{r depre-wave, echo=FALSE, fig.align='center'}
elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o Minima', 'Depresion Media', 'Depresion Moderada', 'Depresion Moderada-Severa\na Severa'))) %>%
  dplyr::filter(tipo_atricion == 1) %>% 
  prop(depr, by = c(ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(depr, ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(depr), 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size = 3, 
            color = rep(rep(c('black', 'white'), each = 2), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE)) +
  ggtitle('Síntomas de depresión, según ola')

```


```{r depre-sexo, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  dplyr::filter(tipo_atricion == 1 & ola %in% c(1, 5)) %>% 
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(phq9, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"),
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o\nmínima', 'Depresion media', 
                                  'Depresion moderada', 'Depresion moderada-severa\no Depresión severa'))) %>% 
  as_label(ola) %>% 
  survey_design_elsoc() %>%
  svytable(~depr + ola + idencuesta, design = .) %>% 
  as.data.frame() %>% 
  group_by(ola) %>% 
  mutate(prop = Freq/sum(Freq)) %>%
  filter(Freq > 0) %>% 
  ggplot(aes(y = prop, x = ola, fill = fct_rev(depr), 
             stratum = fct_rev(depr), alluvium = idencuesta)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0, width = .55) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(direction = -1, end = .9) +
  geom_text(data = function(x) { group_by(.data = x, ola, depr) %>%
      summarise(prop = sum(prop, na.rm = TRUE), idencuesta = 1) %>%
      ungroup()}, 
      aes(label = scales::percent(prop, accuracy = .1)),
      position = position_stack(vjust = .5),
      show.legend = FALSE,
      color = rep(c('white', 'white', 'black', 'black'), 2),
            size = 3) + 
  guides(fill = guide_legend(reverse = TRUE)) + 
  ggtitle(label = 'Cambios en síntomas depresivos entre 2016 y 2021')

            
```


```{r depre-year-sexo, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>% 
  dplyr::filter(tipo_atricion == 1 & muestra == 1) %>% 
  prop(phq9>=10, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, m0_sexo) %>% 
  ggplot(aes(y = prop, x = ola, 
                   color = m0_sexo, group = m0_sexo,
              label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3, nudge_y = .025) + 
  theme(legend.position = 'top',
        legend.title = element_blank())  + 
  ggtitle(label = 'Síntomas depresivos, según sexo', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')
 
```

```{r depre-edad-sexo, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  dplyr::filter(ola %in% c(1, 5) & tipo_atricion == 1 & muestra == 1) %>% 
  prop(phq9 >= 10, by = c(ola, edadt), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, edadt) %>% 
  ggplot(aes(y = prop, x = edadt, 
                   group = ola, color = ola,
                   label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line() +
  geom_point(size = 1.75) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) + 
  theme(legend.position = 'top',
        legend.title = element_blank())  + 
  ggtitle(label = 'Síntomas depresivos, según tramo de edad y ola del estudio', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```


```{r}


elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>% 
  dplyr::filter(tipo_atricion == 1 & muestra == 1 & ola == 5,
                !is_nsnr(s01, s02, s03) & !is_nsnr(s04, s08, s09)) %>% 
  mutate(suma = 4 - (s04 %in% 1:4) - (s08 == 0) - (s09 == 2),
         conducta_saludable = 
           factor(suma, levels = 1:4,
                  labels = c('Practica deporte, y\nno fuma, ni consume\nalcohol regularmente',
                             'Realiza 1 de 3\nconductas no\nsaludables',
                             'Realiza 2 de 3\nconductas no\nsaludables',
                             'No practica deporte,\nfuma y consume\nalcohol regularmente'))) %>% 
  prop(phq9 >= 10, by = conducta_saludable, na.rm = TRUE) %>% 
  ggplot(aes(y = prop, x = conducta_saludable,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2', fill = viridis(1, begin =.33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +  
  scale_color_viridis_d(end = .75, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle(label = 'Síntomas depresivos, según conducta saludable (2021)', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```

```{r depre-labstat, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>%
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1, 2, 3, 4, 5),
                           labels = c("Trabajo remunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otras categorías"))
         ) %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & muestra == 1 & !m02 %in% c(-888, -999)) %>% 
  prop(phq9 >= 10, by = sit_ocup) %>% 
  ggplot(aes(y = prop, x = sit_ocup, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2', fill = viridis(1, begin =.33)) +
  geom_text(position = position_dodge(.9), vjust = -.5, size = 3) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank())  +
  ggtitle(label = 'Síntomas depresivos, según categoría ocupacional (2021)', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```

En 2021 no hay hombres en la categoría Trabajo doméstico no remunerado $^{*}$






## COVID - 19


```{r covid-sexo, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5, tipo_atricion == 1 & !is_nsnr(s31) & !is_nsnr(r03_09)) %>%
  prop_list(s31 == 1, r03_09 > 1, na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('s31 == 1', 'r03_09 > 1'),
                       labels = c('Fue diagnosticado con COVID-19',
                                  'Tiene al menos un conocido/a que\nfue diagnosticado con COVID-19'))) %>% 
  ggplot(aes(y = prop, x = name, fill = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Cercanía de contagio de covid',
          'Porcentaje que...')

```

```{r depre clase.sub, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5, tipo_atricion == 1,
                !is_nsnr(s31, r03_09, d01_01) & !is.na(d01_01)) %>%
  mutate(clase.sub = factor(car::recode(d01_01, "0:4 = 1; 5 = 2; 6:10 = 3"),
                            levels = 1:3,
                            labels = c('Baja y Media baja', 'Media', 'Media y Media alta'))) %>% 
  prop_list(s31 == 1, r03_09 > 1, by = clase.sub, na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('s31 == 1', 'r03_09 > 1'),
                       labels = c('Fue diagnosticado con COVID-19',
                                  'Tiene al menos un conocido/a que\nfue diagnosticado con COVID-19'))) %>%
  ggplot(aes(y = prop, x = name, fill = clase.sub,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .75, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Cercanía de contagio de covid, según clase social subjetiva (2021)',
          'Porcentaje que...')

```


```{r, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5, tipo_atricion == 1 & !is_nsnr(r03_09)) %>%
  mutate(r03_09 = factor(car::recode(r03_09, "4:7 = 4"),
                         levels = 1:4,
                         labels = c('No conoce a nadie que haya\nsido diagnosticado con COVID-19', 
                                    'Conoce a 1', 'Conoce entre 2 y 4', 'Conoce a 5 o más'))) %>% 
  prop(r03_09, na.rm = TRUE) %>% 
  as_label(r03_09) %>% 
  ggplot(aes(y = prop, x = r03_09, fill = r03_09,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Distribución de los encuestados,\nsegún número de conocidos que han sido diagnosticados de covid (2021)')

```

### Cuarentenas

```{r hist-fecha-2021, fig.align='center'}
elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5) %>% 
  mutate(fecha = make_date(year = annio_entr, month = mes_entr, day = dia_entr),
         semana = lubridate::week(fecha)) %>% 
  group_by(semana) %>% 
  summarise(n = n()) %>%
  mutate(fecha = make_date(year = 2021, month = 1, day = 1) + 7*semana) %>% 
  ggplot(mapping = aes(y = n, x = fecha)) +
  theme_bw() +
  geom_col(fill = viridis(1, begin = .33)) +
  scale_y_continuous(limits = c(0,400)) + 
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_x_date(date_labels = "%d-%m",
               date_breaks = '2 weeks') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle('¿Cuándo fueron encuestados los entrevistado? (2021)',
          'Frecuencia de encuestas, según fecha')

```

```{r}
elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1) %>% 
  left_join(elsoc_long_cuarentenas, by = c('idencuesta', 'ola')) %>% 
  mutate(cuarentena_acum.30t = factor(car::recode(cuarentena_acum.30, "0 = 1; 1:14 = 2; 15:21 = 3; 22:30 = 4"),
                                 levels = 1:4,
                                 labels = c('0 días', '1-14 días', '15-21 días', '22-30 días'))) %>% 
  prop(cuarentena_acum.30t) %>% 
  ggplot(aes(y = prop, x = cuarentena_acum.30t, fill = cuarentena_acum.30t,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Días acumulados en cuarentena, el mes previo a la encuesta',
          'Distribución de los encuestados, según días en cuarentena')

```

```{r}

elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1, !is_nsnr(m60)) %>% 
  prop(m60, na.rm = TRUE) %>% 
  mutate(m60 = factor(m60, levels = 1:3,
                      labels = c('Trabajo de manera\ncompleta desde el hogar',
                                 'Trabajo de manera\n parcial en el hogar',
                                 'Trabajo fuera del hogar'))) %>% 
  ggplot(aes(y = prop, x = m60, fill = m60,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.5,
            position = position_dodge(width = .9),
            size = 3)  + 
  theme(legend.position = 'none') + 
  ggtitle('Trabajo remoto (2021)',
          'Porcentaje que trabaja en modalidad...')

```


```{r}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1, ola == 5) %>%
  left_join(elsoc_long_cuarentenas, by = c('idencuesta', 'ola')) %>%
  mutate(cuarentena_acum.30t = factor(car::recode(cuarentena_acum.30, "0 = 1; 1:14 = 2; 15:21 = 3; 22:30 = 4"),
                                 levels = 1:4,
                                 labels = c('0 días', '1-14 días', '15-21 días', '22-30 días'))) %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>%
  prop(phq9 >= 10, by = cuarentena_acum.30t, na.rm = TRUE) %>% 
  as_label(ola) %>% 
  ggplot(aes(y = prop, x = cuarentena_acum.30t, fill = cuarentena_acum.30t,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_fill_viridis_d(begin = 0, end = .85, option = 'viridis') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  geom_text(position = position_dodge(.9),
            vjust = -.5,
            size = 3) +
  theme(legend.position = 'none') +
  ggtitle(label = 'Síntomas depresivos, según días de cuarentena', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```

```{r}
elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1, !is_nsnr(m60) & !is.na(m60)) %>% 
  mutate(m60 = factor(m60, levels = 1:3,
                      labels = c('Trabajo de manera\ncompleta desde el hogar',
                                 'Trabajo de manera\n parcial en el hogar',
                                 'Trabajo fuera del hogar'))) %>%
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(phq9 = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>%
  prop(phq9 >= 10, by = m60, na.rm = TRUE) %>% 
  as_label(ola) %>% 
  ggplot(aes(y = prop, x = m60, fill = m60,
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent, limits = c(0,1)) +
  scale_fill_viridis_d(begin = 0, end = .85, option = 'viridis') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  geom_text(position = position_dodge(.9),
            vjust = -.5,
            size = 3) +
  theme(legend.position = 'none') +
  ggtitle(label = 'Síntomas depresivos, según modalidad de trabajo', 
          'Porcentaje con sintomas de depresión moderada, moderada-severa o severa')

```



### Grado de acuerdo con actividad económica versus salud pública según identificación política el año 2021

```{r}

elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1 & 
           !c37_09 %in% c(-888, -999) & !c15 %in% c(-888, -999)) %>% 
    mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(c37_09 %in% 4:5, pos_id, na.rm = TRUE) %>% 
  sjlabelled::as_label(c37_09, pos_id) %>% 
  ggplot(aes(y = prop, x = pos_id, fill = pos_id, 
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent, limits = c(0,1)) + 
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())

```


```{r}

elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1 & 
           !c37_10 %in% c(-888, -999) & !c15 %in% c(-888, -999)) %>% 
    mutate(pos_id = factor(car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
                         levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(c37_10 %in% 4:5, pos_id, na.rm = TRUE) %>% 
  sjlabelled::as_label(pos_id) %>% 
  ggplot(aes(y = prop, x = pos_id, fill = pos_id,
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())

```

## Estrés Financiero

```{r satisfaccion-wave, echo=FALSE, fig.align='center'}

elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1 & !m43 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

```

```{r satisfaccion-retiro, echo=FALSE, fig.align='center'}
datos.g19.11 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m16 %in% c(-888, -999, NA) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m16, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(m16, m63_02) 


g19.11 <- datos.g19.11 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m16, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.11
```

```{r clase.sub-benef.estatal, echo=FALSE, fig.align='center'}

datos.g19.12 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub = factor(car::recode(d01_01, "c(0,1,2,3)='Baja y media baja'; c(4, 5)='Media'; c(6,7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub, by = c(m63_01), na.rm = TRUE) %>% 
  sjlabelled::as_label(clase.sub, m63_01) 

g19.12 <- datos.g19.12 %>% 
  ggplot(aes(y = prop, x = m63_01, fill = clase.sub, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.12
```

```{r clase.sub.hij-1erretiro, echo=FALSE, fig.align='center'}
datos.g19.13 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub.hijos = factor(car::recode(d01_03, "c(0,1,2,3)='Baja y media baja'; c(4, 5,6)='Media'; c(7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub.hijos %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub.hijos, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(clase.sub.hijos, m63_02) 

g19.13 <- datos.g19.13 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = clase.sub.hijos, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.13
```

```{r endeud-1retiro, echo=FALSE, fig.align='center'}
datos.g19.14 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_02), na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, m63_02) 

g19.14 <- datos.g19.14  %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.14
```

```{r endeud-2retiro, echo=FALSE, fig.align='center'}
datos.g19.15 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_03 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_03), na.rm = TRUE) %>% 
  sjlabelled::as_label(m43, m63_03) 

g19.15 <- datos.g19.15  %>% 
  ggplot(aes(y = prop, x = m63_03, fill = m43, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.15
```

```{r deuda-retiro1, fig.align='center'}
elsoc_long_2016_2021 %>% 
  left_join(elsoc_wide_2016_2021 %>% 
              filter(!m63_02_w05 %in% c(-888, -999) & !m63_03_w05 %in% c(-888, -999)) %>%
              mutate(retiros = factor(case_when(m63_02_w05 == 1 & m63_03_w05 == 1 ~ 1,
                                                m63_02_w05 == 1 ~ 2,
                                                TRUE ~ 3),
                                      levels = c(3, 2, 1),
                                      labels = c('Ningún retiro', 
                                                 'Primer retiro', 
                                                 'Primer y segundo\n retiro'))) %>%
              select(idencuesta, retiros), by = 'idencuesta') %>% 
  filter(tipo_atricion == 1 & ola %in% c(3, 5) & !is.na(retiros) &
           !m42_01 %in% c(-888, -999) & !m42_02 %in% c(-888, -999) & 
           !m42_03 %in% c(-888, -999) & !m42_04 %in% c(-888, -999)) %>% 
  pivot_longer(cols = c(m42_01, m42_02, m42_03, m42_04)) %>% 
  prop(value, by = c(ola, retiros, name), na.rm = TRUE) %>% 
  as_label(value, ola) %>% 
  filter(value == 1) %>% 
  mutate(name = factor(name, 
                       levels = c('m42_01', 'm42_02', 'm42_03', 'm42_04'),
                       labels = c('Casa\ncomercial', 'Banco', 
                                  'Parientes', 'Otros'))) %>% 
  ggplot(aes(y = prop, x = name, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~retiros) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

```



## Distanciamiento y comportamiento prosocial en pandemia

```{r dist-total, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? (2021).'}

datos.9.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  prop(x = dis_soc, na.rm = TRUE)

g9.1 <- datos.9.1 %>% 
  ggplot(aes(y = prop, x = dis_soc, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'none', 
        legend.title = element_blank())
g9.1
```

```{r dist-quintil, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según quintil de ingreso. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.2 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !t01 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;6=445000;
                                           7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;
                                           18=1670000;19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = dis_soc, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente")

g9.2 <- 
  datos.9.2 %>% 
  ggplot(aes(y = prop, x = quintil, fill = quintil, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.2
```


```{r dist-edad, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según edad. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         edadt = factor(car::recode(m0_edad, "18:29=1; 30:49=2; 50:64=3 ;65:150=4"),
                        levels = c(1,2,3,4), labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  prop(x = dis_soc, by = edadt, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente")

g9.3 <- 
  datos.9.3 %>% 
  ggplot(aes(y = prop, x = edadt, fill = edadt, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.3
```

```{r dist-estrato, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según estrato muestral (2021).'}
datos.9.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  prop(x = dis_soc, by = estrato, na.rm = TRUE)

g9.4 <- datos.9.4 %>%
  ggplot(aes(y = prop, x = estrato, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 6)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g9.4
```

```{r dist-telet, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según tipo de trabajo en pandemia. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999) & !m60 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         trab_pandemia = factor(m60, labels = c('Trabajo de manera\ncompleta desde el hogar',
                                                'Trabajo de manera\nparcial desde el hogar',
                                                'Trabajo fuera\ndel hogar'))) %>%
  prop(x = dis_soc, by = trab_pandemia, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente") %>% 
  drop_na()

g9.5 <- 
  datos.9.5 %>% 
  ggplot(aes(y = prop, x = trab_pandemia, fill = trab_pandemia, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.5
```
```{r dist-covid, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según diagnóstico con coronavirus. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999) & !s31 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         covid = factor(s31, labels = c('Si','No'))) %>%
  prop(x = dis_soc, by = covid, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente") %>% 
  drop_na()

g9.6 <- 
  datos.9.6 %>% 
  ggplot(aes(y = prop, x = covid, fill = covid, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.6
```
## Efecto del distanciamiento social 

### Comportamiento pro-social

```{r dist-pros, fig.align='center', fig.cap='Frecuencia de comportamientos pro-sociales, según ola de estudio. Porcentaje de respuestas de "Lo hizo mas de dos veces".'}

datos.9.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(c07_01, c07_03, c07_02, c07_07, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(c07_01, c07_03, c07_02, c07_07)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value == 3, by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c07_01', 'c07_03', 'c07_02', 'c07_07'),
                       labels = c('Visito casa\nde vecino',
                               'Amigos visitaron\nsu casa',
                               'Asistio a reunion sobre temas\nde interes publico/comunitario',
                               'Converso con persona\nen problemas o deprimida')))

g9.7 <- datos.9.7 %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g9.7
```
```{r dist-pros2, fig.align='center', fig.cap='Frecuencia de comportamientos pro-sociales, según cumplimiento de distanciamiento social (2021). Porcentaje de respuestas de "Lo hizo mas de dos veces".'}
datos.9.8 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !c48 %in% c(-888,-999)) %>%  
  select(c07_01, c07_03, c07_02, c07_07,c48, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  pivot_longer(cols = c(c07_01, c07_03, c07_02, c07_07)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value == 3, by = c(name, dis_soc), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c07_01', 'c07_03', 'c07_02', 'c07_07'),
                       labels = c('Visito casa\nde vecino',
                               'Amigos visitaron\nsu casa',
                               'Asistio a reunion\nsobre temas de\ninteres publico/comunitario',
                               'Converso con persona en\nproblemas o deprimida')))

g9.8 <- datos.9.8 %>% 
  ggplot(aes(y = prop, x = name, fill = dis_soc, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g9.8
```

### Percepción de conflictividad y criminalidad barrial
```{r dist-barrio, fig.align='center', fig.cap='Percepción de conflictividad y criminalidad barrial, según cumplimiento de distanciamiento social (2021). Porcentaje de personas que responden "Muchas veces o siempre".'}
datos.9.9 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & 
           !t11_01 %in% c(-888, -999) & !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) &
           !t11_04 %in% c(-888, -999) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999) & 
           !c48 %in% c(-888, -999)) %>%
  mutate(barrio_confli = (t11_01 + t11_03 + t11_03 + t11_04)/4,
         barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
                                    labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  select(barrio_confli_rec,barrio_crim_rec, estrato_disenno, segmento_disenno, ponderador02, dis_soc) %>%
  pivot_longer(cols = c(barrio_confli_rec, barrio_crim_rec)) %>% 
  prop(value == 'Muchas veces o siempre', by = c(name, dis_soc), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('barrio_confli_rec', 'barrio_crim_rec'), 
                       labels = c('Conflictividad barrial', 'Criminalidad barrial'))) %>% 
  sjlabelled::as_label(dis_soc)

g9.9 <- datos.9.9 %>% 
  ggplot(aes(y = prop, x = name, fill = dis_soc, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g9.9
```




<!--chapter:end:03-salud-bienestar.Rmd-->

# Temas sociales

## Conflicto y cohesión territorial

<!-- ### 8.1 ¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio -->
```{r confli-olas, fig.align='center', fig.cap='¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio '}
datos.8.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_confli_rec, by = ola, na.rm = TRUE)

g8.1 <- datos.8.1 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_confli_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top', legend.title = element_blank())
g8.1
```

<!-- ### 8.2 Cambios en frecuencia de conflictos barriales -->
```{r confli-cambio, fig.align='center', fig.cap='Cambios en frecuencia de conflictos barriales'}

elsoc_diseno <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.8.2 <- data.frame((svytable(~barrio_confli_rec + ola + idencuesta, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>%  
  drop_na()

etiquetas.8.2 <- data.frame((svytable(~barrio_confli_rec + ola, elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  drop_na()

g8.2 <- 
  ggplot(datos.8.2, aes(x = ola, fill = barrio_confli_rec, stratum = barrio_confli_rec, 
                           alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.8.2, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('black', 'white', 'white'),2))
g8.2
```

<!-- ### 8.3 Porce´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´{+}egún ola del estudio y zona geográfica. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-zona, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona geográfica. Porcentaje con conflictos barriales "Siempre" o "Muchas veces"'}

datos.8.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate( zona1 = factor(car::recode(region_cod, 
                                     "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana"))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_confli >= 2.76, by = c(ola, zona1), na.rm = TRUE)

g8.3 <- datos.8.3 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.3
```

<!-- ### 8.4 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-estrato, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".'}

datos.8.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
         labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción', 
                    'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_confli_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  filter(barrio_confli_rec == 'Muchas veces o siempre')

g8.4 <- datos.8.4 %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.4
```


<!-- ### 8.5 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintil de ingreso. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-quintil, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintil de ingreso. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".'}
datos.8.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4,
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_confli >= 2.76, by = c(ola, quintil), na.rm = TRUE)

g8.5 <- datos.8.5 %>% 
  ggplot(aes(y = prop, x = quintil, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.5
```

### Cartografía del conflicto barrial

```{r confli-comuna, fig.align='center', fig.cap='Frecuencia promedio de problemas con vecinos, según comuna de residencia en la región metropolitana (2021).'}

elsoc_comuna_rm <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & region_cod == 13 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(m_confli = weighted.mean(barrio_confli, ponderador02, na.rm = T)) %>% 
  ungroup() 

comunas_rm <- chilemapas::mapa_zonas %>%   
  dplyr::filter(codigo_region == '13' & codigo_provincia == '131') %>% 
  st_as_sf(.) %>% 
  group_by(codigo_comuna) %>% 
  summarise() %>% 
  ungroup() %>% 
  mutate(comuna_cod = as.numeric(codigo_comuna)) %>% 
  left_join(elsoc_comuna_rm, by = 'comuna_cod')

g.confli.rm <- comunas_rm %>%
  ggplot() + 
  geom_sf(aes(fill = m_confli, geometry = geometry)) +
  labs(y = NULL, x = NULL, fill = "Conflictividad barrial\npromedio por comuna") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis') +
  theme_bw()
g.confli.rm
```

```{r confli-region2, fig.align='center', fig.cap='Frecuencia promedio de problemas con vecinos, según región de Chile (2021)', message=FALSE, warning=FALSE}

elsoc_region <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(region, region_cod) %>% 
  summarise(m_confli = weighted.mean(barrio_confli, ponderador02, na.rm = T),
            sd_confli = sd(barrio_confli, na.rm = T),
            n = n())

elsoc_region$region_cod <- factor(elsoc_region$region_cod,
                                  labels = c('01','02','03','04','05','06','07','08',
                                            '09','10','11','13','14','15','16'))

regiones <- chilemapas::generar_regiones()
regiones <- merge(regiones,elsoc_region, by.x="codigo_region",by.y="region_cod",all.x=TRUE,sort=F)

#para intentar hacer facet_wrap
#regiones$mitad <- c('1','1','1','1','1','1','1','2','2','2','2','1','2','1','2','2')

regiones$region[is.na(regiones$region)] <- 'Magallanes\n(Sin datos)'
regiones$region[regiones$region == 'Metropolitana de santiago'] <- 'Metropolitana'
regiones$region[regiones$region == 'Libertador general bernardo ohiggins'] <- 'Ohiggins'
regiones$region[regiones$region == 'Aysen del general carlos ibannez del campo'] <- 'Aysen'
regiones$region[regiones$region == 'Arica y parinacota'] <- 'Arica'

g.confli.region <- regiones %>% 
  ggplot(aes(fill = m_confli, geometry = geometry, label = region)) + 
  geom_sf() +
  coord_sf(xlim = c(-100, -65)) +
  labs(y = NULL, x = NULL, fill = "Conflictividad barrial\npromedio por región") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis', na.value = 'white') +
  ggrepel::geom_text_repel(stat = "sf_coordinates", min.segment.length = 0,
                           colour = "black", segment.colour = "black",
                           direction = "y", hjust = 2.5, size = 3) +
  ggspatial::annotation_north_arrow(aes(which_north = "true", location = "bl"), pad_y = unit(0.8, "cm")) +
  ggspatial::annotation_scale(aes(location = "bl", style = "bar")) +
  theme_bw()
g.confli.region
```

## Confianza en vecinos

<!-- ### 8.6 En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio -->
```{r vecinos-ola, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio.'}
datos.8.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t01 %in% c(-888, -999)) %>% 
  mutate(barrio_conf = factor(car::recode(t01, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels = c('Muy poco o poco', 'Algo', 'Bastante o mucho'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_conf, by = ola, na.rm = TRUE)

g8.6 <- datos.8.6 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_conf, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.6
```

<!-- ### 8.7 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.  -->
```{r vecinos-zona, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.8.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t01 %in% c(-888, -999)) %>% 
  mutate(zona1 = factor(car::recode(region_cod, 
                                    "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana")))%>%
  sjlabelled::as_label(ola) %>%
  prop(x = t01 %in% c(4, 5), by = c(ola, zona1), na.rm = TRUE) 

g8.7 <- datos.8.7 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.7
```

<!-- ### 8.8 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y quintil de ingreso. Suma de Respuestas “Bastante” y “Mucho”. -->
```{r vecinos-quintil, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y quintil de ingreso. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.8.8 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t01 %in% c(-888, -999)) %>% 
  mutate(m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m30b = as.numeric(car::recode(m30b, "1 = 125000; 2 = 300000; 3 = 400000; 4 = 620000; 5 = 1100000; NA = NA")),
         m29_imp = ifelse(!is.na(m29), m29, ifelse(ola == 5, m30b ,m30)),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54),
         ing_pc = (m29_imp/n_hogar)) %>%
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), 
                          levels = c(1,2,3,4,5),
                          labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = t01 %in% c(4, 5), by = c(ola, quintil), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.8 <- datos.8.8 %>% 
  ggplot(aes(y = prop, x = quintil, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.8
```


### Seguridad barrial

<!-- ### 8.9 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio. -->
```{r seguri-ola, fig.align='center', fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio.'}
datos.8.9 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(barrio_segur = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), levels = c(1,2,3),
                               labels = c('Muy inseguro o inseguro', 'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_segur, by = ola, na.rm = TRUE)

g8.9 <- datos.8.9 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_segur, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.9
```

<!-- ### 8.10 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Inseguro" o ”Muy Inseguro".  -->

```{r seguri-zona, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}

datos.8.10 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(zona1 = factor(car::recode(region_cod, 
                                    "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana")))%>%
  prop(x = t10 %in% c(1, 2), by = c(ola, zona1), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.10 <- datos.8.10 %>% 
  ggplot(aes(y = prop, x = ola, color = zona1, group = zona1,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.10
```

<!-- ### 8.11 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Inseguro" o ”Muy Inseguro". -->
```{r seguri-educ, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}

datos.8.11 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999) & !m01 %in% c(-888, -999)) %>% 
  mutate(educ = factor(car::recode(m01,
                                   "c(1,2,3)=1; c(4,5)=2; c(6,7)=3; c(8,9,10)=4"),
                        levels = c(1,2,3,4), 
                       labels = c("Basica","Media","Tecnica","Universitaria"))) %>%
  prop(x = t10 %in% c(1, 2), by = c(ola, educ), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.11 <- datos.8.11 %>% 
  ggplot(aes(y = prop, x = ola, color = educ, group = educ,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.11
```

<!-- ### 8.12 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Inseguro" o ”Muy Inseguro". -->
```{r seguri-edad, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}
datos.8.12 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(edadt = factor(car::recode(m0_edad, 
                                    "18:29=1;30:49=2;50:64=3;65:150=4"),
                        levels = c(1,2,3,4), 
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = t10 %in% c(1,2), by = c(ola, edadt), na.rm = TRUE)

g8.12 <- datos.8.12 %>% 
  ggplot(aes(y = prop, x = ola, color = edadt, group = edadt,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.12
```

<!-- ### 8.13 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintil de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-quintil, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintil de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro".'}

datos.8.13 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(barrio_segur = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), levels = c(1,2,3),
                               labels = c('Muy inseguro o inseguro', 'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro')),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_segur, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(barrio_segur == 'Muy inseguro o inseguro', quintil == "Q1" | quintil == "Q5") %>% 
  drop_na()

g8.13 <- datos.8.13 %>% 
  ggplot(aes(y = prop, x = ola, color = quintil, group = quintil,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .55, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.13
```

### Criminalidad barrial

<!-- ### 8.14 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola de estudio. -->
```{r crim-olas, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola de estudio.'}
datos.8.14 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = ola, na.rm = TRUE)

g8.14 <- datos.8.14 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_crim_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top', legend.title = element_blank())
g8.14
```

<!-- ### 8.15 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y zona geográfica. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-zona, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y zona geográfica. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}
datos.8.15 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         zona1 = factor(car::recode(region_cod, "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), labels = c("Norte","Centro","Sur","Metropolitana"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = c(ola, zona1), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre')

g8.15 <- datos.8.15 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.15
```

<!-- ### 8.16 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y tipo de ciudad. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-estrato, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y tipo de ciudad. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}
datos.8.16 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre')

g8.16 <- datos.8.16 %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.16
```

<!-- ### 8.17 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y quintil de ingreso. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-quintil, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y quintil de ingreso. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}

datos.8.17 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_crim_rec, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre', quintil == "Q1" | quintil == "Q5") 

g8.17 <- datos.8.17 %>% 
  ggplot(aes(y = prop, x = ola, color = quintil, group = quintil,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .55, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.17
```
### Cartografía de la criminalidad barrial

```{r crimi-comuna, fig.align='center', fig.cap='Frecuencia promedio de percepción de crímenes (riñas, robos y tráfico de drogas) en el barrio, según comuna de residencia en la región metropolitana (2021).'}

elsoc_comuna_rm <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & region_cod == 13 & !t09_01 %in% c(-888, -999) &
           !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(m_crim = weighted.mean(barrio_crim, ponderador02, na.rm = T),
            sd_crim = sd(barrio_crim, na.rm = T),
            n = n())

comunas_rm <- chilemapas::mapa_zonas %>% 
  filter(codigo_region==13 & codigo_provincia == '131') %>% 
  st_as_sf(.) %>% 
  group_by(codigo_comuna) %>% 
  summarise()

comunas_rm <- merge(comunas_rm, 
                    elsoc_comuna_rm, 
                    by.x = "codigo_comuna", by.y = "comuna_cod",
                    all.x = TRUE,
                    sort=F)

#comunas_rm <- comunas_rm %>% drop_na() #en caso de quitar comunas con NA

g.crimi.rm <- 
  ggplot(comunas_rm) + 
  geom_sf(aes(fill = m_crim, geometry = geometry)) +
  labs(y = NULL, x = NULL, fill = "Criminalidad barrial\npromedio por comuna") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis') +
  theme_bw() 
g.crimi.rm
```

```{r confli-region, fig.align='center', fig.cap='Frecuencia promedio de percepción de crímenes (riñas, robos y tráfico de drogas) en el barrio, según región de Chile (2021)', message=FALSE, warning=FALSE}

elsoc_region <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !t09_01 %in% c(-888, -999) &
           !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(region, region_cod) %>% 
  summarise(m_crim = weighted.mean(barrio_crim, ponderador02, na.rm = T),
            sd_crim = sd(barrio_crim, na.rm = T),
            n = n())

elsoc_region$region_cod <- factor(elsoc_region$region_cod,
                                  labels = c('01','02','03','04','05','06','07','08',
                                            '09','10','11','13','14','15','16'))

regiones <- generar_regiones()
regiones <- merge(regiones,elsoc_region, by.x="codigo_region",by.y="region_cod",all.x=TRUE,sort=F)

#para intentar hacer facet_wrap
#regiones$mitad <- c('1','1','1','1','1','1','1','2','2','2','2','1','2','1','2','2')

regiones$region[is.na(regiones$region)] <- 'Magallanes\n(Sin datos)'
regiones$region[regiones$region == 'Metropolitana de santiago'] <- 'Metropolitana'
regiones$region[regiones$region == 'Libertador general bernardo ohiggins'] <- 'Ohiggins'
regiones$region[regiones$region == 'Aysen del general carlos ibannez del campo'] <- 'Aysen'
regiones$region[regiones$region == 'Arica y parinacota'] <- 'Arica'

g.crim.region <- regiones %>% 
  ggplot(aes(fill = m_crim, geometry = geometry, label = region)) + 
  geom_sf() +
  coord_sf(xlim = c(-100, -65)) +
  labs(y = NULL, x = NULL, fill = "Criminalidad barrial\npromedio por región") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis', na.value = 'white') +
  ggrepel::geom_text_repel(stat = "sf_coordinates", min.segment.length = 0,
                           colour = "black", segment.colour = "black",
                           direction = "y", hjust = 2.5, size = 3) +
  ggspatial::annotation_north_arrow(aes(which_north = "true", location = "bl"), pad_y = unit(0.8, "cm")) +
  ggspatial::annotation_scale(aes(location = "bl", style = "bar")) +
  theme_bw()
g.crim.region
```




## Migración
 
### Amenaza realista y amenaza simbólica respecto a inmigrantes
 
<!-- ### 14.1 "Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen1-wave, fig.align='center',fig.cap='Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_04 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_04 %in% c(4,5), by = c(ola, cuestion_mig)) %>% 
  sjlabelled::as_label(ola, cuestion_mig)
  
datos.g14.1 %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

```{r amen1-zona, fig.align='center',fig.cap='Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola, zona y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  mutate(macrozona = factor(case_when(region_cod %in% c(15, 1, 2, 3) ~ 1,
                               region_cod %in% c(4, 5, 13) ~ 2,
                               region_cod %in% c(6, 7 , 16, 8) ~ 3,
                               region_cod %in% c(9, 14, 10, 11, 12) ~ 4),
                            labels = c('Norte', 'Centro/RM', 'Centro Sur', 'Sur/Austral'))) %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_04 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_04 %in% c(4,5), by = c(ola, cuestion_mig, macrozona)) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>% 
ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~macrozona) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

<!-- ### 14.2 "Con la llegada de migrantes, Chile está perdiendo su identidad", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o "Totalmente de acuerdo". -->
```{r amen2-wave, fig.align='center',fig.cap='"Con la llegada de migrantes, Chile está perdiendo su identidad", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o "Totalmente de acuerdo".'}

datos.g14.2 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_03 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_03 %in% c(4,5), by = c(ola, cuestion_mig), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig)

datos.g14.2 %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
                           label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
```


```{r amen2-zona, fig.align='center',fig.cap='"Con la llegada de migrantes, Chile está perdiendo su identidad", según ola, zona y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o "Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  mutate(macrozona = factor(case_when(region_cod %in% c(15, 1, 2, 3) ~ 1,
                               region_cod %in% c(4, 5, 13) ~ 2,
                               region_cod %in% c(6,7 , 16, 8) ~ 3,
                               region_cod %in% c(9, 14, 10, 11, 12) ~ 4),
                            labels = c('Norte', 'Centro/RM', 'Centro Sur', 'Sur/Austral'))) %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_03 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_03 %in% c(4,5), by = c(ola, cuestion_mig, macrozona), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~macrozona) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

<!-- ### 14.3 Confianza en migrantes, según ola y origen de migrantes. Porcentaje de personas que responden “Bastante” o “Mucha confianza”. -->
```{r conf-wave, fig.align='center',fig.cap='Confianza en migrantes, según ola y origen de migrantes. Porcentaje de personas que responden “Bastante” o “Mucha confianza”'}

datos.g14.3 <- elsoc_long_2016_2021 %>% 
  mutate(confianza = ifelse(ola %in% c(1,3), c06_06, r16)) %>% 
  filter(tipo_atricion %in% c(1,17) & !confianza %in% c(-888,-999)) %>% 
  elsoc::prop(confianza %in% c(4,5), by = c(ola, cuestion_mig), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig)

datos.g14.3 %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
                          label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```


```{r conf-zona, fig.align='center',fig.cap='Confianza en migrantes, según ola, zona y origen de migrantes. Porcentaje de personas que responden “Bastante” o “Mucha confianza”'}
elsoc_long_2016_2021 %>% 
  mutate(macrozona = factor(case_when(region_cod %in% c(15, 1, 2, 3) ~ 1,
                               region_cod %in% c(4, 5, 13) ~ 2,
                               region_cod %in% c(6,7 , 16, 8) ~ 3,
                               region_cod %in% c(9, 14, 10, 11, 12) ~ 4),
                            labels = c('Norte', 'Centro/RM', 'Centro Sur', 'Sur/Austral'))) %>% 
  mutate(confianza = ifelse(ola %in% c(1,3), c06_06, r16)) %>% 
  filter(tipo_atricion %in% c(1,17) & !confianza %in% c(-888,-999)) %>% 
  elsoc::prop(confianza %in% c(4,5), by = c(ola, cuestion_mig, macrozona), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~macrozona) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

<!-- ### 14.4 Percepción de amenaza realista y simbólica, según grupo de migrantes (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-wave, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica, según grupo de migrantes (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.4 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion %in% c(1, 17) & ola == 5) %>% 
  select(r12_03, r12_04, estrato_disenno, segmento_disenno, ponderador02, cuestion_mig) %>%
  pivot_longer(cols = c(r12_03, r12_04)) %>% 
  filter(!value %in% c(-888,-999)) %>% 
  prop(value %in% c(4,5), by = c(name, cuestion_mig), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('r12_04', 'r12_03'), 
                       labels = c('Aumenta desempleo', 'Chile pierde su identidad'))) %>% 
  sjlabelled::as_label(cuestion_mig)

datos.g14.4 %>% 
  ggplot(aes(y = prop, x = name, fill = cuestion_mig, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)

```


### Amenaza realista y simbólica respecto a inmigrantes según nivel educacional


<!-- ### 14.5 Percepción de amenaza realista y simbólica respecto a inmigrantes, según nivel educacional (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-educ, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica respecto a inmigrantes, según nivel educacional (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.5 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion %in% c(1, 17) & ola == 5) %>% 
  mutate(educ = factor(car::recode(m01, "c(1,2,3) = 'Basica'; c(4,5) = 'Media'; c(6,7) = 'Tecnica'; c(8,9,10) = 'Universitaria'"))) %>% 
  select(r12_03, r12_04, estrato_disenno, segmento_disenno, ponderador02, educ) %>%
  pivot_longer(cols = c(r12_03, r12_04)) %>% 
  filter(!value %in% c(-888,-999)) %>% 
  prop(value %in% c(4,5), by = c(name, educ), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('r12_04', 'r12_03'), 
                       labels = c('Aumenta desempleo', 'Chile pierde su identidad')))

datos.g14.5 %>% 
  ggplot(aes(y = prop, x = name, fill = educ, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)

```

<!-- ### 14.8 Percepción de amenaza realista y simbólica, según tramo de edad (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-edad, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica, según tramo de edad (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.8 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion %in% c(1, 17) & ola == 5) %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  select(r12_03, r12_04, estrato_disenno, segmento_disenno, ponderador02, edadt) %>%
  pivot_longer(cols = c(r12_03, r12_04)) %>% 
  filter(!value %in% c(-888,-999)) %>% 
  prop(value %in% c(4,5), by = c(name, edadt), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('r12_04', 'r12_03'), 
                       labels = c('Aumenta desempleo', 'Chile pierde su identidad')))

datos.g14.8 %>% 
  ggplot(aes(y = prop, x = name, fill = edadt, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
```




## Género

### Sexismo hostil y benevolente

```{r sexismo-sexo, fig.align='center', fig.cap='Sexismo benévolo y hostil, según sexo (2021). Porcentaje que responde "De acuerdo" o "Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5 & !g01_01 %in% c(-888, -999) & !g01_02 %in% c(-888, -999) & !g01_03 %in% c(-888, -999) & !g01_04 %in% c(-888, -999)) %>% 
  select(g01_01, g01_02, g01_03, g01_04, segmento_disenno, estrato_disenno, ponderador02, m0_sexo) %>% 
  pivot_longer(cols = c(g01_01, g01_02, g01_03, g01_04)) %>% 
  prop(value %in% 4:5, by = c(name, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(m0_sexo) %>% 
  mutate(name = factor(name,
                       levels = c('g01_01', 'g01_02', 'g01_03', 'g01_04'),
                       labels = c('Mujeres son\nmás refinadas\nque hombres',
                     'Mujeres debieran ser\nqueridas y protegidas\npor los hombres',
                     'Mujeres consiguen\nprivilegios en\nnombre de igualdad',
                     'Cuando mujeres son\nderrotadas limpiamente,\nse quejan de discriminación'))) %>%
  ggplot(aes(y = prop, x = name, fill = m0_sexo, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())  

```

```{r sexismo-educ, fig.align='center',fig.cap='Sexismo benévolo y hostil, según nivel educacional (2021). Porcentaje que responde "De acuerdo" o "Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5 & !g01_01 %in% c(-888, -999) & !g01_02 %in% c(-888, -999) & !g01_03 %in% c(-888, -999) & !g01_04 %in% c(-888, -999) & !m01 %in% c(-888, -999)) %>% 
  select(g01_01, g01_02, g01_03, g01_04, segmento_disenno, estrato_disenno, ponderador02, m01) %>% 
  pivot_longer(cols = c(g01_01, g01_02, g01_03, g01_04)) %>%
  mutate(educ = factor(car::recode(m01, "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                        levels = c(1, 2, 3, 4), 
                       labels = c("Básica", "Media", "Técnica", "Universitaria"))) %>%
  prop(value %in% 4:5, by = c(name, educ), na.rm = TRUE) %>% 
  sjlabelled::as_label(educ) %>% 
  mutate(name = factor(name,
                       levels = c('g01_01', 'g01_02', 'g01_03', 'g01_04'),
                       labels = c('Mujeres son\nmás refinadas\nque hombres',
                     'Mujeres debieran ser\nqueridas y protegidas\npor los hombres',
                     'Mujeres consiguen\nprivilegios en\nnombre de igualdad',
                     'Cuando mujeres son\nderrotadas limpiamente,\nse quejan de discriminación'))) %>%
  ggplot(aes(y = prop, x = name, fill = educ, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())  


```

### Trabajo y género

```{r ocup-sexo, fig.align='center',fig.cap='Porcentaje de trabajadores y trabajadoras por situación ocupacional (2021), según sexo del entrevistado'}
elsoc_long_2016_2021 %>% 
    dplyr::filter(tipo_atricion == 1 
                & ola %in% c(3, 5) & !m01 %in% c(-888, -999)) %>% 
  mutate(sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1:5),
                           labels = c("Trabajo\nremunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otras\ncategorías"))) %>%
  prop(sit_ocup, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(m0_sexo, ola, sit_ocup) %>% 
  ggplot(aes(y = prop, x = m0_sexo, fill = sit_ocup, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(.~ola)+
  scale_fill_viridis_d(begin = .13, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(aes(label = ifelse(prop> 0.03 , scales::percent(prop, accuracy = .1),"")), position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'black', 'black','white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

```

```{r m17, eval=FALSE, fig.align='center', fig.cap='Horas de Cuidado'}
#PENDIENTE
#1
datos.grafico <- data.frame((svytable(~m17_rec + ola + idencuesta, 
                                      elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq))

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~m17_rec + ola, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.11 <- ggplot(subset.grafico, aes(x = ola, fill = m17_rec, stratum = m17_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75)

g16.11
```


## Estatus subjetivo y Percepción de Mérito

### Estatus subjetivo
<!-- ### 11.1 En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio. -->
```{r ess-ola, fig.align='center',fig.cap='En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio.'}
datos.11.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !d01_01 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4, 5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = clase_sub, by = ola, na.rm = T)

g11.1 <- datos.11.1 %>% 
  ggplot(aes(y = prop, x = ola, fill = clase_sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.1

```

<!-- ### 11.2 Cambios de Clase social subjetiva entre 2016, 2019 y 2021 -->
```{r ess-cambio, fig.align='center',fig.cap='Cambios de Clase social subjetiva entre 2016, 2019 y 2021'}
elsoc_panel_m1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1, 4, 5)) %>% 
  group_by(idencuesta) %>% 
  mutate(missing = any(d01_01 %in% c(-888, -999))) %>% 
  filter(!missing) %>% 
  ungroup() %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4, 5)=2; c(6,7,8,9,10)=3; else=NA"), 
                            levels = c(1, 2, 3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.11.2 <- data.frame((svytable(~clase_sub + ola + idencuesta, elsoc_panel_m1, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>%
  filter(Freq>0 & (ola == '2016'| ola == '2019' | ola == '2021')) %>%
  drop_na()

etiquetas.11.2 <- data.frame((svytable(~clase_sub + ola, elsoc_panel_m1, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  filter(Freq>0 & (ola == '2016'| ola == '2019' | ola == '2021')) %>% 
  drop_na()

g11.2 <- 
  ggplot(datos.11.2, aes(x = ola, fill = clase_sub, stratum = clase_sub, 
                          alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(data = etiquetas.11.2, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('white', 'white', 'black'),3))
g11.2
```

<!-- ### 11.3 Clase social subjetiva, según quintiles de ingreso (2021) -->
```{r ess-quintil, fig.align='center',fig.cap='Clase social subjetiva, según quintiles de ingreso (2021)'}

datos.11.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !t01 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = clase_sub, by = c(ola, quintil), na.rm = TRUE)

g11.3 <- 
  datos.11.3 %>% 
  ggplot(aes(y = prop, x = quintil, fill = clase_sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c( 'black','black','white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.3
```

<!-- ### 11.4  Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021) -->
```{r esshijos-ess, fig.align='center',fig.cap='Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021)'}
datos11.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & 
         !d01_01 %in% c(-888, -999) & !d01_03 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta")),
         clase_sub_hijo = factor(car::recode(d01_03, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"),
                                 levels = c(1,2,3), 
                                 labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = clase_sub_hijo, by = c(ola, clase_sub), na.rm = T)

g11.4 <- datos11.4 %>% 
  ggplot(aes(y = prop, x = clase_sub, fill = clase_sub_hijo, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = 'Clase social subjetiva propia') +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.4
```

### Movilidad social

<!-- ### 11.5  Perspectiva de movilidad social, según ola.\nNota: la perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado. -->
```{r mov-soc-rec, fig.align='center',fig.cap='Perspectiva de movilidad social, según ola.\nNota: la perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado.'}
datos.11.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_03 %in% c(-888, -999)) %>% 
  mutate(mov_interg = d01_03 - d01_01) %>% 
  mutate(mov_interg_rec = factor(car::recode(mov_interg, "-8:-1=1;0=2;1:10=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Perpectiva de\nmovilidad descendente", "Perspectiva de\ninmovilidad social",
                                       "Perspectiva de\nmovilidad ascendente"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = mov_interg_rec, by = ola, na.rm = T)

g11.5 <- 
  datos.11.5 %>% 
  ggplot(aes(y = prop, x = ola, fill = mov_interg_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .99, direction = -1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.5
```

<!-- ### 11.6  Estatus subjetivo y tipo de movilidad social, nivel promedio según ola.\nNota: perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado. En cambio movilidad social relativa corresponde a la resta entre el estatus social actual y el estatus social de la familia donde creció.-->
```{r mov-soc, fig.align='center',fig.cap='Estatus subjetivo y tipo de movilidad social, nivel promedio según ola.\nNota: perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado. En cambio movilidad social relativa corresponde a la resta entre el estatus social actual y el estatus social de la familia donde creció.'}
datos.11.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_02 %in% c(-888,-999) & !d01_03 %in% c(-888, -999)) %>%
  sjlabelled::as_label(ola) %>% 
  mutate(mov_interg = d01_03 - d01_01,
         mov_relativa = d01_01 - d01_02) %>% 
  group_by(ola) %>% 
  summarise(m_interg = weighted.mean(mov_interg, ponderador02 ,na.rm = T),
            m_relativa = weighted.mean(mov_relativa, ponderador02 ,na.rm = T),
            m_estatus = weighted.mean(d01_01, ponderador02 ,na.rm = T),
            n = n()) %>% 
  mutate(var_interg = 'Perspectiva de\nmovilidad social',
         var_relativa = 'Movilidad social\nrelativa',
         var_estatus = 'Estatus social\nactual') %>% 
  pivot_longer(cols = starts_with('var_'))  %>%
  mutate(m_mov_social = case_when(
    value == 'Perspectiva de\nmovilidad social' ~ m_interg,
    value == 'Movilidad social\nrelativa' ~ m_relativa,
    value == 'Estatus social\nactual' ~ m_estatus)) 

datos.11.6$m_mov_social <- round(datos.11.6$m_mov_social, digits = 2) 

g11.6 <- datos.11.6 %>% 
  ggplot(aes(y = m_mov_social, x = ola, group = value, color = value,
             label = m_mov_social)) +
  theme_bw() +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(limits = c(0,6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .11, end = .55, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,  size= 3.5)
g11.6
```

### Percepción de meritocracia

<!-- ### 11.7  Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".  -->
```{r merit-wave, fig.align='center',fig.cap='Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".'}

datos.11.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(c18_09, c18_10, d05_02, d05_04, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(c18_09, c18_10, d05_02, d05_04)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value %in% c(4,5), by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c18_09', 'c18_10', 'd05_02', 'd05_04'),
                       labels = c('Personas son\nrecompensadas\npor su esfuerzo',
                               'Personas son\nrecompensadas\npor su inteligencia',
                               'Educación es\nimportante para\nsurgir en la vida',
                               'Trabajo duro\nes importante para\nsurgir en la vida')))

g11.7 <- datos.11.7 %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.7
```


<!--chapter:end:04-temas-sociales.Rmd-->

# Como citar este informe: {-}

:::{.blue-box}
> COES (2021) Radiografía del Cambio Social: Análisis de Resultados Longitudinales ELSOC 2016-2021. Presentación de Resultados COES. Septiembre, Santiago de Chile.
:::

**Entrada Bibtex:**

```{r,echo=TRUE,eval=FALSE}
@techreport{coes_Radiografia_2021,
  title = {Radiograf\'ia Del {{Cambio Social}}: {{An\'alisis}} de {{Resultados Longitudinales ELSOC}} 2016-2021.},
  author = {COES},
  year = {2021},
  month = sep,
  address = {{Santiago de Chile, Chile}},
  institution = {{Centro de Estudios de Conflicto y Cohesi\'on Social}}
}
```

<!--chapter:end:05-cierre.Rmd-->

