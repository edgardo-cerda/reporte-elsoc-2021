--- 
title: "Estudio Longitudinal Social de Chile"
subtitle: "Resultados longitudinales 2016-2021"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
classoption: openany
bibliography:
- book.bib
biblio-style: apalike
link-citations: yes

output:
  bookdown::gitbook:
    lib_dir: assets
    config:
      toolbar:
        position: static
  bookdown::pdf_book:
    extra_dependencies: ["flafter"]
    toc: no

geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE,
                      echo=FALSE) 

Sys.setlocale("LC_ALL","ES_ES.UTF-8")
```

```{r message=FALSE, warning=FALSE, include=FALSE, echo=FALSE,cache=FALSE} 
pacman::p_load(knitr, kableExtra, dplyr,gridExtra,tidyverse,sjmisc,sjlabelled,sticky,ggrepel,ggalluvial,survey,spatstat,readxl,forcats, gtools, lubridate)
```

```{r cargar objetos, include=FALSE, cache = FALSE}
remove(list = ls())
#base de datos
load("1_input/datos_elsoc.RData") 
load("1_input/elsoc_covid.RData")
load("1_input/ELSOC_Long_2016_2021_v1.00_R.RData")
```

```{r disenno, include=FALSE}
elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

#cuando es necesario usar todo el panel (independiente la muestra)
elsoc_diseno_2 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_panel)

#cuando se utilizan datos de covid en panel
elsoc_diseno_3 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_covid_panel)
```

```{r echo=FALSE }
table_format = if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex" 
}

fullw = if(is_html_output()) {T} else if(is_latex_output()) {F}
fsize = if(is_html_output()) {14} else if(is_latex_output()) {8}

ggplot2::theme_set(new = theme_test(base_family = "serif"))
```

# Introducción

El Centro de Estudios de Conflicto y Cohesión Social (COES) tiene el agrado de publicar el informe “Radiografía del Cambio Social”, el cual consolida los principales hallazgos longitudinales de cuatro mediciones anuales del Estudio Longitudinal Social de Chile (ELSOC 2016-2021).

ELSOC es una encuesta desarrollada para analizar longitudinalmente, en un estudio panel, la evolución del conflicto y cohesión social en la sociedad chilena, basándose en modelos conceptuales descritos en la literatura nacional e internacional de las disciplinas del ámbito de la Economía, Sociología, Psicología, Ciencia Política y Estudios Urbanos. De este modo, se orienta a examinar los principales antecedentes, factores moderadores y mediadores, así como las principales consecuencias asociadas al desarrollo de distintas formas de sociabilidad en Chile.

Desde 2019 y hasta la fecha, Chile se ha visto remecido por importantes eventos que han alterado aspectos sociales, políticos y económicos de la vida nacional: la pandemia asociada al COVID-19, y las consecuencias del estallido social más grande de las últimas décadas, ocurrido a partir de octubre de 2019, el que ha desencadenado un proceso constituyente inédito en la historia de Chile.

Ambos fenómenos han significado un desafío para ELSOC, ya que afecta tanto la forma en que son levantados los datos, como las preguntas que el estudio debe abordar. Sin embargo, ELSOC presente una gran oportunidad única: la posibilidad de observar el efecto que éstos fenómenos tienen sobre la población chilena desde una perspectiva longitudinal.

## Sobre COES

El Centro de Estudios de Conflicto y Cohesión Social (COES) desarrolla investigación colaborativa en temas relacionados al conflicto social y la cohesión (convivencia) en Chile, por medio de un equipo multidisciplinario proveniente de las ciencias sociales y humanidades. COES centra sus actividades académicas y de difusión en el análisis de las múltiples manifestaciones del conflicto y cohesión social en Chile, sus causas, así como también su contexto cultural e histórico.

COES está patrocinado por la Universidad de Chile y la Pontificia Universidad Católica de Chile, y como instituciones asociadas se encuentran la Universidad Diego Portales y la Universidad Adolfo Ibáñez. COES cuenta con el apoyo del Fondo de Financiamiento de Centros de Investigación en Áreas Prioritarias (FONDAP, dependiente de la Agencia Nacional de Investigación y Desarrollo (ANID) del Ministerio de Ciencia, Tecnología, Conocimiento e Innovación. ELSOC además cuenta como socio al Instituto Milenio para la Investigación en Depresión y Personalidad (MIDAP).



<!--chapter:end:index.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Sobre ELSOC

## Descripción del estudio

El Estudio Longitudinal Social de Chile (ELSOC) es una encuesta panel, representativa de la población nacional urbana, que analiza la estabilidad y cambio de las creencias, actitudes y percepciones que tenemos los chilenos y chilenas respecto de la convivencia y del conflicto, la cohesión y una amplia gama de aspectos políticos y sociales a lo largo del tiempo. 

Este estudio sigue la evolución de cerca de 4.500 chilenos y chilenas a lo largo de una década. Actualmente se encuentran disponibles 5 olas del estudio, abarcando el período entre 2016 y 2021. Sus temas de estudio y su aspecto longitudinal convierten a ELSOC en un recurso único en Chile y América Latina para analizar la evolución de la sociedad chilena y para el desarrollo de las ciencias sociales en Chile.

Durante los últimos años, ELSOC se ha consolidado como un importante insumo para el desarrollo de investigación científica y aplicada en ciencias sociales. En el sitio web http://elsoc.cl se puede acceder a más información sobre el estudio. 

## Acceso a Bases de Datos ELSOC

Las bases de datos y documentación correspondientes se encuentran disponibles, de manera libre y gratuita, en un repositorio de datos, al cual se podrá acceder en el link:

https://dataverse.harvard.edu/dataverse/elsoc

En este link se obtendrá acceso a los datos de las 5 mediciones transversales de ELSOC, así como bases longitudinales que integran las distintas mediciones en formato wide y long. En colaboración con el Centro de Inteligencia Territorial (CIT), se pone también a disposición las bases ELSOC-CIT. Estas bases de datos permiten combinar la información de ELSOC, y estimaciones e indicadores territoriales y geoespaciales de distinta índole, proveniente de diversas fuentes de información nacional para los períodos 2016 a 2019. 

ELSOC tiene un compromiso con los más altos estándares científicos en términos de producción y análisis de datos. Dentro de esta visión global, ELSOC se guía por las principales pautas de Transparencia y Apertura en la investigación científica. Por esta misma razón, los códigos utilizados para el desarrollo de las figuras y análisis de Radiografía del Cambio Social se encontrarán disponibles en https://github.com/centro-coes.


# Ficha Técnica

- Diseño: Estudio cuantitativo por medio de un cuestionario estructurado.

- Formato de aplicación: Formato CAPI (Encuesta presencial con asistencia de computador). Excepcionalmente se cambió a formato CATI (Encuesta telefónica con asistencia de computador) durante 2021.
  
- Periodicidad: Anual. 

- Diseño Longitudinal: panel repetido (misma encuesta se aplica a dos muestras independientes). Segunda muestra se implementó a partir del tercer año de medición (2018).

- Período de Aplicación: entre Julio y Noviembre de cada año. Debido al estallido social, la cuarta medición se aplicó entre el 21 de noviembre de 2019 y el 9 de marzo de 2020. Debido a la pandemia, la quinta medición se aplicó entre el 29 de enero de 2021 y 12 de julio de 2021

- Instrumento: Cuestionario compuesto por preguntas cerradas de carácter simple y múltiple junto a algunas preguntas abiertas. Combina módulos de preguntas permanentes (medidas en todas las olas) y otras intercaladas entre olas.

- Cobertura Temática: Contiene siete módulos temáticos: Territorio, Redes y actitudes sociales, Ciudadanía y democracia, Desigualdad y legitimidad, Conflicto social, Salud y bienestar y Caracterización sociodemográfica.

## Dimension longitudinal del Diseño

- Unidad de Análisis: Individuos.

- Población Objetivo: Hombres y mujeres de 18 a 75 años, residentes habituales de viviendas particulares ocupadas en zonas urbanas, localizadas en 40 ciudades (92 comunas, 13 regiones) del país.

- Marco Muestral: Marco de muestreo de manzanas del pre-censo 2011, trabajo elaborado por el Centro de Inteligencia Territorial (CIT) de la Universidad Adolfo Ibáñez.

- Diseño Muestral: Probabilístico, estratificado (por tamaño de ciudades), por conglomerados y multietápico.

- Unidades de Muestreo: Primero se eligen ciudades (UPM), luego manzanas (USM), y sub-bloques y viviendas (UTM). La unidad final de selección es la persona.

## Dimensión Territorial del Diseño Muestral



**Organismo Ejecutor**: Consultora Stephanie Eckman y Centro de Inteligencia Territorial (CIT) de la Universidad Adolfo Ibáñez (diseño muestral). Centro Micro Datos (CMD) de la Universidad de Chile (levantamiento, procesamiento de la información y construcción de factores de expansión).


**Entrenamiento y Ejecución**: Contratación de entrevistadores con experiencia en encuestas complejas y/o longitudinales. Capacitación centralizada y presencial para coordinadores de campo y un subconjunto de entrevistadores en Santiago (incluidos ejercicios prácticos para la implementación del cuestionario, uso de tabletas y protocolo de contacto). Actividades adicionales en otras regiones de Chile. Diseño de un Manual de entrevistador especializado para el proyecto.


**Operaciones de Control y Supervisión**: Entrega de incentivos monetarios para el encuestado ($ 6.000 CLP) y de material sobre el estudio (ELSOC y COES). Acciones de seguimiento basadas en la información de contacto (correo electrónico para cumpleaños y días festivos). Los coordinadores de campo supervisan el trabajo de los entrevistadores, verificando el número de visitas, el contacto, la identidad del participante y algunas preguntas claves. El Centro Micro Datos realiza una supervisión interna de al menos el 10% de la muestra (entrevistando nuevamente a algunos encuestados), verificando la duración y la respuesta de los participantes.


## Descripción de atrición

ELSOC al ser un estudio panel longitudinal nos permite observar cambios en los individuos a lo largo del tiempo. Sin embargo, esta misma naturaleza del diseño del estudio pone en juego el desafío de retener a los participantes. En este sentido es que cobra importancia observar el proceso de abandono de un estudio panel, denominado atrición. Uno de los aspectos más importante para medir la calidad de los datos en las encuestas de panel es el nivel de atrición, ya que incluso si un panel comienza con una buena representación de la población de interés, las pequeñas tasas de deserción pueden acumularse rápidamente y hacer que la muestra ya no sea representativa, sobretodo cuando la deserción es sesgada. En teoría, deberíamos ser capaces de aprender bastante de las primeras olas de un panel sobre qué políticas de campo funcionan para reducir el desgaste y cuáles no.


### Tamaño muestral

El diseño de ELSOC contempló entrevistar a 3.000 personas en su primera medición, reconociendo que año tras año, se reduciría el número de participantes, dado que algunos optarían voluntariamente por dejar de participar en el estudio y otras personas no podrían ser recontactadas o incluso algunas fallecerían. Este fenómeno es conocido como atrición, y pueden tener efectos nocivos sobre la utilidad de los datos longitudinales. Para cada año se planifica obtener un número de entrevistados (Muestra Objetivo) considerando una proyección de la atrición definida al momento de diseñar el estudio. ELSOC tiene buenos números en este aspecto. Incluso, en 2018 se logró recontactar a un número de participantes mayor al proyectado.




### Atrición de la Muestra Original y Muestra Refresco



<!--chapter:end:02-ficha-tecnica.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Foco en el cambio individual

Radiografía del Cambio Social tiene como objetivo fundamental caracterizar la estabilidad y el cambio en opiniones, actitudes y conductas de los participantes a lo largo del tiempo, enfocándose en distintas dimensiones de la cohesión y conflicto en Chile. 


Para el logro de dicho objetivo, el presente reporte se centrará en un subconjunto de participantes del estudio: los 2096 entrevistados que participaron en las cuatro primeras olas de ELSOC (como parte de la muestra original). Dicha submuestra será la base empírica de los hallazgos expuestos en las siguientes secciones. 


A continuación se describe a este grupo de participantes según los mismos atributos sociodemográficos (sexo, edad, educación, zona de residencia y religión), considerando la primera medición. Todos los resultados presentados incorporan el diseño muestral complejo de la encuesta.

**Nota 1:** El promedio de edad de los participantes se ha incrementado entre estos años. También hay evidencia de un descenso en la identificación religiosa al comparar distintos años del estudio. Las otras variables no presentan variaciones relevantes a lo largo del tiempo.

**Nota 2:** Se utiliza el ponderador muestral ajustado a población regional y sexo, estrato y conglomerado muestral.



<!--chapter:end:03-foco-cambio-ind.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Principales hallazgos longitudinales

**Nota Explicativa**

A continuación, se presentan los principales resultados de la encuesta ELSOC elaborados por investigadores del Centro de Conflicto y Cohesión Social (COES). Dada la diversidad de temas que son abordados en la encuesta, los investigadores colaboradores utilizaron diversos enfoques teóricos y herramientas empíricas en su análisis. Sin embargo, en Radiografía del Cambio Social se han definido una serie de criterios comunes para el desarrollo de resultados empíricos:

- Foco en la evolución y cambio en las actitudes de la población, aún cuando en ocasiones se analizan preguntas incluidas en una o dos olas del estudio. 
- Uso de pruebas estadísticas específicas para el análisis longitudinal. 
- Utilización de submuestra de XXXX participantes del estudio presentes en las cinco mediciones (2016, 2017, 2018, 2019 y 2021). 
- Tamaños muestrales reportados menores se explican exclusivamente por no respuesta a ítemes específicos.
- Utilización del diseño muestral complejo (ponderador muestral ajustado a población regional y sexo, estrato y conglomerado muestral) en el desarrollo de figuras descriptivas y pruebas inferenciales. 


**Levantamiento durante COVID-19**



<!--chapter:end:04-cambio-long.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Movimientos Sociales y Acciones Colectivas


## Ciclo de movilización política y estallido social

### 1.1 ¿Cuál es el movimiento social que usted más valora de esta lista? Según ola del estudio

<!-- ### 1.1 ¿Cuál es el movimiento social que usted más valora de esta lista? Según ola del estudio  -->

```{r diseno, include=FALSE}
elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r include=FALSE}
datos.1.1 <- data.frame((svytable(~mov + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola == '2019' | ola == '2021') %>%
  na.omit()
```


```{r echo=FALSE}
g1.1 <-datos.1.1 %>% 
  ggplot(aes(y = porcentaje, x = mov, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  coord_flip() +
  theme(axis.text.x = element_text(size=rel(.9))) +
  scale_x_discrete(labels = waiver( ))

g1.1

```

### 1.2 Frecuencia de respuesta en "ninguno" ante la pregunta ¿Cuál es el movimiento social que usted más valora de esta lista? según posición política

<!-- ### 1.2 Frecuencia de respuesta en "ninguno" ante la pregunta ¿Cuál es el movimiento social que usted más valora de esta lista? según posición política  -->

```{r}
datos.1.2 <- data.frame((svytable(~mov + pos_id + ola, elsoc_diseno, round = F))) %>%
  group_by(pos_id, ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(mov == 'Ninguno') %>%
  filter(ola == '2019' | ola == '2021') %>%
  na.omit()
```

```{r}
g1.2 <-datos.1.2 %>% 
    ggplot(aes(y = porcentaje, x = pos_id, fill = mov, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(position = 'dodge2') +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 0.3)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    facet_wrap(datos.1.2$ola)+
    theme(legend.position = 'top',
          legend.title = element_blank()) 

g1.2
```

### 1.3 Frecuencia de respuesta en "ninguno" ante la pregunta ¿Cuál es el movimiento social que usted más valora de esta lista? según posición política "No se identifica"

<!-- ### 1.3 Frecuencia de respuesta en "ninguno" ante la pregunta ¿Cuál es el movimiento social que usted más valora de esta lista? según posición política "No se identifica"  -->

```{r}
datos.1.3 <- data.frame((svytable(~mov + pos_id + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(mov == 'Ninguno') %>%
  na.omit()

```

```{r}
g1.3 <-datos.1.3 %>% 
    ggplot(aes(y = porcentaje, x = ola, fill = mov, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(position = 'dodge2') +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 0.22)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    #Agrego facer_wrap para hacer un Gráfico para cada tramo etario
    facet_wrap(datos.1.3$pos_id)+
    theme(legend.position = 'top',
          legend.title = element_blank()) 
g1.3
```

### 1.4 Alluvial de movimiento social que más valora

```{r}
elsoc_panel_m1$movsoc<- car::recode(elsoc_panel_m1$c20, 
                                          "1='Progresista';2='Progresista';3='Progresista';
                                          4='Progresista';5='Progresista';6='Conservador';7='Conservador';
                                          8='Progresista';9='Progresista';10='Progresista';11=NA;12='Ninguno';
                                          c(-999,-888)=NA",as.factor=T)

datos.1.4 <- elsoc_panel_m1 %>% 
  dplyr::filter(tipo_atricion == 1) %>% 
  dplyr::filter(!is.na(movsoc)) %>%
  group_by(idencuesta) %>%
  mutate(n_obs = n()) %>%
  ungroup() %>% 
  mutate(n_ok = (n_obs == max(n_obs))) %>% 
  dplyr::filter(n_ok) %>%  # Quedarse solo con los casos con observaciones completas
  group_by(idencuesta, movsoc, ola) %>% 
  summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
  group_by(ola) %>% 
  mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
  ungroup()

etiquetas.1.4 <- datos.1.4 %>% 
  group_by(movsoc, ola) %>% 
  summarise(porcentaje = sum(porcentaje, na.rm = TRUE)) %>% 
  mutate(idencuesta = 1)


```

```{r}
g1.4 <- ggplot(datos.1.4 , aes(x = ola, fill = movsoc, stratum = movsoc, 
                  alluvium = idencuesta, y = porcentaje )) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.1.4, 
            aes(label = scales::percent(porcentaje, accuracy = .1)),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = c(rep('black', 5),
                      rep('black', 5),
                      rep('white', 5))) 

g1.4
```

### 1.5 Descriptivos generales

```{r}
datos.1.5 <- elsoc_panel_m1 %>% 
  dplyr::filter(tipo_atricion == 1) %>% 
  dplyr::filter(!is.na(movsoc)) %>%
  mutate(movsoc = factor(movsoc, 
                         levels = c('Progresista', 'Conservador', 'Ninguno'),
                         labels = c('Progresista', 'Conservador', 'Ninguno'))) %>% 
  group_by(movsoc, ola) %>% 
  summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
  group_by(ola) %>% 
  mutate(n2 = sum(n1, na.rm = TRUE), 
         porcentaje = n1/n2) %>% 
  ungroup()
```

```{r}
g1.5 <- datos.1.5 %>% 
  ggplot(aes(y = porcentaje, x = forcats::fct_rev(movsoc), fill = forcats::fct_rev(ola), 
             label = as.character(scales::percent(ifelse(porcentaje == 0, NA, porcentaje), accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
  geom_text(hjust = -.1,
            position = position_dodge(width = 1),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  guides(fill = guide_legend(reverse = TRUE))+
  coord_flip()
g1.5
```

### 1.6 cambios de valoración de movimientos sociales segun posición política

```{r}
datos.1.6 <- elsoc_panel_m1 %>% 
  dplyr::filter(tipo_atricion == 1) %>%
  mutate(movsoc = factor(movsoc, 
                         levels = c('Progresista', 'Conservador', 'Ninguno'),
                         labels = c('Progresista', 'Conservador', 'Ninguno')),
         pos_id = factor(pos_id, 
                         levels = c('Izquierda', 'Centro', 'Derecha', 'No se identifica'),
                         labels = c('Izquierda', 'Centro', 'Derecha', 'No se\n identifica'))) %>% 
  group_by(ola, movsoc, pos_id) %>% 
  summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
  dplyr::filter(!is.na(pos_id) & !is.na(movsoc)) %>%
  group_by(ola, pos_id) %>% 
  mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
  ungroup() 

```

```{r}
g1.6 <- datos.1.6 %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill =movsoc, 
             label = as.character(scales::percent(ifelse(porcentaje>.01, porcentaje, NA), accuracy = .1)))) +
  theme_bw() +
  geom_col(position = 'stack') +
  facet_grid(.~ola) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c(rep('black', 4),
                          rep('white', 4),
                          rep('white', 4)),5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Porcentaje de valoración de movimientos por posición política, por ola')

g1.6
```

### 1.7 segun nivel educativo

```{r}
datos.1.7 <- elsoc_panel_m1 %>% 
  dplyr::filter(tipo_atricion == 1) %>%
  mutate(movsoc = factor(movsoc, 
                         levels = c('Progresista', 'Conservador', 'Ninguno'),
                         labels = c('Progresista', 'Conservador', 'Ninguno')),
         educ = factor(educ, 
                       levels = c('Basica','Media','Tecnica','Universitaria'),
                       labels = c('Basica','Media','Tecnica','Universitaria'))) %>% 
  group_by(ola, movsoc, educ) %>% 
  summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
  dplyr::filter(!is.na(educ) & !is.na(movsoc)) %>%
  group_by(ola, educ) %>% 
  mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
  ungroup() 
```

```{r}
g1.7 <- datos.1.7 %>% 
  ggplot(aes(y = porcentaje, x = educ, fill =movsoc, 
             label = as.character(scales::percent(ifelse(porcentaje>.01, porcentaje, NA), accuracy = .1)))) +
  theme_bw() +
  geom_col(position = 'stack') +
  facet_grid(.~ola) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c(rep('black', 4),
                          rep('white', 4),
                          rep('white', 4)),5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Porcentaje de valoración de movimientos según nivel educativo, por ola')

g1.7

#REVISAR ESTE GRAFICO NO PLOTEA PROGRESISTAS CON MEDIA PARA 2019
```

### 1.8 Valoración de mov segun segun participacion

```{r}
elsoc_panel_m1$participacion<- factor(car::recode(elsoc_panel_m1$c22, "c(1,2)='Nunca o casi nunca'; 3='A veces';
                                                        c(4,5)='Frecuente o muy frecuentemente';
                                                        c(-999,-888)=NA"),
                                            levels=c('Nunca o casi nunca', 'A veces', 'Frecuente o muy frecuentemente'))


datos.1.8 <- elsoc_panel_m1 %>% 
  dplyr::filter(tipo_atricion == 1) %>%
  mutate(movsoc = factor(movsoc, 
                         levels = c('Progresista', 'Conservador', 'Ninguno'),
                         labels = c('Progresista', 'Conservador', 'Ninguno')),
         participacion = factor(participacion, 
                                levels = c('Nunca o casi nunca', 'A veces', 'Frecuente o muy frecuentemente'),
                                labels = c('Nunca o \ncasi nunca', 'A veces', 'Frecuente o muy\n frecuentemente'))) %>% 
  group_by(ola, movsoc, participacion) %>% 
  summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
  dplyr::filter(!is.na(participacion) & !is.na(movsoc)) %>%
  group_by(ola, participacion) %>% 
  mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
  ungroup() 
```

```{r}
g1.8 <- datos.1.8 %>% 
  ggplot(aes(y = porcentaje, x = participacion, fill =movsoc, 
             label = as.character(scales::percent(ifelse(porcentaje>.01, porcentaje, NA), accuracy = .1)))) +
  theme_bw() +
  geom_col(position = 'stack') +
  facet_grid(.~ola) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c(rep('black', 3),
                          rep('white', 3)),5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Porcentaje de valoración de movimientos segun participación del entrevistado, por ola')

g1.8
```


### 1.9 Frecuencia de participación en movimientos sociales, según Ola de encuesta. Porcentaje que responde A veces, Frecuentemente o Muy frecuentemente

<!-- ### 1.4 Frecuencia de participación en movimientos sociales, según Ola de encuesta. Porcentaje que responde A veces, Frecuentemente o Muy frecuentemente  -->

```{r include=FALSE}
elsoc_panel_m1$freq_part <- car::recode(as.numeric(elsoc_panel_m1$c22), recodes = "c(1,2)=1; c(3,4,5)=2; else=NA", as.factor = TRUE)

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r include=FALSE}
datos.1.9 <- data.frame((svytable(~freq_part + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(freq_part == '2') %>%
  na.omit()
```


```{r echo=FALSE}
g1.9 <- datos.1.9 %>% 
    ggplot(aes(y = porcentaje, x = ola, fill = freq_part, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())

g1.9
```


## Confianza en instituciones

### 1.10 Confianza en distintas instituciones según año

```{r}

elsoc_panel_m1$conf_part <- car::recode(as.numeric(elsoc_panel_m1$c05_02), 
                                      recodes = "c(1,2)='Nada y Poca';
                                      c(3, 4)='Algo y Bastante';
                                      else=NA", as.factor = TRUE)
elsoc_panel_m1$conf_carab <- car::recode(as.numeric(elsoc_panel_m1$c05_03), 
                                      recodes = "c(1,2)='Nada y Poca';
                                      c(3, 4)='Algo y Bastante';
                                      else=NA", as.factor = TRUE)
elsoc_panel_m1$conf_jud <- car::recode(as.numeric(elsoc_panel_m1$c05_05), 
                                      recodes = "c(1,2)='Nada y Poca';
                                      c(3, 4)='Algo y Bastante';
                                      else=NA", as.factor = TRUE)
elsoc_panel_m1$conf_cong <- car::recode(as.numeric(elsoc_panel_m1$c05_07), 
                                      recodes = "c(1,2)='Nada y Poca';
                                      c(3, 4)='Algo y Bastante';
                                      else=NA", as.factor = TRUE)
elsoc_panel_m1$conf_pres <- car::recode(as.numeric(elsoc_panel_m1$c05_08), 
                                      recode = "c(1,2)='Nada y Poca';
                                      c(3, 4)='Algo y Bastante';
                                      else=NA", as.factor = TRUE) 
elsoc_panel_m1$conf_gob <- car::recode(as.numeric(elsoc_panel_m1$c05_01), 
                                      recode = "c(1,2)='Nada y Poca';
                                      c(3, 4)='Algo y Bastante';
                                      else=NA", as.factor = TRUE)

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r}
datos.pres <- data.frame((svytable(~conf_pres + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_pres=Freq/sum(Freq))
datos.pres$ola <- NULL

datos.part <- data.frame((svytable(~conf_part + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_part=Freq/sum(Freq))
datos.part$ola <- NULL

datos.carb <- data.frame((svytable(~conf_carab + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_carb=Freq/sum(Freq))
datos.carb$ola <- NULL

datos.jud <- data.frame((svytable(~conf_jud + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_jud=Freq/sum(Freq))
datos.jud$ola <- NULL

datos.cong <- data.frame((svytable(~conf_cong + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_cong=Freq/sum(Freq))
datos.cong$ola <- NULL

datos.gob <- data.frame((svytable(~conf_gob + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_gob=Freq/sum(Freq))

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

datos.grafico.1.10 <- cbind(datos.pres, datos.part, datos.carb, datos.jud, datos.cong, datos.gob)

#trasponer según variable
datos.1.10 <- datos.grafico.1.10 %>% 
        pivot_longer(cols = starts_with('conf_'))  %>%
        mutate(variable = factor(name,
                             labels = c('Presidente/a de la Republica', 
                                        'Partidos Políticos', 
                                        'Carabineros de Chile', 'Poder Judicial', 
                                        'Congreso Nacional', 
                                        'Gobierno de Chile'))) %>%
                              filter(value == 'Algo y Bastante') %>%
                              drop_na() 

datos.1.10$porcentaje <- with(datos.1.10, case_when(
  variable == 'Carabineros de Chile' ~ p_carb,
  variable == 'Presidente/a de la Republica' ~ p_pres,
  variable == 'Partidos Políticos' ~ p_part,
  variable == 'Poder Judicial' ~ p_jud,
  variable == 'Congreso Nacional' ~ p_cong,
  variable == 'Presidente/a de la Republica' ~ p_gob))


```

```{r}
g1.10 <- ggplot(datos.1.10, aes(y = porcentaje, x = ola, color = variable, group = variable,
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
    theme_bw() +   
    geom_line(size = 1) +
    geom_point(size = 1.8) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = 0, end = .95, direction = 1, option = 'viridis') +
    geom_text_repel(posilinetion = position_dodge(width = .9),
    size= 2.25) + 
    theme(legend.position = 'top',
          legend.title = element_blank())

g1.10
```



### 1.11 Confianza en el gobierno según ola 2018, 2019 y 2021

```{r}

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

```


```{r include=FALSE}
datos.1.11 <- data.frame((svytable(~conf_gob + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola == '2018' | ola == '2019' | ola == '2021') %>%
  na.omit()

```


```{r}
g1.11 <- datos.1.11 %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = conf_gob, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g1.11 
```

### 1.12 Confianza en el presidente según ola 2018, 2019 y 2021

```{r}
elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```


```{r include=FALSE}
datos.1.12 <- data.frame((svytable(~conf_pres + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola == '2018' | ola == '2019' | ola == '2021') %>%
  na.omit()

```



```{r}
g1.12 <- datos.1.12 %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = conf_pres, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g1.12
```



<!--chapter:end:05-mov-sociales-acc-colec.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Identificación Política



## Identificación política

### 2.1 Identificación política por ola

<!-- ### 2.1 Identificación política por ola -->

```{r echo=FALSE}
datos.2.1 <- data.frame((svytable(~pos_id + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  na.omit()
```

```{r echo=FALSE}
g.2.1 <- datos.2.1 %>% 
    ggplot(aes(y = porcentaje, x = pos_id, fill = ola, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
    theme_bw() + 
    geom_col(position= 'dodge2') +
    #escala del eje y en porcentajes del 0 al 100%
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    #Nombres de los ejes se eliminan
    ylab(label = NULL) +
    xlab(label = NULL) +
    #colores oficiales por ola: degradé 'viridis'
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    #etiquetas por sobre cada barra
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    #posicionamiento de leyenda arriba
    theme(legend.position = 'top',
          legend.title = element_blank())

g.2.1
```
### 2.2 Alluvial de cambios de Identificación política

<!-- ### 2.2 Alluvial de cambios de Identificación política (+o-) -->

```{r include=FALSE}
datos.2.2 <- data.frame((svytable(~pos_id + ola + idencuesta, elsoc_diseno, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

etiquetas.2.2 <- data.frame((svytable(~pos_id + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)

elsoc_panel_m1$pos_id <- na.replace(elsoc_panel_m1$pos_id, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r echo=FALSE}

g.2.2 <- ggplot(datos.2.2, aes(x = ola, fill = pos_id, stratum = pos_id,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.2.2, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))

g.2.2
```

### 2.3 Grado de acuerdo con la cuarentena según identificación política

<!-- ### 2.3 Grado de acuerdo con la cuarentena según identificación política -->

```{r include=FALSE}
elsoc_panel_m1$ac_cuar <- car::recode(as.numeric(elsoc_panel_m1$c37_10), 
                                      recodes = "c(1,2)='Totalmente en desacuerdo y En desacuerdo';
                                      c(3)='Ni de acuerdo ni en desacuerdo'; 
                                      c(4,5)='De acuerdo y Totalmente de acuerdo';
                                      else=NA", as.factor = TRUE) 

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r}
datos.2.3 <- data.frame((svytable(~pos_id + ac_cuar + ola, elsoc_diseno, round = F))) %>%
  group_by(pos_id) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola == '2021') %>%
  na.omit()
view(datos.2.3)
```


```{r echo=FALSE}
g.2.3 <-datos.2.3 %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = ac_cuar, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('white', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Grado de acuerdo con la cuarentena según identificación política')

g.2.3
```

### 2.4 Grado de acuerdo con actividad económica versus salud pública según identificación política

<!-- ### 2.4 Grado de acuerdo con la frase "Es más importante darle prioridad a la actividad económica que a la salud de la población" según identificación política -->

```{r include=FALSE}
elsoc_panel_m1$salud_ac <- car::recode(as.numeric(elsoc_panel_m1$c37_09), 
                                      recodes = "c(1,2)='Totalmente en desacuerdo y En desacuerdo';
                                      c(3)='Ni de acuerdo ni en desacuerdo'; 
                                      c(4,5)='De acuerdo y Totalmente de acuerdo';
                                      else=NA", as.factor = TRUE)

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r}
datos.2.4 <- data.frame((svytable(~pos_id + salud_ac + ola, elsoc_diseno, round = F))) %>%
  group_by(pos_id) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola == '2021') %>%
  na.omit()
```


```{r echo=FALSE}
g.2.4 <-datos.2.4 %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = salud_ac, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('white', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Grado de acuerdo con la frase "Es más importante darle prioridad a 
          la actividad económica que a la salud de la población"')

g.2.4
```

### 2.5 Intención de voto según identificación política

<!-- ### 2.5 Intención de voto según identificación política -->

```{r include=FALSE}
datos.2.5 <- data.frame((svytable(~intencion_voto + pos_id + ola, elsoc_diseno, round = F))) %>%
  group_by(pos_id , ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola == '2021') %>%
  na.omit()
```

```{r echo=FALSE}
g.2.5 <-datos.2.5 %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = intencion_voto, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Intención de voto según identificación política')

g.2.5
```


<!--chapter:end:06-id-politica.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Actitudes hacia la democracia

## Apoyo a la Democracia

### 3.1 ¿Con cuál de las siguientes frases está usted más de acuerdo?

<!-- ### 3.1 ¿Con cuál de las siguientes frases está usted más de acuerdo? -->

```{r include=FALSE}
elsoc_panel_m1$aut_dem <- car::recode(as.numeric(elsoc_panel_m1$c25), 
                                      recodes = "c(1)='Democracia es preferible a cualquier otra forma de gobierno'; 
                                      c(2)='En algunos casos, gobierno autoritario puede ser preferible'; c(3)='Da lo mismo régimen democrático o autoritario'; 
                                      c(4)='Ninguna'; 
                                      else=NA", as.factor = TRUE) 
elsoc_panel_m1$aut_dem <- na.replace(elsoc_panel_m1$aut_dem, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

```

```{r}
datos.3.1 <- data.frame((svytable(~aut_dem + ola + idencuesta, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

etiquetas.3.1 <- data.frame((svytable(~aut_dem + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)
```

```{r}
g.3.1 <- ggplot(datos.3.1, aes(x = ola, fill = aut_dem, stratum = aut_dem,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.3.1, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))

g.3.1
```

### 3.2 Frecuencia de respuesta "Nada satisfecho" con la democracia según ola

<!-- ### 3.2 Frecuencia de respuesta "Nada satisfecho" con la democracia según ola -->

```{r echo=FALSE}
#agregar variable a bbdd original

elsoc_panel_m1$sat_dem <- car::recode(as.numeric(elsoc_panel_m1$c01), 
                                      recodes = "c(1)='Nada satisfecho'; 
                                      c(2)='Poco satisfecho'; c(3)='Algo satisfecho'; 
                                      c(4)='Bastante satisfecho';c(5)='Muy satisfecho'; 
                                      else=NA", as.factor = TRUE) 

#volver a realizar el código de la encuesta debido a la presencia de una nueva variable
elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

#crear tabla para el gráfico
datos.3.2 <- data.frame((svytable(~sat_dem + ola, elsoc_diseno, round = F))) %>%
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(sat_dem == 'Nada satisfecho') %>%
  na.omit()

view(datos.3.2)
```


```{r echo=FALSE}
g.3.2 <- datos.3.2 %>% 
    ggplot(aes(y = porcentaje, x = ola, fill = sat_dem, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 0.6)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   ## Eliminar leyenda al no ser necesaria
          legend.title = element_blank()) +
    ggtitle('Frecuencia de respuesta "Nada satisfecho" con la democracia según ola')
g.3.2
```

### 3.3 ¿Con cuál de las siguientes frases está usted más de acuerdo? (2021), según posición ideológica

<!-- ### 3.3. ¿Con cuál de las siguientes frases está usted más de acuerdo? (2019), según posición ideológica -->

```{r include=FALSE}

datos.3.3 <- data.frame((svytable(~aut_dem + pos_id + ola, elsoc_diseno, round = F))) %>%
  group_by(pos_id, ola) %>% 
  mutate(porcentaje=Freq/sum(Freq))%>%
  filter(ola=="2021" & aut_dem!= "NS/NR") %>% 
  na.omit()
```


```{r echo=FALSE}

g.3.3 <-datos.3.3 %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = aut_dem, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g.3.3


```



<!-- ### 3.4 Grado de acuerdo con las siguientes afirmaciones Porcentaje que responde De acuerdo o Totalmente de acuerdo  -->
```{r include=FALSE}

```




<!--chapter:end:07-actitud-demo.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Perfiles Ideológicos de los Chilenos 

## Clases latentes: Motivación

### Batería de preguntas

- Las parejas homosexuales deberían poder adoptar hijos
- El aborto debe ser legal bajo cualquier circunstancia
- El Estado de Chile, más que los privados, debería ser el principal proveedor de educación
- Cada persona debiera asegurarse por sí mismo su futura pensión para la tercera edad
- Chile debería tomar medidas más drásticas para impedir el ingreso de inmigrantes al país
- La educación sexual de los niños debería ser responsabilidad exclusiva de los padres
- Se deberían clausurar empresas contaminantes, incluso si esto implica un aumento en el desempleo
- El gasto social debe destinarse únicamente a los más pobres y vulnerables

## Modelo teórico de perfiles ideólogicos


### Aproximación Empírica


### Perfiles ideológicos: Resultados principales



<!-- ### 4.5 Religión, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```



<!-- ### 4.6 Posición política, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```



<!-- ### 4.7 Interés en política, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```



<!-- ### 4.8 Satisfacción con la Democracia, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```


<!-- ### 4.9 Preferencia por la Democracia, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```


<!-- ### 4.10 Consistencia durante las 4 olas en Posición política, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```

<!-- ### 4.11 Consistencia durante las 4 olas en Identificación partidaria, según Perfiles ideológicos -->
```{r include=FALSE}

```



<!-- ### 4.12 Consistencia durante las 4 olas en Identificación con coaliciones política, según Perfiles ideológicos (2019) -->
```{r include=FALSE}

```

<!-- ### 4.13 Niveles de confianza social, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```


```{r include=FALSE}

```



<!--chapter:end:08-perfiles-ideo.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Conflicto de Clases y Élites

## Relaciones inter-clases

<!-- ### 5.1 Frecuencia de contacto con clase alta y clase baja, según clase social subjetiva del entrevistado (2019) -->

```{r, fig.align='center',fig.cap='Frecuencia de contacto con clase alta y clase baja, según clase social subjetiva del entrevistado (2021)'}
datos.alta <- data.frame((svytable(~d07_rec + clase.sub + ola, elsoc_diseno, round = F))) %>% group_by(clase.sub, ola) %>% mutate(p_alta=Freq/sum(Freq))
datos.alta$clase.sub <- NULL
datos.alta$ola <- NULL
datos.baja <- data.frame((svytable(~d13_rec + clase.sub + ola, elsoc_diseno, round = F))) %>% group_by(clase.sub, ola) %>% mutate(p_baja=Freq/sum(Freq))

datos.grafico1<- cbind(datos.alta, datos.baja)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      d07_rec == 'Alto Contacto' | d13_rec == 'Alto Contacto'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('d'))  %>%
  mutate(variable = factor(name, labels = c('Contacto con Clase Alta', 'Contacto con Clase Baja'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Contacto con Clase Alta' ~ p_alta,
  variable == 'Contacto con Clase Baja' ~ p_baja))

#graficamos

gr.09.1 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

gr.09.1
```

```{r N1, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```

<!-- ### 5.2 Contacto positivo con personas de clase alta y clase baja, según clase social subjetiva del entrevistado (2019) -->

```{r, fig.align='center',fig.cap='Contacto positivo con personas de clase alta y clase baja, según clase social subjetiva del entrevistado (2021)'}
datos.alta <- data.frame((svytable(~d08_rec + clase.sub + ola, elsoc_diseno, round = F))) %>% group_by(clase.sub, ola) %>% mutate(p_alta=Freq/sum(Freq))
datos.alta$clase.sub <- NULL
datos.alta$ola <- NULL
datos.baja <- data.frame((svytable(~d14_rec + clase.sub + ola, elsoc_diseno, round = F))) %>% group_by(clase.sub, ola) %>% mutate(p_baja=Freq/sum(Freq))

datos.grafico1<- cbind(datos.alta, datos.baja)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      d08_rec == 'Alto Contacto Positivo' | d14_rec == 'Alto Contacto Positivo'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('d'))  %>%
  mutate(variable = factor(name, labels = c('Contacto Positivo con Clase Alta', 'Contacto Positivo con Clase Baja'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Contacto Positivo con Clase Alta' ~ p_alta,
  variable == 'Contacto Positivo con Clase Baja' ~ p_baja))

#graficamos

gr.09.2 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

gr.09.2
```

```{r N2, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


<!-- ### 5.3 Contacto negativo con personas de clase alta y clase baja, según clase social subjetiva del entrevistado (2019) -->
```{r d09-d15, fig.align='center',fig.cap='Contacto negativo con personas de clase alta y clase baja, según clase social subjetiva del entrevistado (2021)'}
datos.alta <- data.frame((svytable(~d09_rec + clase.sub + ola, elsoc_diseno, round = F))) %>% group_by(clase.sub, ola) %>% mutate(p_alta=Freq/sum(Freq))
datos.alta$clase.sub <- NULL
datos.alta$ola <- NULL
datos.baja <- data.frame((svytable(~d15_rec + clase.sub + ola, elsoc_diseno, round = F))) %>% group_by(clase.sub, ola) %>% mutate(p_baja=Freq/sum(Freq))

datos.grafico1<- cbind(datos.alta, datos.baja)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      d09_rec == 'Alto Contacto Negativo' | d15_rec == 'Alto Contacto Negativo'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('d'))  %>%
  mutate(variable = factor(name, labels = c('Contacto Negativo con Clase Alta', 'Contacto Negativo con Clase Baja'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Contacto Negativo con Clase Alta' ~ p_alta,
  variable == 'Contacto Negativo con Clase Baja' ~ p_baja))

#graficamos

gr.09.3 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

gr.09.3

```

```{r N3, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


### Clases sociales y Trato Justo

<!-- ### 5.7 ¿Con cuánta frecuencia diría que personas de los siguientes grupos son tratadas con respeto...? Porcentaje que responde frecuencia "Alta"    -->
```{r freq-respeto, fig.align='center',fig.cap='¿Con cuánta frecuencia diría que personas de los siguientes grupos son tratadas con respeto...? Porcentaje que responde frecuencia "Alta"'}
datos.01 <- data.frame((svytable(~d25_01_rec+ ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_01=Freq/sum(Freq))
datos.01$ola <- NULL
datos.02 <- data.frame((svytable(~d25_02_rec+ ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_02=Freq/sum(Freq))
datos.02$ola <- NULL
datos.03 <- data.frame((svytable(~d25_03_rec+ ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_03=Freq/sum(Freq))
datos.03$ola <- NULL
datos.04 <- data.frame((svytable(~d25_04_rec+ ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_04=Freq/sum(Freq))
datos.04$ola <- NULL
datos.05 <- data.frame((svytable(~d25_05_rec+ ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_05=Freq/sum(Freq))
datos.05$ola <- NULL
datos.06 <- data.frame((svytable(~d25_06_rec+ ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_06=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04, datos.05, datos.06)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      d25_01_rec == 'Trato Alto' |
                                      d25_02_rec == 'Trato Alto' |
                                      d25_03_rec == 'Trato Alto' |
                                      d25_04_rec == 'Trato Alto' |
                                      d25_05_rec == 'Trato Alto' |
                                      d25_06_rec == 'Trato Alto'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('d25'))  %>%
  mutate(variable = factor(name, labels = c('Pobres', 
                                            'Clase Media',
                                            'Clase Alta', 
                                            'Jovenes',
                                            'Adultos Mayores', 
                                            'Mujeres'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Pobres' ~ p_01,
  variable == 'Clase Media' ~ p_02,
  variable == 'Clase Alta' ~ p_03,
  variable == 'Jovenes' ~ p_04,
  variable == 'Adultos Mayores' ~ p_05,
  variable == 'Mujeres' ~ p_06,))

#graficamos

gr.09.4 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = value, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2", show.legend = FALSE) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) 

gr.09.4
```

```{r N4, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


## Deprivación Relativa


<!-- ### 5.12 Grado de deprivación Relativa según las siguientes categorías (2019) Suma de Respuestas "De acuerdo" y ”Totalmente de acuerdo"  -->
```{r depriv-rel, fig.align='center',fig.cap='Grado de deprivación Relativa según las siguientes categorías (2021) Suma de Respuestas "De acuerdo" y ”Totalmente de acuerdo"'}
datos.01 <- data.frame((svytable(~d27_01_rec+ ola, elsoc_diseno_2, round = F))) %>% group_by(ola) %>% mutate(p_01=Freq/sum(Freq))
datos.01$ola <- NULL
datos.02 <- data.frame((svytable(~d27_02_rec+ ola, elsoc_diseno_2, round = F))) %>% group_by(ola) %>% mutate(p_02=Freq/sum(Freq))
datos.02$ola <- NULL
datos.03 <- data.frame((svytable(~d27_03_rec+ ola, elsoc_diseno_2, round = F))) %>% group_by(ola) %>% mutate(p_03=Freq/sum(Freq))
datos.03$ola <- NULL
datos.04 <- data.frame((svytable(~d27_04_rec+ ola, elsoc_diseno_2, round = F))) %>% group_by(ola) %>% mutate(p_04=Freq/sum(Freq))
datos.04$ola <- NULL
datos.05 <- data.frame((svytable(~d27_05_rec+ ola, elsoc_diseno_2, round = F))) %>% group_by(ola) %>% mutate(p_05=Freq/sum(Freq))


datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04, datos.05)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      d27_01_rec == 'De Acuerdo' & 
                                      d27_02_rec == 'De Acuerdo' &
                                      d27_03_rec == 'De Acuerdo' & 
                                      d27_04_rec == 'De Acuerdo' &
                                      d27_05_rec == 'De Acuerdo'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('d27'))  %>%
  mutate(variable = factor(name, labels = c("Insatisfaccion al compararme con otros",
                                 "Privilegiado en comparacion a otros",
                                 "Insatisfaccion al compararme con clases altas",
                                 "Mi clase social es privilegiada",
                                "Personas de mi clase peor que las mas altas"))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Insatisfaccion al compararme con otros' ~ p_01,
  variable == 'Privilegiado en comparacion a otros' ~ p_02,
  variable == 'Insatisfaccion al compararme con clases altas' ~ p_03,
  variable == 'Mi clase social es privilegiada' ~ p_04,
  variable == 'Personas de mi clase peor que las mas altas' ~ p_05))

#graficamos

gr.09.5 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = value, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2", show.legend = FALSE) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) 

gr.09.5
```




<!--chapter:end:09-conflicto-clases.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Justificación de la Violencia


## Justificación de la violencia para el control social – a manos de ciudadanos

```{r just-vio-ola, fig.aligN='center', fig.cap='Justificación de la violencia en relación a delincuencia, según ola de encuesta'}
datos.alta <- data.frame((svytable(~f05_01_rec + ola, elsoc_diseno, round = F))) %>% group_by( ola) %>% mutate(p_alta=Freq/sum(Freq))
datos.alta$ola <- NULL
datos.baja <- data.frame((svytable(~f05_02_rec + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_baja=Freq/sum(Freq))

datos.grafico1<- cbind(datos.alta, datos.baja)

#trasponer según variable
datos.grafico <- datos.grafico1 %>% 
  pivot_longer(cols = starts_with('f05_'))  %>%
  mutate(variable = factor(name, labels = c('Personas persigan y golpeen a un delincuente\n que acaba de cometer un asalto', 'Personas amarren a un poste y desnuden a un\n delincuente que acaba de cometer un asalto'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Personas persigan y golpeen a un delincuente\n que acaba de cometer un asalto' ~ p_alta,
  variable == 'Personas amarren a un poste y desnuden a un\n delincuente que acaba de cometer un asalto' ~ p_baja))

#graficamos

g10.1 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = value, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(datos.grafico$variable) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g10.1
```


## Justificación de la violencia para el control social – a manos de carabineros

```{r just-carab-ola, fig.align='center',fig.cap="Justificación de la violencia en relación al actuar de Carabineros, según ola"}
datos.alta <- data.frame((svytable(~f05_03_rec + ola, elsoc_diseno, round = F))) %>% group_by( ola) %>% mutate(p_alta=Freq/sum(Freq))
datos.alta$ola <- NULL
datos.baja <- data.frame((svytable(~f05_04_rec + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_baja=Freq/sum(Freq))
datos.alta$ola <- NULL
datos.media <- data.frame((svytable(~f05_07_rec + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_media=Freq/sum(Freq))
datos.grafico1<- cbind(datos.alta, datos.baja, datos.media)

#trasponer según variable
datos.grafico <- datos.grafico1 %>% 
  pivot_longer(cols = starts_with('f05_'))  %>%
  mutate(variable = factor(name, labels = c('Carabineros use la fuerza para\n reprimir manifestación pacífica',
                                 'Carabineros desaloje a la fuerza\na estudiantes de liceo en toma',
                                 'Estudiantes tiren piedras a Carabi-\nneros en marcha por la educación'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Carabineros use la fuerza para\n reprimir manifestación pacífica' ~ p_alta,
  variable == 'Carabineros desaloje a la fuerza\na estudiantes de liceo en toma' ~ p_baja,
  variable == 'Estudiantes tiren piedras a Carabi-\nneros en marcha por la educación' ~ p_media))

#graficamos

g10.2 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = value, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(datos.grafico$variable) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g10.2
```



<!--chapter:end:10-just-viol.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Cambio Constitucional

```{r particip-edad, fig.align='center', fig.cap='Participación en Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c43 + ola + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(ola==2021)

g11.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = edadt, fill = c43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle()

g11.1
```

```{r servel-apruebo, fig.align='center', fig.cap='Voto retrospectivo Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c44 + ola, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021) 

apruebo <- tibble(c44="Apruebo", ola="Datos Servel", Freq=0 , porcentaje=0.7828)
rechazo <- tibble(c44="Rechazo", ola="Datos Servel", Freq=0 , porcentaje=0.2172)

datos.subset <- rbind(datos.grafico, apruebo, rechazo)

g11.2 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = c44, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.2
```

```{r servel-cc, fig.align='center', fig.cap= 'Voto Retrospectivo Plebiscito Nueva Constitucion'}
datos.grafico <- data.frame((svytable(~c45 + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021) 

cm <- tibble(c45="Convención Mixta", ola="Datos Servel", Freq=0 , porcentaje=0.2101)
cc <- tibble(c45="Convención Constitucional", ola="Datos Servel", Fre1=0 , porcentaje=0.7899)

datos.subset <- rbind(datos.grafico, cm, cc)

g11.3 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = c45, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.3
```

```{r particip-elect-id, fig.align='center', fig.cap= 'Sí Participa en Elecciones según Identificación Política'}
datos.grafico <- data.frame((svytable(~particip_electoral + pos_id + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(pos_id, ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) 

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$particip_electoral == "Si" & 
                                  (datos.grafico$ola == '2016' | 
                                  datos.grafico$ola == '2018' | 
                                  datos.grafico$ola == "2021")  ))

g11.4 <- ggplot(datos.subset, 
               aes(y = porcentaje, x = ola, 
                   color = pos_id, group = pos_id,
              label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0.22, end = .66, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.4
```

```{r id-pol-voto, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
#como voto cada id_pol en el plebicito
datos.grafico <- data.frame((svytable(~c44_rec + pos_id, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(pos_id) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g11.5 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = pos_id, fill = c44_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.5
```

## Patrones de Votación

```{r presi-voto-c44, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.grafico <- data.frame((svytable(~c44_rec + c39_rec, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c39_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g11.6 <- datos.grafico %>% 
  ggplot(aes(x = porcentaje, y = c39_rec, fill = c44_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 9)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.6
```

```{r presi-voto-c45}
datos.grafico <- data.frame((svytable(~c45_rec + c39_rec, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c39_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g11.7 <- datos.grafico %>% 
  ggplot(aes(x = porcentaje, y = c39_rec, fill = c45_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 9)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle("Voto Retrospectivo Plebicito, según Posición Ideológica")

g11.7
```

```{r 2020-vs-2021, fig.align='center', fig.cap= "Participación Electoral 2021, según la Participación en 2017"}
datos.grafico <- data.frame((svytable(~c43 + c11, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(c11) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g11.7 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = c11, fill = c43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = "Participación Electoral en 2017") +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(porcentaje > 0.06 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g11.7
```

```{r cambio_participa}
#grafico y caracterización pendiente
sjmisc::frq(elsoc_wide_m1$cambio_participa_w05)
```



<!--chapter:end:11-camb-constiucional.Rmd-->

# Conflicto barrial

```{r Disenno-complejo, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 

Sys.setlocale("LC_ALL","ES_ES.UTF-8")

rm(list = ls())
library(survey)
library(tidyverse)
getwd()
load("1_input/datos_elsoc.RData")

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel)

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel_m1)
```

<!-- ### 8.1 ¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio -->
```{r confli-total, fig.align='center', fig.cap='¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio '}
datos.g8.1 <- data.frame(svytable(~confli_barrial_rec + ola, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit()

g8.1 <- 
  datos.g8.1 %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = confli_barrial_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.1
```

<!-- ### 8.2 Cambios en frecuencia de conflictos barriales -->
```{r confli-cambios, fig.align='center', fig.cap='Cambios en frecuencia de conflictos barriales'}
datos.g8.2 <- data.frame((svytable(~confli_barrial_rec + ola + idencuesta, elsoc_diseno_m1, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%  
  dplyr::filter(ola == '2019' | ola == '2021') %>% 
  na.omit()

etiquetas.g8.2 <- data.frame((svytable(~confli_barrial_rec + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  dplyr::filter(ola == '2019' | ola == '2021') %>% 
  na.omit()

g8.2 <- 
  ggplot(datos.g8.2, aes(x = ola, fill = confli_barrial_rec, stratum = confli_barrial_rec, 
                           alluvium = idencuesta, y = porcentaje)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.g8.2, 
            aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'),2))
g8.2
```


<!-- ### 8.3 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona geográfica. Porcentaje con conflictos barriables "Siempre" o "Muchas veces".  -->
```{r confli-zona, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona geográfica. Porcentaje con conflictos barriables "Siempre" o "Muchas veces"'}
datos.g8.3 <- data.frame(svytable(~confli_barrial_rec + ola + zona1, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, zona1) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(confli_barrial_rec == 'Muchas veces o siempre', ola == '2019' | ola == '2021')

g8.3 <-
  datos.g8.3 %>% 
  ggplot(aes(y = porcentaje, x = zona1, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.3
```

<!-- ### 8.4 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriables "Siempre" o "Muchas veces".  -->
```{r confli-estrato, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriables "Siempre" o "Muchas veces".'}
datos.g8.4 <- data.frame(svytable(~confli_barrial_rec + ola + estrato, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, estrato) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(confli_barrial_rec == 'Muchas veces o siempre', ola == '2019' | ola == '2021')

g8.4 <-
  datos.g8.4 %>% 
  ggplot(aes(y = porcentaje, x = estrato, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.4
```


<!-- ### 8.5 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintiles de ingreso. Porcentaje con conflictos barriables "Siempre" o "Muchas veces".  -->
```{r confli-quintil, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintiles de ingreso. Porcentaje con conflictos barriables "Siempre" o "Muchas veces".'}
datos.g8.5 <- data.frame(svytable(~confli_barrial_rec + ola + quintil, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, quintil) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(confli_barrial_rec == 'Muchas veces o siempre', ola == '2019' | ola == '2021')

g8.5 <-
  datos.g8.5 %>% 
  ggplot(aes(y = porcentaje, x = quintil, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.5
```
<!-- ### 8.6 ¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos?, según grado de cumplimiento de aislamiento social (2021). -->
```{r confli-aisl, fig.align='center', fig.cap='¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según grado de cumplimiento de aislamiento social (2021).'}
datos.g8.6 <- 
  data.frame((svytable(~confli_barrial_rec + aislamiento + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(aislamiento, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g8.6 <- 
  datos.g8.6 %>% 
  ggplot(aes(y = porcentaje, x = aislamiento, fill = confli_barrial_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = 'Cumplimiento aislamiento social') +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','white', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.6
```


<!--chapter:end:12-territorio.Rmd-->

## Efecto aislamiento social 

```{r Disenno complejo, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 

Sys.setlocale("LC_ALL","ES_ES.UTF-8")

rm(list = ls())
library(survey)
library(tidyverse)
library(ggrepel)
getwd()
load("1_input/datos_elsoc.RData")

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel)

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel_m1)
```

```{r aisl-total}
datos.g13.1 <- data.frame(svytable(~aislamiento, elsoc_diseno_m1, round = F)) %>% 
  mutate(porcentaje = Freq/sum(Freq)) %>% 
  na.omit

g13.1 <- datos.g13.1 %>% 
  ggplot(aes(y = porcentaje, x = aislamiento, fill = aislamiento, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none', 
          legend.title = element_blank())
g13.1
```

```{r aisl-quintil}
datos.g13.2 <- 
  data.frame((svytable(~aislamiento + quintil + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(quintil, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g13.2 <- 
  datos.g13.2 %>% 
  ggplot(aes(y = porcentaje, x = quintil, fill = aislamiento, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g13.2
```

```{r aisl-zona}
datos.g13.3 <- 
  data.frame((svytable(~aislamiento + zona1 + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(zona1, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g13.3 <- 
  datos.g13.3 %>% 
  ggplot(aes(y = porcentaje, x = zona1, fill = aislamiento, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g13.3
```

```{r aisl-estrato}
datos.g13.4 <- 
  data.frame((svytable(~aislamiento + estrato + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(estrato, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g13.4 <- 
  datos.g13.4 %>% 
  ggplot(aes(y = porcentaje, x = estrato, fill = aislamiento, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 6)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g13.4
```

```{r aisl-telet}
sjmisc::frq(elsoc_panel_m1$m60)
datos.g13.5 <- 
  data.frame((svytable(~aislamiento + m60 + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(m60, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g13.5 <- 
  datos.g13.5 %>% 
  ggplot(aes(y = porcentaje, x = m60, fill = aislamiento, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g13.5
```

```{r aisl-prosocial}
sjmisc::frq(elsoc_panel_m1$conf_vecinos)

elsoc_panel_m1 <- elsoc_panel_m1 %>%
  mutate(frec_veci = factor(car::recode(c07_01, "1=1;2=2;3=3"),
                           labels = c('Nunca lo hizo', 'Lo hizo una o dos veces', 'Lo hizo mas de dos veces')),
         frec_visi = factor(car::recode(c07_03, "1=1;2=2;3=3"),
                               labels = c('Nunca lo hizo', 'Lo hizo una o dos veces', 'Lo hizo mas de dos veces')),
         frec_reun = factor(car::recode(c07_02, "1=1;2=2;3=3"),
                            labels = c('Nunca lo hizo', 'Lo hizo una o dos veces', 'Lo hizo mas de dos veces')),
         frec_conv = factor(car::recode(c07_07, "1=1;2=2;3=3"),
                          labels = c('Nunca lo hizo', 'Lo hizo una o dos veces', 'Lo hizo mas de dos veces')))

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                             nest = TRUE, data = elsoc_panel_m1)

datos.fveci <- data.frame((svytable(~frec_veci + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(ola) %>% mutate(p_veci=Freq/sum(Freq))
datos.fveci$ola <- NULL

datos.fvisit <- data.frame((svytable(~frec_visi + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(p_visi=Freq/sum(Freq))
datos.fvisit$ola <- NULL

datos.freu <- data.frame((svytable(~frec_reun + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(p_reun=Freq/sum(Freq))
datos.freu$ola <- NULL

datos.fconv <- data.frame((svytable(~frec_conv + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(p_conv=Freq/sum(Freq))

datos.g0.6 <- cbind(datos.fveci, datos.fvisit, datos.freu, datos.fconv)

#trasponer según variable
datos.g0.6a <- datos.g0.6 %>% 
  pivot_longer(cols = starts_with('frec_'))  %>%
  mutate(variable = factor(name,
                           labels = c('Visito casa de vecino', 
                                      'Amigos visitaron su casa',
                                      'Asistio a reunion sobre temas de interes publico/comunitario',
                                      'Converso con persona en problemas o deprimida'))) %>%
  drop_na()

datos.g0.6a$porcentaje <- with(datos.g0.6a, case_when(
  variable == 'Visito casa de vecino' ~ p_veci,
  variable == 'Amigos visitaron su casa' ~ p_visi,
  variable == 'Asistio a reunion sobre temas de interes publico/comunitario' ~ p_reun,
  variable == 'Converso con persona en problemas o deprimida' ~ p_conv))

#Paso 1.2: filtrar el subset manteniendo "De acuerdo o totalmente de acuerdo"
subset.g0.6 <- droplevels(subset(datos.g0.6a, value == 'Lo hizo mas de dos veces'))

g0.6 <- 
  ggplot(subset.g0.6, aes(y = porcentaje, x = ola, color = variable, group = variable,
                              label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g0.6

```

<!--chapter:end:13-aisla-social.Rmd-->

# Confianza y seguridad con perspectiva territorial
```{r Diseno complejo2, include=FALSE}
rm(list = ls())
library(survey)
library(tidyverse)
library(ggrepel)
load("1_input/datos_elsoc.RData")

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel_m1)
```

```{r Recode, include=FALSE}

elsoc_panel_m1 <- 
  elsoc_panel_m1 %>%
  mutate(conf_vecinos = factor(car::recode(t01, "c(1,2) = 1;c(3) = 2;c(4,5) = 3"),
                               labels = c('Muy poco o poco', 
                                              'Algo',
                                              'Bastante o mucho')),
         segur_barrio = factor(car::recode(t10, "c(1,2) = 1;c(3) = 2;c(4,5) = 3"),
                               labels = c('Muy inseguro o inseguro', 
                                          'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro')))
sjmisc::frq(elsoc_panel_m1$conf_vecinos)
sjmisc::frq(elsoc_panel_m1$segur_barrio)

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                             nest = TRUE, data = elsoc_panel_m1)
```

## Confianza en vecinos

<!-- ### 10.0 En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio -->
```{r vecinos-total, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio.'}
datos.g10.0 <- data.frame(svytable(~conf_vecinos + ola, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit()

g10.0 <- 
  datos.g10.0 %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = conf_vecinos, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.0
```

<!-- ### 10.1 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.  -->
```{r vecinos-zona, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.g10.1 <- data.frame(svytable(~conf_vecinos + ola + zona1, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, zona1) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(conf_vecinos == 'Bastante o mucho', ola == '2019' | ola == '2021')

g10.1 <-
  datos.g10.1 %>% 
  ggplot(aes(y = porcentaje, x = zona1, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g10.1
```

<!-- ### 10.2 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y nivel educacional. Suma de Respuestas “Bastante” y “Mucho”. -->
```{r vecinos-quinti, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y nivel educacional. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.g10.2 <- data.frame(svytable(~conf_vecinos + ola + quintil, elsoc_diseno_m1, round = F)) %>% 
  group_by(ola, quintil) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(conf_vecinos == 'Bastante o mucho', ola == '2019' | ola == '2021')

g10.2 <-
  datos.g10.2 %>% 
  ggplot(aes(y = porcentaje, x = quintil, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g10.2
```
<!-- ### 8.6 ¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos?, según grado de cumplimiento de aislamiento social (2021). -->
```{r vecinos-aisl, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? según grado de cumplimiento de aislamiento social (2021).'}
datos.g10.X <- 
  data.frame((svytable(~conf_vecinos + aislamiento + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(aislamiento, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g10.X <- 
  datos.g10.X %>% 
  ggplot(aes(y = porcentaje, x = aislamiento, fill = conf_vecinos, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = 'Cumplimiento aislamiento social') +
  scale_fill_viridis_d(begin = 0, end = .99, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('white', 'white','black'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.X
```

## Seguridad barrial
<!-- ### 10.3 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Seguro" o ”Muy Seguro".  -->

```{r seguri-zona, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.3 <- data.frame((svytable(~zona1 + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, zona1) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.3 <- 
  ggplot(datos.g10.3, aes(y = porcentaje, x = ola, color = zona1, group = zona1,
                           label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .88, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.3
```

<!-- ### 10.4 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-educ, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.4 <- data.frame((svytable(~educ + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, educ) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.4 <- 
  ggplot(datos.g10.4, aes(y = porcentaje, x = ola, color = educ, group = educ,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .88, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.4
```


<!-- ### 10.5 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-edad, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.5 <- data.frame((svytable(~edadt + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, edadt) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.5 <- 
  ggplot(datos.g10.5, aes(y = porcentaje, x = ola, color = edadt, group = edadt,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .88, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
                  posilinetion = position_dodge(width = .9),
                  size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.5
```


<!-- ### 10.6 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintiles de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-quintil, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintiles de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro".'}

datos.g10.6 <- data.frame((svytable(~quintil + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, quintil) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro", quintil == "Q1" | quintil == "Q5") 

g10.6 <- 
  ggplot(datos.g10.6, aes(y = porcentaje, x = ola, color = quintil, group = quintil,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .22, end = .77, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.6
```


<!-- ### 10.7 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio e ideología política. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-ideolo, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio e ideología política. Suma de Respuestas "Seguro" o ”Muy Seguro".'}
datos.g10.7 <- data.frame((svytable(~pos_id + ola + segur_barrio, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola, pos_id) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(segur_barrio == "Seguro o Muy seguro") 

g10.7 <- 
  ggplot(datos.g10.7, aes(y = porcentaje, x = ola, color = pos_id, group = pos_id,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .22, end = .88, direction = -1, option = 'viridis') +
  geom_text_repel(vjust = -0.8,
                  posilinetion = position_dodge(width = .9),
                  size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g10.7  
```

 

<!--chapter:end:14-confianza-territ.Rmd-->

# Estatus subjetivo y Percepción de Mérito
```{r Disenno complejo2, include=FALSE}
rm(list = ls())
library(survey)
library(tidyverse)
load("1_input/datos_elsoc.RData")

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel_m1)
```

## Estatus subjetivo

```{r Recode estatus, include=FALSE}
elsoc_panel_m1 <- elsoc_panel_m1 %>% 
  mutate(mov_interg = d01_03 - d01_01, #estatus futuro hijos menos estatus propio
         mov_relativa = d01_01 - d01_02) #estatus propio vs estatus padres

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                             nest = TRUE, data = elsoc_panel_m1)

```

```{r}
elsoc_movilidad <- elsoc_panel_m1 %>%
  group_by(ola) %>% 
  summarise(m_interg = weighted.mean(mov_interg, ponderador02 ,na.rm = T),
            m_relativa = weighted.mean(mov_relativa, ponderador02 ,na.rm = T),
            m_estatus = weighted.mean(d01_01, ponderador02 ,na.rm = T),
            conteo = n()) %>% 
  mutate(var_interg = 'Perspectiva de movilidad social',
         var_relativa = 'Movilidad social relativa',
         var_estatus = 'Estatus social actual') 

elsoc_movilidad$m_interg <- round(elsoc_movilidad$m_interg, digits = 2) 
elsoc_movilidad$m_relativa <- round(elsoc_movilidad$m_relativa, digits = 2) 
elsoc_movilidad$m_estatus <- round(elsoc_movilidad$m_estatus, digits = 2) 

datos.g11.0 <- elsoc_movilidad %>% 
  pivot_longer(cols = starts_with('var_'))  %>%
  mutate(mov_social = factor(name, labels = c('Perspectiva de movilidad social',
                                      'Movilidad social relativa','Estatus social actual'))) %>% 
  drop_na()

datos.g11.0$m_mov_social <- with(datos.g11.0, case_when(
  mov_social == 'Perspectiva de movilidad social' ~ m_interg,
  mov_social == 'Movilidad social relativa' ~ m_relativa,
  mov_social == 'Estatus social actual' ~ m_estatus))

g11.0 <- 
  ggplot(datos.g11.0, aes(y = m_mov_social, x = ola, group = mov_social, color = mov_social,
                              label = m_mov_social)) +
  theme_bw() +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(limits = c(0,5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .11, end = .55, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(posilinetion = position_dodge(width = .9),
                  vjust = -0.8,
                  size= 3.5)
g11.0
```


<!-- ### 11.1 En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio. -->
```{r essind-ola, fig.align='center',fig.cap='En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio.'}

datos.g11.1 <- 
  data.frame((svytable(~clase.sub + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(ola) %>% 
  mutate(porcentaje = Freq/sum(Freq))

g11.1 <- 
  datos.g11.1 %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .99, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.1

```


<!-- ### 11.2 Cambios de Clase social subjetiva entre 2016, 2019 y 2021 -->
```{r ess-wave, fig.align='center',fig.cap='Cambios de Clase social subjetiva entre 2016, 2019 y 2021'}
datos.g11.2 <- data.frame((svytable(~clase.sub + ola + idencuesta, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>%
  filter(Freq>0, ola == '2016'| ola == '2019' | ola == '2021') %>%
  na.omit()

etiquetas.g11.2 <- data.frame((svytable(~clase.sub + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  filter(Freq>0, ola == '2016'| ola == '2019' | ola == '2021') %>% 
  na.omit()

g11.2 <- 
  ggplot(datos.g11.2, aes(x = ola, fill = clase.sub, stratum = clase.sub, 
                          alluvium = idencuesta, y = porcentaje)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .95, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.g11.2, 
            aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white', 'white'),3)) +
  ggtitle('Cambios de Clase social subjetiva entre 2019 y 2021')

g11.2

```


<!-- ### 11.3 Clase social subjetiva, según quintiles de ingreso (2021) -->
```{r ess-quintil, fig.align='center',fig.cap='Clase social subjetiva, según quintiles de ingreso (2021)'}
datos.g11.3 <- 
  data.frame((svytable(~clase.sub + quintil + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(quintil, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>%
  filter(ola == '2019') %>% 
  na.omit()

g11.3 <- 
  datos.g11.3 %>% 
  ggplot(aes(y = porcentaje, x = quintil, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.3
```

<!-- ### 11.4  Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021) -->
```{r esshijos-ess, fig.align='center',fig.cap='Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021)'}
datos.g11.4 <- 
  data.frame((svytable(~clase.sub.hijos + clase.sub + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(clase.sub, ola) %>% mutate(porcentaje = Freq/sum(Freq)) %>% 
  filter(ola == '2021') %>% 
  na.omit()

g11.4 <- 
  datos.g11.4 %>% 
  ggplot(aes(y = porcentaje, x = clase.sub, fill = clase.sub.hijos, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = 'Clase social subjetiva propia') +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.4
```

## Percepción de meritocracia

<!-- ### 11.5  Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".  -->
```{r merit-wave, fig.align='center',fig.cap='Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".'}

elsoc_panel_m1 <- elsoc_panel_m1 %>%
  mutate(merit_esfu = factor(car::recode(c18_09, "c(1,2)=1;c(3)=2;c(4,5)=3"),
                           labels = c('En desacuendo o totalmente en desacuerdo', 
                                      'Ni de acuerdo ni en desacuerdo', 'De acuerdo o totalmente de acuerdo')),
         merit_inte = factor(car::recode(c18_10, "c(1,2)=1;c(3)=2;c(4,5)=3"),
                               labels = c('En desacuendo o totalmente en desacuerdo', 
                                          'Ni de acuerdo ni en desacuerdo', 'De acuerdo o totalmente de acuerdo')),
         merit_educ = factor(car::recode(d05_02, "c(1,2)=1;c(3)=2;c(4,5)=3"),
                            labels = c('En desacuendo o totalmente en desacuerdo', 
                                       'Ni de acuerdo ni en desacuerdo', 'De acuerdo o totalmente de acuerdo')),
         merit_trab = factor(car::recode(d05_04, "c(1,2)=1;c(3)=2;c(4,5)=3"),
                          labels = c('En desacuendo o totalmente en desacuerdo', 
                                     'Ni de acuerdo ni en desacuerdo', 'De acuerdo o totalmente de acuerdo')))

elsoc_diseno_m1 <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                             nest = TRUE, data = elsoc_panel_m1)

datos.esfu <- data.frame((svytable(~merit_esfu + ola, elsoc_diseno_m1, round = F))) %>%
  group_by(ola) %>% mutate(p_esfu=Freq/sum(Freq))
datos.esfu$ola <- NULL

datos.inte <- data.frame((svytable(~merit_inte + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(p_inte=Freq/sum(Freq))
datos.inte$ola <- NULL

datos.educ <- data.frame((svytable(~merit_educ + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(p_educ=Freq/sum(Freq))
datos.educ$ola <- NULL

datos.trab <- data.frame((svytable(~merit_trab + ola, elsoc_diseno_m1, round = F))) %>% 
  group_by(ola) %>% mutate(p_trab=Freq/sum(Freq))

datos.grafico.g11.5 <- cbind(datos.esfu, datos.inte, datos.educ, datos.trab)

#trasponer según variable
datos.grafico.g11.5.a <- datos.grafico.g11.5 %>% 
  pivot_longer(cols = starts_with('merit_'))  %>%
  mutate(variable = factor(name,
                           labels = c('Personas son recompensadas por su esfuerzo', 
                                      'Personas son recompensadas por su inteligencia',
                                      'Educación es importane para surgir en la vida',
                                      'Trabajo duro es importane para surgir en la vida'))) %>%
  drop_na()

datos.grafico.g11.5.a$porcentaje <- with(datos.grafico.g11.5.a, case_when(
  variable == 'Personas son recompensadas por su esfuerzo' ~ p_esfu,
  variable == 'Personas son recompensadas por su inteligencia' ~ p_inte,
  variable == 'Educación es importane para surgir en la vida' ~ p_educ,
  variable == 'Trabajo duro es importane para surgir en la vida' ~ p_trab))

#Paso 1.2: filtrar el subset manteniendo "De acuerdo o totalmente de acuerdo"
subset.g11.5 <- droplevels(subset(datos.grafico.g11.5.a, value == 'De acuerdo o totalmente de acuerdo'))

g11.5 <- 
  ggplot(subset.g11.5, aes(y = porcentaje, x = ola, color = variable, group = variable,
                              label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            posilinetion = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) + 
  ggtitle('Percepción de importancia y recompensas del mérito, según ola de estudio. 
          Porcentaje de Respuestas “De acuerdo” y ”Totalmente de acuerdo".')

g11.5
```


<!--chapter:end:15-merito-desig.Rmd-->

---
output:
  pdf_document: default
  html_document: default
---
# Género

## Sexismo hostil y benevolente

```{r objetos, include=FALSE}
#Escala sexismo
elsoc_panel_m1$sexismo <- c( as.numeric(elsoc_panel_m1$g01_01) + as.numeric(elsoc_panel_m1$g01_02) +
                          as.numeric(elsoc_panel_m1$g01_03) + as.numeric(elsoc_panel_m1$g01_04)) /4

elsoc_panel_m1$sexismo_benevolo <- c( as.numeric(elsoc_panel_m1$g01_01) + as.numeric(elsoc_panel_m1$g01_02))/2
elsoc_panel_m1$sexismo_benevolo <- factor(car::recode(as.numeric(elsoc_panel_m1$sexismo_benevolo), 'c(1,1.5,2)=1;c(2.5, 3, 3.5)=2;c(4,4.5, 5)= 3; else=NA', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Debil', 'Medio', 'Fuerte'))
elsoc_panel_m1$sexismo_benevolo <- na.replace(elsoc_panel_m1$sexismo_benevolo, "NS/NR") #recode NA en categoría "NS/NR"
elsoc_panel_m1$sexismo_hostil <- c(as.numeric(elsoc_panel_m1$g01_03) + as.numeric(elsoc_panel_m1$g01_04))/2
elsoc_panel_m1$sexismo_hostil <- factor(car::recode(as.numeric(elsoc_panel_m1$sexismo_hostil), 'c(1,1.5,2)=1;c(2.5, 3, 3.5)=2;c(4,4.5, 5)= 3; else=NA', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Debil', 'Medio', 'Fuerte'))
elsoc_panel_m1$sexismo_hostil <- na.replace(elsoc_panel_m1$sexismo_hostil, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_panel_m1$g01_01_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_01), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))
elsoc_panel_m1$g01_02_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_02), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$g01_03_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_03), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$g01_04_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_04), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))


#Variables 2018 al 2021
elsoc_panel_m1$c19_01_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_01), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))


elsoc_panel_m1$c19_02_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_02), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$c19_03_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_03), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$c19_04_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_04), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

#Horas de Cuidado
elsoc_panel_m1$m17_rec <- factor(car::recode(elsoc_panel_m1$m17, '0:3=1;4:9=2;10:29=3;30:59=4;60:300=5; else="NS/NR"', as.factor = TRUE), levels = c(1,2,3,4,5),
                          labels = c('0-3 Horas','4-9 Horas','10-29 Horas', '30-59 Horas', '60 o más Horas'))
elsoc_panel_m1$m17_rec <- sjlabelled::set_label(elsoc_panel_m1$m17_rec, label = c("Horas de Cuidado en Tramos")) 

elsoc_diseno <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r sexismo-ben, fig.align='center', fig.cap='Cambio en Sexismo benévolo, según ola y sexo .'}

#1
datos.grafico <- data.frame((svytable(~sexismo_benevolo + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola,m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2019' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~sexismo_benevolo + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, 
                     etiquetas.grafico$ola == '2019' | etiquetas.grafico$ola == '2021'))

g16.1 <- ggplot(subset.grafico, aes(x = ola, fill = sexismo_benevolo, stratum = sexismo_benevolo, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75, color = rep.int(c('black','white', 'white'), 4))

g16.1
```

```{r sexismo-host, fig.align='center', fig.cap='Sexismo hostil, según ola y sexo .'}

#1
datos.grafico <- data.frame((svytable(~sexismo_hostil + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola,m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2019' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~sexismo_hostil + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, 
                     etiquetas.grafico$ola == '2019' | etiquetas.grafico$ola == '2021'))

g16.2 <- ggplot(subset.grafico, aes(x = ola, fill = sexismo_hostil, stratum = sexismo_hostil, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75, color = rep.int(c('black','white', 'white'), 4))

g16.2
```

```{r sexismo-sexo, fig.align='center', fig.cap='Sexismo benévolo y hostil, según sexo (2021). Porcentaje que responde "De acuerdo" o "Totalmente de acuerdo".'}
datos.01 <- data.frame((svytable(~g01_01_rec + m0_sexo + ola, elsoc_diseno, round = F))) %>% group_by(ola, m0_sexo) %>% mutate(p_01=Freq/sum(Freq))
datos.01$ola <- NULL
datos.01$m0_sexo <- NULL
datos.02 <- data.frame((svytable(~g01_02_rec+m0_sexo +  ola, elsoc_diseno, round = F))) %>% group_by(ola, m0_sexo) %>% mutate(p_02=Freq/sum(Freq))
datos.02$ola <- NULL
datos.02$m0_sexo <- NULL
datos.03 <- data.frame((svytable(~g01_03_rec+m0_sexo +  ola, elsoc_diseno, round = F))) %>% group_by(ola, m0_sexo) %>% mutate(p_03=Freq/sum(Freq))
datos.03$ola <- NULL
datos.03$m0_sexo <- NULL
datos.04 <- data.frame((svytable(~g01_04_rec+m0_sexo +  ola, elsoc_diseno, round = F))) %>% group_by(ola, m0_sexo) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      g01_01_rec == 'De Acuerdo' & 
                                      g01_02_rec == 'De Acuerdo' &
                                      g01_03_rec == 'De Acuerdo' & 
                                      g01_04_rec == 'De Acuerdo'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('g01'))  %>%
  mutate(variable = factor(name, labels = c('Mujeres son más refinadas y con mejor gusto que los hombres',
                     'Mujeres debieran ser queridas y protegidas por los hombres',
                     'Mujeres consiguen privilegios en nombre de igualdad',
                     'Cuando mujeres son derrotadas limpiamente, se quejan de discriminación'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Mujeres son más refinadas y con mejor gusto que los hombres' ~ p_01,
  variable == 'Mujeres debieran ser queridas y protegidas por los hombres' ~ p_02,
  variable == 'Mujeres consiguen privilegios en nombre de igualdad' ~ p_03,
  variable == 'Cuando mujeres son derrotadas limpiamente, se quejan de discriminación' ~ p_04))

#graficamos

g16.3 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = m0_sexo, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g16.3

```

```{r sexismo-educ, fig.align='center',fig.cap='Sexismo benévolo y hostil, según nivel educacional (2021). Porcentaje que responde "De acuerdo" o "Totalmente de acuerdo".'}
datos.01 <- data.frame((svytable(~g01_01_rec + educ + ola, elsoc_diseno, round = F))) %>% group_by(ola, educ) %>% mutate(p_01=Freq/sum(Freq))
datos.01$ola <- NULL
datos.01$educ <- NULL
datos.02 <- data.frame((svytable(~g01_02_rec+educ +  ola, elsoc_diseno, round = F))) %>% group_by(ola, educ) %>% mutate(p_02=Freq/sum(Freq))
datos.02$ola <- NULL
datos.02$educ <- NULL
datos.03 <- data.frame((svytable(~g01_03_rec+educ +  ola, elsoc_diseno, round = F))) %>% group_by(ola, educ) %>% mutate(p_03=Freq/sum(Freq))
datos.03$ola <- NULL
datos.03$educ <- NULL
datos.04 <- data.frame((svytable(~g01_04_rec+educ +  ola, elsoc_diseno, round = F))) %>% group_by(ola, educ) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1, datos.grafico1$ola == '2021' & 
                                      g01_01_rec == 'De Acuerdo' & 
                                      g01_02_rec == 'De Acuerdo' &
                                      g01_03_rec == 'De Acuerdo' & 
                                      g01_04_rec == 'De Acuerdo'))

#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('g01'))  %>%
  mutate(variable = factor(name, labels = c('Mujeres son más refinadas y con mejor gusto que los hombres',
                     'Mujeres debieran ser queridas y protegidas por los hombres',
                     'Mujeres consiguen privilegios en nombre de igualdad',
                     'Cuando mujeres son derrotadas limpiamente, se quejan de discriminación'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Mujeres son más refinadas y con mejor gusto que los hombres' ~ p_01,
  variable == 'Mujeres debieran ser queridas y protegidas por los hombres' ~ p_02,
  variable == 'Mujeres consiguen privilegios en nombre de igualdad' ~ p_03,
  variable == 'Cuando mujeres son derrotadas limpiamente, se quejan de discriminación' ~ p_04))

#graficamos

g16.4 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = educ, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g16.4
```

## Roles de Género
```{r c19_01, fig.align='center', fig.cap='Sexismo hostil, según ola y sexo .'}
#1
datos.grafico <- data.frame((svytable(~c19_01_rec + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2016' |  datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~c19_01_rec + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2016' | etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.5 <- ggplot(subset.grafico, aes(x = ola, fill = c19_01_rec, stratum = c19_01_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 6))

g16.5
```

```{r c19_02, fig.align='center', fig.cap='Sexismo hostil, según ola y sexo .'}

#1
datos.grafico <- data.frame((svytable(~c19_02_rec + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2016' |  datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~c19_02_rec + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2016' | etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.6 <- ggplot(subset.grafico, aes(x = ola, fill = c19_02_rec, stratum = c19_02_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 6))

g16.6
```

```{r c19_03, fig.align='center', fig.cap='Sexismo hostil, según ola y sexo .'}

#1
datos.grafico <- data.frame((svytable(~c19_03_rec + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2016' |  datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~c19_03_rec + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2016' | etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.7 <- ggplot(subset.grafico, aes(x = ola, fill = c19_03_rec, stratum = c19_03_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 6))

g16.7
```

```{r c19_04, fig.align='center', fig.cap='Sexismo hostil, según ola y sexo .'}

#1
datos.grafico <- data.frame((svytable(~c19_04_rec + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2016' |  datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~c19_04_rec + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2016' | etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.8 <- ggplot(subset.grafico, aes(x = ola, fill = c19_04_rec, stratum = c19_04_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75, color = rep.int(c('black', 'white', 'white'), 6))

g16.8
```

## Trabajo y género

```{r ocup-sexo, fig.align='center',fig.cap='Porcentaje de trabajadores y trabajadoras por situación ocupacional (2021), según sexo del entrevistado'}
datos.grafico <- data.frame((svytable(~m0_sexo + ola + empleo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021' ))

g16.9 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = m0_sexo, fill = empleo, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(.~ola)+
  scale_fill_viridis_d(begin = .13, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")), position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep('black')) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g16.9

```


```{r ocup-sexo-ola, fig.align='center',fig.cap='Porcentaje de trabajadores y trabajadoras no remunerados, según ola y sexo del entrevistado'}
#1
elsoc_long$empleo <- na.replace(elsoc_long$empleo, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel)

datos.grafico <- data.frame((svytable(~empleo + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola,m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~empleo + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años 2018 y 2021
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, 
                     etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.10 <- ggplot(subset.grafico, aes(x = ola, fill = empleo, stratum = empleo, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep('white'))

g16.10
```


```{r m17, fig.align='center', fig.cap='Horas de Cuidado'}

#1
datos.grafico <- data.frame((svytable(~m17_rec + ola + idencuesta, 
                                      elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq))

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~m17_rec + ola, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.11 <- ggplot(subset.grafico, aes(x = ola, fill = m17_rec, stratum = m17_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75)

g16.11
```



<!--chapter:end:16-genero.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Salud mental y bienestar

```{r recode-var}
elsoc_panel_m1$depr_rec <- car::recode(elsoc_panel_m1$suma_dep,
                               "c(0,1,2,3,4)='1';
c(5,6,7,8,9)='2';
c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='3'")

elsoc_panel_m1$m43_rec <- car::recode(elsoc_panel_m1$m43,
                               "c(1,2)='Nada o Poco Sobrecargado';
c(3)='Algo Sobrecargado';
c(4,5)='Bastante o Muy Sobrecargado'")

elsoc_panel_m1$s03_rec <- car::recode(elsoc_panel_m1$s03,
                               "c(1,2)='Mala o Regular';
c(3)='Buena';
c(4,5)='Muy buena o Excelente'")

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel_m1)

elsoc_panel$depr_rec <- car::recode(elsoc_panel$suma_dep,
                               "c(0,1,2,3,4)='1';
c(5,6,7,8,9)='2';
c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='3'")

elsoc_panel$m43_rec <- car::recode(elsoc_panel$m43,
                               "c(1,2)='Nada o Poco Sobrecargado';
c(3)='Algo Sobrecargado';
c(4,5)='Bastante o Muy Sobrecargado'")

elsoc_diseno_2 <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel)
```

```{r depre-wave, echo=FALSE, fig.align='center', fig.cap= 'Síntomas de Depresión, según Ola del Estudio'}
datos.grafico <- data.frame((svytable(~depr + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g17.1 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g17.1

```

```{r N5, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```

```{r depre-deuda-wave, echo=FALSE, fig.align='center', fig.cap="Síntomas de Depresión, según Ola del Estudio y Sobrecarga de Deuda"}
datos.grafico <- data.frame((svytable(~depr + ola + m43_rec, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m43_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  filter((ola==2016 | ola==2018 | ola==2021)) 
datos.grafico$porcentaje[is.na(datos.grafico$porcentaje)] <- 0

g17.2 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 9)) + 
  facet_grid(~factor(m43_rec, levels=c('Nada o Poco Sobrecargado','Algo Sobrecargado','Bastante o Muy Sobrecargado'))) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.2

```

```{r deuda-phq, fig.align='center',fig.cap="Deuda según ola y Sintomas Depresivos"}
#este grafico no logra nada... eliminarlo
datos.01 <- data.frame((svytable(~deuda_01 + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_01=Freq/sum(Freq))
datos.01$phq <- NULL
datos.01$ola <- NULL
datos.02 <- data.frame((svytable(~deuda_02 + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_02=Freq/sum(Freq))
datos.02$phq <- NULL
datos.02$ola <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_03=Freq/sum(Freq))
datos.03$phq <- NULL
datos.03$ola <- NULL
datos.04 <- data.frame((svytable(~deuda_04  + ola + phq, elsoc_diseno, round = F))) %>% group_by(phq,ola) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g17.3 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = ola, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  facet_wrap(.~phq)+
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.3
```

## Brecha de género en Salud Mental

```{r depre-year-sexo, echo=FALSE, fig.align='center', fig.cap= 'Sintomatología Depresiva por año, según sexo. Porcentaje con síntomas de “Depresion Moderada” o “Depresion Moderada Severa a Severa”.'}

datos.grafico <- data.frame((svytable(~depr_rec + ola + m0_sexo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$depr_rec == '3'))

g17.4 <- ggplot(datos.subset, 
               aes(y = porcentaje, x = ola, 
                   color = m0_sexo, group = m0_sexo,
              label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .55, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.4
 
```
```{r N6, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


```{r depre-sexo, echo=FALSE, fig.align='center', fig.cap= 'Cambios en Síntomas de depresión entre años 2018 y 2021, según sexo'}

#1
elsoc_panel$depr <- na.replace(elsoc_panel$depr, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_panel)

datos.grafico <- data.frame((svytable(~depr + ola + idencuesta + 
                                        m0_sexo, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola,m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~depr + ola + m0_sexo, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años 2017 y 2019
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, 
                     etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g17.5 <- ggplot(subset.grafico, aes(x = ola, fill = depr, stratum = depr, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.1 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep('white'))

g17.5

```

```{r N7, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```


```{r depre-edad-sexo, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según tramos de edad y sexo (2021). Porcentaje con síntomas de “Depresion Moderada” o “Depresion Moderada Severa a Severa'}
datos.grafico <- data.frame((svytable(~depr_rec + ola + m0_sexo + edadt, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo, edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021' & datos.grafico$depr_rec == '3'))

g17.6 <- ggplot(datos.subset, 
               aes(y = porcentaje, x = edadt, 
                   color = m0_sexo, group = m0_sexo,
                   label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .55, direction = 1, option = 'viridis') +
  geom_text_repel(posilinetion = position_dodge(width = .9),
                  size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.6

```

```{r N8, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
``` 

## Sintomatología depresiva, sexo y ocupación

```{r depre-labstat, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según sexo y situación ocupacional (2021). Porcentaje con síntomas PHQ-9>10'}
datos.grafico <- data.frame((svytable(~depr_rec + ola + m0_sexo + empleo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m0_sexo, empleo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021' & datos.grafico$depr_rec == '3'))

g17.7 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = empleo, fill = m0_sexo, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .65, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.7
```

En 2021 no hay hombres en la categoría Trabajo doméstico no remunerado $^{*}$

```{r N9, include=FALSE}
N<-round(sum(datos.grafico$Freq),0)
```

## COVID - 19
```{r covid-sexo, fig.align='center', fig.cap= 'Diagnosticado con COVID-19 según sexo'}
datos.grafico <- data.frame((svytable(~s31 + m0_sexo, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(m0_sexo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, s31=='1'))

g17.8 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = s31, fill = m0_sexo, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.2)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.8
```

```{r depre-s03, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según Estado de Salud y ola de estudio. Porcentaje con síntomas PHQ-9>10'}
datos.grafico <- data.frame((svytable(~s03_rec + ola + depr_rec, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, depr_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico,datos.grafico$depr_rec == '3'))

g17.9 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = s03_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .65, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.9
```

## Salud Mental en COVID-19


```{r depre-teletrabajo, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión, según Modalidad de Trabajo'}
datos.grafico <- data.frame((svytable(~depr + ola + m60, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m60) %>% 
  na.omit(m60) %>%
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

g17.10 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = m60, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.10
```


```{r depre-beneficios, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión (2021), según sexo y acceso a beneficios'}
datos.grafico <- data.frame((svytable(~depr + ola + m0_sexo + m63_01, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola, m63_01, m0_sexo) %>% 
  na.omit(m63_01) %>%
  mutate(porcentaje=Freq/sum(Freq))

datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2021'))

g17.11 <- datos.subset %>% 
  ggplot(aes(y = porcentaje, x = m63_01, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  #Agrego facer_wrap para hacer un Gráfico para cada sexo
  facet_wrap(datos.subset$m0_sexo) +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.11
```

```{r depre clase.sub, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión, según Clase Subjetiva'}
datos.grafico <- data.frame((svytable(~depr_rec + clase.sub, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(clase.sub) %>% 
  mutate(porcentaje=Freq/sum(Freq)) 

g17.12 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = clase.sub, fill = depr_rec, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 3)) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.12

```


<!--chapter:end:17-salud-bienestar.Rmd-->

# Migración
```{r include=FALSE}
# Librerías y datos -------------------------------------------------------
rm(list = ls())
library(survey)
library(tidyverse)
library(ggrepel)
load("1_input/datos_elsoc.RData")

# Diseño complejo ---------------------------------------------------------
elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel)
```
 
## Amenaza realista y amenaza simbólica respecto a inmigrantes
 
```{r Recode4, include=FALSE}
elsoc_panel <- elsoc_panel %>%
  mutate(amenaza_realista = factor(car::recode(amenaza_realista, "c(1,2)=1;c(3)=2;c(4,5)=3"),
                                   labels = c('En desacuendo o totalmente en desacuerdo', 
                                              'Ni de acuerdo ni en desacuerdo',
                                              'De acuerdo o totalmente de acuerdo')),
         amenaza_simbolica = factor(car::recode(amenaza_simbolica, "c(1,2)=1;c(3)=2;c(4,5)=3"),
                                    labels = c('En desacuendo o totalmente en desacuerdo', 
                                               'Ni de acuerdo ni en desacuerdo',
                                               'De acuerdo o totalmente de acuerdo')),
         confianza_rec =  factor(car::recode(confianza, "c(1,2) = 1;c(3) = 2;c(4,5) = 3"),
                                  labels = c('Nada o poca confianza',
                                             'Algo de confianza',
                                             'Bastante o mucha confianza')))

elsoc_diseno <- svydesign(ids = ~segmento, strata = ~estrato, weights = ~ponderador02, 
                          nest = TRUE, data = elsoc_panel)
```


<!-- ### 14.1 "Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen1-wave, fig.align='center',fig.cap='Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}
datos.g14.1 <- data.frame((svytable(~migrantes + ola + muestra + amenaza_realista, elsoc_diseno, round = F))) %>% 
  group_by(ola, migrantes) %>% mutate(porcentaje=Freq/sum(Freq)) %>%  
  filter(amenaza_realista == 'De acuerdo o totalmente de acuerdo', porcentaje > 0.00000000) %>% 
  na.omit()
  
g14.1 <- datos.g14.1 %>% 
  ggplot(aes(y = porcentaje, x = ola, color = migrantes, group = migrantes,
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g14.1
```

<!-- ### 14.2 "Con la llegada de migrantes, Chile está perdiendo su identidad", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen2-wave, fig.align='center',fig.cap='"Con la llegada de migrantes, Chile está perdiendo su identidad", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}
datos.g14.2 <- data.frame((svytable(~migrantes + ola + muestra + amenaza_simbolica, elsoc_diseno, round = F))) %>%
  group_by(ola, migrantes) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(amenaza_simbolica == 'De acuerdo o totalmente de acuerdo', porcentaje > 0.00000000) %>% 
  na.omit()

g14.2 <- datos.g14.2 %>% 
  ggplot(aes(y = porcentaje, x = ola, color = migrantes, group = migrantes,
                           label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g14.2
```

```{r include=FALSE}
datos.g14.3 <- data.frame((svytable(~migrantes + ola + muestra + confianza_rec, elsoc_diseno, round = F))) %>%
  group_by(ola, migrantes) %>% mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(porcentaje > 0.00000000, confianza_rec == 'Bastante o mucha confianza') %>% 
  na.omit()

g14.3 <- datos.g14.3 %>% 
  ggplot(aes(y = porcentaje, x = ola, color = migrantes, group = migrantes,
                          label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g14.3

```

<!-- ### 14.4 Percepción de amenaza realista y simbólica, según grupo de migrantes (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen3-wave, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica, según grupo de migrantes (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}
amreal.g14.4 <- data.frame((svytable(~amenaza_realista + migrantes + ola,
                       elsoc_diseno, round = F))) %>%
  group_by(ola, migrantes) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit() %>% 
  filter(amenaza_realista == 'De acuerdo o totalmente de acuerdo' & ola == 2021) %>% 
  mutate(amenaza = 'Aumenta desempleo')

amsim.g14.4 <- data.frame((svytable(~amenaza_simbolica + migrantes + ola,
                       elsoc_diseno, round = F))) %>%
  group_by(ola, migrantes) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit() %>% 
  filter(amenaza_simbolica == 'De acuerdo o totalmente de acuerdo' & ola == 2021) %>% 
  mutate(amenaza = 'Chile pierde su identidad')

datos.g14.4 <- rbind(amreal.g14.4, amsim.g14.4)

g14.4 <- datos.g14.4 %>% 
  ggplot(aes(y = porcentaje, x = amenaza, fill = migrantes, 
             label = scales::percent(porcentaje, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)

  g14.4

```


## Amenaza realista y simbólica respecto a inmigrantes según nivel educacional


<!-- ### 14.5 Percepción de amenaza realista y simbólica respecto a inmigrantes, según nivel educacional (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-educ, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica respecto a inmigrantes, según nivel educacional (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

amreal.g14.5 <- data.frame((svytable(~amenaza_realista + educ + ola, elsoc_diseno, round = F))) %>%
  group_by(ola, educ) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit() %>% 
  filter(ola == 2021 & amenaza_realista == 'De acuerdo o totalmente de acuerdo') %>% 
  mutate(amenaza = 'Aumenta desempleo')

amsim.g14.5 <- data.frame((svytable(~amenaza_simbolica + educ + ola, elsoc_diseno, round = F))) %>%
  group_by(ola, educ) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit() %>% 
  filter(ola == 2021 & amenaza_simbolica == 'De acuerdo o totalmente de acuerdo') %>% 
  mutate(amenaza = 'Chile pierde su identidad')

datos.g14.5 <- rbind(amreal.g14.5, amsim.g14.5)

g14.5 <- datos.g14.5 %>% 
  ggplot(aes(y = porcentaje, x = amenaza, fill = educ, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g14.5
```

<!-- ### 14.8 Percepción de amenaza realista y simbólica, según tramo de edad (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-edad, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica, según tramo de edad (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

amreal.g14.8 <- data.frame((svytable(~amenaza_realista + edadt + ola, elsoc_diseno, round = F))) %>%
  group_by(ola, edadt) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit() %>% 
  filter(ola == 2021 & amenaza_realista == 'De acuerdo o totalmente de acuerdo') %>% 
  mutate(amenaza = 'Aumenta desempleo')
  
amsim.g14.8 <- 
  data.frame((svytable(~amenaza_simbolica + edadt + ola, elsoc_diseno, round = F))) %>%
  group_by(ola, edadt) %>% mutate(porcentaje = Freq/sum(Freq)) %>% na.omit() %>% 
  filter(ola == 2021 & amenaza_simbolica == 'De acuerdo o totalmente de acuerdo') %>% 
  mutate(amenaza = 'Chile pierde su identidad')

datos.g14.8 <- rbind(amreal.g14.8, amsim.g14.8)

g14.8 <- datos.g14.8 %>% 
  ggplot(aes(y = porcentaje, x = amenaza, fill = edadt, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g14.8
```

<!--chapter:end:18-migracion.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Pandemia Covid-19

## Cuarentenas 
```{r hist-fecha-2021, fig.align='center', fig.cap="Histograma Fechas de Entrevistas"}
load("1_input/elsoc_covid.RData")
elsoc_diseno_3 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_covid_panel)

datos.grafico <- data.frame((svytable(~fecha_entr + comuna_cod + ola, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(comuna_cod, ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021 & Freq>0)

datos.grafico$fecha_entr<-as.Date(datos.grafico$fecha_entr)

g19.1 <- datos.grafico %>% 
  ggplot(mapping = aes(x = fecha_entr)) +
  theme_bw() + 
  geom_histogram(bins = 9,
                 stat="count") +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%d %b %Y")

g19.1
```

```{r ccum-heter, fig.align='center', fig.cap="Heterogeneidad de Cuarentena Acumulada en el Panel"}
g19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density() +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

g19.2
```

```{r ccum-zona, fig.align='center', fig.cap='Días de Cuarentena Acumulada, según Zona'}
datos.grafico <- data.frame((svytable(~ccum_t + zona1, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(zona1) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g19.3 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = zona1, fill = ccum_t, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.3
```

```{r ccum-edad, fig.align='center', fig.cap='Días de Cuarentena Acumulada, según Tramo Etario'}
datos.grafico <- data.frame((svytable(~ccum_t + edadt, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(edadt) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g19.4 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = edadt, fill = ccum_t, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.4
```

```{r ccum-aislamiento, fig.align='center', fig.cap='Cumplimiento de Aislamiento Social, según Días de Cuarentena Acumulada'}
datos.grafico <- data.frame((svytable(~c48 + ccum_t, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(ccum_t) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g19.5 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ccum_t, fill = c48, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.5
```

```{r ccum-depr, fig.align='center', fig.cap= 'Sintomatología Depresiva, según Días de Cuarentena Acumulada'}
datos.grafico <- data.frame((svytable(~depr + ccum_t + ola, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(ccum_t, ola) %>% 
  mutate(porcentaje=Freq/sum(Freq))%>%
  filter(ola==2021)

g19.6 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ccum_t, fill = depr, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g19.6
```

```{r ccum-sit_ocup, fig.align='center', fig.cap= 'Días de Cuarentena Acumulada, según Situación Ocupacional'}
datos.grafico <- data.frame((svytable(~ccum_t + empleo, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(empleo) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g19.7 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = empleo, fill = ccum_t, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.7
```

```{r ccum-ahorro, fig.align='center', fig.cap= 'Días de Cuarentena Acumulada, según Situación Ocupacional'}
elsoc_covid_panel$m44_rec <- car::recode(elsoc_covid_panel$m44,
                               "c(1,2)='Nada o Pocos Ahorros';
c(3)='Algo de Ahorros';
c(4,5)='Bastante o Muchos Ahorros'")

elsoc_diseno_3 <- svydesign(ids = ~segmento, strata = ~estrato, 
                          weights = ~ponderador02, nest = TRUE, data = elsoc_covid_panel)

datos.grafico <- data.frame((svytable(~ccum_t + m44_rec, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(m44_rec) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g19.8 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m44_rec, fill = ccum_t, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.8
```

```{r cuarentena-etario, fig.align='center', fig.cap= 'Encuestados en Cuarentena según Tramo Etario'}
datos.grafico <- data.frame((svytable(~cuarentena + edadt + ola, 
                                      elsoc_diseno_3, round = F))) %>% 
  group_by(edadt + ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  filter(ola==2021)

g19.9 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = cuarentena, fill = edadt, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.9
```

## Estrés Financiero
```{r satisfaccion-wave, echo=FALSE, fig.align='center', fig.cap= 'Satisfacción con el Ingreso por Ola'}
datos.grafico <- data.frame((svytable(~m43 + ola, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g19.10 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = m43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black','white', 'white','white' ), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.10
```

```{r satisfaccion-retiro, echo=FALSE, fig.align='center', fig.cap= 'Satisfacción con el Ingreso según Retiro AFP'}
datos.grafico <- data.frame((svytable(~m16 + m63_02, 
                                      elsoc_diseno, round = F))) %>% 
  group_by(m63_02) %>% 
  mutate(porcentaje=Freq/sum(Freq))

g19.11 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_02, fill = m16, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.11
```

```{r clase.sub-benef.estatal, echo=FALSE, fig.align='center', fig.cap='Satisfacción con el Ingreso según Acceso a Beneficios'}
elsoc_diseno_2 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_panel)

datos.grafico <- data.frame((svytable(~clase.sub + m63_01, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_01) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g19.12 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_01, fill = clase.sub, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.12
```

```{r clase.sub.hij-1erretiro, echo=FALSE, fig.align='center', fig.cap='Clase Social Subjetiva de Hijo según Primer Retiro AFP'}
datos.grafico <- data.frame((svytable(~clase.sub.hijos + m63_02, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_02) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g19.13 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_02, fill = clase.sub.hijos, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.13
```

```{r endeud-1retiro, echo=FALSE, fig.align='center', fig.cap='Sobrecarga de Deuda según Primer Retiro AFP'}
datos.grafico <- data.frame((svytable(~m43 + m63_02, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_02) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g19.14 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_02, fill = m43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.14
```

```{r endeud-2retiro, echo=FALSE, fig.align='center', fig.cap='Sobrecarga de Deuda según Primer Retiro AFP'}
datos.grafico <- data.frame((svytable(~m43 + m63_03, 
                                      elsoc_diseno_2, round = F))) %>% 
  group_by(m63_03) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>%
  drop_na()

g19.15 <- datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = m63_03, fill = m43, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.15
```

```{r deuda-retiro1, fig.align='center',fig.cap="Primer retiro de AFP, según deuda"}
datos.01 <- data.frame((svytable(~deuda_01  + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_01=Freq/sum(Freq))
datos.01$retiro1 <- NULL
datos.02 <- data.frame((svytable(~deuda_02  + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_02=Freq/sum(Freq))
datos.02$retiro1 <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_03=Freq/sum(Freq))
datos.03$retiro1 <- NULL
datos.04 <- data.frame((svytable(~deuda_04 + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g19.16 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = retiro1, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.16
```

```{r deuda-retiro2, fig.align='center',fig.cap="Segundo retiro de AFP, según deuda"}
datos.01 <- data.frame((svytable(~deuda_01  + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_01=Freq/sum(Freq))
datos.01$retiro2 <- NULL
datos.02 <- data.frame((svytable(~deuda_02  + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_02=Freq/sum(Freq))
datos.02$retiro2 <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_03=Freq/sum(Freq))
datos.03$retiro2 <- NULL
datos.04 <- data.frame((svytable(~deuda_04 + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g19.17 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = retiro2, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.17
```

```{r deuda-benef, fig.align='center',fig.cap="Beneficios Estatales, según deuda"}
datos.01 <- data.frame((svytable(~deuda_01  + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_01=Freq/sum(Freq))
datos.01$benef_estado <- NULL
datos.02 <- data.frame((svytable(~deuda_02  + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_02=Freq/sum(Freq))
datos.02$benef_estado <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_03=Freq/sum(Freq))
datos.03$benef_estado <- NULL
datos.04 <- data.frame((svytable(~deuda_04 + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g19.17 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = benef_estado, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.17
```


<!--chapter:end:19-pandemia-covid-19.Rmd-->

# Cómo citar este informe: {-}

:::{.blue-box}
> COES (2021) Radiografía del Cambio Social: Análisis de Resultados Longitudinales ELSOC 2016-2021. Presentación de Resultados COES. Septiembre, Santiago de Chile.
:::

**Entrada Bibtex:**

```{r,echo=TRUE,eval=FALSE}
@techreport{coes_Radiografia_2021,
  title = {Radiograf\'ia Del {{Cambio Social}}: {{An\'alisis}} de {{Resultados Longitudinales ELSOC}} 2016-2021.},
  author = {COES},
  year = {2021},
  month = sep,
  address = {{Santiago de Chile, Chile}},
  institution = {{Centro de Estudios de Conflicto y Cohesi\'on Social}}
}
```

<!--chapter:end:20-como-citar.Rmd-->

