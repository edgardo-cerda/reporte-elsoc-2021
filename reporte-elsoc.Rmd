--- 
title: "Estudio Longitudinal Social de Chile"
subtitle: "Resultados longitudinales 2016-2021"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
documentclass: book
classoption: openany
bibliography:
- book.bib
biblio-style: apalike
link-citations: yes

output:
  bookdown::gitbook:
    lib_dir: assets
    config:
      toolbar:
        position: static
  bookdown::pdf_book:
    extra_dependencies: ["flafter"]
    toc: no

geometry: "left=4cm, right=3cm, top=2.5cm, bottom=2.5cm"
fontsize: 12pt
linestretch: 1.5
toc-depth: 1
lof: True
lot: True
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE,
                      echo=FALSE) 

Sys.setlocale("LC_ALL","ES_ES.UTF-8")
```

```{r message=FALSE, warning=FALSE, include=FALSE, echo=FALSE,cache=FALSE} 
pacman::p_load(knitr, kableExtra, dplyr, gridExtra, tidyverse, sjmisc, sjlabelled, sticky, ggrepel, ggalluvial, survey, spatstat, readxl, forcats,gtools, elsoc, panelr, ggplot2, tidyr, sf, chilemapas)
library(elsoc)
```

```{r cargar objetos, include=FALSE, cache = FALSE}
remove(list = ls())
#base de datos
load("1_input/datos_elsoc.RData") 
load("1_input/elsoc_covid.RData")
elsoc::load_elsoc(format = 'long')
elsoc::load_elsoc(format = 'wide')

```

```{r disenno, include=FALSE}
elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_panel_m1)

#cuando es necesario usar todo el panel (independiente la muestra)
elsoc_diseno_2 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_panel)

#cuando se utilizan datos de covid en panel
elsoc_diseno_3 <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_covid_panel)
```

```{r echo=FALSE }
table_format = if(is_html_output()) {
  "html"
} else if(is_latex_output()) {
  "latex" 
}

fullw = if(is_html_output()) {T} else if(is_latex_output()) {F}
fsize = if(is_html_output()) {14} else if(is_latex_output()) {8}

ggplot2::theme_set(new = theme_test(base_family = "serif"))
```

# Introducción

El Centro de Estudios de Conflicto y Cohesión Social (COES) tiene el agrado de publicar el informe “Radiografía del Cambio Social”, el cual consolida los principales hallazgos longitudinales de cinco mediciones anuales del Estudio Longitudinal Social de Chile (ELSOC 2016-2021).

ELSOC es una encuesta desarrollada para analizar longitudinalmente, en un estudio panel, la evolución del conflicto y cohesión social en la sociedad chilena, basándose en modelos conceptuales descritos en la literatura nacional e internacional de las disciplinas del ámbito de la Economía, Sociología, Psicología, Ciencia Política y Estudios Urbanos. De este modo, se orienta a examinar los principales antecedentes, factores moderadores y mediadores, así como las principales consecuencias asociadas al desarrollo de distintas formas de sociabilidad en Chile.

Desde 2019 y hasta la fecha, Chile se ha visto remecido por importantes eventos que han alterado aspectos sociales, políticos y económicos de la vida nacional: la pandemia asociada al COVID-19, y las consecuencias del estallido social más grande de las últimas décadas, ocurrido a partir de octubre de 2019, el que ha desencadenado un proceso constituyente inédito en la historia de Chile.

Ambos fenómenos han significado un desafío para ELSOC, ya que afecta tanto la forma en que son levantados los datos, como las preguntas que el estudio debe abordar. Sin embargo, ELSOC presente una gran oportunidad única: la posibilidad de observar el efecto que éstos fenómenos tienen sobre la población chilena desde una perspectiva longitudinal.

## Sobre COES

El Centro de Estudios de Conflicto y Cohesión Social (COES) desarrolla investigación colaborativa en temas relacionados al conflicto social y la cohesión (convivencia) en Chile, por medio de un equipo multidisciplinario proveniente de las ciencias sociales y humanidades. COES centra sus actividades académicas y de difusión en el análisis de las múltiples manifestaciones del conflicto y cohesión social en Chile, sus causas, así como también su contexto cultural e histórico.

COES está patrocinado por la Universidad de Chile y la Pontificia Universidad Católica de Chile, y como instituciones asociadas se encuentran la Universidad Diego Portales y la Universidad Adolfo Ibáñez. COES cuenta con el apoyo del Fondo de Financiamiento de Centros de Investigación en Áreas Prioritarias (FONDAP, dependiente de la Agencia Nacional de Investigación y Desarrollo (ANID) del Ministerio de Ciencia, Tecnología, Conocimiento e Innovación. ELSOC además cuenta como socio al Instituto Milenio para la Investigación en Depresión y Personalidad (MIDAP).



<!--chapter:end:index.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Sobre ELSOC

## Descripción del estudio

El Estudio Longitudinal Social de Chile (ELSOC) es una encuesta panel, representativa de la población nacional urbana, que analiza la estabilidad y cambio de las creencias, actitudes y percepciones que tenemos los chilenos y chilenas respecto de la convivencia y del conflicto, la cohesión y una amplia gama de aspectos políticos y sociales a lo largo del tiempo. 

Este estudio sigue la evolución de cerca de 4.500 chilenos y chilenas a lo largo de una década. Actualmente se encuentran disponibles 5 olas del estudio, abarcando el período entre 2016 y 2021. Sus temas de estudio y su aspecto longitudinal convierten a ELSOC en un recurso único en Chile y América Latina para analizar la evolución de la sociedad chilena y para el desarrollo de las ciencias sociales en Chile.

Durante los últimos años, ELSOC se ha consolidado como un importante insumo para el desarrollo de investigación científica y aplicada en ciencias sociales. En el sitio web http://elsoc.cl se puede acceder a más información sobre el estudio. 

## Acceso a Bases de Datos ELSOC

Las bases de datos y documentación correspondientes se encuentran disponibles, de manera libre y gratuita, en un repositorio de datos, al cual se podrá acceder en el link:

https://dataverse.harvard.edu/dataverse/elsoc

En este link se obtendrá acceso a los datos de las 5 mediciones transversales de ELSOC, así como bases longitudinales que integran las distintas mediciones. En colaboración con el Centro de Inteligencia Territorial (CIT), se pone también a disposición las bases ELSOC-CIT. Estas bases de datos permiten combinar la información de ELSOC, y estimaciones e indicadores territoriales y geoespaciales de distinta índole, proveniente de diversas fuentes de información nacional para los períodos 2016 a 2019. 

ELSOC tiene un compromiso con los más altos estándares científicos en términos de producción y análisis de datos. Dentro de esta visión global, ELSOC se guía por las principales pautas de Transparencia y Apertura en la investigación científica. Por esta misma razón, los códigos utilizados para el desarrollo de este documento se encontrarán disponibles en https://github.com/centro-coes.


## Características del diseño muestral

- Unidad de Análisis: Individuos

- Muestra objetivo: 3.000 individuos en muestra original (a partir de 2016) y 1.500 en muestra refresco (a partir de 2018)

- Población Objetivo: Hombres y mujeres de 18 a 75 años, residentes habituales de viviendas particulares ocupadas en zonas urbanas, localizadas en 40 ciudades (92 comunas, 13 regiones) del país

- Periodicidad: Anual. 

```{r, echo=FALSE}
knitr::include_graphics(file.path('1_input', 'imagenes', 'olas_elsoc.png'))
```


- Marco Muestral: Marco de muestreo de manzanas del pre-censo 2011

- Diseño Muestral: Probabilístico, estratificado (por tamaño de ciudades), por conglomerados y multietápico

- Unidades de Muestreo: Primero se eligen ciudades (UPM), luego manzanas (USM), y sub-bloques y viviendas (UTM). La unidad final de selección es la persona

```{r, echo=FALSE}
knitr::include_graphics(file.path('1_input/imagenes/etapas_seleccion.jpg'))
```


**Organismo Ejecutor**: Consultora Stephanie Eckman y Centro de Inteligencia Territorial (CIT) de la Universidad Adolfo Ibáñez

## Características del levantamiento de datos

- Formato de aplicación: Cuestionario estructurado. Levantamiento en formato CAPI (Encuesta presencial con asistencia de tablet). Excepcionalmente se cambió a formato CATI (Encuesta telefónica con asistencia de tablet) durante 2021, debido a contingencia COVID-19

- Período de Aplicación: entre Julio y Noviembre de cada año. Debido al estallido social, la cuarta medición se aplicó entre el 21 de noviembre de 2019 y el 9 de marzo de 2020. Debido a la pandemia, la quinta medición se aplicó entre el 29 de enero de 2021 y 12 de julio de 2021

- Instrumento: Cuestionario compuesto por preguntas cerradas de carácter simple y múltiple junto a algunas preguntas abiertas. Combina módulos de preguntas permanentes (medidas en todas las olas) y otras intercaladas entre olas

- Cobertura Temática: Contiene siete módulos temáticos: Territorio, Redes y actitudes sociales, Ciudadanía y democracia, Desigualdad y legitimidad, Conflicto social, Salud y bienestar y Caracterización sociodemográfica

- Incentivos a la participación: Entrega de incentivos monetarios para el encuestado ($ 6.000 CLP) y de material sobre el estudio (ELSOC y COES). Acciones de seguimiento basadas en la información de contacto (correo electrónico para cumpleaños y días festivos)

- Entrenamiento de entrevistadores: Contratación de entrevistadores con experiencia en encuestas complejas y/o longitudinales. Capacitación centralizada y presencial para coordinadores de campo y un subconjunto de entrevistadores en Santiago (incluidos ejercicios prácticos para la implementación del cuestionario, uso de tabletas y protocolo de contacto). Actividades adicionales en otras regiones de Chile. Diseño de un Manual de entrevistador especializado para el proyecto

- Operaciones de Control y Supervisión: Coordinadores de campo supervisan el trabajo de entrevistadores, verificando el número de visitas, el contacto, la identidad del participante y preguntas claves. Organismo ejecutor realiza una supervisión interna de al menos el 10% de la muestra (entrevistando nuevamente a algunos encuestados), verificando la duración y la respuesta de los participantes

**Organismo Ejecutor**: Levantamiento a cargo de Centro Micro Datos (CMD) de la Universidad de Chile





<!--chapter:end:02-ficha-tecnica.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Atrición de la muestra

El diseño de ELSOC contempló entrevistar a 3.000 personas en su muestra original y 1.500 en la muestra refresco. Sin embargo, es habitual que en encuestas panel se reduce el número de participantes, dado que algunos optan voluntariamente por dejar de participar y otras personas no pueden ser recontactadas. Este fenómeno es conocido como atrición, y pueden tener efectos nocivos sobre la utilidad de los datos longitudinales. En el caso de ELSOC, la tasa de atrición es comparativamente baja en comparación a otros estudios similares, por lo que no se considera al momento un problema significativo. A pesar de esto, el año 2018 se introduce una muestra refresco para contraarrestar el efecto de la atrición. 

El año 2021, la atrición presenta un alza importante debido a la mayor dificultad que implica el levantamiento durante la pandemia de COVID-19 y al cambio de modalidad.

```{r, echo=FALSE, warning=FALSE}
tabla_atricion <- data.frame(Medicon = c(2016, 2017, 2018, 2019, 2021),
                             Muestra_lograda_original = scales::number(c(2927, 2473, 2229, 2153, 1739)),
                             atricion_original = scales::percent(c(NA, .155, .099, .034, .192)),
                             Muestra_lograda_refresco = scales::number(c(NA, NA, 1519, 1264, 1001)),
                             atricion_refresco = scales::percent(c(NA, NA, NA, .168, .208)))

options(knitr.kable.NA = '')

tabla_atricion %>% 
    kbl(align = c('c', 'c', 'c', 'c', 'c'),
        col.name = c('Medición', rep(c('Muestra lograda', 'Atrición'), 2))) %>% 
    kable_styling(full_width = F) %>% 
    kable_classic_2() %>% 
    add_header_above(c(" " = 1, 'Muestra original' = 2, 'Muestra refresco' = 2))

```


<!--chapter:end:03-atricion.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Foco en el cambio individual

Radiografía del Cambio Social tiene como objetivo fundamental caracterizar la estabilidad y el cambio en opiniones, actitudes y conductas de los participantes a lo largo del tiempo, enfocándose en distintas dimensiones de la cohesión y conflicto en Chile. 

Para el logro de dicho objetivo, el presente reporte se centrará en un subconjunto de participantes del estudio: los 1.513 entrevistados y entrevistadas que participaron en las cinco olas de ELSOC (por lo tanto, todos son parte de la muestra original). Dicha submuestra será la base empírica de los hallazgos expuestos en las siguientes secciones. 

A continuación se describe a este grupo de participantes según los mismos atributos sociodemográficos (sexo, edad, educación, zona de residencia y religión), considerando la primera medición. Todos los resultados presentados incorporan el diseño muestral complejo de la encuesta.

**Nota 1:** El promedio de edad de los participantes se ha incrementado entre estos años. También hay evidencia de un descenso en la identificación religiosa al comparar distintos años del estudio. Las otras variables no presentan variaciones relevantes a lo largo del tiempo.

**Nota 2:** Se utiliza el ponderador muestral ajustado a población regional y sexo, estrato y conglomerado muestral.


## Nota Explicativa 

A continuación, se presentan los principales resultados de la encuesta ELSOC elaborados por investigadores del Centro de Conflicto y Cohesión Social (COES). Dada la diversidad de temas que son abordados en la encuesta, los investigadores colaboradores utilizaron diversos enfoques teóricos y herramientas empíricas en su análisis. Sin embargo, en Radiografía del Cambio Social se han definido una serie de criterios comunes para el desarrollo de resultados empíricos:

- Foco en la evolución y cambio en las actitudes de la población, aún cuando en ocasiones se analizan preguntas incluidas en una o dos olas del estudio. 
- Uso de pruebas estadísticas específicas para el análisis longitudinal. 
- Utilización de submuestra de 1.513 participantes del estudio presentes en las cinco mediciones (2016, 2017, 2018, 2019 y 2021). 
- Tamaños muestrales reportados menores se explican exclusivamente por no respuesta a ítemes específicos.
- Utilización del diseño muestral complejo (ponderador muestral ajustado a población regional y sexo, estrato y conglomerado muestral) en el desarrollo de figuras descriptivas y pruebas inferenciales. 


**Levantamiento durante COVID-19**



<!--chapter:end:04-foco-cambio-long.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Movimientos Sociales y Acciones Colectivas


## Ciclo de movilización política y estallido social

### 1.1 ¿Cuál es el movimiento social que usted más valora de esta lista? Según ola del estudio

<!-- ### 1.1 ¿Cuál es el movimiento social que usted más valora de esta lista? Según ola del estudio  -->

```{r include=FALSE}
datos.1.1 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% c(4,5) & !c20 %in% c(-888, -999)) %>%
  mutate(mov = factor(c20, levels = c(11,12,5,8,6,3,4,7,1,2,10,9),
                         labels = c('Otro',
                                    'Ninguno',
                                    'Diversidad sexual',
                                    'Feminista',
                                    'Provida o Antiaborto',
                                    'Ambiental',
                                    'Indigena',
                                    'Antidelincuencia',
                                    'Estudiantil',
                                    'Laboral',
                                    'Mov Social de Octubre (18/O)',
                                    'Pensiones'))) %>%
  prop(x = mov, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)



g1.1 <- datos.1.1 %>% 
  ggplot(aes(y = prop, x = mov, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .66, end = .33, direction = -1, option = 'viridis') +
  coord_flip() +
  theme(axis.text.x = element_text(size=rel(.9))) +
  guides(fill = guide_legend(reverse = TRUE)) +
  scale_x_discrete(labels = waiver( ))

g1.1
```

### 1.2 Frecuencia de respuesta en "ninguno" ante la pregunta ¿Cuál es el movimiento social que usted más valora de esta lista? según posición política"

<!-- ### 1.2 Frecuencia de respuesta en "ninguno" ante la pregunta ¿Cuál es el movimiento social que usted más valora de esta lista? según posición política  -->

```{r}
datos.1.2 <- elsoc_long_2016_2021 %>%
    filter(tipo_atricion == 1 & muestra == 1 & !c20 %in% c(-888,-999)) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(c20 %in% c(12), by  = c(pos_id, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g1.2 <-datos.1.2 %>% 
    ggplot(aes(y = prop, x = ola, fill = pos_id, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
    geom_col(position = 'dodge2') +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    facet_wrap(datos.1.2$pos_id)+
    theme(legend.position = 'top',
          legend.title = element_blank()) 
g1.2

```


### 1.3 Alluvial de movimiento social que más valora

```{r}
datos.1.3 <- elsoc_long_2016_2021 %>% 
  mutate(movsoc = car::recode(c20, recodes = "1='1';2='1';3='1';
                                          4='1';5='1';6='2';7='2';
                                          8='1';9='1';10='1';11=NA;12='3';
                                          c(-999,-888)=NA",as.factor=T)) %>% 
   mutate(movsoc = factor(movsoc, levels = c(1,2,3),
                         labels = c('Progresista', "Conservador", "Ninguno"))) %>%
  dplyr::filter(tipo_atricion == 1) %>% 
  dplyr::filter(!is.na(movsoc)) %>%
  group_by(idencuesta) %>%
  mutate(n_obs = n()) %>%
  ungroup() %>% 
  mutate(n_ok = (n_obs == max(n_obs))) %>% 
  dplyr::filter(n_ok) %>%  # Quedarse solo con los casos con observaciones completas
  group_by(idencuesta, movsoc, ola) %>% 
  summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
  group_by(ola) %>% 
  mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
  sjlabelled::as_label(ola) %>% 
  ungroup()

etiquetas.1.3 <- datos.1.3 %>% 
  group_by(movsoc, ola) %>% 
  summarise(porcentaje = sum(porcentaje, na.rm = TRUE)) %>% 
  mutate(idencuesta = 1)

g1.3 <- ggplot(datos.1.3 , aes(x = ola, fill = movsoc, stratum = movsoc, 
                  alluvium = idencuesta, y = porcentaje )) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.1.3, 
            aes(label = scales::percent(porcentaje, accuracy = .1)),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = c(rep('black', 5),
                      rep('black', 5),
                      rep('white', 5))) 

g1.3
```


La determinación entre las categorías "Progresista" y "Conservador" se hizo en base a la siguiente agrupación de movimientos sociales:

Progresista: Movimiento social de apoyo a la causa estudiantil, Movimiento social de apoyo a demandas laborales, Movimiento social de grupos ambientalistas, Movimiento social de apoyo a las demandas indígena, Movimiento social de apoyo a la diversidad sexual, Movimiento feminista o de apoyo a la igualdad de género, Movimiento por el cambio al sistema de pensiones, Estallido social del 18 de Octubre de 2019

Conservador: Movimiento social provida o antiaborto, Movimiento social antidelincuencia



### 1.4 Descriptivos generales

```{r}
datos.1.4 <- elsoc_long_2016_2021 %>%
  mutate(movsoc = car::recode(c20, recodes = "1='1';2='1';3='1';
                                          4='1';5='1';6='2';7='2';
                                          8='1';9='1';10='1';11=NA;12='3';
                                          c(-999,-888)=NA",as.factor=T)) %>% 
   mutate(movsoc = factor(movsoc, levels = c(3,2,1),
                         labels = c("Ninguno", "Conservador", 'Progresista'))) %>%
    filter(tipo_atricion == 1) %>%
    dplyr::filter(!is.na(movsoc)) %>%
  prop(movsoc, by  = c(ola), na.rm = TRUE)  %>% 
  sjlabelled::as_label(ola) 

g1.4 <-datos.1.4 %>% 
    #indicar el contenido del gráfico: ejes y relleno (fill) por ola
    ggplot(aes(y = prop, x = movsoc, fill = ola, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
    #fijar el fondo y el marco del gráfico uniforme
    theme_bw() + 
    #geom_col para usar variable y=porcentaje. 'dodge2' para formato side-to-side
    geom_col(position= 'dodge2') +
    #escala del eje y en porcentajes del 0 al 100%
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    #Nombres de los ejes se eliminan
    ylab(label = NULL) +
    xlab(label = NULL) +
    #colores oficiales por ola: degradé 'viridis'
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(hjust = -.1,
            position = position_dodge(width = 1),
            size= 2.75) +
    #posicionamiento de leyenda arriba
    theme(legend.position = 'top',
          legend.title = element_blank()) +
  coord_flip()

g1.4
```


### 1.5 Cambios en la valoración de movimientos sociales según posición política

```{r}
datos.1.5 <-elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% c(3,4,5)) %>%
 mutate(movsoc = car::recode(c20, recodes = "1='1';2='1';3='1';
                                          4='1';5='1';6='2';7='2';
                                          8='1';9='1';10='1';11=NA;12='3';
                                          c(-999,-888)=NA",as.factor=T)) %>% 
   mutate(movsoc = factor(movsoc, levels = c(1,2,3),
                         labels = c('Progresista', "Conservador", "Ninguno"))) %>%
  mutate(pos_id = car::recode(c15, recodes = 
                  "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; 
                   c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", 
                                    "No se identifica"))) %>%
  dplyr::filter(!is.na(pos_id) & !is.na(movsoc)) %>%
  prop(movsoc, by  = c(ola, pos_id), na.rm = TRUE)%>% 
  sjlabelled::as_label(ola)

g1.5 <- datos.1.5 %>% 
  ggplot(aes(y = prop, x = pos_id, fill =movsoc, 
             label = as.character(scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1)))) +
  theme_bw() +
  geom_col(position = 'stack') +
  facet_grid(.~ola) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c(rep('white', 4),
                          rep('white', 4),
                          rep('white', 4)),3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g1.5
```


### 1.6 Cambios en la valoración de movimientos sociales según nivel educativo

```{r}
datos.1.6 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !ola %in% c(1)) %>%
   mutate(movsoc = car::recode(c20, recodes = "1='1';2='1';3='1';
                                          4='1';5='1';6='2';7='2';
                                          8='1';9='1';10='1';11=NA;12='3';
                                          c(-999,-888)=NA",as.factor=T)) %>% 
   mutate(movsoc = factor(movsoc, levels = c(1,2,3),
                         labels = c('Progresista', "Conservador", "Ninguno"))) %>%
  mutate(educ = car::recode(m01, recodes = "c(1,2,3)=1;c(4,5)=2;c(6,7)=3;c(8,9,10)=4")) %>%
  mutate(educ = factor(educ, levels = c(1,2,3,4),
                         labels = c("Basica","Media","Tecnica","Universitaria"))) %>%
    dplyr::filter(!is.na(educ) & !is.na(movsoc)) %>%
  prop(movsoc, by  = c(ola, educ), na.rm = TRUE)%>% 
  sjlabelled::as_label(ola)
  
  
g1.6 <- datos.1.6 %>% 
  ggplot(aes(y = prop, x = educ, fill =movsoc, 
             label = as.character(scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1)))) +
  theme_bw() +
  geom_col(position = 'stack') +
  facet_grid(.~ola) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c(rep('white', 4),
                          rep('white', 4),
                          rep('white', 4)),4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g1.6
```


### 1.7 Valoración de movimientos sociales segun segun participacion

```{r}
datos.1.7 <- elsoc_long_2016_2021 %>%
  mutate(movsoc = car::recode(c20, recodes = "1='1';2='1';3='1';
                                          4='1';5='1';6='2';7='2';
                                          8='1';9='1';10='1';11=NA;12='3';
                                          c(-999,-888)=NA",as.factor=T)) %>% 
   mutate(movsoc = factor(movsoc, levels = c(1,2,3),
                         labels = c('Progresista', "Conservador", "Ninguno"))) %>%
  mutate(participacion = car::recode(c22, recodes = 
                         "c(1,2)='1'; 3='2';
                          c(4,5)='3';
                          c(-999,-888)=NA",as.factor=T)) %>%
    mutate(participacion = factor(participacion, levels = c(1,2,3),
                         labels = c('Nunca o\ncasi nunca', 'A veces', 'Frecuente o\nmuy\nfrecuentemente'))) %>%
    filter(tipo_atricion == 1) %>%
    dplyr::filter(!is.na(participacion) & !is.na(movsoc)) %>%
  prop(movsoc, by  = c(ola, participacion), na.rm = TRUE)%>% 
  sjlabelled::as_label(ola)

g1.7 <- datos.1.7 %>% 
  ggplot(aes(y = prop, x = participacion, fill =movsoc, 
             label = as.character(scales::percent(ifelse(prop>.01, prop, NA), accuracy = .1)))) +
  theme_bw() +
  geom_col(position = 'stack') +
  facet_grid(.~ola) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75,
            color = rep(c(rep('white', 3),
                          rep('white', 3)),5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g1.7
```


### 1.8 Frecuencia de participación en movimientos sociales, según Ola de encuesta. Porcentaje que responde Frecuentemente o Muy frecuentemente

<!-- ### 1.8 Frecuencia de participación en movimientos sociales, según Ola de encuesta. Porcentaje que responde Frecuentemente o Muy frecuentemente  -->

```{r include=FALSE}
datos.1.8 <- elsoc_long_2016_2021 %>%
  mutate(freq_part = car::recode(c22, recodes = "c(1,2,3)=1; c(4,5)=2; else=NA", as.factor = TRUE)) %>%
  filter(tipo_atricion == 1 & muestra==1) %>%
   prop(freq_part %in% c(2), by  = ola, na.rm = TRUE) %>%
  sjlabelled::as_label(ola)


g1.8 <- datos.1.8 %>% 
    ggplot(aes(y = prop, x = ola, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())

g1.8
```


## Confianza en instituciones

### 1.9 Bastante o Mucha confianza en el/la Presidente(a) de la República, el Gobierno y el Congreso Nacional según año

```{r}
elsoc_long_2016_2021$conf_cong <- car::recode(as.numeric(elsoc_long_2016_2021$c05_07), 
                                      recodes = "c(1,2)='Nada o Poca';
                                      c(3)='Algo';
                                      c(4,5)='Bastante o Mucha';
                                      else=NA", as.factor = TRUE)
elsoc_long_2016_2021$conf_pres <- car::recode(as.numeric(elsoc_long_2016_2021$c05_08), 
                                      recode = "c(1,2)='Nada o Poca';
                                      c(3)='Algo';
                                      c(4,5)='Bastante o Mucha';
                                      else=NA", as.factor = TRUE) 
elsoc_long_2016_2021$conf_gob <- car::recode(as.numeric(elsoc_long_2016_2021$c05_01), 
                                      recode = "c(1,2)='Nada o Poca';
                                      c(3)='Algo';
                                      c(4,5)='Bastante o Mucha';
                                      else=NA", as.factor = TRUE)

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_long_2016_2021)
datos.pres <- data.frame((svytable(~conf_pres + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_pres=Freq/sum(Freq))
datos.pres$ola <- NULL

datos.cong <- data.frame((svytable(~conf_cong + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_cong=Freq/sum(Freq))
datos.cong$ola <- NULL

datos.gob <- data.frame((svytable(~conf_gob + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_gob=Freq/sum(Freq))

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_long_2016_2021)

datos.grafico.1.9 <- cbind(datos.pres, datos.cong, datos.gob)


datos.1.9 <- datos.grafico.1.9 %>% 
        pivot_longer(cols = starts_with('conf_'))  %>%
        mutate(variable = factor(name,
                             labels = c('Presidente/a de la Republica', 
                                        'Congreso Nacional', 
                                        'Gobierno de Chile'))) %>%
                              filter(value == 'Bastante o Mucha') %>%
                              drop_na() 

datos.1.9$porcentaje <- with(datos.1.9, case_when(
  variable == 'Presidente/a de la Republica' ~ p_pres,
  variable == 'Congreso Nacional' ~ p_cong,
  variable == 'Gobierno de Chile' ~ p_gob))


g1.9 <- ggplot(datos.1.9,aes(y = porcentaje, x = ola, color = variable, group = variable,
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
    theme_bw() +  
    geom_line(size = 1) +
    geom_point(size = 1.8) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
    facet_wrap(.~variable)+
    geom_text(vjust = -0.8,
    posilinetion = position_dodge(width = .9),
    size= 1.75) +
    theme(legend.position = 'top',
          legend.title = element_blank())

g1.9
```

### 1.10 Bastante o Mucha confianza en Carabineros, el Poder Judicial y en Partidos Políticos según año

```{r}

elsoc_long_2016_2021$conf_part <- car::recode(as.numeric(elsoc_long_2016_2021$c05_02), 
                                      recodes = "c(1,2)='Nada o Poca';
                                      c(3)='Algo';
                                      c(4,5)='Bastante o Mucha';
                                      else=NA", as.factor = TRUE)
elsoc_long_2016_2021$conf_carab <- car::recode(as.numeric(elsoc_long_2016_2021$c05_03), 
                                      recodes = "c(1,2)='Nada o Poca';
                                      c(3)='Algo';
                                      c(4,5)='Bastante o Mucha';
                                      else=NA", as.factor = TRUE)
elsoc_long_2016_2021$conf_jud <- car::recode(as.numeric(elsoc_long_2016_2021$c05_05), 
                                      recodes = "c(1,2)='Nada o Poca';
                                      c(3)='Algo';
                                      c(4,5)='Bastante o Mucha';
                                      else=NA", as.factor = TRUE)

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_long_2016_2021)

datos.part <- data.frame((svytable(~conf_part + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_part=Freq/sum(Freq))
datos.part$ola <- NULL

datos.carb <- data.frame((svytable(~conf_carab + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_carb=Freq/sum(Freq))
datos.carb$ola <- NULL

datos.jud <- data.frame((svytable(~conf_jud + ola, elsoc_diseno, round = F))) %>% group_by(ola) %>% mutate(p_jud=Freq/sum(Freq))

elsoc_diseno <- svydesign(ids = ~segmento, #muestreo por conglomerado a nivel de manzanas (segmento)
                          strata = ~estrato, #muestreo estratificado a nivel ciudad (estato)
                          weights = ~ponderador02, #ponderador de corte transversal
                          nest = TRUE,
                          data = elsoc_long_2016_2021)

datos.grafico.1.10 <- cbind(datos.part, datos.carb, datos.jud)

#trasponer según variable
datos.1.10 <- datos.grafico.1.10 %>% 
        pivot_longer(cols = starts_with('conf_'))  %>%
                mutate(variable = factor(name,
                             labels = c('Partidos Políticos', 
                                        'Carabineros de Chile', 
                                        'Poder Judicial'))) %>%
                              filter(value == 'Bastante o Mucha') %>%
                              drop_na() 


datos.1.10$porcentaje <- with(datos.1.10, case_when(
  variable == 'Carabineros de Chile' ~ p_carb,
  variable == 'Partidos Políticos' ~ p_part,
  variable == 'Poder Judicial' ~ p_jud))

g1.10 <- ggplot(datos.1.10,aes(y = porcentaje, x = ola, color = variable, group = variable,
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
    theme_bw() +  
    geom_line(size = 1) +
    geom_point(size = 1.8) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0,1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .33, end = .66, direction = 1, option = 'viridis') +
    facet_wrap(.~variable)+
    geom_text(vjust = -0.8,
    posilinetion = position_dodge(width = .9),
    size= 1.75) +
    theme(legend.position = 'top',
          legend.title = element_blank()) 
g1.10

```



<!--chapter:end:05-mov-sociales-acc-colec.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Identificación Política



## Identificación política

### 2.1 Identificación política por ola

<!-- ### 2.1 Identificación política por ola -->

```{r echo=FALSE}
datos.2.1 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(x = pos_id, by = ola, na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g.2.1 <- datos.2.1 %>% 
    ggplot(aes(y = prop, x = pos_id, fill = ola, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
    theme_bw() + 
    geom_col(position= 'dodge2') +
    #escala del eje y en porcentajes del 0 al 100%
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    #Nombres de los ejes se eliminan
    ylab(label = NULL) +
    xlab(label = NULL) +
    #colores oficiales por ola: degradé 'viridis'
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    #etiquetas por sobre cada barra
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    #posicionamiento de leyenda arriba
    theme(legend.position = 'top',
          legend.title = element_blank())


g.2.1
```

### 2.2 Alluvial de cambios de Identificación política

<!-- ### 2.2 Alluvial de cambios de Identificación política (+o-) -->

```{r include=FALSE}
elsoc_panel_m1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1) %>% 
  group_by(idencuesta) %>% 
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  ungroup() %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.2.2 <- data.frame((svytable(~pos_id + ola + idencuesta, elsoc_panel_m1, round = F))) %>% dplyr::filter(Freq>0)  %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit()

etiquetas.2.2 <- data.frame((svytable(~pos_id + ola, elsoc_panel_m1, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% drop_na() %>% 
  mutate(idencuesta = 1)

g.2.2 <- ggplot(datos.2.2, aes(x = ola, fill = pos_id, stratum = pos_id,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.2.2, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))

g.2.2
```

### 2.3 De acuerdo o Totalmente de acuerdo con la cuarentena según identificación política el año 2021


```{r include=FALSE}
datos.2.3 <- elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1 & 
           !c37_10 %in% c(-888, -999) & !c15 %in% c(-888, -999)) %>% 
    mutate(pos_id = car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
           pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(c37_10, pos_id, na.rm = TRUE) %>% 
  sjlabelled::as_label(c37_10, pos_id)

g.2.3 <- datos.2.3 %>% 
  ggplot(aes(y = prop, x = pos_id, fill = c37_10, 
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())

g.2.3

```


### 2.4 Grado de acuerdo con actividad económica versus salud pública según identificación política el año 2021

<!-- ### 2.4 Grado de acuerdo con la frase "Es más importante darle prioridad a la actividad económica que a la salud de la población" según identificación política -->

```{r include=FALSE}

datos.2.4 <- elsoc_long_2016_2021 %>% 
  filter(ola == 5 & tipo_atricion == 1 & 
           !c37_09 %in% c(-888, -999) & !c15 %in% c(-888, -999)) %>% 
    mutate(pos_id = car::recode(c15, recodes = "0:4 = 1; 5 = 2; 6:10 = 3; 11:12 = 4"),
           pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(c37_09, pos_id, na.rm = TRUE) %>% 
  sjlabelled::as_label(c37_09, pos_id)

g.2.4 <- datos.2.4 %>% 
  ggplot(aes(y = prop, x = pos_id, fill = c37_09, 
               label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())

g.2.4

```

### 2.6 Grado de acuerdo con el aborto según identificación política

```{r include=FALSE}
datos.2.6 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & c37_02 %in% c(4,5)) %>%
  mutate(aborto = car::recode(c37_02, recodes = "c(4,5)= 1;
                                      else=NA", as.factor = TRUE)) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
   prop(x = pos_id, by = c(ola, aborto), na.rm = TRUE) %>%
  sjlabelled::as_label(ola)

g2.6 <-datos.2.6 %>% 
  ggplot(aes(y = prop, x = pos_id,  
               label = as.character(scales::percent(prop, accuracy = .1)))) +
    theme_bw() + 
    geom_col(position= 'dodge2') +
    #escala del eje y en porcentajes del 0 al 100%
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    #Nombres de los ejes se eliminan
    ylab(label = NULL) +
    xlab(label = NULL) +
    #colores oficiales por ola: degradé 'viridis'
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  facet_grid(.~ola) +
    #etiquetas por sobre cada barra
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    #posicionamiento de leyenda arriba
    theme(legend.position = 'top',
          legend.title = element_blank())

#g2.6
```

### 2.7 Grado de acuerdo con la capitalizacion individual pensiones según identificación política

```{r}
datos.2.7 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1) %>%
  mutate(cap_pension = car::recode(c37_04, recodes = "c(1,2)= 1;
                                      c(3)= 2; 
                                      c(4,5)= 3;
                                      else=NA", as.factor = TRUE)) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  filter(cap_pension %in% c(3)) %>% 
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(x = pos_id, by = c(cap_pension, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)
```

```{r}
g2.7 <-datos.2.7 %>% 
  ggplot(aes(y = prop, x = ola, fill = cap_pension, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
    theme_bw() + 
    geom_col(position= 'dodge2') +
    #escala del eje y en porcentajes del 0 al 100%
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    #Nombres de los ejes se eliminan
    ylab(label = NULL) +
    xlab(label = NULL) +
    #colores oficiales por ola: degradé 'viridis'
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  facet_grid(.~pos_id) +
    #etiquetas por sobre cada barra
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    #posicionamiento de leyenda arriba
    theme(legend.position = 'top',
          legend.title = element_blank())

#g2.7
```

### 2.8 Grado de acuerdo con las restricciones de ingreso de migrantes según identificación política

```{r}
datos.2.8 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1) %>%
  mutate(rest_migrantes = car::recode(c37_05, recodes = "c(1,2)= 1;
                                      c(3)= 2; 
                                      c(4,5)= 3;
                                      else=NA", as.factor = TRUE)) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  filter(rest_migrantes %in% c(3)) %>% 
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(x = pos_id, by = c(rest_migrantes, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola) %>%
  na.omit()
g2.8 <-datos.2.8 %>% 
  ggplot(aes(y = prop, x = ola, fill = rest_migrantes, 
               label = as.character(scales::percent(prop, accuracy = .1)))) +
    theme_bw() + 
    geom_col(position= 'dodge2') +
    #escala del eje y en porcentajes del 0 al 100%
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    #Nombres de los ejes se eliminan
    ylab(label = NULL) +
    xlab(label = NULL) +
    #colores oficiales por ola: degradé 'viridis'
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  facet_grid(.~pos_id) +
    #etiquetas por sobre cada barra
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    #posicionamiento de leyenda arriba
    theme(legend.position = 'top',
          legend.title = element_blank())

#g2.8
```


<!--chapter:end:06-id-politica.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Actitudes hacia la democracia

## Apoyo a la Democracia

### 3.1 ¿Con cuál de las siguientes frases está usted más de acuerdo?

<!-- ### 3.1 ¿Con cuál de las siguientes frases está usted más de acuerdo? -->

```{r include=FALSE}
elsoc_panel_m1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & !ola %in% c(1,2)) %>% 
  group_by(idencuesta) %>% 
  mutate(aut_dem = factor(c25, levels = c(1, 2, 3, 4),
                         labels = c('Democracia es preferible a\ncualquier otra forma\nde gobierno', 'En algunos casos,\n gobierno autoritario puede\n ser preferible', 'Da lo mismo régimen\ndemocrático o autoritario', 'Ninguna'))) %>%
  mutate(missing = any(aut_dem %in% c("NA"))) %>% 
  filter(!missing) %>% 
  ungroup() %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.3.1 <- data.frame((svytable(~aut_dem + ola + idencuesta, elsoc_panel_m1, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit()

etiquetas.3.1 <- data.frame((svytable(~aut_dem + ola, elsoc_panel_m1, round = F))) %>% group_by(ola) %>% mutate(porcentaje=Freq/sum(Freq)) %>% na.omit() %>% 
  mutate(idencuesta = 1)

g.3.1 <- ggplot(datos.3.1, aes(x = ola, fill = aut_dem, stratum = aut_dem,
                             alluvium = idencuesta, y = porcentaje))+
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.3.1, 
              aes(label = ifelse(porcentaje > 0.03 , scales::percent(porcentaje, accuracy = .1),"")),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2,
              color = rep('white'))

g.3.1
```

### 3.2 Insatisfacción con la democracia por ola

<!-- ### 3.2 Insatisfacción con la democracia por ola -->

```{r echo=FALSE}
datos.3.2 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & !c01 %in% c(-999,-888)) %>%
  prop(c01 %in% c(1), by  = c(ola), na.rm = TRUE) %>%
  sjlabelled::as_label(ola, c01)
elsoc_long_2016_2021$c01

g.3.2 <- datos.3.2 %>% 
  ggplot(aes(y = prop, x = ola,  
               label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
    geom_col() +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'none',   
          legend.title = element_blank())
g.3.2
```

### 3.3 ¿Con cuál de las siguientes frases está usted más de acuerdo? (2021), según posición ideológica

<!-- ### 3.3. ¿Con cuál de las siguientes frases está usted más de acuerdo? (2019), según posición ideológica -->

```{r include=FALSE}
datos.3.3 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & ola %in% c(5) & !c25 %in% c(-888,-999)) %>%
  mutate(aut_dem = factor(c25, levels = c(1, 2, 3, 4),
                         labels = c('Democracia es preferible a\ncualquier otra forma\nde gobierno', 'En algunos casos,\n gobierno autoritario puede\n ser preferible', 'Da lo mismo régimen\ndemocrático o autoritario', 'Ninguna'))) %>%
  mutate(pos_id = car::recode(c15, recodes = "c(0,1,2,3,4)=1; c(5)=2; c(6,7,8,9,10)=3; c(11,12, -999, -888)=4")) %>%
  mutate(pos_id = factor(pos_id, levels = c(1, 2, 3, 4),
                         labels = c('Izquierda', "Centro", "Derecha", "No se identifica"))) %>%
  prop(x = aut_dem, by = c(pos_id, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(pos_id, ola)

g.3.3 <-datos.3.3 %>% 
  ggplot(aes(y = prop, x = pos_id, fill = aut_dem, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .95, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g.3.3
```






<!--chapter:end:07-actitud-demo.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Perfiles Ideológicos de los Chilenos 

## Clases latentes: Motivación

### Batería de preguntas

- Las parejas homosexuales deberían poder adoptar hijos
- El aborto debe ser legal bajo cualquier circunstancia
- El Estado de Chile, más que los privados, debería ser el principal proveedor de educación
- Cada persona debiera asegurarse por sí mismo su futura pensión para la tercera edad
- Chile debería tomar medidas más drásticas para impedir el ingreso de inmigrantes al país
- La educación sexual de los niños debería ser responsabilidad exclusiva de los padres
- Se deberían clausurar empresas contaminantes, incluso si esto implica un aumento en el desempleo
- El gasto social debe destinarse únicamente a los más pobres y vulnerables

## Modelo teórico de perfiles ideólogicos


### Aproximación Empírica


### Perfiles ideológicos: Resultados principales



<!-- ### 4.5 Religión, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```



<!-- ### 4.6 Posición política, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```



<!-- ### 4.7 Interés en política, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```



<!-- ### 4.8 Satisfacción con la Democracia, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```


<!-- ### 4.9 Preferencia por la Democracia, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```


<!-- ### 4.10 Consistencia durante las 4 olas en Posición política, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```

<!-- ### 4.11 Consistencia durante las 4 olas en Identificación partidaria, según Perfiles ideológicos -->
```{r include=FALSE}

```



<!-- ### 4.12 Consistencia durante las 4 olas en Identificación con coaliciones política, según Perfiles ideológicos (2019) -->
```{r include=FALSE}

```

<!-- ### 4.13 Niveles de confianza social, según Perfiles ideológicos de los chilenos (2019) -->
```{r include=FALSE}

```


```{r include=FALSE}

```



<!--chapter:end:08-perfiles-ideo.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Justificación de la Violencia


## Justificación de la violencia para el control social – a manos de ciudadanos

```{r just-vio-ola, fig.aligN='center', fig.cap='Justificación de la violencia en relación a delincuencia, según ola de encuesta'}
datos.g10.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(f05_01, f05_02, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(f05_01, f05_02)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value %in% c(4,5), by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('f05_01', 'f05_02'),
                       labels = c('Personas persigan y golpeen a un delincuente\n que acaba de cometer un asalto','Personas amarren a un poste y desnuden a un\n delincuente que acaba de cometer un asalto'))) %>% 
sjlabelled::as_label(ola,f05_01, f05_02)

#graficamos

g10.1 <-datos.g10.1 %>% 
  ggplot(aes(y = prop, x = ola,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(datos.g10.1$name) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g10.1
```


## Justificación de la violencia para el control social – a manos de carabineros

```{r just-carab-ola, fig.align='center',fig.cap="Justificación de la violencia en relación al actuar de Carabineros, según ola"}
datos.g10.2 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(f05_03, f05_04, f05_07, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(f05_03, f05_04, f05_07)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value %in% c(4,5), by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('f05_03', 'f05_04', 'f05_07'),
                       labels = c('Carabineros use la fuerza para\n reprimir manifestación pacífica','Carabineros desaloje a la fuerza\na estudiantes de liceo en toma','Estudiantes tiren piedras a Carabi-\nneros en marcha por la educación'))) %>% 
sjlabelled::as_label(ola,f05_03, f05_04, f05_07)

#graficamos

g10.2 <-datos.g10.2 %>% 
  ggplot(aes(y = prop, x = ola,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(datos.g10.2$name) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g10.2
```



<!--chapter:end:10-just-viol.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Cambio Constitucional

```{r particip-edad, fig.align='center', fig.cap='Participación en Plebiscito Nueva Constitucion'}
datos.g11.1 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c43 %in% c(3, -888, -999)) %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  prop(c43, by = edadt, na.rm = TRUE) %>% 
  sjlabelled::as_label(c43, edadt)
  
g11.1 <- datos.g11.1 %>% 
  ggplot(aes(y = prop, x = edadt, fill = c43, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.1
```

```{r servel-apruebo, fig.align='center', fig.cap='Voto retrospectivo Plebiscito Nueva Constitucion'}

datos.g11.2 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c44 %in% c(3, 4, -888, -999)& !is.na(c44)) %>% 
  prop(c44, na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(c44) %>% 
  mutate(datos = 'Datos ELSOC') %>%
  add_row(c44 = c('Apruebo', 'Rechazo'), prop = c(.7828, .2172), datos = c('Datos servel', 'Datos servel'))

g11.2 <- datos.g11.2 %>% 
  ggplot(aes(y = prop, x = datos, fill = c44, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.2
```

```{r servel-cc, fig.align='center', fig.cap= 'Voto Retrospectivo Plebiscito Nueva Constitucion'}
datos.g11.3 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !c45 %in% c(3, 4, -888, -999) & !is.na(c45)) %>% 
  prop(c45, na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(c45) %>% 
  mutate(datos = 'Datos ELSOC') %>%
  add_row(c45 = c('Convención Mixta', 'Convención Constitucional'), prop = c(.2101, .7899), datos = c('Datos servel', 'Datos servel'))

g11.3 <- datos.g11.3 %>% 
  ggplot(aes(y = prop, x = datos, fill = c45, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.3
```

```{r particip-elect-id, fig.align='center', fig.cap= 'Sí Participa en Elecciones según Identificación Política'}

datos.g11.4 <- elsoc_long_2016_2021 %>% 
  mutate(c11 = car::recode(c11, '1=2;2=1'), # en c11 1 = no participa, a diferencia de c43
         particip_electoral = ifelse(ola == 5, c43, c11),
         pos_id = factor(car::recode(c15, "c(11,12) = 'No se identifica'; c(0,1,2,3,4) = 'Izquierda'; c(5) = 'Centro'; c(6,7,8,9,10) = 'Derecha'"), levels = c('Izquierda', 'Centro', 'Derecha', 'No se identifica'))) %>%
  filter(tipo_atricion == 1 & !particip_electoral %in% c(3, -888, -999) & 
           ola %in% c(1,3,5) & !is.na(pos_id)) %>% 
  prop(particip_electoral == 1, by = c(ola, pos_id), na.rm = TRUE) %>%
  sjlabelled::as_label(pos_id) %>% 
  mutate(ola = factor(ola, levels = c(1,3,5), labels = c('Elecciones Presidenciales\nde 2013', 'Elecciones Presidenciales\nde 2017', 'Plebiscito cambio\nconstitucional')))


g11.4 <- datos.g11.4 %>% 
  ggplot(aes(y = prop, x = ola, color = pos_id, group = pos_id,
              label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0.22, end = .66, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.4
```

```{r id-pol-voto, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.g11.5 <- elsoc_long_2016_2021 %>% 
  mutate(pos_id = factor(car::recode(c15, "c(11,12) = 'No se identifica'; c(0,1,2,3,4) = 'Izquierda'; c(5) = 'Centro'; c(6,7,8,9,10) = 'Derecha'"), levels = c('Izquierda', 'Centro', 'Derecha', 'No se identifica'))) %>%
  dplyr::filter(ola == 5 & tipo_atricion == 1 
                & !c44 %in% c(3,4, -888, -999) & !is.na(c44) & !is.na(pos_id)) %>% 
  prop(c44, by = c(pos_id), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(c44, pos_id) 

  
g11.5 <- datos.g11.5 %>% 
  ggplot(aes(y = prop, x = pos_id, fill = c44, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g11.5
```

## Patrones de Votación

```{r presi-voto-c44, fig.align='center', fig.cap= "Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.g11.6 <- elsoc_wide_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1 
                & !c44_w05 %in% c(3,4, -888, -999)
                & !c39_w03 %in% c(-888, -999) & !is.na(c44_w05) & !is.na(c39_w03)) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(c44_w05, by = c39_w03, na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(c44_w05, c39_w03) 

g11.6 <- datos.g11.6 %>% 
  ggplot(aes(x = prop, y = c39_w03, fill = c44_w05, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(prop > 0.04 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.6
```

```{r presi-voto-c45, fig.align='center', fig.cap="Voto Retrospectivo Plebicito, según Posición Ideológica"}
datos.g11.7 <- elsoc_wide_2016_2021 %>% 
  dplyr::filter(tipo_atricion == 1 
                & !c45_w05 %in% c(3,4, -888, -999)
                & !c39_w03 %in% c(-888, -999) & !is.na(c45_w05) & !is.na(c39_w03)) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(c45_w05, by = c39_w03, na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(c45_w05, c39_w03) 

g11.7 <- datos.g11.7 %>% 
  ggplot(aes(x = prop, y = c39_w03, fill = c45_w05, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_x_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(aes(label = ifelse(prop > 0.04 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'white'), 10)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g11.7
```

```{r 2020-vs-2021, fig.align='center', fig.cap= "Participación Electoral 2021, según la Participación en 2017"}
datos.11.7 <- elsoc_wide_2016_2021 %>% 
  filter(tipo_atricion == 1 & !c43_w05 %in% c(3, -888, -999) & 
           !c11_w03 %in% c(3, -888, -999)) %>% 
  survey_design_elsoc(weights = 'ponderador02_w05') %>% 
  prop(c43_w05, by = c11_w03) %>% 
  sjlabelled::as_label(c43_w05, c11_w03)

datos.11.7 %>% 
  ggplot(aes(y = prop, x = c11_w03, fill = c43_w05, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = "Stack") +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = "Participación Electoral en 2017") +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('black', 'white'), 2)) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
```

```{r cambio_participa}
#grafico y caracterización pendiente
elsoc_wide_2016_2021$cambio_participa_w05 <- factor(with(elsoc_wide_2016_2021, case_when(
  (c11_w03 == 2) & (c43_w05 == 2) ~ 1 ,
  (c11_w03 == 2) & (c43_w05 == 1) ~ 2 ,
  (c11_w03 == 1) & (c43_w05 == 2) ~ 3 ,
  (c11_w03 == 1) & (c43_w05 == 1) ~ 4)),
  labels = c('Se mantiene no votando',
             'Cambia a votar',
             'Cambia a No Votar',
             'Se mantiene votando'))

sjmisc::frq(elsoc_wide_2016_2021$cambio_participa_w05)
```


<!--chapter:end:11-camb-constiucional.Rmd-->

# Conflicto y cohesión territorial en pandemia

```{r library-12, eval=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 
Sys.setlocale("LC_ALL","ES_ES.UTF-8")

#devtools::install_github('edgardo-cerda/elsoc', force = TRUE)
library(elsoc)
library(tidyverse)
library(sjlabelled)
library(ggrepel)
library(survey)
library(sf)
library(chilemapas)
library(rgdal)

#load(file.path('1_input', 'ELSOC_Long_2016_2021_v1.00_R.RData'))
elsoc::load_elsoc(format = 'long')
```

## Conflictividad barrial

<!-- ### 8.1 ¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio -->
```{r confli-olas, fig.align='center', fig.cap='¿Con qué frecuencia usted/alguien de su hogar se ha molestado o incomodado por problemas con sus vecinos? según ola de estudio '}
datos.8.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_confli_rec, by = ola, na.rm = TRUE)

g8.1 <- datos.8.1 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_confli_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top', legend.title = element_blank())
g8.1
```

<!-- ### 8.2 Cambios en frecuencia de conflictos barriales -->
```{r confli-cambio, fig.align='center', fig.cap='Cambios en frecuencia de conflictos barriales'}

elsoc_diseno <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.8.2 <- data.frame((svytable(~barrio_confli_rec + ola + idencuesta, elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>%  
  drop_na()

etiquetas.8.2 <- data.frame((svytable(~barrio_confli_rec + ola, elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  drop_na()

g8.2 <- 
  ggplot(datos.8.2, aes(x = ola, fill = barrio_confli_rec, stratum = barrio_confli_rec, 
                           alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.8.2, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('black', 'white', 'white'),2))
g8.2
```

<!-- ### 8.3 Porce´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´´{+}egún ola del estudio y zona geográfica. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-zona, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona geográfica. Porcentaje con conflictos barriales "Siempre" o "Muchas veces"'}

datos.8.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate( zona1 = factor(car::recode(region_cod, 
                                     "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana"))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_confli >= 2.76, by = c(ola, zona1), na.rm = TRUE)

g8.3 <- datos.8.3 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.3
```

<!-- ### 8.4 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-estrato, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y zona de residencia. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".'}
datos.8.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
         labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
         labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción', 
                    'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_confli_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  filter(barrio_confli_rec == 'Muchas veces o siempre')

g8.4 <- datos.8.4 %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.4
```


<!-- ### 8.5 Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintil de ingreso. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".  -->
```{r confli-quintil, fig.align='center', fig.cap='Porcentaje con alta frecuencia de conflictos barriales, según ola del estudio y quintil de ingreso. Porcentaje con conflictos barriales "Siempre" o "Muchas veces".'}
datos.8.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4,
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_confli >= 2.76, by = c(ola, quintil), na.rm = TRUE)

g8.5 <- datos.8.5 %>% 
  ggplot(aes(y = prop, x = quintil, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .3)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.5
```

### Cartografía del conflicto barrial

```{r confli-comuna, fig.align='center', fig.cap='Frecuencia promedio de problemas con vecinos, según comuna de residencia en la región metropolitana (2021).'}

elsoc_comuna_rm <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & region_cod == 13 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(m_confli = weighted.mean(barrio_confli, ponderador02, na.rm = T)) %>% 
  ungroup() 

comunas_rm <- chilemapas::mapa_zonas %>%   
  dplyr::filter(codigo_region == '13' & codigo_provincia == '131') %>% 
  st_as_sf(.) %>% 
  group_by(codigo_comuna) %>% 
  summarise() %>% 
  ungroup() %>% 
  mutate(comuna_cod = as.numeric(codigo_comuna)) %>% 
  left_join(elsoc_comuna_rm, by = 'comuna_cod')

g.confli.rm <- comunas_rm %>%
  ggplot() + 
  geom_sf(aes(fill = m_confli, geometry = geometry)) +
  labs(y = NULL, x = NULL, fill = "Conflictividad barrial\npromedio por comuna") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis') +
  theme_bw()
g.confli.rm
```

```{r confli-region2, fig.align='center', fig.cap='Frecuencia promedio de problemas con vecinos, según región de Chile (2021)', message=FALSE, warning=FALSE}

elsoc_region <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !t11_01 %in% c(-888, -999) &
           !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) & !t11_04 %in% c(-888, -999)) %>% 
  mutate(barrio_confli = (t11_01 + t11_02 + t11_03 + t11_04)/4) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(region, region_cod) %>% 
  summarise(m_confli = weighted.mean(barrio_confli, ponderador02, na.rm = T),
            sd_confli = sd(barrio_confli, na.rm = T),
            n = n())

elsoc_region$region_cod <- factor(elsoc_region$region_cod,
                                  labels = c('01','02','03','04','05','06','07','08',
                                            '09','10','11','13','14','15','16'))

regiones <- generar_regiones()
regiones <- merge(regiones,elsoc_region, by.x="codigo_region",by.y="region_cod",all.x=TRUE,sort=F)

#para intentar hacer facet_wrap
#regiones$mitad <- c('1','1','1','1','1','1','1','2','2','2','2','1','2','1','2','2')

regiones$region[is.na(regiones$region)] <- 'Magallanes\n(Sin datos)'
regiones$region[regiones$region == 'Metropolitana de santiago'] <- 'Metropolitana'
regiones$region[regiones$region == 'Libertador general bernardo ohiggins'] <- 'Ohiggins'
regiones$region[regiones$region == 'Aysen del general carlos ibannez del campo'] <- 'Aysen'
regiones$region[regiones$region == 'Arica y parinacota'] <- 'Arica'

g.confli.region <- regiones %>% 
  ggplot(aes(fill = m_confli, geometry = geometry, label = region)) + 
  geom_sf() +
  coord_sf(xlim = c(-100, -65)) +
  labs(y = NULL, x = NULL, fill = "Conflictividad barrial\npromedio por región") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis', na.value = 'white') +
  ggrepel::geom_text_repel(stat = "sf_coordinates", min.segment.length = 0,
                           colour = "black", segment.colour = "black",
                           direction = "y", hjust = 2.5, size = 3) +
  ggspatial::annotation_north_arrow(aes(which_north = "true", location = "bl"), pad_y = unit(0.8, "cm")) +
  ggspatial::annotation_scale(aes(location = "bl", style = "bar")) +
  theme_bw()
g.confli.region
```

## Confianza en vecinos

<!-- ### 8.6 En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio -->
```{r vecinos-ola, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? según ola de estudio.'}
datos.8.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t01 %in% c(-888, -999)) %>% 
  mutate(barrio_conf = factor(car::recode(t01, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels = c('Muy poco o poco', 'Algo', 'Bastante o mucho'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_conf, by = ola, na.rm = TRUE)

g8.6 <- datos.8.6 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_conf, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.6
```

<!-- ### 8.7 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.  -->
```{r vecinos-zona, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y zona geográfica. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.8.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t01 %in% c(-888, -999)) %>% 
  mutate(zona1 = factor(car::recode(region_cod, 
                                    "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana")))%>%
  sjlabelled::as_label(ola) %>%
  prop(x = t01 %in% c(4, 5), by = c(ola, zona1), na.rm = TRUE) 

g8.7 <- datos.8.7 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.7
```

<!-- ### 8.8 En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y quintil de ingreso. Suma de Respuestas “Bastante” y “Mucho”. -->
```{r vecinos-quintil, fig.align='center', fig.cap='En términos generales, ¿cuánto confía usted en sus vecinos? Según ola del estudio y quintil de ingreso. Suma de Respuestas “Bastante” y “Mucho”.'}
datos.8.8 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) & !t01 %in% c(-888, -999)) %>% 
  mutate(m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m30b = as.numeric(car::recode(m30b, "1 = 125000; 2 = 300000; 3 = 400000; 4 = 620000; 5 = 1100000; NA = NA")),
         m29_imp = ifelse(!is.na(m29), m29, ifelse(ola == 5, m30b ,m30)),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54),
         ing_pc = (m29_imp/n_hogar)) %>%
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), 
                          levels = c(1,2,3,4,5),
                          labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = t01 %in% c(4, 5), by = c(ola, quintil), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.8 <- datos.8.8 %>% 
  ggplot(aes(y = prop, x = quintil, fill = ola, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.8
```


## Seguridad barrial

<!-- ### 8.9 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio. -->
```{r seguri-ola, fig.align='center', fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio.'}
datos.8.9 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(barrio_segur = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), levels = c(1,2,3),
                               labels = c('Muy inseguro o inseguro', 'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = barrio_segur, by = ola, na.rm = TRUE)

g8.9 <- datos.8.9 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_segur, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.9
```

<!-- ### 8.10 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Inseguro" o ”Muy Inseguro".  -->

```{r seguri-zona, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y zona geográfica. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}

datos.8.10 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(zona1 = factor(car::recode(region_cod, 
                                    "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), 
                        labels = c("Norte","Centro","Sur","Metropolitana")))%>%
  prop(x = t10 %in% c(1, 2), by = c(ola, zona1), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.10 <- datos.8.10 %>% 
  ggplot(aes(y = prop, x = ola, color = zona1, group = zona1,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.10
```

<!-- ### 8.11 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Inseguro" o ”Muy Inseguro". -->
```{r seguri-educ, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y nivel educacional. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}

datos.8.11 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999) & !m01 %in% c(-888, -999)) %>% 
  mutate(educ = factor(car::recode(m01,
                                   "c(1,2,3)=1; c(4,5)=2; c(6,7)=3; c(8,9,10)=4"),
                        levels = c(1,2,3,4), 
                       labels = c("Basica","Media","Tecnica","Universitaria"))) %>%
  prop(x = t10 %in% c(1, 2), by = c(ola, educ), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola)

g8.11 <- datos.8.11 %>% 
  ggplot(aes(y = prop, x = ola, color = educ, group = educ,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.11
```

<!-- ### 8.12 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Inseguro" o ”Muy Inseguro". -->
```{r seguri-edad, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y tramos de edad. Suma de Respuestas "Inseguro" o ”Muy Inseguro".'}
datos.8.12 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(edadt = factor(car::recode(m0_edad, 
                                    "18:29=1;30:49=2;50:64=3;65:150=4"),
                        levels = c(1,2,3,4), 
                        labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  sjlabelled::as_label(ola) %>%
  prop(x = t10 %in% c(1,2), by = c(ola, edadt), na.rm = TRUE)

g8.12 <- datos.8.12 %>% 
  ggplot(aes(y = prop, x = ola, color = edadt, group = edadt,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size = 3) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.12
```

<!-- ### 8.13 ¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintil de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro". -->
```{r seguri-quintil, fig.align='center',fig.cap='¿Qué tan seguro o inseguro se siente en el barrio o vecindario donde usted vive? Según ola del estudio y quintil de ingreso per capita. Suma de Respuestas "Seguro" o ”Muy Seguro".'}

datos.8.13 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !t10 %in% c(-888, -999)) %>% 
  mutate(barrio_segur = factor(car::recode(t10, "c(1,2)=1; c(3)=2; c(4,5)=3"), levels = c(1,2,3),
                               labels = c('Muy inseguro o inseguro', 'Ni seguro ni inseguro',
                                          'Seguro o Muy seguro')),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_segur, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(barrio_segur == 'Muy inseguro o inseguro', quintil == "Q1" | quintil == "Q5") %>% 
  drop_na()

g8.13 <- datos.8.13 %>% 
  ggplot(aes(y = prop, x = ola, color = quintil, group = quintil,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .55, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.13
```

## Criminalidad barrial

<!-- ### 8.14 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola de estudio. -->
```{r crim-olas, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola de estudio.'}
datos.8.14 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = ola, na.rm = TRUE)

g8.14 <- datos.8.14 %>% 
  ggplot(aes(y = prop, x = ola, fill = barrio_crim_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top', legend.title = element_blank())
g8.14
```

<!-- ### 8.15 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y zona geográfica. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-zona, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y zona geográfica. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}
datos.8.15 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         zona1 = factor(car::recode(region_cod, "c(1,2,3,4,15)=1; c(5,6,7,8,16)=2; c(9,10,11,12,14)=3; 13=4"),
                        levels = c(1,2,3,4), labels = c("Norte","Centro","Sur","Metropolitana"))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = c(ola, zona1), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre')

g8.15 <- datos.8.15 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.15
```

<!-- ### 8.16 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y tipo de ciudad. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-estrato, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y tipo de ciudad. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}
datos.8.16 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(4,5) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  sjlabelled::as_label(ola) %>% 
  prop(x = barrio_crim_rec, by = c(ola, estrato), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre')

g8.16 <- datos.8.16 %>% 
  ggplot(aes(y = prop, x = estrato, fill = ola, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g8.16
```

<!-- ### 8.17 ¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y quintil de ingreso. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".  -->
```{r crim-quintil, fig.align='center', fig.cap='¿Con qué frecuencia se han producido crímenes (riñas, robos y tráfico de drogas) en su barrio?, según ola del estudio y quintil de ingreso. Porcentaje de experiencias de criminalidad "Siempre" o "Muchas veces".'}

datos.8.17 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>% 
  mutate(barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = barrio_crim_rec, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(barrio_crim_rec == 'Muchas veces o siempre', quintil == "Q1" | quintil == "Q5") 

g8.17 <- datos.8.17 %>% 
  ggplot(aes(y = prop, x = ola, color = quintil, group = quintil,
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,.6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .0, end = .55, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g8.17
```
### Cartografía de la criminalidad barrial

```{r crimi-comuna, fig.align='center', fig.cap='Frecuencia promedio de percepción de crímenes (riñas, robos y tráfico de drogas) en el barrio, según comuna de residencia en la región metropolitana (2021).'}

elsoc_comuna_rm <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & region_cod == 13 & !t09_01 %in% c(-888, -999) &
           !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(comuna, comuna_cod) %>% 
  summarise(m_crim = weighted.mean(barrio_crim, ponderador02, na.rm = T),
            sd_crim = sd(barrio_crim, na.rm = T),
            n = n())

comunas_rm <- chilemapas::mapa_zonas %>% 
  filter(codigo_region==13 & codigo_provincia == '131') %>% 
  st_as_sf(.) %>% 
  group_by(codigo_comuna) %>% 
  summarise()

comunas_rm <- merge(comunas_rm, 
                    elsoc_comuna_rm, 
                    by.x = "codigo_comuna", by.y = "comuna_cod",
                    all.x = TRUE,
                    sort=F)

#comunas_rm <- comunas_rm %>% drop_na() #en caso de quitar comunas con NA

g.crimi.rm <- 
  ggplot(comunas_rm) + 
  geom_sf(aes(fill = m_crim, geometry = geometry)) +
  labs(y = NULL, x = NULL, fill = "Criminalidad barrial\npromedio por comuna") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis') +
  theme_bw() 
g.crimi.rm
```

```{r confli-region, fig.align='center', fig.cap='Frecuencia promedio de percepción de crímenes (riñas, robos y tráfico de drogas) en el barrio, según región de Chile (2021)', message=FALSE, warning=FALSE}

elsoc_region <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !t09_01 %in% c(-888, -999) &
           !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999)) %>% 
  mutate(barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(region, region_cod) %>% 
  summarise(m_crim = weighted.mean(barrio_crim, ponderador02, na.rm = T),
            sd_crim = sd(barrio_crim, na.rm = T),
            n = n())

elsoc_region$region_cod <- factor(elsoc_region$region_cod,
                                  labels = c('01','02','03','04','05','06','07','08',
                                            '09','10','11','13','14','15','16'))

regiones <- generar_regiones()
regiones <- merge(regiones,elsoc_region, by.x="codigo_region",by.y="region_cod",all.x=TRUE,sort=F)

#para intentar hacer facet_wrap
#regiones$mitad <- c('1','1','1','1','1','1','1','2','2','2','2','1','2','1','2','2')

regiones$region[is.na(regiones$region)] <- 'Magallanes\n(Sin datos)'
regiones$region[regiones$region == 'Metropolitana de santiago'] <- 'Metropolitana'
regiones$region[regiones$region == 'Libertador general bernardo ohiggins'] <- 'Ohiggins'
regiones$region[regiones$region == 'Aysen del general carlos ibannez del campo'] <- 'Aysen'
regiones$region[regiones$region == 'Arica y parinacota'] <- 'Arica'

g.crim.region <- regiones %>% 
  ggplot(aes(fill = m_crim, geometry = geometry, label = region)) + 
  geom_sf() +
  coord_sf(xlim = c(-100, -65)) +
  labs(y = NULL, x = NULL, fill = "Criminalidad barrial\npromedio por región") +
  scale_fill_viridis_c(begin = .11, end = .88, direction = -1, option = 'viridis', na.value = 'white') +
  ggrepel::geom_text_repel(stat = "sf_coordinates", min.segment.length = 0,
                           colour = "black", segment.colour = "black",
                           direction = "y", hjust = 2.5, size = 3) +
  ggspatial::annotation_north_arrow(aes(which_north = "true", location = "bl"), pad_y = unit(0.8, "cm")) +
  ggspatial::annotation_scale(aes(location = "bl", style = "bar")) +
  theme_bw()
g.crim.region
```

<!--chapter:end:12-territorio.Rmd-->

# Distanciamiento y comportamiento prosocial en pandemia

```{r library-13, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 
Sys.setlocale("LC_ALL","ES_ES.UTF-8")

#devtools::install_github('edgardo-cerda/elsoc', force = TRUE)
library(elsoc)
library(tidyverse)
library(sjlabelled)
library(ggrepel)
library(survey)

#load(file.path('1_input', 'ELSOC_Long_2016_2021_v1.00_R.RData'))
elsoc::load_elsoc(format = 'long')
```

## Distanciamiento social

```{r dist-total, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? (2021).'}
datos.9.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  prop(x = dis_soc, na.rm = TRUE)

g9.1 <- datos.9.1 %>% 
  ggplot(aes(y = prop, x = dis_soc, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'none', 
        legend.title = element_blank())
g9.1
```

```{r dist-quintil, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según quintil de ingreso. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.2 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !t01 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;6=445000;
                                           7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;
                                           18=1670000;19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = dis_soc, by = c(ola, quintil), na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente")

g9.2 <- 
  datos.9.2 %>% 
  ggplot(aes(y = prop, x = quintil, fill = quintil, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.2
```


```{r dist-edad, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según edad. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         edadt = factor(car::recode(m0_edad, "18:29=1; 30:49=2; 50:64=3 ;65:150=4"),
                        levels = c(1,2,3,4), labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  prop(x = dis_soc, by = edadt, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente")

g9.3 <- 
  datos.9.3 %>% 
  ggplot(aes(y = prop, x = edadt, fill = edadt, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.3
```

```{r dist-estrato, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según estrato muestral (2021).'}
datos.9.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         estrato = factor(estrato, levels = c(1,2,3,4,5,6),
                          labels = c('Gran\nSantiago', 'Gran\nValparaíso', 'Gran\nConcepción',
                                     'Ciudades\ngrandes', 'Ciudades\nmedianas', 'Ciudades\npequeñas'))) %>%
  prop(x = dis_soc, by = estrato, na.rm = TRUE)

g9.4 <- datos.9.4 %>%
  ggplot(aes(y = prop, x = estrato, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c( 'black','black','white'), 6)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g9.4
```

```{r dist-telet, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según tipo de trabajo en pandemia. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999) & !m60 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         trab_pandemia = factor(m60, labels = c('Trabajo de manera\ncompleta desde el hogar',
                                                'Trabajo de manera\nparcial desde el hogar',
                                                'Trabajo fuera\ndel hogar'))) %>%
  prop(x = dis_soc, by = trab_pandemia, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente") %>% 
  drop_na()

g9.5 <- 
  datos.9.5 %>% 
  ggplot(aes(y = prop, x = trab_pandemia, fill = trab_pandemia, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.5
```
```{r dist-covid, fig.align='center', fig.cap='¿En qué medida usted ha seguido la recomendación de quedarse en su hogar, manteniendo el aislamiento social? según diagnóstico con coronavirus. Suma de respuestas "Frecuente o "Muy frecuentemente" (2021).'}
datos.9.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !c48 %in% c(-888, -999) & !s31 %in% c(-888, -999)) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3),
                               labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente")),
         covid = factor(s31, labels = c('Si','No'))) %>%
  prop(x = dis_soc, by = covid, na.rm = TRUE) %>% 
  filter(dis_soc == "Frecuentemente o\nmuy frecuentemente") %>% 
  drop_na()

g9.6 <- 
  datos.9.6 %>% 
  ggplot(aes(y = prop, x = covid, fill = covid, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Dodge') +
  scale_y_continuous(labels = scales::percent,
                      limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) + 
  theme(legend.position = 'none',
        legend.title = element_blank())
g9.6
```
## Efecto del distanciamiento social 

### Comportamiento pro-social

```{r dist-pros, fig.align='center', fig.cap='Frecuencia de comportamientos pro-sociales, según ola de estudio. Porcentaje de respuestas de "Lo hizo mas de dos veces".'}

datos.9.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(c07_01, c07_03, c07_02, c07_07, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(c07_01, c07_03, c07_02, c07_07)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value == 3, by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c07_01', 'c07_03', 'c07_02', 'c07_07'),
                       labels = c('Visito casa\nde vecino',
                               'Amigos visitaron\nsu casa',
                               'Asistio a reunion sobre temas\nde interes publico/comunitario',
                               'Converso con persona\nen problemas o deprimida')))

g9.7 <- datos.9.7 %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .77, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g9.7
```
```{r dist-pros2, fig.align='center', fig.cap='Frecuencia de comportamientos pro-sociales, según cumplimiento de distanciamiento social (2021). Porcentaje de respuestas de "Lo hizo mas de dos veces".'}
datos.9.8 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & !c48 %in% c(-888,-999)) %>%  
  select(c07_01, c07_03, c07_02, c07_07,c48, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  pivot_longer(cols = c(c07_01, c07_03, c07_02, c07_07)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value == 3, by = c(name, dis_soc), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c07_01', 'c07_03', 'c07_02', 'c07_07'),
                       labels = c('Visito casa\nde vecino',
                               'Amigos visitaron\nsu casa',
                               'Asistio a reunion\nsobre temas de\ninteres publico/comunitario',
                               'Converso con persona en\nproblemas o deprimida')))

g9.8 <- datos.9.8 %>% 
  ggplot(aes(y = prop, x = name, fill = dis_soc, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g9.8
```

### Percepción de conflictividad y criminalidad barrial
```{r dist-barrio, fig.align='center', fig.cap='Percepción de conflictividad y criminalidad barrial, según cumplimiento de distanciamiento social (2021). Porcentaje de personas que responden "Muchas veces o siempre".'}
datos.9.9 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & 
           !t11_01 %in% c(-888, -999) & !t11_02 %in% c(-888, -999) & !t11_03 %in% c(-888, -999) &
           !t11_04 %in% c(-888, -999) &
           !t09_01 %in% c(-888, -999) & !t09_02 %in% c(-888, -999) & !t09_03 %in% c(-888, -999) & 
           !c48 %in% c(-888, -999)) %>%
  mutate(barrio_confli = (t11_01 + t11_03 + t11_03 + t11_04)/4,
         barrio_crim = (t09_01 + t09_02 + t09_03)/3) %>%
  mutate(barrio_confli_rec = factor(cut(barrio_confli, breaks = c(0,1,2.75,5)),
                                    labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         barrio_crim_rec = factor(cut(barrio_crim, breaks = c(0,1,2.67,5)),
                                  labels = c("Nunca","Pocas o algunas veces","Muchas veces o siempre")),
         dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o\ncasi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  select(barrio_confli_rec,barrio_crim_rec, estrato_disenno, segmento_disenno, ponderador02, dis_soc) %>%
  pivot_longer(cols = c(barrio_confli_rec, barrio_crim_rec)) %>% 
  prop(value == 'Muchas veces o siempre', by = c(name, dis_soc), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('barrio_confli_rec', 'barrio_crim_rec'), 
                       labels = c('Conflictividad barrial', 'Criminalidad barrial'))) %>% 
  sjlabelled::as_label(dis_soc)

g9.9 <- datos.9.9 %>% 
  ggplot(aes(y = prop, x = name, fill = dis_soc, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
g9.9
```

<!--chapter:end:13-dist-social.Rmd-->

# Estatus subjetivo y Percepción de Mérito
```{r library-15, include=FALSE}
knitr::opts_chunk$set(cache=FALSE, 
                      warning = FALSE, 
                      message = FALSE) 
Sys.setlocale("LC_ALL","ES_ES.UTF-8")

#devtools::install_github('edgardo-cerda/elsoc', force = TRUE)
library(elsoc)
library(tidyverse)
library(sjlabelled)
library(ggrepel)
library(survey)

#load(file.path('1_input', 'ELSOC_Long_2016_2021_v1.00_R.RData'))
elsoc::load_elsoc(format = 'long')
```

## Estatus subjetivo
<!-- ### 11.1 En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio. -->
```{r ess-ola, fig.align='center',fig.cap='En nuestra sociedad, hay grupos que tienden a ubicarse en los niveles más altos y grupos que tienden a ubicarse en los niveles más bajos de la sociedad ¿Dónde se ubicaría usted?, según ola de estudio.'}
datos.11.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & !d01_01 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4, 5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = clase_sub, by = ola, na.rm = T)

g11.1 <- datos.11.1 %>% 
  ggplot(aes(y = prop, x = ola, fill = clase_sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.1

```

<!-- ### 11.2 Cambios de Clase social subjetiva entre 2016, 2019 y 2021 -->
```{r ess-cambio, fig.align='center',fig.cap='Cambios de Clase social subjetiva entre 2016, 2019 y 2021'}
elsoc_panel_m1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola %in% c(1, 4, 5)) %>% 
  group_by(idencuesta) %>% 
  mutate(missing = any(d01_01 %in% c(-888, -999))) %>% 
  filter(!missing) %>% 
  ungroup() %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4, 5)=2; c(6,7,8,9,10)=3; else=NA"), 
                            levels = c(1, 2, 3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.11.2 <- data.frame((svytable(~clase_sub + ola + idencuesta, elsoc_panel_m1, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>%
  filter(Freq>0 & (ola == '2016'| ola == '2019' | ola == '2021')) %>%
  drop_na()

etiquetas.11.2 <- data.frame((svytable(~clase_sub + ola, elsoc_panel_m1, round = F))) %>% 
  group_by(ola) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  filter(Freq>0 & (ola == '2016'| ola == '2019' | ola == '2021')) %>% 
  drop_na()

g11.2 <- 
  ggplot(datos.11.2, aes(x = ola, fill = clase_sub, stratum = clase_sub, 
                          alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  geom_text(data = etiquetas.11.2, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('white', 'white', 'black'),3))
g11.2
```

<!-- ### 11.3 Clase social subjetiva, según quintiles de ingreso (2021) -->
```{r ess-quintil, fig.align='center',fig.cap='Clase social subjetiva, según quintiles de ingreso (2021)'}

datos.11.3 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola %in% c(5) & !t01 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta")),
         m30 = as.numeric(car::recode(m30,"1=110000;2=251000;3=305000;4=355000;5=400000;
                                           6=445000;7=490000;8=535000;9=585000;10=640000;11=700000;12=765000;
                                           13=845000;14=935000;15=1040000;16=1180000;17=1375000;18=1670000;
                                           19=2275000;20=2700000;NA=NA")),
         m29_imp = ifelse(!is.na(m29),m29, m30),
         n_hogar = case_when(ola == 1 ~ nhogar1, ola == 2 ~ m46_nhogar,
                             ola == 3 ~ m54, ola == 4 ~ m54, ola == 5 ~ m54)) %>%
  mutate(ing_pc = (m29_imp/n_hogar)) %>%
  sjlabelled::as_label(ola) %>% 
  group_by(ola) %>% 
  mutate(quintil = factor(ntile(-desc(ing_pc), 5), levels = c(1,2,3,4,5),
         labels = c('Q1', 'Q2', 'Q3', 'Q4', 'Q5'))) %>% 
  prop(x = clase_sub, by = c(ola, quintil), na.rm = TRUE)

g11.3 <- 
  datos.11.3 %>% 
  ggplot(aes(y = prop, x = quintil, fill = clase_sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .99, direction = -1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c( 'black','black','white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.3
```

<!-- ### 11.4  Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021) -->
```{r esshijos-ess, fig.align='center',fig.cap='Si usted tiene actualmente hijos o si los tuviera en el futuro, ¿dónde cree usted que se ubicarían ellos?, según Clase social subjetiva (2021)'}
datos11.4 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & ola == 5 & 
         !d01_01 %in% c(-888, -999) & !d01_03 %in% c(-888, -999)) %>% 
  mutate(clase_sub = factor(car::recode(d01_01, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Baja y media baja", "Media", "Alta y media alta")),
         clase_sub_hijo = factor(car::recode(d01_03, "c(0,1,2,3)=1; c(4,5)=2; c(6,7,8,9,10)=3;else=NA"),
                                 levels = c(1,2,3), 
                                 labels = c("Baja y media baja", "Media", "Alta y media alta"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = clase_sub_hijo, by = c(ola, clase_sub), na.rm = T)

g11.4 <- datos11.4 %>% 
  ggplot(aes(y = prop, x = clase_sub, fill = clase_sub_hijo, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = 'Clase social subjetiva propia') +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('white', 'white', 'black'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.4
```

## Movilidad social

<!-- ### 11.5  Perspectiva de movilidad social, según ola.\nNota: la perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado. -->
```{r mov-soc-rec, fig.align='center',fig.cap='Perspectiva de movilidad social, según ola.\nNota: la perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado.'}
datos.11.5 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_03 %in% c(-888, -999)) %>% 
  mutate(mov_interg = d01_03 - d01_01) %>% 
  mutate(mov_interg_rec = factor(car::recode(mov_interg, "-8:-1=1;0=2;1:10=3;else=NA"), 
                            levels = c(1,2,3), 
                            labels = c("Perpectiva de\nmovilidad descendente", "Perspectiva de\ninmovilidad social",
                                       "Perspectiva de\nmovilidad ascendente"))) %>% 
  sjlabelled::as_label(ola) %>% 
  prop(x = mov_interg_rec, by = ola, na.rm = T)

g11.5 <- 
  datos.11.5 %>% 
  ggplot(aes(y = prop, x = ola, fill = mov_interg_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .11, end = .99, direction = -1, option = 'viridis') +
  scale_y_continuous(labels = scales::percent) + 
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep(c('black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.5
```

<!-- ### 11.6  Estatus subjetivo y tipo de movilidad social, nivel promedio según ola.\nNota: perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado. En cambio movilidad social relativa corresponde a la resta entre el estatus social actual y el estatus social de la familia donde creció.-->
```{r mov-soc, fig.align='center',fig.cap='Estatus subjetivo y tipo de movilidad social, nivel promedio según ola.\nNota: perspectiva de movilidad social corresponde a la resta entre el estatus social esperado del hijo y el estatus social actual del encuestado. En cambio movilidad social relativa corresponde a la resta entre el estatus social actual y el estatus social de la familia donde creció.'}
datos.11.6 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1 & 
         !d01_01 %in% c(-888, -999) & !d01_02 %in% c(-888,-999) & !d01_03 %in% c(-888, -999)) %>%
  sjlabelled::as_label(ola) %>% 
  mutate(mov_interg = d01_03 - d01_01,
         mov_relativa = d01_01 - d01_02) %>% 
  group_by(ola) %>% 
  summarise(m_interg = weighted.mean(mov_interg, ponderador02 ,na.rm = T),
            m_relativa = weighted.mean(mov_relativa, ponderador02 ,na.rm = T),
            m_estatus = weighted.mean(d01_01, ponderador02 ,na.rm = T),
            n = n()) %>% 
  mutate(var_interg = 'Perspectiva de\nmovilidad social',
         var_relativa = 'Movilidad social\nrelativa',
         var_estatus = 'Estatus social\nactual') %>% 
  pivot_longer(cols = starts_with('var_'))  %>%
  mutate(m_mov_social = case_when(
    value == 'Perspectiva de\nmovilidad social' ~ m_interg,
    value == 'Movilidad social\nrelativa' ~ m_relativa,
    value == 'Estatus social\nactual' ~ m_estatus)) 

datos.11.6$m_mov_social <- round(datos.11.6$m_mov_social, digits = 2) 

g11.6 <- datos.11.6 %>% 
  ggplot(aes(y = m_mov_social, x = ola, group = value, color = value,
             label = m_mov_social)) +
  theme_bw() +
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(limits = c(0,6)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .11, end = .55, direction = 1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,  size= 3.5)
g11.6
```
## Percepción de meritocracia

<!-- ### 11.7  Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".  -->
```{r merit-wave, fig.align='center',fig.cap='Percepción de importancia y recompensas del mérito, según ola de estudio. Porcentaje de Respuestas "De acuerdo" y ”Totalmente de acuerdo".'}

datos.11.7 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & muestra == 1) %>%  
  select(c18_09, c18_10, d05_02, d05_04, ola, ponderador02, segmento_disenno, estrato_disenno) %>% 
  pivot_longer(cols = c(c18_09, c18_10, d05_02, d05_04)) %>% 
  filter(!value %in% c(-888, -999)) %>% 
  prop(value %in% c(4,5), by = c(ola, name), na.rm = TRUE) %>% 
  mutate(name = factor(name,
                       levels = c('c18_09', 'c18_10', 'd05_02', 'd05_04'),
                       labels = c('Personas son\nrecompensadas\npor su esfuerzo',
                               'Personas son\nrecompensadas\npor su inteligencia',
                               'Educación es\nimportante para\nsurgir en la vida',
                               'Trabajo duro\nes importante para\nsurgir en la vida')))

g11.7 <- datos.11.7 %>% 
  ggplot(aes(y = prop, x = ola, color = name, group = name,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = 1, option = 'viridis') +
  geom_text(vjust = -0.8,
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
g11.7
```


<!--chapter:end:15-ess-merito.Rmd-->

---
output:
  pdf_document: default
  html_document: default
---
# Género

## Sexismo hostil y benevolente

```{r objetos, include=FALSE}
#Escala sexismo
elsoc_panel_m1$sexismo <- c( as.numeric(elsoc_panel_m1$g01_01) + as.numeric(elsoc_panel_m1$g01_02) +
                          as.numeric(elsoc_panel_m1$g01_03) + as.numeric(elsoc_panel_m1$g01_04)) /4

elsoc_panel_m1$sexismo_benevolo <- c( as.numeric(elsoc_panel_m1$g01_01) + as.numeric(elsoc_panel_m1$g01_02))/2
elsoc_panel_m1$sexismo_benevolo <- factor(car::recode(as.numeric(elsoc_panel_m1$sexismo_benevolo), 'c(1,1.5,2)=1;c(2.5, 3, 3.5)=2;c(4,4.5, 5)= 3; else=NA', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Debil', 'Medio', 'Fuerte'))
elsoc_panel_m1$sexismo_benevolo <- na.replace(elsoc_panel_m1$sexismo_benevolo, "NS/NR") #recode NA en categoría "NS/NR"
elsoc_panel_m1$sexismo_hostil <- c(as.numeric(elsoc_panel_m1$g01_03) + as.numeric(elsoc_panel_m1$g01_04))/2
elsoc_panel_m1$sexismo_hostil <- factor(car::recode(as.numeric(elsoc_panel_m1$sexismo_hostil), 'c(1,1.5,2)=1;c(2.5, 3, 3.5)=2;c(4,4.5, 5)= 3; else=NA', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Debil', 'Medio', 'Fuerte'))
elsoc_panel_m1$sexismo_hostil <- na.replace(elsoc_panel_m1$sexismo_hostil, "NS/NR") #recode NA en categoría "NS/NR"

elsoc_panel_m1$g01_01_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_01), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))
elsoc_panel_m1$g01_02_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_02), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$g01_03_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_03), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$g01_04_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$g01_04), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else=NA', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))


#Variables 2018 al 2021
elsoc_panel_m1$c19_01_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_01), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', 
                                             as.factor = TRUE), levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))


elsoc_panel_m1$c19_02_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_02), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$c19_03_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_03), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

elsoc_panel_m1$c19_04_rec <- factor(car::recode(as.numeric(elsoc_panel_m1$c19_04), 'c(1,2)=1;c(3)=2;c(4,5)= 3; else="NS/NR"', as.factor = TRUE),
                                levels = c(1,2,3),
                                labels = c('Desacuerdo', 'Ni acuerdo ni desacuerdo', 'De Acuerdo'))

#Horas de Cuidado
elsoc_panel_m1$m17_rec <- factor(car::recode(elsoc_panel_m1$m17, '0:3=1;4:9=2;10:29=3;30:59=4;60:300=5', as.factor = TRUE), levels = c(1,2,3,4,5),
                          labels = c('0-3 Horas','4-9 Horas','10-29 Horas', '30-59 Horas', '60 o más Horas'))
elsoc_diseno <- svydesign(ids = ~segmento,
                          strata = ~estrato, 
                          weights = ~ponderador02,
                          nest = TRUE,
                          data = elsoc_panel_m1)
```

```{r sexismo-sexo, fig.align='center', fig.cap='Sexismo benévolo y hostil, según sexo (2021). Porcentaje que responde "De acuerdo" o "Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5 & !g01_01 %in% c(-888, -999) & !g01_02 %in% c(-888, -999) & !g01_03 %in% c(-888, -999) & !g01_04 %in% c(-888, -999)) %>% 
  select(g01_01, g01_02, g01_03, g01_04, segmento_disenno, estrato_disenno, ponderador02, m0_sexo) %>% 
  pivot_longer(cols = c(g01_01, g01_02, g01_03, g01_04)) %>% 
  prop(value %in% 4:5, by = c(name, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(m0_sexo) %>% 
  mutate(name = factor(name,
                       levels = c('g01_01', 'g01_02', 'g01_03', 'g01_04'),
                       labels = c('Mujeres son\nmás refinadas\nque hombres',
                     'Mujeres debieran ser\nqueridas y protegidas\npor los hombres',
                     'Mujeres consiguen\nprivilegios en\nnombre de igualdad',
                     'Cuando mujeres son\nderrotadas limpiamente,\nse quejan de discriminación'))) %>%
  ggplot(aes(y = prop, x = name, fill = m0_sexo, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())  

```

```{r sexismo-educ, fig.align='center',fig.cap='Sexismo benévolo y hostil, según nivel educacional (2021). Porcentaje que responde "De acuerdo" o "Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  filter(tipo_atricion == 1 & ola == 5 & !g01_01 %in% c(-888, -999) & !g01_02 %in% c(-888, -999) & !g01_03 %in% c(-888, -999) & !g01_04 %in% c(-888, -999) & !m01 %in% c(-888, -999)) %>% 
  select(g01_01, g01_02, g01_03, g01_04, segmento_disenno, estrato_disenno, ponderador02, m01) %>% 
  pivot_longer(cols = c(g01_01, g01_02, g01_03, g01_04)) %>%
  mutate(educ = factor(car::recode(m01, "1:3 = 1; 4:5 = 2; 6:7 = 3; 8:10 = 4"),
                        levels = c(1, 2, 3, 4), 
                       labels = c("Básica", "Media", "Técnica", "Universitaria"))) %>%
  prop(value %in% 4:5, by = c(name, educ), na.rm = TRUE) %>% 
  sjlabelled::as_label(educ) %>% 
  mutate(name = factor(name,
                       levels = c('g01_01', 'g01_02', 'g01_03', 'g01_04'),
                       labels = c('Mujeres son\nmás refinadas\nque hombres',
                     'Mujeres debieran ser\nqueridas y protegidas\npor los hombres',
                     'Mujeres consiguen\nprivilegios en\nnombre de igualdad',
                     'Cuando mujeres son\nderrotadas limpiamente,\nse quejan de discriminación'))) %>%
  ggplot(aes(y = prop, x = name, fill = educ, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())  


```


## Trabajo y género

```{r ocup-sexo, fig.align='center',fig.cap='Porcentaje de trabajadores y trabajadoras por situación ocupacional (2021), según sexo del entrevistado'}
elsoc_long_2016_2021 %>% 
    dplyr::filter(tipo_atricion == 1 
                & ola %in% c(3, 5) & !m01 %in% c(-888, -999)) %>% 
  mutate(sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1:5),
                           labels = c("Trabajo\nremunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otras\ncategorías"))) %>%
  prop(sit_ocup, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(m0_sexo, ola, sit_ocup) %>% 
  ggplot(aes(y = prop, x = m0_sexo, fill = sit_ocup, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  facet_wrap(.~ola)+
  scale_fill_viridis_d(begin = .13, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(aes(label = ifelse(prop> 0.03 , scales::percent(prop, accuracy = .1),"")), position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep.int(c('black', 'black', 'black','white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

```

```{r m17, eval=FALSE, fig.align='center', fig.cap='Horas de Cuidado'}
#PENDIENTE
#1
datos.grafico <- data.frame((svytable(~m17_rec + ola + idencuesta, 
                                      elsoc_diseno, round = F))) %>% 
  dplyr::filter(Freq>0)  %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq))

#1.1
subset.grafico <- droplevels(subset(datos.grafico, datos.grafico$ola == '2018' | datos.grafico$ola == '2021'))

#2
etiquetas.grafico <- data.frame((svytable(~m17_rec + ola, 
                                          elsoc_diseno, round = F))) %>% 
  group_by(ola) %>% 
  mutate(porcentaje=Freq/sum(Freq)) %>% 
  na.omit() %>% 
  mutate(idencuesta = 1)

#Paso 2.2: crear un subset sólo para los años
etiquetas.grafico <- droplevels(subset(etiquetas.grafico, etiquetas.grafico$ola == '2018' | etiquetas.grafico$ola == '2021'))

g16.11 <- ggplot(subset.grafico, aes(x = ola, fill = m17_rec, stratum = m17_rec, 
                              alluvium = idencuesta, y = porcentaje)) +
  theme_bw() +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = 0, end = .9, direction = -1, option = 'viridis') +
  geom_text(data = etiquetas.grafico, 
            aes(label = ifelse(porcentaje > 0.05 , scales::percent(porcentaje, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size= 2.75)

g16.11
```



<!--chapter:end:16-genero.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---

# Salud mental y bienestar

```{r depre-wave, echo=FALSE, fig.align='center', fig.cap= 'Síntomas de Depresión, según Ola del Estudio'}
elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(suma_dep = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(suma_dep, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o Minima', 'Depresion Media', 'Depresion Moderada', 'Depresion Moderada-Severa\na Severa'))) %>%
  dplyr::filter(tipo_atricion == 1) %>% 
  prop(depr, by = c(ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(depr, ola) %>% 
  ggplot(aes(y = prop, x = ola, fill = depr, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 5)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

```


```{r depre-deuda-wave, echo=FALSE, fig.align='center', fig.cap="Síntomas de Depresión, según Ola del Estudio y Sobrecarga de Deuda"}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(suma_dep = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         depr = factor(car::recode(suma_dep, "0:4 = 1; 5:9 = 2; 10:14 = 3; 15:27 = 4"), 
                       levels = c(1,2,3,4),
                       labels = c('Sin sintomas o Minima', 'Depresion Media', 'Depresion Moderada', 'Depresion Moderada-Severa\na Severa')),
         m43_rec = factor(car::recode(m43,
         "c(1,2)='Nada o Poco Sobrecargado'; c(3)='Algo Sobrecargado'; c(4,5)='Bastante o Muy Sobrecargado'",
         levels = c('Nada o Poco Sobrecargado','Algo Sobrecargado', 'Bastante o Muy Sobrecargado')))) %>%
  dplyr::filter(tipo_atricion == 1 & !m43_rec %in% c(-888, -999) & !is.na(m43_rec)) %>% 
  prop(depr, by = c(ola, m43_rec), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(depr, ola, m43_rec) %>% 
  ggplot(aes(y = prop, x = ola, fill = depr, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 9)) + 
  facet_grid(~factor(m43_rec, levels=c('Nada o Poco Sobrecargado','Algo Sobrecargado','Bastante o Muy Sobrecargado'))) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

```


## Brecha de género en Salud Mental

```{r depre-year-sexo, echo=FALSE, fig.align='center', fig.cap= 'Sintomatología Depresiva por año, según sexo. Porcentaje con síntomas de “Depresion Moderada” o “Depresion Moderada Severa a Severa”.'}

elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(suma_dep = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09)) %>% 
  dplyr::filter(tipo_atricion == 1 & muestra == 1) %>% 
  prop(suma_dep>=10, by = c(ola, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, m0_sexo) %>% 
  ggplot(aes(y = prop, x = ola, 
                   color = m0_sexo, group = m0_sexo,
              label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .55, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

 
```

```{r depre-sexo, echo=FALSE, fig.align='center', fig.cap= 'Cambios en Síntomas de depresión entre años 2018 y 2021, según sexo'}
#Pendiente por Alluvial
elsoc_panel_m1 <- elsoc_long_2016_2021 %>% 
mutate(s11_01_rec = as.numeric(car::recode(s11_01, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_02_rec = as.numeric(car::recode(s11_02, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , 
       s11_03_rec = as.numeric(car::recode(s11_03, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_04_rec = as.numeric(car::recode(s11_04, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , 
       s11_05_rec = as.numeric(car::recode(s11_05, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_06_rec = as.numeric(car::recode(s11_06, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , 
       s11_07_rec = as.numeric(car::recode(s11_07, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_08_rec = as.numeric(car::recode(s11_08, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , 
       s11_09_rec = as.numeric(car::recode(s11_09, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")), 
       suma_dep = (s11_01_rec + s11_02_rec + s11_03_rec + s11_04_rec +  s11_05_rec + s11_06_rec + s11_07_rec + s11_08_rec + s11_09_rec),
         depr = factor(car::recode(suma_dep,"c(0,1,2,3,4)='Sin sintomas o Minima';c(5,6,7,8,9)='Depresion Media'; c(10,11,12,13,14)='Depresion Moderada';c(15,16,17,18,19,20,21,22,23,24,25,26,27)='Depresion Moderada Severa a Severa'"), levels = c('Sin sintomas o Minima','Depresion Media','Depresion Moderada', 'Depresion Moderada Severa a Severa'))) %>%
  filter(tipo_atricion == 1 & ola %in% c(3, 5)) %>% 
  group_by(idencuesta) %>% 
  mutate(missing = any(depr %in% c(-888, -999))) %>% 
  filter(!missing) %>% 
  ungroup() %>%
  sjlabelled::as_label(ola) %>% 
  survey_design_elsoc()

datos.g17.5 <- data.frame((svytable(~depr + ola + idencuesta + m0_sexo, elsoc_panel_m1, round = F))) %>% 
  group_by(ola, m0_sexo) %>% mutate(prop=Freq/sum(Freq)) %>%
  filter(Freq>0 & (ola == '2018'| ola == '2021')) %>%
  drop_na()

etiquetas.g17.5 <- data.frame((svytable(~depr + ola + m0_sexo, elsoc_panel_m1, round = F))) %>% 
  group_by(ola, m0_sexo) %>% mutate(prop=Freq/sum(Freq)) %>% mutate(idencuesta = 1) %>% 
  filter(Freq>0 & (ola == '2018'| ola == '2021')) %>% 
  drop_na()

g17.5 <- 
  ggplot(datos.g17.5, aes(x = ola, fill = depr, stratum = depr, 
                          alluvium = idencuesta, y = prop)) +
  ggalluvial::geom_flow(alpha = .66) + 
  ggalluvial::geom_stratum(linetype = 0) +
  scale_y_continuous(labels = scales::percent) + 
  ylab(label = NULL) +
  xlab(label = NULL) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  scale_fill_viridis_d(begin = .11, end = .88, direction = 1, option = 'viridis') +
  facet_wrap(.~m0_sexo)+
  geom_text(data = etiquetas.g17.5, 
            aes(label = ifelse(prop > 0.03 , scales::percent(prop, accuracy = .1),"")),
            position = position_stack(vjust = .5),
            show.legend = FALSE,
            size = 2.75,
            color = rep(c('white', 'white', 'black','black'),4))
g17.5
```

```{r depre-edad-sexo, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según tramos de edad y sexo (2021). Porcentaje con síntomas de “Depresion Moderada” o “Depresion Moderada Severa a Severa'}
datos.g17.6 <- elsoc_long_2016_2021 %>% 
  purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(suma_dep = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & muestra == 1) %>% 
  prop(suma_dep >= 10, by = c(edadt, m0_sexo), na.rm = TRUE) %>% 
  sjlabelled::as_label(edadt, m0_sexo)


g17.6 <- ggplot(datos.g17.6, 
               aes(y = prop, x = edadt, 
                   color = m0_sexo, group = m0_sexo,
                   label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,0.5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = .33, end = .55, direction = 1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.25) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.6

```

## Sintomatología depresiva, sexo y ocupación

```{r depre-labstat, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según sexo y situación ocupacional (2021). Porcentaje con síntomas PHQ-9>10'}
datos.g17.7 <- elsoc_long_2016_2021 %>% 
    purrr::map_at(.at = vars(starts_with('s11_0')), 
                .f = function(s) car::recode(s, "1 = 0; 2 = 1; 3 = 2; c(4, 5) = 3; c(-888, -999) = NA")) %>%
  as.data.frame() %>%  
  mutate(suma_dep = (s11_01 + s11_02 + s11_03 + s11_04 + s11_05 + s11_06 + s11_07 + s11_08 + s11_09),
         sit_ocup = factor(car::recode(m02, "1:3 = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5"), 
                           levels = c(1, 2, 3, 4, 5),
                           labels = c("Trabajo remunerado", "Trabajo doméstico\nno remunerado", "Desempleado/a", "Jubilado/a o\npensionado/a", "Otras categorías"))
         ) %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & muestra == 1 & !m02 %in% c(-888, -999)) %>% 
  prop(suma_dep >= 10, by = c(sit_ocup, m0_sexo)) %>% 
  sjlabelled::as_label(sit_ocup, m0_sexo)

g17.7 <- datos.g17.7 %>% 
  ggplot(aes(y = prop, x = sit_ocup, fill = m0_sexo, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .65, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.7
```

En 2021 no hay hombres en la categoría Trabajo doméstico no remunerado $^{*}$

## COVID - 19
```{r covid-sexo, fig.align='center', fig.cap= 'Sí fue diagnosticado con COVID-19, según sexo'}
datos.g17.8 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !s31 %in% c(-888, -999, NA)) %>% 
  prop(s31==1, by=m0_sexo, na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(s31,m0_sexo)


g17.8 <- datos.g17.8 %>% 
  ggplot(aes(y = prop, x = m0_sexo, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 0.2)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.8
```

```{r depre-s03, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión según Estado de Salud y ola de estudio. Porcentaje con síntomas PHQ-9>10'}
datos.g17.9 <- elsoc_long_2016_2021 %>% 
  mutate(s11_01_rec = as.numeric(car::recode(s11_01, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_02_rec = as.numeric(car::recode(s11_02, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_03_rec = as.numeric(car::recode(s11_03, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_04_rec = as.numeric(car::recode(s11_04, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_05_rec = as.numeric(car::recode(s11_05, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_06_rec = as.numeric(car::recode(s11_06, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_07_rec = as.numeric(car::recode(s11_07, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_08_rec = as.numeric(car::recode(s11_08, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_09_rec = as.numeric(car::recode(s11_09, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")), suma_dep = (s11_01_rec + s11_02_rec + s11_03_rec + s11_04_rec + 
                              s11_05_rec + s11_06_rec + s11_07_rec + s11_08_rec + s11_09_rec),
         phq = factor(car::recode(suma_dep,"c(0,1,2,3,4,5,6,7,8,9)='Sin Sintomas Depresivos';c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='Con Sintomas Depresivos'"), levels = c('Sin Sintomas Depresivos','Con Sintomas Depresivos')),
         s03_rec = factor(car::recode(s03, "c(1) = 'Mala'; c(2,3) = 'Regular o Buena'; c(3,4) = 'Muy Buena o Excelente'"),
                           levels = c('Mala', 'Regular o Buena', 'Muy Buena o Excelente'))) %>%
  dplyr::filter(tipo_atricion == 1 & !phq %in% c(-888, -999, NA) & !is.na(s03_rec)) %>% 
  prop(phq=='Con Sintomas Depresivos', by = c(s03_rec, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(phq, s03_rec, ola)


g17.9 <- datos.g17.9  %>% 
  ggplot(aes(y =prop, x = ola, fill = s03_rec, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .65, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g17.9
```

## Salud Mental en COVID-19

```{r depre-teletrabajo, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión, según Modalidad de Trabajo'}
datos.g17.10 <- elsoc_long_2016_2021 %>% 
  mutate(s11_01_rec = as.numeric(car::recode(s11_01, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_02_rec = as.numeric(car::recode(s11_02, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_03_rec = as.numeric(car::recode(s11_03, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_04_rec = as.numeric(car::recode(s11_04, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_05_rec = as.numeric(car::recode(s11_05, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_06_rec = as.numeric(car::recode(s11_06, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_07_rec = as.numeric(car::recode(s11_07, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_08_rec = as.numeric(car::recode(s11_08, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_09_rec = as.numeric(car::recode(s11_09, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")), suma_dep = (s11_01_rec + s11_02_rec + s11_03_rec + s11_04_rec + 
                              s11_05_rec + s11_06_rec + s11_07_rec + s11_08_rec + s11_09_rec),
         depr = factor(car::recode(suma_dep,"c(0,1,2,3,4)='Sin sintomas o Minima';c(5,6,7,8,9)='Depresion Media'; c(10,11,12,13,14)='Depresion Moderada';c(15,16,17,18,19,20,21,22,23,24,25,26,27)='Depresion Moderada Severa a Severa'"), levels = c('Sin sintomas o Minima','Depresion Media','Depresion Moderada', 'Depresion Moderada Severa a Severa'))) %>%
  dplyr::filter(tipo_atricion == 1 & !depr %in% c(-888, -999, NA) & !m60 %in% c(-888, -999, NA)) %>% 
  prop(depr, by = c(ola, m60), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(depr, m60) 


g17.10 <- datos.g17.10 %>% 
  ggplot(aes(y = prop, x = m60, fill = depr, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75)  + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.10
```

```{r depre-beneficios, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión (2021), según sexo y acceso a beneficios'}

datos.g17.11 <- elsoc_long_2016_2021 %>% 
  mutate(s11_01_rec = as.numeric(car::recode(s11_01, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_02_rec = as.numeric(car::recode(s11_02, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_03_rec = as.numeric(car::recode(s11_03, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_04_rec = as.numeric(car::recode(s11_04, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_05_rec = as.numeric(car::recode(s11_05, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_06_rec = as.numeric(car::recode(s11_06, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_07_rec = as.numeric(car::recode(s11_07, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_08_rec = as.numeric(car::recode(s11_08, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_09_rec = as.numeric(car::recode(s11_09, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")), suma_dep = (s11_01_rec + s11_02_rec + s11_03_rec + s11_04_rec + 
                              s11_05_rec + s11_06_rec + s11_07_rec + s11_08_rec + s11_09_rec),
         depr = factor(car::recode(suma_dep,"c(0,1,2,3,4)='Sin sintomas o Minima';c(5,6,7,8,9)='Depresion Media'; c(10,11,12,13,14)='Depresion Moderada';c(15,16,17,18,19,20,21,22,23,24,25,26,27)='Depresion Moderada Severa a Severa'"), levels = c('Sin sintomas o Minima','Depresion Media','Depresion Moderada', 'Depresion Moderada Severa a Severa'))) %>%
  dplyr::filter(tipo_atricion == 1 & !depr %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(depr, by = c(m63_01, m0_sexo), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(depr, m63_01, m0_sexo) 

g17.11 <- datos.g17.11 %>% 
  ggplot(aes(y = prop, x = m63_01, fill = depr, 
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  #Agrego facer_wrap para hacer un Gráfico para cada sexo
  facet_wrap(.~m0_sexo) +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.11
```

```{r depre clase.sub, echo=FALSE, fig.align='center', fig.cap='Síntomas de Depresión, según Clase Subjetiva y ola. Porcentaje con síntomas PHQ-9>10'}
datos.g17.12 <- elsoc_long_2016_2021 %>% 
  mutate(s11_01_rec = as.numeric(car::recode(s11_01, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_02_rec = as.numeric(car::recode(s11_02, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_03_rec = as.numeric(car::recode(s11_03, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_04_rec = as.numeric(car::recode(s11_04, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_05_rec = as.numeric(car::recode(s11_05, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_06_rec = as.numeric(car::recode(s11_06, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_07_rec = as.numeric(car::recode(s11_07, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_08_rec = as.numeric(car::recode(s11_08, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_09_rec = as.numeric(car::recode(s11_09, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")), suma_dep = (s11_01_rec + s11_02_rec + s11_03_rec + s11_04_rec + 
                              s11_05_rec + s11_06_rec + s11_07_rec + s11_08_rec + s11_09_rec),
         phq = factor(car::recode(suma_dep,"c(0,1,2,3,4,5,6,7,8,9)='Sin Sintomas Depresivos';c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='Con Sintomas Depresivos'"), levels = c('Sin Sintomas Depresivos','Con Sintomas Depresivos')),
         clase.sub = factor(car::recode(d01_01, "c(0,1,2,3)='Baja y media baja'; c(4, 5)='Media'; c(6,7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(tipo_atricion == 1 & !phq %in% c(-888, -999, NA) & !is.na(clase.sub)) %>% 
  prop(phq=='Con Sintomas Depresivos', by = c(clase.sub, ola), na.rm = TRUE) %>% 
  sjlabelled::as_label(phq, clase.sub, ola)


g17.12 <- datos.g17.12 %>% 
  ggplot(aes(y = prop, x = ola, fill = clase.sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g17.12

```


<!--chapter:end:17-salud-bienestar.Rmd-->

# Migración
 
## Amenaza realista y amenaza simbólica respecto a inmigrantes
 
<!-- ### 14.1 "Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen1-wave, fig.align='center',fig.cap='Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.1 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_04 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_04 %in% c(4,5), by = c(ola, cuestion_mig)) %>% 
  sjlabelled::as_label(ola, cuestion_mig)
  
datos.g14.1 %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

```{r amen1-zona, fig.align='center',fig.cap='Con la llegada de migrantes a Chile, está aumentando el desempleo", según ola, zona y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  mutate(macrozona = factor(case_when(region_cod %in% c(15, 1, 2, 3) ~ 1,
                               region_cod %in% c(4, 5, 13) ~ 2,
                               region_cod %in% c(6, 7 , 16, 8) ~ 3,
                               region_cod %in% c(9, 14, 10, 11, 12) ~ 4),
                            labels = c('Norte', 'Centro/RM', 'Centro Sur', 'Sur/Austral'))) %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_04 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_04 %in% c(4,5), by = c(ola, cuestion_mig, macrozona)) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>% 
ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~macrozona) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

<!-- ### 14.2 "Con la llegada de migrantes, Chile está perdiendo su identidad", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o "Totalmente de acuerdo". -->
```{r amen2-wave, fig.align='center',fig.cap='"Con la llegada de migrantes, Chile está perdiendo su identidad", según ola y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o "Totalmente de acuerdo".'}

datos.g14.2 <- elsoc_long_2016_2021 %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_03 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_03 %in% c(4,5), by = c(ola, cuestion_mig), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig)

datos.g14.2 %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
                           label = scales::percent(prop, accuracy = .1))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())
```


```{r amen2-zona, fig.align='center',fig.cap='"Con la llegada de migrantes, Chile está perdiendo su identidad", según ola, zona y origen de migrantes. Porcentaje de personas que responden "De acuerdo" o "Totalmente de acuerdo".'}

elsoc_long_2016_2021 %>% 
  mutate(macrozona = factor(case_when(region_cod %in% c(15, 1, 2, 3) ~ 1,
                               region_cod %in% c(4, 5, 13) ~ 2,
                               region_cod %in% c(6,7 , 16, 8) ~ 3,
                               region_cod %in% c(9, 14, 10, 11, 12) ~ 4),
                            labels = c('Norte', 'Centro/RM', 'Centro Sur', 'Sur/Austral'))) %>% 
  filter(tipo_atricion %in% c(1, 17) & !r12_03 %in% c(-888, -999)) %>% 
  elsoc::prop(r12_03 %in% c(4,5), by = c(ola, cuestion_mig, macrozona), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~macrozona) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

<!-- ### 14.3 Confianza en migrantes, según ola y origen de migrantes. Porcentaje de personas que responden “Bastante” o “Mucha confianza”. -->
```{r conf-wave, fig.align='center',fig.cap='Confianza en migrantes, según ola y origen de migrantes. Porcentaje de personas que responden “Bastante” o “Mucha confianza”'}

datos.g14.3 <- elsoc_long_2016_2021 %>% 
  mutate(confianza = ifelse(ola %in% c(1,3), c06_06, r16)) %>% 
  filter(tipo_atricion %in% c(1,17) & !confianza %in% c(-888,-999)) %>% 
  elsoc::prop(confianza %in% c(4,5), by = c(ola, cuestion_mig), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig)

datos.g14.3 %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
                          label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0,1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```


```{r conf-zona, fig.align='center',fig.cap='Confianza en migrantes, según ola, zona y origen de migrantes. Porcentaje de personas que responden “Bastante” o “Mucha confianza”'}
elsoc_long_2016_2021 %>% 
  mutate(macrozona = factor(case_when(region_cod %in% c(15, 1, 2, 3) ~ 1,
                               region_cod %in% c(4, 5, 13) ~ 2,
                               region_cod %in% c(6,7 , 16, 8) ~ 3,
                               region_cod %in% c(9, 14, 10, 11, 12) ~ 4),
                            labels = c('Norte', 'Centro/RM', 'Centro Sur', 'Sur/Austral'))) %>% 
  mutate(confianza = ifelse(ola %in% c(1,3), c06_06, r16)) %>% 
  filter(tipo_atricion %in% c(1,17) & !confianza %in% c(-888,-999)) %>% 
  elsoc::prop(confianza %in% c(4,5), by = c(ola, cuestion_mig, macrozona), na.rm = TRUE) %>% 
  sjlabelled::as_label(ola, cuestion_mig) %>% 
  ggplot(aes(y = prop, x = ola, color = cuestion_mig, group = cuestion_mig,
             label = scales::percent(prop, accuracy = .1))) +
  facet_wrap(.~macrozona) +
  theme_bw() +   
  geom_line(size = 1) +
  geom_point(size = 1.8) +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_color_viridis_d(begin = 0, end = .66, direction = -1, option = 'viridis') +
  ggrepel::geom_text_repel(size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

```

<!-- ### 14.4 Percepción de amenaza realista y simbólica, según grupo de migrantes (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-wave, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica, según grupo de migrantes (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.4 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion %in% c(1, 17) & ola == 5) %>% 
  select(r12_03, r12_04, estrato_disenno, segmento_disenno, ponderador02, cuestion_mig) %>%
  pivot_longer(cols = c(r12_03, r12_04)) %>% 
  filter(!value %in% c(-888,-999)) %>% 
  prop(value %in% c(4,5), by = c(name, cuestion_mig), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('r12_04', 'r12_03'), 
                       labels = c('Aumenta desempleo', 'Chile pierde su identidad'))) %>% 
  sjlabelled::as_label(cuestion_mig)

datos.g14.4 %>% 
  ggplot(aes(y = prop, x = name, fill = cuestion_mig, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)

```


## Amenaza realista y simbólica respecto a inmigrantes según nivel educacional


<!-- ### 14.5 Percepción de amenaza realista y simbólica respecto a inmigrantes, según nivel educacional (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-educ, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica respecto a inmigrantes, según nivel educacional (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.5 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion %in% c(1, 17) & ola == 5) %>% 
  mutate(educ = factor(car::recode(m01, "c(1,2,3) = 'Basica'; c(4,5) = 'Media'; c(6,7) = 'Tecnica'; c(8,9,10) = 'Universitaria'"))) %>% 
  select(r12_03, r12_04, estrato_disenno, segmento_disenno, ponderador02, educ) %>%
  pivot_longer(cols = c(r12_03, r12_04)) %>% 
  filter(!value %in% c(-888,-999)) %>% 
  prop(value %in% c(4,5), by = c(name, educ), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('r12_04', 'r12_03'), 
                       labels = c('Aumenta desempleo', 'Chile pierde su identidad')))

datos.g14.5 %>% 
  ggplot(aes(y = prop, x = name, fill = educ, 
             label = scales::percent(prop, accuracy = .1))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)

```

<!-- ### 14.8 Percepción de amenaza realista y simbólica, según tramo de edad (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo". -->
```{r amen-edad, fig.align='center',fig.cap='Percepción de amenaza realista y simbólica, según tramo de edad (2021). Porcentaje de personas que responden "De acuerdo" o Totalmente de acuerdo".'}

datos.g14.8 <- elsoc_long_2016_2021 %>%
  filter(tipo_atricion %in% c(1, 17) & ola == 5) %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>% 
  select(r12_03, r12_04, estrato_disenno, segmento_disenno, ponderador02, edadt) %>%
  pivot_longer(cols = c(r12_03, r12_04)) %>% 
  filter(!value %in% c(-888,-999)) %>% 
  prop(value %in% c(4,5), by = c(name, edadt), na.rm = TRUE) %>% 
  mutate(name = factor(name, levels = c('r12_04', 'r12_03'), 
                       labels = c('Aumenta desempleo', 'Chile pierde su identidad')))

datos.g14.8 %>% 
  ggplot(aes(y = prop, x = name, fill = edadt, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .8)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)
```

<!--chapter:end:18-migracion.Rmd-->

---
editor_options: 
  markdown: 
    wrap: 72
---
```{r variables-covid, include=FALSE}
#Análisis de Cuarentenas por comuna en base a datos del Ministerio de Ciencia (@MinCiencia)
library(readr)
library(dplyr)
library(scales)
library(ggplot2)
library(reshape2)
library(leaflet)
library(ggplot2)
library(data.table)
library(tidyr)
library(stringr)
library(lubridate)

#abrir bases de datos necesarias
load(file.path('1_input', 'ELSOC_Long_2016_2021_v1.00_R.RData'))

## DATA CUARENTENA ---------
# Url para descarga directa de datos desde el Github del Ministerio de Ciencia
url <- "https://raw.githubusercontent.com/MinCiencia/Datos-COVID19/master/output"

## Cuarentenas desde 2020/07/28 al día actualizado.
df_pasos <- read_csv(paste(url,"producto74","paso_a_paso_std.csv", sep="/"))
df_pasos$Fecha<-as.Date(df_pasos$Fecha)
df_pasos$dia <- weekdays(as.Date(df_pasos$Fecha))

#new variable dias_cuarentena
df_pasos$cuarentena <- case_when(df_pasos$Paso==1 ~ 1,
                                 df_pasos$Paso==2 & df_pasos$dia=="Saturday" ~ 1,
                                 df_pasos$Paso==2 & df_pasos$dia=="Sunday" ~ 1,
                                 TRUE ~ 0)
df_pasos <- df_pasos %>% 
  filter(zona=="Urbana" | zona=="Total")

#cuarentena acomulada del 2020/07/27 a la fecha de entrevista
df_pasos2 <- df_pasos %>% 
  group_by(codigo_comuna, zona) %>% 
  mutate(csum = cumsum(cuarentena)) %>% 
  mutate(ola=5)

#crear variable fecha entrevista
elsoc_long_2016_2021$fecha_entr <- as.Date(with(elsoc_long_2016_2021, paste(annio_entr, mes_entr, dia_entr ,sep="-")), "%Y-%m-%d")

#unir bbdd
els_long <- merge(x = elsoc_long_2016_2021, 
                  y = df_pasos2[ , c("Fecha","codigo_comuna", "csum", "ola")], 
                   by.x=c("fecha_entr", "comuna_cod", "ola"), 
                   by.y=c("Fecha", "codigo_comuna", "ola"), all.x = T)

## Cuarentenas desde 2021/03 hasta 2020/07/28 
pre_27jul <- read_csv(paste(url,"producto29","Cuarentenas-Totales.csv", sep="/"))
names(pre_27jul) <- names(pre_27jul) %>% str_to_lower() %>% str_replace_all(" ","_")
pre_27jul$fecha_de_inicio <- as.Date(pre_27jul$fecha_de_inicio)
pre_27jul$fecha_de_término <- as.Date(pre_27jul$fecha_de_término)

# cortar en fecha 2020/07/27 
pre_27jul$fecha_de_termino2 <- ifelse(pre_27jul$fecha_de_término>"2020-07-27",
                                      date("2020-07-27"),
                                      pre_27jul$fecha_de_término)

pre_27jul$fecha_termino <- as.Date(pre_27jul$fecha_de_termino2, 
                                   origin = "1970-01-01")
#filtrar fecha_inicio > 2020/07/27 
pre_27jul <- pre_27jul %>% filter(fecha_de_inicio<"2020/07/27")
#calcular dias en cuarentena
pre_27jul$dias <- as.Date(pre_27jul$fecha_termino) - 
  as.Date(pre_27jul$fecha_de_inicio)

pre_27jul$dias <- as.numeric(pre_27jul$dias, units="days")

## Unir fechas
pre_27jul <- pre_27jul %>% 
  group_by(código_cut_comuna) %>% 
  summarise(cuarentena_pre_27jul = sum(dias))  %>% 
  mutate(ola=5)

els_long2 <- merge(x = els_long, y = pre_27jul, 
                   by.x=c("ola", "comuna_cod"), 
                   by.y=c("ola", "código_cut_comuna"), all.x = T)
els_long2$cuarentena_pre_27jul[is.na(els_long2$cuarentena_pre_27jul)] <- 0
#VARIABLE 1: cuarentena en els_long3 acomulada
els_long2$ccum <- els_long2$cuarentena_pre_27jul + els_long2$csum

#VARIABLE 2: dummy de cuarentena en els_long3
elsoc_covid <- merge(x = els_long2, y = df_pasos, 
                   by.x=c("fecha_entr", "comuna_cod"), 
                   by.y=c("Fecha", "codigo_comuna"), all.x = T)


elsoc_covid$ccum <- as.numeric(as.character(elsoc_covid$ccum))

elsoc_covid$cuarentena <- factor(elsoc_covid$cuarentena,
                            levels = c(0,1),
                            labels = c("Sin Cuarentena", "Con Cuarentena"))

elsoc_covid$ccum_t <- factor(car::recode(elsoc_covid$ccum, "0='0 Dias';1:99='1-99 Dias';
                                        100:149='100-149 Dias';150:500='150 o más Dias'"),
                           levels = c('0 Dias', '1-99 Dias', '100-149', '150 o más Dias'))

elsoc_covid_panel <- elsoc_covid %>% filter(tipo_atricion == 1 | 
                                            tipo_atricion == 17 )

```

# Pandemia Covid-19

## Cuarentenas 
```{r hist-fecha-2021, fig.align='center', fig.cap="Histograma Fechas de Entrevistas"}
datos.g19.1 <- elsoc_covid_panel %>% 
  dplyr::filter(ola==5) %>% 
  prop(fecha_entr, by = c(comuna_cod), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(comuna_cod) 

g19.1 <- datos.g19.1 %>% 
  ggplot(mapping = aes(x = fecha_entr)) +
  theme_bw() + 
  geom_histogram(bins = 9,
                 stat="count") +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_x_date(date_breaks = "1 month", date_labels = "%d %b %Y")

g19.1
```

```{r ccum-heter, fig.align='center', fig.cap="Heterogeneidad de Cuarentena Acumulada en el Panel"}
g19.2 <- elsoc_covid_panel %>% 
  ggplot(aes(x=ccum)) + 
  geom_histogram(aes(y = ..density..), bins=30) + 
  geom_density() +
  theme_bw() +
  ylab(label = NULL) +
  xlab(label = "Tiempo (Nº de Días)")

g19.2
```

```{r ccum-zona, fig.align='center', fig.cap='Días de Cuarentena Acumulada al momento de la entrevista, según Zona'}
datos.g19.3 <- elsoc_covid_panel %>% 
  mutate(zona1 = factor(car::recode(region_cod, "c(1,2,3,4,15)='Norte'; c(5,6,7,8,16)='Centro'; c(9,10,11,12,14)='Sur'; 13='Metropolitana'", levels = c("Norte","Centro","Sur","Metropolitana"))))  %>% 
  dplyr::filter(ola==5 & !is.na(ccum_t))   %>% 
  prop(ccum_t, by = c(zona1), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(zona1) 
  

g19.3 <- datos.g19.3 %>% 
  ggplot(aes(y = prop, x = zona1, fill = ccum_t, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.3
```

```{r ccum-edad, fig.align='center', fig.cap='Días de Cuarentena Acumulada al momento de la entrevista, según Tramo Etario'}
datos.g19.4 <- elsoc_covid_panel %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  dplyr::filter(ola==5 & !is.na(ccum_t)) %>% 
  prop(ccum_t, by = c(edadt), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(edadt) 


g19.4 <- datos.g19.4  %>% 
  ggplot(aes(y = prop, x = edadt, fill = ccum_t, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 4)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.4
```

```{r ccum-aislamiento, fig.align='center', fig.cap='Cumplimiento de Aislamiento Social, según Días de Cuarentena Acumulada al momento de la entrevista'}
datos.g19.5 <- elsoc_covid_panel %>% 
  mutate(dis_soc = factor(car::recode(c48, "c(1,2) = 1; c(3) = 2; c(4,5) = 3"),
                               levels = c(1,2,3), labels= c("Nunca o casi nunca", "A veces",
                                         "Frecuentemente o\nmuy frecuentemente"))) %>%
  dplyr::filter(!is.na(ccum_t) & !dis_soc %in% c(-888, -999, NA)) %>% 
  prop(dis_soc, by = c(ccum_t), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(ccum_t, dis_soc)

g19.5 <- datos.g19.5 %>% 
  ggplot(aes(y = prop, x = ccum_t, fill = dis_soc, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.5
```

```{r ccum-depr, fig.align='center', fig.cap= 'Sintomatología Depresiva, según Días de Cuarentena Acumulada al momento de la entrevista'}
datos.g19.6 <- elsoc_covid_panel %>% 
  mutate(s11_01_rec = as.numeric(car::recode(s11_01, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_02_rec = as.numeric(car::recode(s11_02, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_03_rec = as.numeric(car::recode(s11_03, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_04_rec = as.numeric(car::recode(s11_04, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_05_rec = as.numeric(car::recode(s11_05, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_06_rec = as.numeric(car::recode(s11_06, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_07_rec = as.numeric(car::recode(s11_07, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_08_rec = as.numeric(car::recode(s11_08, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")) , s11_09_rec = as.numeric(car::recode(s11_09, " '1' = 0; '2' = 1; '3' = 2; c('5', '4') = 3")), suma_dep = (s11_01_rec + s11_02_rec + s11_03_rec + s11_04_rec + 
                              s11_05_rec + s11_06_rec + s11_07_rec + s11_08_rec + s11_09_rec),
         phq = factor(car::recode(suma_dep,"c(0,1,2,3,4,5,6,7,8,9)='Sin Sintomas Depresivos';c(10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27)='Con Sintomas Depresivos'"), levels = c('Sin Sintomas Depresivos','Con Sintomas Depresivos'))) %>%
  dplyr::filter(tipo_atricion == 1 & muestra == 1 & !is.na(ccum_t) & !phq %in% c(-888, -999, NA)) %>% 
  prop(phq=='Con Sintomas Depresivos', by = c(ola, ccum_t), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(phq, ola, ccum_t) 


g19.6 <- datos.g19.6  %>% 
  ggplot(aes(y = prop, x = ccum_t,
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, .5)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('white', 'white', 'white'),1)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())
g19.6
```

```{r ccum-sit_ocup, fig.align='center', fig.cap= 'Situación Ocupacional, según Días de Cuarentena Acumulada al momento de la entrevista'}
datos.g19.7 <- elsoc_covid_panel %>% 
  mutate(empleo = factor(car::recode(m02, "c(1,2,3) = 'Trabajo remunerado'; 7 = 'Trabajo doméstico no remunerado'; 6 = 'Desempleado/a'; 5 = 'Jubilado/a o pensionado/a'; c(4, 8, 9) = 'Otras categorías'"), levels = c("Trabajo remunerado", "Trabajo doméstico no remunerado", "Desempleado/a", "Jubilado/a o pensionado/a", "Otras categorías"))) %>%
  dplyr::filter(tipo_atricion == 1 & !is.na(ccum_t) & !empleo %in% c(-888, -999, NA)) %>% 
  prop(empleo, by = c(ola, ccum_t), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(empleo, ola, ccum_t) 


g19.7 <- datos.g19.7 %>% 
  ggplot(aes(y = prop, x = ccum_t, fill = empleo, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color = rep.int(c('black', 'black','black', 'white', 'white'), 3)) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.7
```

```{r ccum-ahorro, fig.align='center', fig.cap= 'Nivel de Ahorro "Nada o Poco", según Días de Cuarentena Acumulada al momento de la entrevista (2021)'}
datos.g19.8 <- elsoc_covid_panel %>% 
  mutate(m44_rec = factor(car::recode(m44, "c(1,2)='Nada o Pocos Ahorros'; c(3)='Algo de Ahorros';c(4,5)='Bastante o Muchos Ahorros'"), levels = c("Nada o Pocos Ahorros", "Algo de Ahorros", "Bastante o Muchos Ahorros"))) %>%
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !is.na(ccum_t) & !m44_rec %in% c(-888, -999, NA)) %>% 
  prop(m44_rec=='Nada o Pocos Ahorros', by = c(ccum_t), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(m44_rec, ccum_t) 


g19.8 <- datos.g19.8 %>% 
  ggplot(aes(y = prop, x = ccum_t, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75, color="white") + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.8
```

```{r cuarentena-etario, fig.align='center', fig.cap= 'Encuestados en Cuarentena según Tramo Etario'}
datos.g19.9 <- elsoc_covid_panel %>% 
  mutate(edadt = factor(car::recode(m0_edad, "18:29 = 1; 30:49 = 2; 50:64 = 3; 65:150 = 4"),
                           labels = c('18-29', '30-49', '50-64', '65 o más'))) %>%
  dplyr::filter(ola == 5 & tipo_atricion == 1 & !is.na(ccum_t) & !edadt %in% c(-888, -999, NA)) %>% 
  prop(cuarentena, by = c(edadt), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(edadt, cuarentena) 

g19.9 <- datos.g19.9 %>% 
  ggplot(aes(y = prop, x = edadt, fill = cuarentena, 
             label = as.character(scales::percent(prop, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.9
```

## Estrés Financiero
```{r satisfaccion-wave, echo=FALSE, fig.align='center', fig.cap= 'Satisfacción con el Ingreso por Ola'}
datos.g19.10 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1 & !m43 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(ola), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(m43, ola) 


g19.10 <- datos.g19.10 %>% 
  ggplot(aes(y = prop, x = ola, fill = m43, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.10
```

```{r satisfaccion-retiro, echo=FALSE, fig.align='center', fig.cap= 'Satisfacción con el Ingreso según Retiro AFP'}
datos.g19.11 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m16 %in% c(-888, -999, NA) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m16, by = c(m63_02), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(m16, m63_02) 


g19.11 <- datos.g19.11 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m16, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.11
```

```{r clase.sub-benef.estatal, echo=FALSE, fig.align='center', fig.cap='Satisfacción con el Ingreso según Acceso a Beneficios'}

datos.g19.12 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub = factor(car::recode(d01_01, "c(0,1,2,3)='Baja y media baja'; c(4, 5)='Media'; c(6,7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub, by = c(m63_01), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(clase.sub, m63_01) 

g19.12 <- datos.g19.12 %>% 
  ggplot(aes(y = prop, x = m63_01, fill = clase.sub, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 

g19.12
```

```{r clase.sub.hij-1erretiro, echo=FALSE, fig.align='center', fig.cap='Clase Social Subjetiva de Hijo según Primer Retiro AFP'}
datos.g19.13 <- elsoc_long_2016_2021 %>% 
  mutate(clase.sub.hijos = factor(car::recode(d01_03, "c(0,1,2,3)='Baja y media baja'; c(4, 5,6)='Media'; c(7,8,9,10)='Alta y media alta'"),
                           levels = c("Baja y media baja", "Media", "Alta y media alta"))) %>%
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !clase.sub.hijos %in% c(-888, -999, NA) & !m63_01 %in% c(-888, -999, NA)) %>% 
  prop(clase.sub.hijos, by = c(m63_02), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(clase.sub.hijos, m63_02) 

g19.13 <- datos.g19.13 %>% 
  ggplot(aes(y = prop, x = m63_02, fill = clase.sub.hijos, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.13
```

```{r endeud-1retiro, echo=FALSE, fig.align='center', fig.cap='Sobrecarga de Deuda según Primer Retiro AFP'}
datos.g19.14 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_02 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_02), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(m43, m63_02) 

g19.14 <- datos.g19.14  %>% 
  ggplot(aes(y = prop, x = m63_02, fill = m43, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.14
```

```{r endeud-2retiro, echo=FALSE, fig.align='center', fig.cap='Sobrecarga de Deuda según Primer Retiro AFP'}
datos.g19.15 <- elsoc_long_2016_2021 %>% 
  dplyr::filter(muestra == 1 & tipo_atricion == 1
                & !m43 %in% c(-888, -999, NA) & !is.na(m43) & !m63_03 %in% c(-888, -999, NA)) %>% 
  prop(m43, by = c(m63_03), na.rm = TRUE, vartype = NULL) %>% 
  sjlabelled::as_label(m43, m63_03) 

g19.15 <- datos.g19.15  %>% 
  ggplot(aes(y = prop, x = m63_03, fill = m43, 
             label = as.character(scales::percent(prop, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .85, direction = -1, option = 'viridis') +
  #cambiar geom_text tal que: Stack y cambio colores
  geom_text(position = position_stack(vjust = .5),
            size= 2.75) + 
  theme(legend.position = 'top',
        legend.title = element_blank()) 
g19.15
```

```{r deuda-retiro1, fig.align='center',fig.cap="Primer retiro de AFP, según deuda"}
datos.01 <- data.frame((svytable(~deuda_01  + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_01=Freq/sum(Freq))
datos.01$retiro1 <- NULL
datos.02 <- data.frame((svytable(~deuda_02  + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_02=Freq/sum(Freq))
datos.02$retiro1 <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_03=Freq/sum(Freq))
datos.03$retiro1 <- NULL
datos.04 <- data.frame((svytable(~deuda_04 + retiro1, elsoc_diseno_2, round = F))) %>% group_by(retiro1) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g19.16 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = retiro1, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.16
```

```{r deuda-retiro2, fig.align='center',fig.cap="Segundo retiro de AFP, según deuda"}
datos.01 <- data.frame((svytable(~deuda_01  + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_01=Freq/sum(Freq))
datos.01$retiro2 <- NULL
datos.02 <- data.frame((svytable(~deuda_02  + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_02=Freq/sum(Freq))
datos.02$retiro2 <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_03=Freq/sum(Freq))
datos.03$retiro2 <- NULL
datos.04 <- data.frame((svytable(~deuda_04 + retiro2, elsoc_diseno_2, round = F))) %>% group_by(retiro2) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g19.17 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = retiro2, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.17
```

```{r deuda-benef, fig.align='center',fig.cap="Beneficios Estatales, según deuda"}
datos.01 <- data.frame((svytable(~deuda_01  + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_01=Freq/sum(Freq))
datos.01$benef_estado <- NULL
datos.02 <- data.frame((svytable(~deuda_02  + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_02=Freq/sum(Freq))
datos.02$benef_estado <- NULL
datos.03 <- data.frame((svytable(~deuda_03 + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_03=Freq/sum(Freq))
datos.03$benef_estado <- NULL
datos.04 <- data.frame((svytable(~deuda_04 + benef_estado, elsoc_diseno_2, round = F))) %>% group_by(benef_estado) %>% mutate(p_04=Freq/sum(Freq))

datos.grafico1<- cbind(datos.01, datos.02, datos.03, datos.04)

subset.grafico <- droplevels(subset(datos.grafico1,
                                      deuda_01 == 'Si' & 
                                      deuda_02== 'Si' &
                                      deuda_03 == 'Si' & 
                                      deuda_04 == 'Si'))
#trasponer según variable
datos.grafico <- subset.grafico %>% 
  pivot_longer(cols = starts_with('deuda_'))  %>%
  mutate(variable = factor(name, labels = c('Deuda Casa Comercial',
                     'Deuda Banco',
                     'Deuda Pariente',
                     'Otras Deudas'))) %>% 
  drop_na()

datos.grafico$porcentaje <- with(datos.grafico, case_when(
  variable == 'Deuda Casa Comercial' ~ p_01,
  variable == 'Deuda Banco' ~ p_02,
  variable == 'Deuda Pariente' ~ p_03,
  variable == 'Otras Deudas' ~ p_04))

#graficamos

g19.17 <-datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = variable, fill = benef_estado, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
  geom_col(position = "dodge2") +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') + 
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75)  +
  theme(legend.position = 'top',
        legend.title = element_blank())

g19.17
```


<!--chapter:end:19-pandemia-covid-19.Rmd-->

# Cómo citar este informe: {-}

:::{.blue-box}
> COES (2021) Radiografía del Cambio Social: Análisis de Resultados Longitudinales ELSOC 2016-2021. Presentación de Resultados COES. Septiembre, Santiago de Chile.
:::

**Entrada Bibtex:**

```{r,echo=TRUE,eval=FALSE}
@techreport{coes_Radiografia_2021,
  title = {Radiograf\'ia Del {{Cambio Social}}: {{An\'alisis}} de {{Resultados Longitudinales ELSOC}} 2016-2021.},
  author = {COES},
  year = {2021},
  month = sep,
  address = {{Santiago de Chile, Chile}},
  institution = {{Centro de Estudios de Conflicto y Cohesi\'on Social}}
}
```

<!--chapter:end:20-como-citar.Rmd-->

